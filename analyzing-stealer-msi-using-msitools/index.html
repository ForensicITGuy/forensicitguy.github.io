<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="Analyzing a Stealer MSI using msitools" /><meta property="og:locale" content="en" /><meta name="description" content="This post is dedicated to Josh Rickard (@MSAdministrator on Twitter) since his feedback on my blog posts has cut my triage time on MSI files down in a massive way! After writing an analysis of a MSI payload distributing njRAT, Josh hit me up on Twitter to suggest a Python tool he made to analyze MSIs, msi-utils with the caveat that it only worked on macOS. I set off to figure out why it only worked on macOS and, long story short, the journey led me to the msitools package on Linux. I’ll use it in this post to analyze this sample in MalwareBazaar: https://bazaar.abuse.ch/sample/1f7830f0117f694b87ae81caed022c82174f9a8d158a0b8e127154e17d1600cc/." /><meta property="og:description" content="This post is dedicated to Josh Rickard (@MSAdministrator on Twitter) since his feedback on my blog posts has cut my triage time on MSI files down in a massive way! After writing an analysis of a MSI payload distributing njRAT, Josh hit me up on Twitter to suggest a Python tool he made to analyze MSIs, msi-utils with the caveat that it only worked on macOS. I set off to figure out why it only worked on macOS and, long story short, the journey led me to the msitools package on Linux. I’ll use it in this post to analyze this sample in MalwareBazaar: https://bazaar.abuse.ch/sample/1f7830f0117f694b87ae81caed022c82174f9a8d158a0b8e127154e17d1600cc/." /><link rel="canonical" href="https://forensicitguy.github.io/analyzing-stealer-msi-using-msitools/" /><meta property="og:url" content="https://forensicitguy.github.io/analyzing-stealer-msi-using-msitools/" /><meta property="og:site_name" content="Tony Lambert" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-02-12T00:00:00+00:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Analyzing a Stealer MSI using msitools" /><meta name="twitter:site" content="@ForensicITGuy" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2022-03-28T23:09:20+00:00","datePublished":"2022-02-12T00:00:00+00:00","description":"This post is dedicated to Josh Rickard (@MSAdministrator on Twitter) since his feedback on my blog posts has cut my triage time on MSI files down in a massive way! After writing an analysis of a MSI payload distributing njRAT, Josh hit me up on Twitter to suggest a Python tool he made to analyze MSIs, msi-utils with the caveat that it only worked on macOS. I set off to figure out why it only worked on macOS and, long story short, the journey led me to the msitools package on Linux. I’ll use it in this post to analyze this sample in MalwareBazaar: https://bazaar.abuse.ch/sample/1f7830f0117f694b87ae81caed022c82174f9a8d158a0b8e127154e17d1600cc/.","headline":"Analyzing a Stealer MSI using msitools","mainEntityOfPage":{"@type":"WebPage","@id":"https://forensicitguy.github.io/analyzing-stealer-msi-using-msitools/"},"url":"https://forensicitguy.github.io/analyzing-stealer-msi-using-msitools/"}</script><title>Analyzing a Stealer MSI using msitools | Tony Lambert</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Tony Lambert"><meta name="application-name" content="Tony Lambert"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src=" /assets/images/avatar.jpg " alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Tony Lambert</a></div><div class="site-subtitle font-italic">An educator that does security things</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/ForensicITGuy" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/ForensicITGuy" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a> <a href="https://ko-fi.com/forensicitguy" aria-label="ko-fi" target="_blank" rel="noopener"> <i class="fas fa-mug-hot"></i> </a> <a href="https://infosec.exchange/web/@ForensicITGuy" aria-label="mastodon" target="_blank" rel="noopener"> <i class="fab fa-mastodon"></i> </a> <a href="https://www.linkedin.com/in/tonymlambert/" aria-label="linkedin" target="_blank" rel="noopener"> <i class="fab fa-linkedin"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Analyzing a Stealer MSI using msitools</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Analyzing a Stealer MSI using msitools</h1><div class="post-meta text-muted"><div> By <em> <a href="https://twitter.com/ForensicITGuy">Tony Lambert</a> </em></div><div class="d-flex"><div> <span> Posted <em class="timeago" data-ts="1644624000" data-toggle="tooltip" data-placement="bottom" data-tooltip-df="llll" > 2022-02-12 </em> </span> <span> Updated <em class="timeago" data-ts="1648508960" data-toggle="tooltip" data-placement="bottom" data-tooltip-df="llll" > 2022-03-28 </em> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="2025 words"> <em>11 min</em> read</span></div></div></div><div class="post-content"><p>This post is dedicated to Josh Rickard (<a href="https://twitter.com/MSAdministrator">@MSAdministrator</a> on Twitter) since his feedback on my blog posts has cut my triage time on MSI files down in a massive way! After writing an analysis of a <a href="https://forensicitguy.github.io/njrat-installed-from-msi/">MSI payload distributing njRAT</a>, Josh hit me up on Twitter to suggest a Python tool he made to analyze MSIs, <a href="https://github.com/MSAdministrator/msi-utils"><code class="language-plaintext highlighter-rouge">msi-utils</code></a> with the caveat that it only worked on macOS. I set off to figure out why it only worked on macOS and, long story short, the journey led me to the <a href="https://wiki.gnome.org/msitools"><code class="language-plaintext highlighter-rouge">msitools</code></a> package on Linux. I’ll use it in this post to analyze this sample in MalwareBazaar: <a href="https://bazaar.abuse.ch/sample/1f7830f0117f694b87ae81caed022c82174f9a8d158a0b8e127154e17d1600cc/">https://bazaar.abuse.ch/sample/1f7830f0117f694b87ae81caed022c82174f9a8d158a0b8e127154e17d1600cc/</a>.</p><h2 id="getting-msitools"><span class="mr-2">Getting msitools</span><a href="#getting-msitools" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><blockquote><p>2022-02-14 Edit: <code class="language-plaintext highlighter-rouge">msitools</code> is now included in REMnux! To get it run <code class="language-plaintext highlighter-rouge">remnux upgrade</code>.</p></blockquote><p>The <code class="language-plaintext highlighter-rouge">msitools</code> package isn’t installed by default in REMnux, so we have to go install it ourselves. This is easily done using <code class="language-plaintext highlighter-rouge">apt</code>.</p><div class="language-shell highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="nb">sudo </span>apt update
<span class="nb">sudo </span>apt <span class="nb">install </span>msitools
</pre></table></code></div></div><p>Once the package is installed, we can move on to ripping apart MSI files!</p><h2 id="triage-the-msi-sample"><span class="mr-2">Triage the MSI Sample</span><a href="#triage-the-msi-sample" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>The Detect-It-Easy and <code class="language-plaintext highlighter-rouge">file</code> output confirm we do have a MSI file.</p><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre><span class="gp">remnux@remnux:~/cases/arkei-msi$</span><span class="w"> </span>diec po.msi 
<span class="go">filetype: Binary
arch: NOEXEC
mode: Unknown
endianess: LE
type: Unknown
  installer: Microsoft Installer(MSI)

</span><span class="gp">remnux@remnux:~/cases/arkei-msi$</span><span class="w"> </span>file po.msi 
<span class="gp">po.msi: Composite Document File V2 Document, Little Endian, Os: Windows, Version 10.0, MSI Installer, Code page: 1252, Title: My App 21.9.9.16, Subject: My App, Author: My App, Keywords: Installer, Template: Intel;</span>1033, Revision Number: <span class="o">{</span>9CE926D0-E487-4691-A805-7922D5CC3D39<span class="o">}</span>, Create Time/Date: Thu Feb 18 21:32:30 2021, Last Saved Time/Date: Thu Feb 18 21:32:30 2021, Number of Pages: 200, Number of Words: 12, Name of Creating Application: MSI Wrapper <span class="o">(</span>10.0.50.0<span class="o">)</span>, Security: 2
</pre></table></code></div></div><p>More specifically, the data from <code class="language-plaintext highlighter-rouge">file</code> indicates the MSI file was created by a tool named “MSI Wrapper (10.0.50.0)”. The tool is likely the one from this web site: <a href="https://www.exemsi.com/">https://www.exemsi.com/</a></p><h2 id="enumerating-msi-tables-and-streams"><span class="mr-2">Enumerating MSI Tables and Streams</span><a href="#enumerating-msi-tables-and-streams" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>We can start the analysis using <code class="language-plaintext highlighter-rouge">msiinfo</code> to get some information about the file. We definitely want to know what table and stream structures we can expect within the MSI.</p><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
</pre><td class="rouge-code"><pre><span class="gp">remnux@remnux:~/cases/arkei-msi$</span><span class="w"> </span>msiinfo tables po.msi 
<span class="go">_SummaryInformation
_ForceCodepage
_Validation
AdminExecuteSequence
AdminUISequence
AdvtExecuteSequence
Binary
Component
Directory
CustomAction
Feature
FeatureComponents
File
Icon
InstallExecuteSequence
InstallUISequence
LaunchCondition
Media
Property
Registry
Upgrade

</span><span class="gp">remnux@remnux:~/cases/arkei-msi$</span><span class="w"> </span>msiinfo streams po.msi 
<span class="go">Icon.ProductIcon
Binary.bz.CustomActionDll
Binary.bz.WrappedSetupProgram
SummaryInformation
DocumentSummaryInformation
</span></pre></table></code></div></div><p>As MSI files go, this one isn’t particularly complex. Depending on the product used, there can be a lot more data in tables and streams. There are a few things we definitely want to hit during our analysis here. First, we need to examine the contents of the “CustomAction” table at the very least. The CustomAction table is often interesting with malicious installers as adversaries may hide code to execute within the CustomAction table. PurpleFox malware has placed JScript to execute in this table in the past and other malware families have used the table to specify that a malicious DLL should be executed during installation. T</p><h2 id="dumping-tables-and-streams"><span class="mr-2">Dumping Tables and Streams</span><a href="#dumping-tables-and-streams" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>We can dump out all of the contents using <code class="language-plaintext highlighter-rouge">msidump</code>.</p><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
</pre><td class="rouge-code"><pre><span class="gp">remnux@remnux:~/cases/arkei-msi$</span><span class="w"> </span>msidump <span class="nt">-s</span> <span class="nt">-t</span> po.msi 
<span class="go">Exporting table _SummaryInformation...
Exporting table _ForceCodepage...
Exporting table _Validation...
Exporting table AdminExecuteSequence...
Exporting table AdminUISequence...
Exporting table AdvtExecuteSequence...
Exporting table Binary...
Exporting table Component...
Exporting table Directory...
Exporting table CustomAction...
Exporting table Feature...
Exporting table FeatureComponents...
Exporting table File...
Exporting table Icon...
Exporting table InstallExecuteSequence...
Exporting table InstallUISequence...
Exporting table LaunchCondition...
Exporting table Media...
Exporting table Property...
Exporting table Registry...
Exporting table Upgrade...
Exporting stream Icon.ProductIcon...
Exporting stream Binary.bz.CustomActionDll...
Exporting stream Binary.bz.WrappedSetupProgram...
Exporting stream SummaryInformation...
Exporting stream DocumentSummaryInformation...

</span><span class="gp">remnux@remnux:~/cases/arkei-msi$</span><span class="w"> </span><span class="nb">ls</span> <span class="nt">-l</span>
<span class="go">total 4720
-rw-rw-r-- 1 remnux remnux     243 Feb 12 22:44 AdminExecuteSequence.idt
-rw-rw-r-- 1 remnux remnux     141 Feb 12 22:44 AdminUISequence.idt
-rw-rw-r-- 1 remnux remnux     225 Feb 12 22:44 AdvtExecuteSequence.idt
drwxrwxr-x 2 remnux remnux    4096 Feb 12 22:44 Binary
-rw-rw-r-- 1 remnux remnux     132 Feb 12 22:44 Binary.idt
-rw-rw-r-- 1 remnux remnux     202 Feb 12 22:44 Component.idt
-rw-rw-r-- 1 remnux remnux    1093 Feb 12 22:44 CustomAction.idt
</span><span class="c">...
</span></pre></table></code></div></div><p>Each of the IDT files contain data from the tables, while two folders named “Binary” and “_Streams” hold executable and stream data fetched from the MSI. First up, let’s inspect that CustomAction.idt file.</p><div class="language-text highlighter-rouge"><div class="code-header"> <span data-label-text="Text"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre><td class="rouge-code"><pre>Action  Type    Source  Target  ExtendedType
s72     i2      S72     S255    I4
CustomAction    Action
bz.EarlyInstallMain     1       bz.CustomActionDll      _InstallMain@4  
bz.EarlyInstallSetPropertyForDeferred1  51      bz.EarlyInstallFinish2  [BZ.INIFILE]    
bz.EarlyInstallFinish2  1       bz.CustomActionDll      _InstallFinish2@4       
bz.LateInstallPrepare   1       bz.CustomActionDll      _InstallPrepare@4       
bz.LateInstallSetPropertyForDeferred1   51      bz.LateInstallFinish1   [BZ.INIFILE]    
bz.LateInstallFinish1   3073    bz.CustomActionDll      _InstallFinish1@4       
bz.LateInstallSetPropertyForDeferred2   51      bz.LateInstallFinish2   [BZ.INIFILE]    
bz.LateInstallFinish2   3073    bz.CustomActionDll      _InstallFinish2@4       
bz.CheckReboot  1       bz.CustomActionDll      _CheckReboot@4  
bz.UninstallPrepare     1       bz.CustomActionDll      _UninstallPrepare@4     
bz.UninstallSetPropertyForDeferred1     51      bz.UninstallFinish1     [BZ.INIFILE]    
bz.UninstallFinish1     3073    bz.CustomActionDll      _UninstallFinish1@4     
bz.UninstallSetPropertyForDeferred2     51      bz.UninstallFinish2     [BZ.INIFILE]    
bz.UninstallFinish2     1025    bz.CustomActionDll      _UninstallFinish2@4     
bz.UninstallWrapped     1       bz.CustomActionDll      _UninstallWrapped@4 
</pre></table></code></div></div><p>The table contents look relatively normal as far as MSI files go. If there were malicious content here we’d see code chunks that we’d expect to see in JScript or VBScript files. Let’s go take a look at some other interesting tables. The Property table gives some more information.</p><div class="language-text highlighter-rouge"><div class="code-header"> <span data-label-text="Text"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
</pre><td class="rouge-code"><pre>Property        Value
s72     l0
Property        Property
UpgradeCode     {3FF46275-96F9-4EBF-9B1E-50CA97E8DB0E}
ALLUSERS        1
ARPNOREPAIR     1
ARPNOMODIFY     1
ARPPRODUCTICON  ProductIcon
BZ.WRAPPED_REGISTRATION None
BZ.VER  2922
BZ.CURRENTDIR   *SOURCEDIR*
BZ.WRAPPED_APPID        {1FC4DB72-5AB1-4002-B9B0-00FAA9B12D8E}
BZ.COMPANYNAME  EXEMSI.COM
BZ.BASENAME     NEnXoxoXxKaPjctW.exe
BZ.ELEVATE_EXECUTABLE   administrators
BZ.INSTALLMODE  EARLY
BZ.WRAPPERVERSION       10.0.50.0
BZ.EXITCODE     0
BZ.INSTALL_SUCCESS_CODES        0
Manufacturer    My App
ProductCode     {481C9516-0944-4A5D-B8F1-803936B5D792}
ProductLanguage 1033
ProductName     My App
ProductVersion  21.9.9.16
SecureCustomProperties  WIX_DOWNGRADE_DETECTED;WIX_UPGRADE_DETECTED
</pre></table></code></div></div><p>It looks like the CompanyName for this MSI Wrapper is EXEMSI.COM, consistent with what we expected so far. The BaseName property looks to be <code class="language-plaintext highlighter-rouge">NEnXoxoXxKaPjctW.exe</code>. We haven’t seen this name anywhere else in the tables so far, so I’m going to guess there’s an archive or something inside a stream that contains the executable or content that downloads it. Let’s go look at the _Streams content.</p><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="gp">remnux@remnux:~/cases/arkei-msi/_Streams$</span><span class="w"> </span>file <span class="k">*</span>
<span class="go">Binary.bz.CustomActionDll:     PE32 executable (DLL) (GUI) Intel 80386, for MS Windows
Binary.bz.WrappedSetupProgram: Microsoft Cabinet archive data, Windows 2000/XP setup, 2059637 bytes, 1 file, at 0x2c +A "NEnXoxoXxKaPjctW.exe", ID 5658, number 1, 64 datablocks, 0x1503 compression
DocumentSummaryInformation:    dBase III DBT, version number 0, next free block index 65534
Icon.ProductIcon:              Targa image data - Map 32 x 19866 x 1 +1
SummaryInformation:            dBase III DBT, version number 0, next free block index 65534
</span></pre></table></code></div></div><p>We have some executable content that looks interesting in _Streams. First, the file <code class="language-plaintext highlighter-rouge">Binary.bz.CustomActionDll</code> looks like it’s a Windows native DLL file. A “custom action DLL” is pretty common to see in MSI files from multiple different products. I commonly see this sort of DLL in MSIs made by AdvancedInstaller tools, and those are usually signed. The second interesting file is <code class="language-plaintext highlighter-rouge">Binary.bz.WrappedSetupProgram</code>. This looks like a Microsoft CAB file that we can unpack using <code class="language-plaintext highlighter-rouge">7z</code>.</p><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
</pre><td class="rouge-code"><pre><span class="gp">remnux@remnux:~/cases/arkei-msi/_Streams$</span><span class="w"> </span>7z x Binary.bz.WrappedSetupProgram
<span class="go">
7-Zip [64] 16.02 : Copyright (c) 1999-2016 Igor Pavlov : 2016-05-21
p7zip Version 16.02 (locale=en_US.UTF-8,Utf16=on,HugeFiles=on,64 bits,2 CPUs Intel(R) Core(TM) i7-8550U CPU @ 1.80GHz (806EA),ASM,AES-NI)

Scanning the drive for archives:
1 file, 2059637 bytes (2012 KiB)

Extracting archive: Binary.bz.WrappedSetupProgram
--         
Path = Binary.bz.WrappedSetupProgram
Type = Cab
Physical Size = 2059637
Method = LZX:21
Blocks = 1
Volumes = 1
Volume Index = 0
ID = 5658

Everything is Ok

Size:       2094224
Compressed: 2059637

</span><span class="gp">remnux@remnux:~/cases/arkei-msi/_Streams$</span><span class="w"> </span><span class="nb">ls</span> <span class="nt">-l</span>
<span class="go">total 4408
-rw-rw-r-- 1 remnux remnux  212992 Feb 12 22:44  Binary.bz.CustomActionDll
-rw-rw-r-- 1 remnux remnux 2059637 Feb 12 22:44  Binary.bz.WrappedSetupProgram
-rw-rw-r-- 1 remnux remnux 2094224 Feb  9 14:17  NEnXoxoXxKaPjctW.exe
</span></pre></table></code></div></div><p>After a life-affirming message from <code class="language-plaintext highlighter-rouge">7z</code>, the tool successfully unpacked <code class="language-plaintext highlighter-rouge">NEnXoxoXxKaPjctW.exe</code> from the CAB. This is the EXE we were looking for after it was mentioned in Property.idt! Thus ends the MSI triage!</p><h2 id="triage-the-exe"><span class="mr-2">Triage the EXE</span><a href="#triage-the-exe" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>Using Detect-It-Easy to identify the file helped find a stumbling block.</p><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="gp">remnux@remnux:~/cases/arkei-msi/_Streams$</span><span class="w"> </span>diec NEnXoxoXxKaPjctW.exe 
<span class="go">filetype: PE32
arch: I386
mode: 32-bit
endianess: LE
type: GUI
  protector: Obsidium(-)[-]
  linker: unknown(2.30)[GUI32]
</span></pre></table></code></div></div><p>The EXE is protected/packed using <a href="https://www.obsidium.de/">Obsidium</a>, a commercial packing tool. There’s probably a way to unpack it statically or with a debugger, but that’s going to take more effort than I want to put in tonight. The best way from here forward for me will be to lean on a sandbox report.</p><h2 id="how-do-we-know-its-arkei-stealer"><span class="mr-2">How do we know it’s Arkei Stealer?</span><a href="#how-do-we-know-its-arkei-stealer" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>The <a href="https://tria.ge/220211-hzzkgacbe4/behavioral1">Tria.ge report</a> for the sample indicates it found evidence of Arkei in the memory dump of process ID 1312, which corresponds to <code class="language-plaintext highlighter-rouge">NEnXoxoXxKaPjctW.exe</code>. Let’s inspect that memory dump with some YARA rules and see what we can find. After running the sample through YARA rules from the <code class="language-plaintext highlighter-rouge">yara-rules</code> and <code class="language-plaintext highlighter-rouge">ditekshen</code> repositories, I couldn’t find a match. I assume at this point that the YARA rule is internal/private to Hatching. So let’s see if we can find intelligence overlaps in the sandbox telemetry.</p><p>The network activity from the report indicates the sample downloaded <code class="language-plaintext highlighter-rouge">mozglue.dll</code>, <code class="language-plaintext highlighter-rouge">sqlite3.dll</code>, <code class="language-plaintext highlighter-rouge">nss3.dll</code>, <code class="language-plaintext highlighter-rouge">freebl3.dll</code>, and a couple others. These DLLs are commonly downloaded and loaded into memory by stealers as they provide functionality to decrypt sensitive data within Mozilla Firefox and Chromium-based web browsers. This is common to Vidar and Arkei, and these two families are similar enough that <a href="https://fumik0.com/2018/12/24/lets-dig-into-vidar-an-arkei-copycat-forked-stealer-in-depth-analysis/">one may be forked</a> from the other. The network telemetry in the sandbox PCAP can also be helpful since it looks like there was a POST request. We can take a look at the data in Wireshark. In Wireshark, we want to filter on <code class="language-plaintext highlighter-rouge">http</code> protocol only so we can immediately find that POST request.To see the content of the POST, we can right-click on the POST request and follow the HTTP stream. Once we do that, we can see it looks like the malware uploaded a ZIP archive named <code class="language-plaintext highlighter-rouge">USR1V37900ZM7Q.zip</code>.</p><p><img data-src="/assets/images/analyzing-stealer-msi-using-msitools/stealer-http-stream.png" alt="Wireshark HTTP Stream" data-proofer-ignore></p><p>Since this file is uploaded over HTTP, it stands to reason that we can carve it out of the network traffic and inspect the contents. We can do this easily with NetworkMiner. Once you open the PCAP in NetworkMiner, all the files get automatically reassembled and written to disk. To inspect one, right-click on the file and either “Open File” or “Open Folder”.</p><p><img data-src="/assets/images/analyzing-stealer-msi-using-msitools/network-miner.png" alt="NetworkMiner Interface" data-proofer-ignore></p><p>After unpacking the ZIP we can find just a few files.</p><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="gp">remnux@remnux:~/cases/arkei-msi/network$</span><span class="w"> </span>tree <span class="nt">-a</span>
<span class="c">.
</span><span class="go">├── History
│   └── Firefox_n0kj3f68.default-release.txt
├── screenshot.jpg
├── system.txt
└── USR1V37900ZM7Q.zip
</span></pre></table></code></div></div><p>Just <a href="https://www.google.com/search?q=%22screenshot.jpg%22+%22system.txt%22">searching for “screenshot.jpg” + “system.txt” on Google</a> will yield some hits on Oski stealer, and one on Vidar. This isn’t surprising as <a href="https://blog.minerva-labs.com/a-long-list-of-arkei-stealers-browser-crypto-wallets">Oski reportedly shares some code with Vidar and Arkei</a>.</p><p>The Firefox and screenshot information will likely be self-explanatory, so let’s start with <code class="language-plaintext highlighter-rouge">system.txt</code>. Stealers commonly capture system configuration data within a text file and sometimes leave specific toolmarks/artifacts inside those files. For example, Raccoon often leaves its own name in a systeminfo text file. Previous versions of Vidar, such as in <a href="https://fumik0.com/2018/12/24/lets-dig-into-vidar-an-arkei-copycat-forked-stealer-in-depth-analysis/">fumik0’s analysis</a>, seem to store system information in a file named <code class="language-plaintext highlighter-rouge">information.txt</code> instead. This makes me think we’re actually somewhere in Oski stealer territory since it allegedly shares some code with Arkei. Lastly, there’s also a possibility this could be Mars stealer based on its similarity to Oski in <a href="https://3xp0rt.com/posts/mars-stealer">this analysis</a> as with Oski, there is a <code class="language-plaintext highlighter-rouge">system.txt</code> file.</p><p>So why does any of this matter? It matters a bit for threat intelligence tracking and attribution to developers. This also shows the great challenge in threat intelligence of trying to interpret malware analysis findings and detection details when many malware tools fork from one another and share artifacts. In worst case scenarios analysts can make assessments based on severely flawed or dated information. In many cases, though, the data is “close enough” to still be useful. This can be seen in the Tria.ge report: no matter what the stealer is, the configuration is still parsed.</p><p>Thanks for reading!</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/malware/'>malware</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/malware/" class="post-tag no-text-decoration" >malware</a> <a href="/tags/msitools/" class="post-tag no-text-decoration" >msitools</a> <a href="/tags/stealer/" class="post-tag no-text-decoration" >stealer</a> <a href="/tags/msi/" class="post-tag no-text-decoration" >msi</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Analyzing a Stealer MSI using msitools - Tony Lambert&amp;url=https://forensicitguy.github.io/analyzing-stealer-msi-using-msitools/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Analyzing a Stealer MSI using msitools - Tony Lambert&amp;u=https://forensicitguy.github.io/analyzing-stealer-msi-using-msitools/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https://forensicitguy.github.io/analyzing-stealer-msi-using-msitools/&amp;text=Analyzing a Stealer MSI using msitools - Tony Lambert" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <a href="https://www.linkedin.com/sharing/share-offsite/?url=https://forensicitguy.github.io/analyzing-stealer-msi-using-msitools/" data-toggle="tooltip" data-placement="top" title="Linkedin" target="_blank" rel="noopener" aria-label="Linkedin"> <i class="fa-fw fab fa-linkedin"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/pecheck-malware-weight-loss/">Bad Guys Hate This Trick for Malware Weight Loss!</a><li><a href="/formbook-via-vbs-powershell-and-csharp/">Formbook Distributed Via VBScript, PowerShell, and C# Code</a><li><a href="/agenttesla-vba-certutil-download/">An AgentTesla Sample Using VBA Macros and Certutil</a><li><a href="/my-sans-dfir-netwars-experience/">My SANS DFIR NetWars Experience</a><li><a href="/making-meterpreter-look-google-signed/">Making Meterpreter Look Google Signed</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/malware/">malware</a> <a class="post-tag" href="/tags/powershell/">powershell</a> <a class="post-tag" href="/tags/msi/">msi</a> <a class="post-tag" href="/tags/windows/">windows</a> <a class="post-tag" href="/tags/agenttesla/">agenttesla</a> <a class="post-tag" href="/tags/ld-preload/">ld_preload</a> <a class="post-tag" href="/tags/mshta/">mshta</a> <a class="post-tag" href="/tags/net/">.net</a> <a class="post-tag" href="/tags/cobalt-strike/">cobalt-strike</a> <a class="post-tag" href="/tags/csharp/">csharp</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="tail-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/batloader-ursnif-redline-oh-my/"><div class="card-body"> <em class="timeago small" data-ts="1674432000" > 2023-01-23 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>BATLoader, Ursnif, and Redline, oh my!</h3><div class="text-muted small"><p> Earlier today, @MalwareHunterTeam posted on Twitter about a malicious MSI file masquerading as a Rufus installer. Searching for &amp;quot;rufus&amp;quot; in Google right now gives 2 ads that are obviously...</p></div></div></a></div><div class="card"> <a href="/strrat-attached-to-msi/"><div class="card-body"> <em class="timeago small" data-ts="1643760000" > 2022-02-02 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>STRRAT Attached to a MSI File</h3><div class="text-muted small"><p> Adversaries can get really creative with ways to hide and execute payloads. In this post I’ll cover one instance where an adversary appended STRRAT to a MSI file to make it look legitimate during a...</p></div></div></a></div><div class="card"> <a href="/njrat-installed-from-msi/"><div class="card-body"> <em class="timeago small" data-ts="1643846400" > 2022-02-03 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>njRAT Installed from a MSI</h3><div class="text-muted small"><p> In my last post I walked through the analysis of an unusual MSI file that an adversary had tacked a STRRAT Java ARchive file to the end of the MSI contents. In this post, I want to walk through a m...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/xloader-formbook-velvetsweatshop-spreadsheet/" class="btn btn-outline-primary" prompt="Older"><p>XLoader/Formbook Distributed by Encrypted VelvetSweatshop Spreadsheets</p></a> <a href="/aggah-ppam-renamed-mshta/" class="btn btn-outline-primary" prompt="Newer"><p>Aggah PPAM macros renaming MSHTA</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center text-muted"><div class="footer-left"><p class="mb-0"> © 2023 <a href="https://twitter.com/ForensicITGuy">Tony Lambert</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/malware/">malware</a> <a class="post-tag" href="/tags/powershell/">powershell</a> <a class="post-tag" href="/tags/msi/">msi</a> <a class="post-tag" href="/tags/windows/">windows</a> <a class="post-tag" href="/tags/agenttesla/">agenttesla</a> <a class="post-tag" href="/tags/ld-preload/">ld_preload</a> <a class="post-tag" href="/tags/mshta/">mshta</a> <a class="post-tag" href="/tags/net/">.net</a> <a class="post-tag" href="/tags/cobalt-strike/">cobalt-strike</a> <a class="post-tag" href="/tags/csharp/">csharp</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-THRVSJGH6S"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-THRVSJGH6S'); }); </script>
