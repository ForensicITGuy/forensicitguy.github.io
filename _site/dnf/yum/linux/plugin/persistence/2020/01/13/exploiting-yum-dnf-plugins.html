<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />

    <title>Where DFIR Meets IT - ForensicITGuy's blog about DFIR and tech</title>
    <meta name="description" content="ForensicITGuy's blog about DFIR and tech" />

    <meta name="HandheldFriendly" content="True" />
    <meta name="MobileOptimized" content="320" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link rel="stylesheet" type="text/css" href="/assets/css/screen.css" />
    <link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=Merriweather:300,700,700italic,300italic|Open+Sans:700,400" />
    <!-- Customisation  -->
    <link rel="stylesheet" type="text/css" href="/assets/css/main.css " />

</head>
<body class="home-template">

    <header class="main-header post-head no-cover">
    <nav class="main-nav  clearfix">
        <a class="back-button icon-arrow-left" href="/">Home</a>
        <a class="subscribe-button icon-feed" href="/feed.xml">Subscribe</a>
    </nav>
</header>

<main class="content" role="main">

    <article class="post">

        <header class="post-header">
            <h1 class="post-title">Exploiting Yum and DNF Plugins for Persistence</h1>
            <section class="post-meta">
                
                    on DNF, Yum, Linux, Plugin, and Persistence
                
                <time class="post-date" datetime="2020-01-13">13 Jan 2020</time>
            </section>
        </header>

<!--         <header class="post-header">
            <a id="blog-logo" href="https://forensicitguy.github.io/feed.xml">
                
                    <span class="blog-title">Where DFIR Meets IT</span>
                
            </a>
        </header> -->

        <!-- <span class="post-meta">
            <time datetime="2020-01-13">13 Jan 2020</time>
            
                on DNF, Yum, Linux, Plugin, and Persistence
            
        </span> -->

        <!-- <h1 class="post-title">Exploiting Yum and DNF Plugins for Persistence</h1> -->

        <section class="post-content">
            <p>Two Metasploit Framework modules have held my interest in the last few weeks: the ones for persistence using Linux package managers <a href="https://github.com/rapid7/metasploit-framework/blob/master/modules/exploits/linux/local/apt_package_manager_persistence.rb">apt</a> and <a href="https://github.com/rapid7/metasploit-framework/blob/master/modules/exploits/linux/local/yum_package_manager_persistence.rb">Yum</a>. While they require root privileges to exploit, they provide a novel persistence mechanism that is likely overlooked by defenders. While looking at these modules I noticed that persistence using DNF wasn’t included, and I set off to find a way to persist on Linux systems using DNF plugins.</p>

<h2 id="whats-a-package-manager-anyway">What’s a Package Manager, anyway?</h2>

<p>On Windows systems most folks download applications from sites on the Internet or install them from media such as CDs or DVDs. This proves to be a major threat to the stability and security of Windows as it lets users download and install unpredictable software. On the other side of the spectrum, it allows users to find and use software to improve their world.</p>

<p>For Linux distributions, the software installation model looks different. You can still download software from the Internet, but it is not usually distributed in binary form for Linux systems. In these cases, you’d need to download the source code from a trusted mirror, compile it, and resolve any dependencies needed to make the software work. This is unfriendly for inexperienced users and can cause misconfiguration. As systems developed, a more friendly form of software distribution evolved: packages. Packages became an easy way to distribute compiled binaries for specific Linux distro versions and the software that managed packages helped administrators automate dependency resolution and configuration.</p>

<p>Now, most Linux distributions have a package manager and consume one of a few package types. The most common are RPM Package Manager (RPM) and Debian (DEB) packages. RPM packages work with systems that derive from Red Hat Enterprise Linux. These include RHEL itself, CentOS, and Fedora. DEB packages work with systems that derive from Debian Linux. These include Debian, Ubuntu, Mint, ElementaryOS, and others.</p>

<p>On the RPM side, administrators used the <a href="http://man7.org/linux/man-pages/man8/yum.8.html">Yum</a> command to interact with packages prior to RHEL/CentOS 8 and Fedora 22. After those builds, administrators began to use the <a href="https://dnf.readthedocs.io/en/latest/command_ref.html">dnf</a> command. On the DEB side, administrators typically use the <a href="http://manpages.ubuntu.com/manpages/eoan/man8/apt.8.html">apt</a> or apt-get commands to interact with packages. As these package managers became more complex, they included plugins or additional functionality to make package installation more extensible. A good example of this in Yum is the fastestmirror plugin that measures the speed of interaction with one or more update mirrors and helps Yum pick the fastest one.</p>

<p>For the rest of this post we will focus on Yum and DNF plugins. Some of this functionality also exists in apt, but that’s a story for another day.</p>

<h2 id="foundational-yum-and-dnf-plugin-knowledge">Foundational Yum and DNF Plugin Knowledge</h2>

<p>Yum and DNF are both written in Python and handle all the operations around package installation. From the terminal you’ll run commands such as this:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/usr/bin/dnf install httpd
/usr/bin/yum update
</code></pre></div></div>

<p>Since these tools are implemented in Python, their plugins are also Python.</p>

<h3 id="yum">Yum</h3>

<p>With Yum, we need a few things for plugin execution. First, plugins must be enabled in <code class="language-plaintext highlighter-rouge">/etc/yum.conf</code>. This is done with the line <code class="language-plaintext highlighter-rouge">plugins=1</code>. Next, one or more plugin configurations present in the <code class="language-plaintext highlighter-rouge">/etc/yum/pluginconf.d</code> directory must be enabled with a line <code class="language-plaintext highlighter-rouge">enabled=1</code>. Finally, the Python plugin code itself lives in the <code class="language-plaintext highlighter-rouge">/usr/lib/yum-plugins</code> directory. When writing the plugin, the developer can set hook functions that will execute when Yum executes specific triggers.</p>

<p>As it so happens, the <code class="language-plaintext highlighter-rouge">fastestmirror</code> plugin is always used by yum in its default state. An easy way to exploit this is to plant malicious code within <code class="language-plaintext highlighter-rouge">/usr/lib/yum-plugins/fastestmirror.py</code>. This requires root privileges and will cause the malicious code to run as root every time Yum executes for installations or updates.</p>

<h3 id="dnf">DNF</h3>

<p>With DNF, the configuration and code paths change but most of the concepts stay the same. First, DNF configurations exist in <code class="language-plaintext highlighter-rouge">/etc/dnf/dnf.conf</code>. Plugins are enabled by default and are only disabled if a line similar to <code class="language-plaintext highlighter-rouge">plugins=False</code> is present. Next, plugin configurations exist in the <code class="language-plaintext highlighter-rouge">/etc/dnf/plugins</code> directory. Finally, the actual plugin code lives under the <code class="language-plaintext highlighter-rouge">/usr/lib/python3.6/site-packages/dnf-plugins</code> directory, but the path will change as Python versions change.</p>

<p>In DNF, we can target one specific plugin for persistence: <code class="language-plaintext highlighter-rouge">generate_completion_cache.py</code>. This plugin executes whenever an administrator runs <code class="language-plaintext highlighter-rouge">dnf install</code> or <code class="language-plaintext highlighter-rouge">dnf update</code> to speed up shell completion. It is distributed by default across Fedora, CentOS, and RHEL distributions. There doesn’t appear to be a specific configuration file that disables the plugin itself. Even in the <a href="https://dnf-plugins-core.readthedocs.io/en/latest/generate_completion_cache.html">dnf-plugins-core documentation</a>, the plugin appears intended to always run in the background without user interaction. This is perfect for exploitation. To show, we can use vim to change the plugin code.</p>

<p>Change <code class="language-plaintext highlighter-rouge">/usr/lib/python3.6/site-packages/dnf-plugins/generate_completion_cache.py</code> to add the following code above <code class="language-plaintext highlighter-rouge">import os.path</code>:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>import os
os.system(‘touch /etc/root-marker’)
</code></pre></div></div>

<p>This will give us proof that the plugin executed as root and wrote a file to disk.</p>

<p>Next, execute these commands (as root):</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>dnf update

ls -l /etc/root-marker
</code></pre></div></div>

<p>If <code class="language-plaintext highlighter-rouge">/etc/root-marker</code> exists, you have a successful execution.</p>

<p><img src="/assets/images/exploiting-dnf-plugins/successful-execution.png" alt="" /></p>

<h2 id="detection-and-breakage">Detection and Breakage</h2>

<p>I haven’t dived too far into detection for this technique. Process monitoring will show the code you add as spawning from an instance of <code class="language-plaintext highlighter-rouge">python</code> with the command line showing <code class="language-plaintext highlighter-rouge">dnf update</code> or a similar command. You may find luck monitoring for different <code class="language-plaintext highlighter-rouge">exec</code> system calls that spawn shell processes, scripts, or other utilities. Any Python code you add that does not spawn an external command will execute within the <code class="language-plaintext highlighter-rouge">dnf</code> python instance itself. This will blend in with surrounding update activity.</p>

<p>This technique will probably break with package updates to <code class="language-plaintext highlighter-rouge">dnf-plugins-core</code>. In addition, you can revert the plugin file by reverting the added code.</p>

<h2 id="why-not-just-change-dnf-itself">Why not just change DNF itself?</h2>

<p>You can probably do that, I just zoomed in on the plugins for execution. If you want to modify DNF for persistence, you probably can.</p>

<h2 id="is-it-useful">Is it useful?</h2>

<p>It depends. This technique requires root/sudo privileges to use. The technique assumes you’re attempting to persist on a system that you’ve found either misconfigured or susceptible to privilege escalation. This path should not be your first stop for persistence if you only have user privileges.</p>

        </section>

        

        <footer class="post-footer">
            <!-- If we want to display author's name and bio -->
            
                <figure class="author-image">
                    <a class="img" href="/" style="background-image: url(/assets/images/profile.png)">
                    <span class="hidden">Tony Lambert (ForensicITGuy)'s Picture</span></a>
                </figure>
                <section class="author">
                    <!-- Author Name -->
                    <h4> Tony Lambert (ForensicITGuy) </h4>
                    <!-- Author Bio -->
                    <p>
                        An educator that happens to do security things for Red Canary
                    </p>
                </section>
            

            <!-- Share links section -->
            <section class="share">
    <h4>Share this post</h4>
    <a class="icon-twitter" href="http://twitter.com/share?text=Exploiting Yum and DNF Plugins for Persistence&amp;url=https://forensicitguy.github.io/dnf/yum/linux/plugin/persistence/2020/01/13/exploiting-yum-dnf-plugins.html"
        onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
        <span class="hidden">Twitter</span>
    </a>
    <a class="icon-facebook" href="https://www.facebook.com/sharer/sharer.php?u=https://forensicitguy.github.io/dnf/yum/linux/plugin/persistence/2020/01/13/exploiting-yum-dnf-plugins.html"
        onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
        <span class="hidden">Facebook</span>
    </a>
    <a class="icon-google-plus" href="https://plus.google.com/share?url=https://forensicitguy.github.io/dnf/yum/linux/plugin/persistence/2020/01/13/exploiting-yum-dnf-plugins.html"
       onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;">
        <span class="hidden">Google+</span>
    </a>
</section>

            <!-- Disqus comments -->
            

        </footer>

    </article>

</main>

    <footer class="site-footer clearfix">
      <section class="copyright">
        <a href="">Where DFIR Meets IT</a> &copy; 
              2021 &bull; All rights reserved.
      </section>
      <section class="poweredby">Made with Jekyll using 
        <a href="http://github.com/rosario/kasper">Kasper theme</a>
      </section>
    </footer>
    
    <script type="text/javascript" src="/assets/js/jquery-1.11.1.min.js"></script>
    <script type="text/javascript" src="/assets/js/jquery.fitvids.js"></script>
    <script type="text/javascript" src="/assets/js/index.js"></script>

    <!-- Google Analytics Tracking code -->
    <script type="text/javascript">

      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-155060013-1']);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();

    </script>   
</body>
</html>
